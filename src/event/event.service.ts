import { HttpException, HttpStatus, Inject, Injectable } from '@nestjs/common';
import { PrismaService } from 'prisma/prisma.service';
import { JwtService } from '@nestjs/jwt';
import * as fs from 'fs';
import customParseFormat from 'dayjs/plugin/customParseFormat';
import isSameOrAfter from 'dayjs/plugin/isSameOrAfter';
import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import timezone from 'dayjs/plugin/timezone';
import buddhistEra from 'dayjs/plugin/buddhistEra';
// import * as localizedFormat from 'dayjs/plugin/localizedFormat';

// import * as puppeteer from 'puppeteer';
import { Response } from 'express';

// const pdfMake = require('pdfmake/build/pdfmake');
// const pdfFonts = require('pdfmake/build/vfs_fonts');
// pdfMake.vfs = pdfFonts.vfs;
import * as pdfMake from 'pdfmake/build/pdfmake';
import {
  vfs,
  logoPtt,
  used,
  notUsed,
  checkBoxCheck,
  checkBox,
} from '../fonts/vfs_fonts';
import isBetween from 'dayjs/plugin/isBetween';
import {
  getTodayEndAdd7,
  getTodayNow,
  getTodayNowAdd7,
  getTodayNowYYYYMMDDDfaultAdd7,
  getTodayStartAdd7,
  getYearEndAdd7,
  getYearStartAdd7,
} from 'src/common/utils/date.util';
import * as archiver from 'archiver';
import * as nodemailer from 'nodemailer';
import JSZip from 'jszip';
import { assertSafeExternalUrl } from 'src/common/utils/url.util';

dayjs.extend(isBetween);
dayjs.extend(utc);
dayjs.extend(timezone);
dayjs.extend(customParseFormat);
dayjs.extend(isSameOrAfter);
dayjs.extend(buddhistEra);
// dayjs.extend(localizedFormat);
// ห้ามลบ
@Injectable()
export class EventService {
  constructor(
    private jwtService: JwtService,
    private prisma: PrismaService,
  ) {}

  async useReqs(req: any) {
    const ip = req.headers['x-forwarded-for'] || req.ip;
    return {
      ip: ip,
      sub: req?.user?.sub,
      first_name: req?.user?.first_name,
      last_name: req?.user?.last_name,
      username: req?.user?.username,
      originalUrl: req?.originalUrl,
    };
  }

  async writeReq(reqUser: any, type: any, method: any, value: any) {
    const usedData = {
      reqUser: reqUser ? JSON.stringify(await this.useReqs(reqUser)) : null,
      type: type,
      method: method,
      value: JSON.stringify(value),
      id_value: value?.id,
      create_date: getTodayNowAdd7().toDate(),
      create_date_num: getTodayNowAdd7().unix(),
      module: 'EVENT',
      ...(!!reqUser?.user?.sub && {
        create_by_account: {
          connect: {
            id: Number(reqUser?.user?.sub),
          },
        },
      }),
    };
    await this.prisma.history.create({
      data: usedData,
    });
    return true;
  }

  // menus_id: 107, // Off-spec Gas
  // menus_id: 106, // Emergency/Difficult Day
  // menus_id: 1013, // OFO
  async tesoNotiCenter(menu_id:any){
      const roleMenuAllocationManagementNoticeEmail =
    await this.prisma.account.findMany({
      where: {
        id: {
          not: 99999,
        },
        account_manage: {
          some: {
            account_role: {
              some: {
                role: {
                  user_type_id: 2,
                  menus_config: {
                    some: {
                      menus_id: menu_id,
                      // menus_id: 107, // Off-spec Gas
                      // menus_id: 106, // Emergency/Difficult Day
                      // menus_id: 1013, // OFO
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
      orderBy: {
        id: 'asc',
      },
    });

    return roleMenuAllocationManagementNoticeEmail?.map((e:any) => e?.email)
  }

  // prover email
  async sendEmailProviderCustomEvent({
    header,
    subject,
    sendEmail,
    detail,
    excelBuffer,
    tagHTMLDetail,
    filename,
    contentType,
    // filename,
    // contentType,
  }: any) {
    const transporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST,
      port: Number(process.env.SMTP_PORT),
      secure: process.env.SMTP_SECURE === 'true',
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS,
      },
      tls: { rejectUnauthorized: true },
    });

    const info = await transporter.sendMail({
      from: `<${process.env.SMTP_USER}>`,
      to: sendEmail,
      // to: "teerapong.songsan@gmail.com",
      subject: subject || '',
      attachments: [
        {
          filename: filename,
          // filename: 'offspec_document.pdf',
          // filename: 'documents.zip',
          content: excelBuffer,
          contentType: contentType,
          // contentType:
          //   'application/pdf',
          //   // 'application/zip',
        },
      ],
      html: `<!DOCTYPE html>
              <html lang="en">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>Document</title>
                  </head>
                  <body>
                      <div 
                          style="width: 500px; 
                          border: 1px solid #D6D6D6; 
                          height: auto; 
                          border-radius: 15px;
                          margin: 10px auto;
                          padding: 15px;"
                      >
                          <div
                              style="display: flex;
                              margin-bottom: 50px;"
                          >
                              <img
                                  src="https://nu-test01.nueamek.app/exynos/20241203082755_logo-ptt.png"
                                  alt="logo-ptt"
                                  style="margin: 0 auto; width: 120px; object-fit: contain;"
                              />
                          </div>
                          <div
                              style="display: flex;
                              margin-bottom: 40px;"
                          >
                              <img
                                  src="https://nu-test01.nueamek.app/exynos/20241203082741_email-img.png"
                                  alt="img-email"
                                  style="margin: 0 auto; object-fit: contain;"
                              />
                          </div>
                          <div
                              style="text-align: center;
                              font-size: 20px;
                              font-weight: 700;"
                          >
                              ${header || '-'}
                          </div>
                           <div
                              style="line-height: 40px;
                              margin-top: 20px;
                              text-align: left;
                              font-size: 15px;
                              "
                          >
                              <div>
                              ${tagHTMLDetail}
                              </div>
                          </div>
                        
                          <div style="margin-top: 30px; font-size: 15px;">
                              <div style="text-align: center;">
                                  Thank You,
                              </div>
                              <div style="text-align: center;">
                                  TPA, Systems
                              </div>
                          </div>
                          <div style="margin-top: 40px; text-align: center; font-size: 14px;">
                              <span>If you did not initiate this request, please contact us immediately at </span>
                              <a href="#">support@ptt.com.</a>
                          </div>
                      </div>
                  </body>
              </html>`,
    });

    return info;
  }

  eventStatus() {
    return this.prisma.event_status.findMany({ orderBy: { id: 'asc' } });
  }

  eventDocStatus() {
    return this.prisma.event_doc_status.findMany({
      orderBy: { id: 'asc' },
      where: {
        id: {
          in: [3, 4, 5],
        },
      },
    });
  }

  async offspecGasOnce(id: any, userId: any) {
    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const groupId = group?.id;
    const result = await this.prisma.event_runnumber.findFirst({
      where: {
        id: Number(id),
      },
      include: {
        event_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_file_pdf: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            },
            event_document_action: {
              include: {
                event_doc_master: true,
                event_doc_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: {
                id: 'desc',
              },
            },
          },
        },
      },
    });
    const rData = this.mapDataEventOffspacGas(
      result,
      result?.user_type_id,
      groupId,
    );
    return rData;
  }

  async offspecGasAll(query: any, userId: any) {
    console.log('userId : ', userId);
    const {
      eventCode,
      eventDateFrom,
      eventDateTo,
      EventStatus,
      offset,
      limit,
    } = query;

    // const page_ = Number(offset);
    // const limit_ = Number(limit);
    // const offset_ = page_ * limit_;
    const limit_ = Number(limit);
    const offset_ = Number(offset);

    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group.user_type?.id;
    const groupId = group?.id;

    const eventDateCondition =
      !!eventDateFrom && !!eventDateTo
        ? {
            event_date: {
              gte: getTodayNowYYYYMMDDDfaultAdd7(eventDateFrom).toDate(),
              lte: getTodayNowYYYYMMDDDfaultAdd7(eventDateTo)
                .endOf('day')
                .toDate(),
            },
          }
        : eventDateFrom
          ? {
              event_date: {
                gte: getTodayNowYYYYMMDDDfaultAdd7(eventDateFrom).toDate(),
              },
            }
          : eventDateTo
            ? {
                event_date: {
                  lte: getTodayNowYYYYMMDDDfaultAdd7(eventDateTo)
                    .endOf('day')
                    .toDate(),
                },
              }
            : {};

    // // STEP 1: ดึง id ทั้งหมด (ตามเงื่อนไข)
    //   const allIdsResult = await this.prisma.event_runnumber.findMany({
    //     where: {
    //       ...(userTypeId === 3 && { group_id: groupId }),
    //       event_nember: { contains: eventCode },
    //       ...(EventStatus && { event_status_id: Number(EventStatus) }),
    //       ...eventDateCondition,
    //     },
    //     orderBy: [{ id: 'desc' }],
    //     select: { id: true },
    //   });

    //   const allIds = allIdsResult.map((r) => r.id);
    //   console.log('allIds : ', allIds);
    //   const pagedIds = allIds.slice(offset_, offset_ + limit_);

    const result = await this.prisma.event_runnumber.findMany({
      // where: { id: { in: pagedIds } },
      where: {
        ...(userTypeId === 3 && {
          OR: [
            { group_id: groupId },
            { event_document: { some: { group_id: groupId } } },
          ],
        }), // รับปรับ

        event_nember: {
          contains: eventCode && eventCode?.toUpperCase() || "",
        },
        ...(EventStatus && {
          event_status_id: Number(EventStatus),
        }),
        ...eventDateCondition,
      },
      skip: Number(offset_),
      take: Number(limit_),
      include: {
        event_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_file_pdf: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            },
            event_document_action: {
              include: {
                event_doc_master: true,
                event_doc_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: {
                id: 'desc',
              },
            },
          },
        },
      },
      orderBy: [{ create_date: 'desc' }, { id: 'desc' }],
    });
    console.log('result : ', result);
    // const result = pagedIds.map(id => nosortedResult.find(r => r.id === id));
    console.log(result.map((r) => r.id));

    console.log('eventDateCondition : ', eventDateCondition);

    const newData = result?.map((e: any) => {
      const rData = this.mapDataEventOffspacGas(e, userTypeId, groupId);
      // console.log('rData : ', rData);
      return rData;
    });

    const count = await this.prisma.event_runnumber.count({
      where: {
        ...(userTypeId === 3 && {
          OR: [
            { group_id: groupId },
            { event_document: { some: { group_id: groupId } } },
          ],
        }),
        event_nember: {
          contains: eventCode && eventCode?.toUpperCase() || "",
        },
        ...(EventStatus && {
          event_status_id: Number(EventStatus),
        }),
        ...eventDateCondition,
      },
    });

    return {
      total: count,
      data: newData,
    };
  }

  mapDataEventOffspacGas(e: any, userTypeId: any, groupId?: any) {
    const { event_document, ...nE } = e;
    let document1 = null;
    let document2 = null;
    let document3 = null;

    let document2TSOID = null;
    let document3TSOID = null;
    // console.log('event_document : ', event_document);

    if (userTypeId === 3) {
      // shipper
      // user_type?.id
      document1 = event_document?.find(
        (f: any) => f?.event_doc_master_id === 1,
      );

      document2 = event_document?.find(
        (f: any) => f?.event_doc_master_id === 2 && f?.group_id === groupId, // เป็น obj 1
      );

      document3 = event_document?.find(
        (f: any) => f?.event_doc_master_id === 3 && f?.group_id === groupId, // เป็น obj 1
      );
    } else {
      // tso | อื่นๆ
      document1 = event_document?.find(
        (f: any) => f?.event_doc_master_id === 1,
      );

      document2 = event_document?.filter(
        (f: any) => f?.event_doc_master_id === 2 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );

      document2TSOID = event_document?.find(
        (f: any) => f?.event_doc_master_id === 2 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
      )?.id;

      document3 = event_document?.filter(
        (f: any) =>
          f?.event_doc_master_id === 3 &&
          (f?.ref_document !== null || f?.event_doc_status_id === 1), // เป็น [] shipper only สำหรับนับ
      );

      document3TSOID = event_document?.find(
        (f: any) =>
          f?.event_doc_master_id === 3 &&
          (f?.ref_document === null || f?.event_doc_status_id === 1), // เป็น [] shipper only สำหรับนับ
      )?.id;
    }

    return {
      ...nE,
      document1: document1 ?? null,
      document2: document2 ?? null,
      document2TSOID: document2TSOID ?? null,
      document3: document3 ?? null,
      document3TSOID: document3TSOID ?? null,
      // temps: event_document,
    };
  }

  async updateStatus(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_status_id } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId === 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_runnumber.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_status_id: event_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      const eventRunId = await prisma.event_runnumber.findFirst({
        where: {
          id: Number(id),
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.offspecGasOnce(result?.eventRunId, userId);

    return findOnce;
  }

  async doc1Find(id: any, userId: any) {
    console.log('userId : ', userId);
    const result = await this.prisma.event_document.findFirst({
      where: {
        id: Number(id),
      },
      include: {
        event_runnumber: {
          include: {
            event_status: true,
          },
        },
        event_doc_master: true,
        event_doc_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_file: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
          orderBy: { id: 'desc' },
        },
        event_document_file_pdf: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
        },
        event_document_action: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
                signature: true,
                signature_base_64: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
                signature: true,
                signature_base_64: true,
              },
            },
          },
          orderBy: {
            id: 'desc',
          },
        },
      },
    });
    console.log('result : ', result);
    return result;
  }

  async doc1Create(payload: any, userId: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,
      input_delivery_point_at_the_scene,
      input_date_time_of_the_incident,
      input_gas_quality_is_not_in_the_gas_quality_requirements,
      input_more,
      input_reason_the_gas_quality_requirements,
      input_duration_that_is_expected_to_be_completed,
      input_note,
      file,
      longdo_dict,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const eventNumberCount = await prisma.event_runnumber.count({
        where: {
          create_date: {
            gte: todayStart,
            lte: todayEnd,
          },
        },
      });
      const eventNumber = `${newDate.format('YYYY')}-OSG-${(eventNumberCount > 0 ? eventNumberCount + 1 : 1).toString().padStart(4, '0')}`;

      const createEventRunnumber = await prisma.event_runnumber.create({
        data: {
          event_nember: eventNumber,
          event_date: getTodayNowAdd7().toDate(),
          event_status: {
            connect: {
              id: 1,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
        include: {
          event_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      const createEventDocument = await prisma.event_document.create({
        data: {
          event_date: getTodayNowAdd7(event_date).toDate(),
          event_runnumber: {
            connect: {
              id: createEventRunnumber?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 1,
            },
          },
          input_delivery_point_at_the_scene:
            input_delivery_point_at_the_scene ?? null,
          input_date_time_of_the_incident:
            input_date_time_of_the_incident ?? null,
          input_gas_quality_is_not_in_the_gas_quality_requirements:
            input_gas_quality_is_not_in_the_gas_quality_requirements ?? null,
          input_more: input_more ?? null,
          input_reason_the_gas_quality_requirements:
            input_reason_the_gas_quality_requirements ?? null,
          input_duration_that_is_expected_to_be_completed:
            input_duration_that_is_expected_to_be_completed ?? null,
          input_note: input_note ?? null,
          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
        include: {
          event_doc_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          event_runnumber: true,
        },
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_file.createMany({
          data: fileData,
        });
      }

      // file
      // event_document_file_pdf                                          event_document_file_pdf[]

      await prisma.event_document_action.create({
        data: {
          event_document: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 1,
            },
          },
          input_note: input_note ?? null,
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      return { createEventRunnumber, createEventDocument };
    });

    const findOnce = await this.offspecGasOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: result?.createEventDocument?.id, //doc 2 3 shipper ใช้ ref in
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // email
    const tsoGroup = await this.prisma.account.findMany({
      where: {
        id: {
          not: 99999,
        },
        account_manage: {
          some: {
            user_type_id: 2,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
      orderBy: {
        id: 'asc',
      },
    });

    const tsoEmail = tsoGroup
      ?.map((e: any) => e?.email)
      ?.filter((f: any) => f !== null)
      .join(', ');

    const excelBuffer = await this.doc1PDF(
      result?.createEventDocument?.id,
      null,
      null,
      true,
    );

    const originalShipperInformsOffspecGasDoc1Part1 = {
      header: `Shipper ${result?.createEventDocument?.group.name} แจ้งเหตุคุณภาพก๊าซนำเข้าไมอยู่ในข้อกำหนด`,
      subject:
        'Events/Offspec Gas - Original Shipper informs offspec gas (Doc.1) (Part 1)',
      sendEmail: tsoEmail,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${result?.createEventDocument?.event_runnumber?.event_nember}</li>
          <li>จุดที่ส่งเข้าที่เกิดเหตุ :  ${input_delivery_point_at_the_scene}</li>
          <li>วัน/เวลาที่เกิดเหตุ :  ${input_date_time_of_the_incident}</li>
        </ul>
      </div>
      `,
      filename: 'offspec_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(
      originalShipperInformsOffspecGasDoc1Part1,
    );

    return findOnce;
  }

  async doc1Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_doc_status_id, input_note } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId === 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber.findFirst({
        where: {
          event_status_id: 2,
          event_document: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          input_note: input_note ?? null,
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      // file
      // event_document_file_pdf                                          event_document_file_pdf[]

      await prisma.event_document_action.create({
        data: {
          event_document: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 1,
            },
          },
          input_note: input_note ?? null,
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber.findFirst({
        where: {
          event_document: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.offspecGasOnce(result?.eventRunId, userId);

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: Number(id), //doc 2 3 shipper ใช้ ref in
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        event_runnumber: true,
        input_delivery_point_at_the_scene: true,
        input_date_time_of_the_incident: true,
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    //   // TSO รับทราบการแจ้งเหตุคุณภาพก๊าซนำเข้าไมอยู่ในข้อกำหนด
    //   // - Comment: xxxx ไม่แนบ
    // Events/Offspec Gas - TSO Acknowledge (Doc.1)

    //   // TSO ตอบรับการแจ้งเหตุคุณภาพก๊าซนำเข้าไมอยู่ในข้อกำหนด
    // Events/Offspec Gas - TSO Accept (Doc.1)

    //   // TSO ปฎิเสธการแจ้งเหตุคุณภาพก๊าซนำเข้าไมอยู่ในข้อกำหนด
    // Events/Offspec Gas - TSO Reject (Doc.1)

    const header =
      event_doc_status_id === 3
        ? `TSO ตอบรับการแจ้งเหตุคุณภาพก๊าซนำเข้าไม่อยู่ในข้อกำหนด`
        : event_doc_status_id === 4
          ? `TSO ปฎิเสธการแจ้งเหตุคุณภาพก๊าซนำเข้าไม่อยู่ในข้อกำหนด`
          : event_doc_status_id === 5
            ? `TSO รับทราบการแจ้งเหตุคุณภาพก๊าซนำเข้าไม่อยู่ในข้อกำหนด`
            : ``;
    const subject =
      event_doc_status_id === 3
        ? `Events/Offspec Gas - TSO Accept (Doc.1)`
        : event_doc_status_id === 4
          ? `Events/Offspec Gas - TSO Reject (Doc.1)`
          : event_doc_status_id === 5
            ? `Events/Offspec Gas - TSO Acknowledge (Doc.1)`
            : ``;

    const excelBuffer = await this.doc1PDF(docId?.id, null, null, true);

    const originalShipperInformsOffspecGasDoc1Part1 = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber?.event_nember || ''}</li>
          <li>จุดที่ส่งเข้าที่เกิดเหตุ :  ${docId?.input_delivery_point_at_the_scene || ''}</li>
          <li>วัน/เวลาที่เกิดเหตุ :  ${docId?.input_date_time_of_the_incident || ''}</li>
          ${
            (event_doc_status_id === 5 &&
              `
            <li>Comment :  ${input_note || ''}</li>
            `) ||
            ''
          }
        </ul>
      </div>
      `,
      filename: 'offspec_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(
      originalShipperInformsOffspecGasDoc1Part1,
    );

    return findOnce;
  }

  async doc1History(id: any, userId: any) {
    const resData = await this.prisma.event_document_log_history.findMany({
      where: {
        event_document_id: Number(id),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  getExtensionFromUrl(url: string): string {
    try {
      const pathname = new URL(url).pathname; // ดึง path ของ URL
      const filename = pathname.split('/').pop() || '';
      const match = filename.match(/\.([a-zA-Z0-9]+)$/);
      return match ? match[1].toLowerCase() : '';
    } catch {
      return '';
    }
  }

  async convertUrlToBase64(url: any, type: any) {
    const axios = require('axios');
    try {
      if (typeof url !== 'string' || url.trim().length === 0) {
        throw new Error('Empty URL');
      }
      assertSafeExternalUrl(url);
    } catch (e) {
      throw new Error(`Invalid or unsafe URL for conversion: ${e?.message || 'unknown'}`);
    }

    const data = JSON.stringify({
      url: url,
      format: type?.toUpperCase() || '',
    });

    const config = {
      method: 'post',
      maxBodyLength: Infinity,
      url: `${process.env.GATEWAY_BASE_URL || `https://${process.env.IP_URL}:${process.env.KONG_PORT}`}/files/convert-to-base64/`,
      headers: {
        'Content-Type': 'application/json',
      },
      data: data,
    };

    const response = await axios.request(config);
    return response?.data?.base64;
  }


  // {
  //                         text: [
  //                           'หมายเหตุ : ',
  //                           {
  //                             text:
  //                               input_note ? input_note : '____________',
  //                             decoration: input_note && 'underline',
  //                           },
  //                         ],
  //                     margin: [0, 5, 0, 2],
  //                   },

  async doc1PDF(id: any, userId: any, res: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const rdoc1Find = await this.doc1Find(id, userId);
    console.log('rdoc1Find : ', rdoc1Find);

    // event_runnumber?.event_nember
    // event_runnumber?.event_date
    const event_document_action = rdoc1Find?.event_document_action;
    const fromFullname =
      event_document_action[event_document_action.length - 1]?.create_by_account
        ?.first_name &&
      event_document_action[event_document_action.length - 1]?.create_by_account
        ?.last_name
        ? `${event_document_action[event_document_action.length - 1]?.create_by_account?.first_name} ${event_document_action[event_document_action.length - 1]?.create_by_account?.last_name}`
        : '';
    const fromCompany =
      (event_document_action[event_document_action.length - 1]?.group
        ?.company_name &&
        event_document_action[event_document_action.length - 1]?.group
          ?.company_name) ||
      '………………………………………………………………';
    const fromDate = dayjs(
      event_document_action[event_document_action.length - 1]?.create_date,
    ).locale('th');
    const fromSignature =
      event_document_action[event_document_action.length - 1]?.create_by_account
        ?.signature_base_64 || ''; //
    // const fromSignatureMimtype = fromSignature
    //   ? this.getExtensionFromUrl(fromSignature)
    //   : '';
    // const fromSignatureBase64 = fromSignatureMimtype
    //   ? await this.convertUrlToBase64(fromSignature, fromSignatureMimtype)
    //   : '';

    const toAction = event_document_action?.find(
      (f: any) => f?.user_type_id === 2,
    );
    const toFullname =
      toAction?.create_by_account?.first_name &&
      toAction?.create_by_account?.last_name
        ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
        : '';
    const toCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
    const toSignature = toAction?.create_by_account?.signature_base_64 || ''; //
    // const toSignatureMimtype = toSignature
    //   ? this.getExtensionFromUrl(toSignature)
    //   : '';
    // const toSignatureBase64 = toSignatureMimtype
    //   ? await this.convertUrlToBase64(toSignature, toSignatureMimtype)
    //   : '';
    // console.log('toSignature : ', toSignature);

    const toDate = dayjs(toAction?.create_date).locale('th');
    const event_nember = rdoc1Find?.event_runnumber?.event_nember;
    const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
    const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');
    const input_delivery_point_at_the_scene =
      rdoc1Find?.input_delivery_point_at_the_scene;
    const input_date_time_of_the_incident =
      rdoc1Find?.input_date_time_of_the_incident;
    const input_gas_quality_is_not_in_the_gas_quality_requirements =
      rdoc1Find?.input_gas_quality_is_not_in_the_gas_quality_requirements;
    const input_more = rdoc1Find?.input_more;
    const input_reason_the_gas_quality_requirements =
      rdoc1Find?.input_reason_the_gas_quality_requirements;
    const input_duration_that_is_expected_to_be_completed =
      rdoc1Find?.input_duration_that_is_expected_to_be_completed;
    const input_note = rdoc1Find?.input_note;

    const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา
    // จุดส่งเข้าที่เกิดเหตุ | input_delivery_point_at_the_scene
    // วัน/เวลาที่เกิดเหตุ | input_date_time_of_the_incident
    // ประเภทและค่าของคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ | input_gas_quality_is_not_in_the_gas_quality_requirements
    // เพิ่มเติม | input_more
    // สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ | input_reason_the_gas_quality_requirements
    // ระยะเวลาที่คาดว่าจะแก้ไขแล้วเสร็จ | input_duration_that_is_expected_to_be_completed
    // หมายเหตุ | input_note

    (pdfMake as any).vfs = vfs;
    const fonts = {
      THSarabun: {
        normal: 'THSarabunNew.ttf',
        bold: 'THSarabunNew-Bold.ttf',
        italics: 'THSarabunNew.ttf',
        bolditalics: 'THSarabunNew-Bold.ttf',
      },
    };
    (pdfMake as any).fonts = fonts;
    const docDefinition = {
      header: (currentPage, pageCount) => {
        return {
          columns: [
            { width: '*', text: '' }, // เว้นซ้าย
            {
              width: 'auto',
              stack: [
                {
                  text: `เลขที่เอกสาร: …………${event_nember}…………`,
                  fontSize: 12,
                  alignment: 'right',
                },
                {
                  text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}…/…${event_runnumber.format('BBBB')}…………`,
                  fontSize: 12,
                  alignment: 'right',
                },
              ],
              margin: [0, 5, 10, 0], // [left, top, right, bottom],
            },
          ],
        };
      },
      content: [
        {
          image: logoImage,
          width: 70,
          alignment: 'center',
          margin: [0, 0, 0, 10],
        },

        {
          text: 'เอกสารแจ้งเตือนคุณภาพก๊าซฯ 1',
          alignment: 'center',
          fontSize: 18,
          bold: true,
          margin: [0, 0, 0, 5],
        },
        {
          text: 'เอกสารแจ้งเหตุคุณภาพก๊าซที่นำเข้าไม่อยู่ในข้อกำหนดคุณภาพก๊าซ หรือ กรณีคุณภาพหรือปริมาณก๊าซนำเข้าก๊าซเบี่ยงเบนมากกว่ากำหนดที่กำหนด',
          alignment: 'center',
          margin: [0, 0, 0, 10],
        },

        // ======== กรอบ "เรียน / สำเนา" =========
        {
          table: {
            widths: ['auto', '*'],
            body: [
              [
                {
                  text: 'เรียน:',
                  bold: true,
                  alignment: 'center',
                  verticalAlignment: 'middle',
                  margin: [0, 10, 0, 10],
                },
                {
                  text: 'ส่วนบริหารและควบคุมระบบส่งก๊าซ (Gas Transmission Management & System Operation Division)',
                  verticalAlignment: 'middle',
                  margin: [0, 10, 0, 10],
                },
              ],
              [
                {
                  text: 'สำเนา:',
                  bold: true,
                  alignment: 'center',
                  verticalAlignment: 'middle',
                  margin: [0, 10, 0, 10],
                },
                {
                  stack: [`${longdo_dict}`, 'โทร 025372000,35063'],
                  // margin: [0, 7, 0, 7], // << บังคับความสูงให้จัดกลาง
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
          },
          margin: [0, 0, 0, 0],
        },

        // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
        {
          table: {
            widths: ['*'],
            body: [
              [
                {
                  stack: [
                    {
                      text: 'ส่วนของผู้ใช้บริการ (ผู้ทำให้เกิดเหตุการณ์)',
                      bold: true,
                      decoration: 'underline',
                      margin: [0, 0, 0, 5],
                    },
                    {
                      ul: [
                        {
                          text: [
                            'จุดที่ส่งเข้าที่เกิดเหตุ : ',
                            {
                              text: input_delivery_point_at_the_scene ? input_delivery_point_at_the_scene : '____________',
                              decoration: input_delivery_point_at_the_scene && 'underline',
                            },
                          ],
                        },
                        {
                          text: [
                            'วัน/เวลาที่เกิดเหตุ : ',
                            {
                              text: input_date_time_of_the_incident ? input_date_time_of_the_incident : '____________',
                              decoration: input_date_time_of_the_incident && 'underline',
                            },
                          ],
                        },
                        {
                          text: [
                            'ประเภทและค่าที่ไม่อยู่ในข้อกำหนด/เกณฑ์ที่กำหนด  : ',
                            {
                              text: input_gas_quality_is_not_in_the_gas_quality_requirements ? input_gas_quality_is_not_in_the_gas_quality_requirements : '____________',
                              decoration: input_gas_quality_is_not_in_the_gas_quality_requirements && 'underline',
                            },
                          ],
                        },
                        {
                          text: [
                            // 'ประเภทและค่าที่ไม่อยู่ในข้อกำหนด/เกณฑ์ที่กำหนด  : ',
                            {
                              text: input_more ? input_more : '____________',
                              decoration: input_more && 'underline',
                            },
                          ],
                        },
                        {
                          text: [
                            'สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนด/เกณฑ์ที่กำหนด : ',
                            {
                              text:
                                input_reason_the_gas_quality_requirements ? input_reason_the_gas_quality_requirements : '____________',
                              decoration: input_reason_the_gas_quality_requirements && 'underline',
                            },
                          ],
                        },
                        {
                          text: [
                            'ระยะเวลาที่คาดว่าจะแก้ไขสำเร็จ : ',
                            {
                              text:
                                input_duration_that_is_expected_to_be_completed ? input_duration_that_is_expected_to_be_completed : '____________',
                              decoration: input_duration_that_is_expected_to_be_completed && 'underline',
                            },
                          ],
                        },
                        // `จุดที่ส่งเข้าที่เกิดเหตุ : ${input_delivery_point_at_the_scene || '-'}`,
                        // `วัน/เวลาที่เกิดเหตุ : ${input_date_time_of_the_incident || '-'}`,
                        // `ประเภทและค่าที่ไม่อยู่ในข้อกำหนด/เกณฑ์ที่กำหนด : ${input_gas_quality_is_not_in_the_gas_quality_requirements || '-'}`,
                        // `${input_more || '-'}`,
                        // `สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนด/เกณฑ์ที่กำหนด : ${input_reason_the_gas_quality_requirements || '-'}`,
                        // `ระยะเวลาที่คาดว่าจะแก้ไขสำเร็จ : ${input_duration_that_is_expected_to_be_completed || '-'}`,
                      ],
                    },
                  ],
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
          },
          margin: [0, 0, 0, 0],
        },

        // ======== กรอบ "รับ/ปฏิเสธ" =========
        {
          table: {
            widths: ['*'],
            body: [
              [
                {
                  stack: [
                    {
                      text: 'ส่วนของผู้ใช้บริการ',
                      bold: true,
                      decoration: 'underline',
                      margin: [0, 0, 0, 5],
                    },
                    {
                      columns: [
                        {
                          width: 15,
                          image:
                            event_doc_status === 3 ? logoUsed : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                          verticalAlignment: 'middle',
                          alignment: 'center',
                          fit: [12, 12],
                        },
                        {
                          text: [
                            { text: 'รับ ', bold: true },
                            'ก๊าซไม่อยู่ในข้อตกลงฯ/เกณฑ์ที่กำหนด',
                          ],
                          margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                          alignment: 'left',
                        },
                      ],
                      margin: [0, 0, 0, 2],
                    },
                    {
                      columns: [
                        {
                          width: 15,
                          image:
                            event_doc_status === 4 ? logoUsed : logoNotUsed, // แทนด้วย base64 string
                          verticalAlignment: 'middle',
                          alignment: 'center',
                          fit: [12, 12],
                        },
                        {
                          text: [
                            { text: 'ปฏิเสธ ', bold: true },
                            'ก๊าซไม่อยู่ในข้อตกลงฯ/เกณฑ์ที่กำหนด',
                          ],
                          margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                          alignment: 'left',
                        },
                      ],
                      margin: [0, 0, 0, 2],
                    },
                    // {
                    //   columns: [
                    //     {
                    //       width: 15,
                    //       image:
                    //         event_doc_status === 5 ? logoUsed : logoNotUsed, // แทนด้วย base64 string
                    //       verticalAlignment: 'middle',
                    //       alignment: 'center',
                    //       fit: [12, 12],
                    //     },
                    //     {
                    //       text: 'รับทราบ',
                    //       bold: true,
                    //       margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                    //       alignment: 'left',
                    //     },
                    //   ],
                    //   margin: [0, 0, 0, 2],
                    // },
                     {
                          text: [
                            'หมายเหตุ : ',
                            {
                              text:
                                input_note ? input_note : '____________',
                              decoration: input_note && 'underline',
                            },
                          ],
                      margin: [0, 5, 0, 2],
                    },
                    // {
                    //   text: `หมายเหตุ: ${input_note || '-'}`,
                    //   margin: [0, 5, 0, 2],
                    // },
                    // {
                    //   text: 'สวัสดี...:',
                    //   margin: [0, 0, 0, 0],
                    //   // decoration: 'underline',
                    // },

                    // 'สวัสดี_______________________________________________________',
                    // '_______________________________________________________',
                  ],
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
          },
          margin: [0, 0, 0, 0],
        },

        // ======== กรอบช่องเซ็นชื่อ =========
        {
          table: {
            widths: ['*', '*'],
            body: [
              [
                {
                  stack: [
                    // https://app.clickup.com/t/86eum0nv1
                    fromSignature
                      ? {
                          columns: [
                            { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                            {
                              image: fromSignature, // base64 หรือ path
                              width: 50,
                              alignment: 'center',
                            },
                            { text: '', width: 'auto', alignment: 'left' },
                          ],
                          columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                          margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        }
                      : { text: `แจ้งโดย ` },
                    { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },

                    // { text: `แจ้งโดย ${fromFullname}` },
                    // fromSignature
                    //   ? {
                    //       columns: [
                    //         { text: '(', width: 'auto', alignment: 'right' },
                    //         {
                    //           image: fromSignature, // base64 หรือ path
                    //           width: 50,
                    //           alignment: 'center',
                    //         },
                    //         { text: ')', width: 'auto', alignment: 'left' },
                    //       ],
                    //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                    //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                    //     }
                    //   : { text: `(                                   )` },
                    { text: `หน่วยงาน ${fromCompany} (ผู้ใช้บริการ)` },
                    {
                      text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                    },
                  ],
                  margin: [5, 5, 5, 5],
                },
                {
                  stack: [
                    { text: `รับทราบโดย ${toFullname}` },
                    toSignature
                      ? {
                          columns: [
                            { text: '(', width: 'auto', alignment: 'right' },
                            {
                              image: toSignature, // base64 หรือ path
                              width: 50,
                              alignment: 'center',
                            },
                            { text: ')', width: 'auto', alignment: 'left' },
                          ],
                          columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                          margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        }
                      : { text: `(                                   )` },
                    {
                      text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toCompany} (ผู้ให้บริการ)`,
                    },
                    {
                      text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                    },
                  ],
                  margin: [5, 5, 5, 5],
                },
              ],
            ],
          },
          layout: {
            hLineWidth: () => 0.5,
            vLineWidth: () => 0.5,
          },
          margin: [0, 0, 0, 0],
        },

        // ======== Footer ========
        // {
        //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
        //   alignment: 'left',
        //   fontSize: 10,
        //   bold: true,
        //   margin: [0, 10, 0, 0],
        // },
      ],
      defaultStyle: {
        font: 'THSarabun',
        fontSize: 14,
      },
    };

    // buff

    if (buff) {
      return new Promise<Buffer>((resolve, reject) => {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          resolve(buffer); // ✅ return buffer ออกไป
        });
      });
    } else {
      const pdfDocGenerator = pdfMake.createPdf(docDefinition);
      pdfDocGenerator.getBuffer((buffer) => {
        res.setHeader('Content-Type', 'application/pdf');
        res.setHeader(
          'Content-Disposition',
          `attachment; filename=offspec_${id}.pdf`,
        );
        res.end(buffer);
      });
    }
  }

  // doc 2

  async sendEmailProviderCustomDocs({
    cc,
    header,
    subject,
    sendEmail,
    detail,
    excelBuffer,
    tagHTMLDetail,
    filename,
    contentType,
    // filename,
    // contentType,
  }: any) {
    const transporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST,
      port: Number(process.env.SMTP_PORT),
      secure: false,
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS,
      },
      tls: process.env.SMTP_REJECT_UNAUTHORIZED === 'false' && process.env.NODE_ENV !== 'production' ? { rejectUnauthorized: false } : { rejectUnauthorized: true },
    });

    const info = await transporter.sendMail({
      from: `<${process.env.SMTP_USER}>`,
      to: sendEmail,
      cc: cc,
      // bcc: ["niti.lkul@gmail.com", "teerapong.songsan@gmail.com"],
      // to: "teerapong.songsan@gmail.com",
      subject: subject || '',
      attachments: [
        {
          filename: filename,
          // filename: 'offspec_document.pdf',
          // filename: 'documents.zip',
          content: excelBuffer,
          contentType: contentType,
          // contentType:
          //   'application/pdf',
          //   // 'application/zip',
        },
      ],
      html: `<!DOCTYPE html>
              <html lang="en">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>Document</title>
                  </head>
                  <body>
                      <div 
                          style="width: 500px; 
                          border: 1px solid #D6D6D6; 
                          height: auto; 
                          border-radius: 15px;
                          margin: 10px auto;
                          padding: 15px;"
                      >
                          <div
                              style="display: flex;
                              margin-bottom: 50px;"
                          >
                              <img
                                  src="https://nu-test01.nueamek.app/exynos/20241203082755_logo-ptt.png"
                                  alt="logo-ptt"
                                  style="margin: 0 auto; width: 120px; object-fit: contain;"
                              />
                          </div>
                          <div
                              style="display: flex;
                              margin-bottom: 40px;"
                          >
                              <img
                                  src="https://nu-test01.nueamek.app/exynos/20241203082741_email-img.png"
                                  alt="img-email"
                                  style="margin: 0 auto; object-fit: contain;"
                              />
                          </div>
                          <div
                              style="text-align: center;
                              font-size: 20px;
                              font-weight: 700;"
                          >
                              ${header || '-'}
                          </div>
                           <div
                              style="line-height: 40px;
                              margin-top: 20px;
                              text-align: left;
                              font-size: 15px;
                              "
                          >
                              <div>
                              ${tagHTMLDetail}
                              </div>
                          </div>
                        
                          <div style="margin-top: 30px; font-size: 15px;">
                              <div style="text-align: center;">
                                  Thank You,
                              </div>
                              <div style="text-align: center;">
                                  TPA, Systems
                              </div>
                          </div>
                          <div style="margin-top: 40px; text-align: center; font-size: 14px;">
                              <span>If you did not initiate this request, please contact us immediately at </span>
                              <a href="#">support@ptt.com.</a>
                          </div>
                      </div>
                  </body>
              </html>`,
    });

    return info;
  }

  async sendEmailCondition(
    emailUse: any,
    payload: any,
    reqPayload: any,
    doc: any,
  ) {
    // console.log('***************');
    // console.log(payload);
    // -------------------------------Editable-------------------------------------------
    // TSO แจ้งคุณภาพก๊าซหรือปริมาณก๊าซนำเข้ากลับเป็นปกติ
    // -------------------------------Non Editable-------------------------------------
    // - Event Code: xxxx
    // - โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจาระบบก๊าซเมื่อวันที่ :  xxxx
    // *พร้อมแนบ PDF file จากระบบ

    if (doc === 2) {
      const header = `TSO แจ้งเหตุคุณภาพก๊าซนำเข้าไม่อยู่ในข้อกำหนด`;
      const subject = `Events/Offspec Gas - TSO generate Doc.2 to informs other shipper (Part 1)`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        // ?.filter((f: any) => f?.user_type_id === 3) // https://app.clickup.com/t/86eum0nv5
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

      for (let i = 0; i < payload?.document2?.length; i++) {
        const excelBuffer = await this.doc2PDF(
          payload?.document2?.[i]?.id,
          null,
          null,
          payload?.document2?.[i]?.group_id,
          true,
        );
        const sG = gSHIPPER?.filter((f: any) => {
          return f?.group_id === payload?.document2?.[i]?.group_id;
        });
        const sGm = sG
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();
        const sendEmail = [payload?.document2?.[i]?.group?.email, ...sGm]?.filter(
          (f: any) => f !== null,
        );

        const templateDoc2Create = {
          cc: emailUse?.ccEmail,
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer,
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>จุดที่ส่งเข้าที่เกิดเหตุ :  ${reqPayload?.doc2_input_delivery_point_at_the_scene || ''}</li>
              <li>วัน/เวลาที่เกิดเหตุ :  ${reqPayload?.doc2_input_date_time_of_the_incident || ''}</li>
            </ul>
          </div>
          `,
          filename: 'offspec_document.pdf',
          // filename: 'documents.zip',
          contentType: 'application/pdf',
          // contentType: 'application/zip',
        };
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDoc2Create);
        }
      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc2PDF(
          payload?.document2TSOID,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDoc2Create = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>จุดที่ส่งเข้าที่เกิดเหตุ :  ${reqPayload?.doc2_input_delivery_point_at_the_scene || ''}</li>
              <li>วัน/เวลาที่เกิดเหตุ :  ${reqPayload?.doc2_input_date_time_of_the_incident || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDoc2Create : ', templateDoc2Create);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDoc2Create);
        }
      }
    } else if (doc === 3) {
      const header = `TSO แจ้งคุณภาพก๊าซหรือปริมาณก๊าซนำเข้ากลับเป็นปกติ`;
      const subject = `Events/Offspec Gas - TSO informs Doc.3`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

      for (let i = 0; i < payload?.document3?.length; i++) {
        const excelBuffer = await this.doc3PDF(
          payload?.document3?.[i]?.id,
          null,
          null,
          payload?.document3?.[i]?.group_id,
          true,
        );
        const sG = gSHIPPER?.filter((f: any) => {
          return f?.group_id === payload?.document3?.[i]?.group_id;
        });
        const sGm = sG
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();
        const sendEmail = [payload?.document3?.[i]?.group?.email, ...sGm]?.filter(
          (f: any) => f !== null,
        );

        const templateDocCreate = {
          cc: emailUse?.ccEmail,
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer,
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจากระบบก๊าซเมื่อวันที่ : ${reqPayload?.doc3_input_tso_disapeared_date || ''} ${reqPayload?.doc3_input_tso_disapeared_time || ""}</li>
            </ul>
          </div>
          `,
          filename: 'offspec_document.pdf',
          // filename: 'documents.zip',
          contentType: 'application/pdf',
          // contentType: 'application/zip',
        };
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc3PDF(
          payload?.document3TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจากระบบก๊าซเมื่อวันที่ : ${reqPayload?.doc3_input_tso_disapeared_date || ''} ${reqPayload?.doc3_input_tso_disapeared_time || ""}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    } else if (doc === 39) {
      const header = `TSO แจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง`;
      const subject = `Events/Emergency/Difficult Day - TSO generate Doc.3.9`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

      for (let i = 0; i < payload?.document39?.length; i++) {
        const excelBuffer = await this.doc39PDF(
          payload?.document39?.[i]?.id,
          null,
          null,
          payload?.document39?.[i]?.group_id,
          true,
        );
        const sG = gSHIPPER?.filter((f: any) => {
          return f?.group_id === payload?.document39?.[i]?.group_id;
        });
        const sGm = sG
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();
        const sendEmail = [
          payload?.document39?.[i]?.group?.email,
          ...sGm,
        ]?.filter((f: any) => f !== null);

        const templateDocCreate = {
          cc: emailUse?.ccEmail,
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer,
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>Date :  ${payload?.document39?.[i]?.doc_39_input_date_time_of_the_incident || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'emergency_difficult_document.pdf',
          // filename: 'documents.zip',
          contentType: 'application/pdf',
          // contentType: 'application/zip',
        };
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
      // document39
      console.log('reqPayload : ', reqPayload);
      console.log('payload : ', payload);
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc39PDF(
          payload?.document39TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    } else if (doc === 41) {
      console.log('41');
      const header = `TSO ออกคำสั่งปรับปริมาณก๊าซจากเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง`;
      const subject = `Events/Emergency/Difficult Day - TSO generate Doc.4`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

        const maxGroupId = (payload?.document41 ?? []).reduce((mx, r) => {
          const n = Number(r?.group_id);
          return Number.isFinite(n) && n > mx ? n : mx;
        }, -Infinity) ?? null;
      for (let i = 0; i < payload?.document41?.length; i++) {
        if(payload?.document41?.[i]?.seq === maxGroupId){ // ส่งแค่ version ล่าสุด https://app.clickup.com/t/86eum0nzk
          const excelBuffer = await this.doc41PDF(
            payload?.document41?.[i]?.id,
            null,
            null,
            payload?.document41?.[i]?.group_id,
            true,
          );
          const sG = gSHIPPER?.filter((f: any) => {
            return f?.group_id === payload?.document41?.[i]?.group_id;
          });
          const sGm = sG
            ?.map((e: any) => e?.email)
            ?.filter((f: any) => f !== null)
            ?.flat();
          const sendEmail = [payload?.document41?.[i]?.group?.email, ...sGm]?.filter(
            (f: any) => f !== null,
          );
  
          const templateDocCreate = {
            cc: emailUse?.ccEmail,
            header: header,
            subject: subject,
            sendEmail: sendEmail,
            detail: '',
            excelBuffer: excelBuffer,
            tagHTMLDetail: `
            <div>
              <ul>
                <li>Event Code: ${payload?.event_nember || ''}</li>
                <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
                <li>Date :  ${payload?.document41?.[i]?.doc_4_input_date_time_of_the_incident || ''}</li>
                <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
                <li>การสั่งการ :  ${payload?.document41?.[i]?.doc_4_input_order_ir_id === 1 ? `เพิ่ม จุดส่งเข้า ปริมาณ ${payload?.document41?.[i]?.doc_4_input_order_value || ""}` : `ลด จุดส่งออก ปริมาณ ${payload?.document41?.[i]?.doc_4_input_order_value || ""}`}</li>
              </ul>
            </div>
            `,
            filename: 'emergency_difficult_document.pdf',
            // filename: 'documents.zip',
            contentType: 'application/pdf',
            // contentType: 'application/zip',
          };
          if (sendEmail.length > 0) {
            await this.sendEmailProviderCustomDocs(templateDocCreate);
          }
        }

      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc4PDF(
          payload?.document41TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    } else if (doc === 5) {
      const header = `TSO แจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรงกลับเป็นปกติ`;
      const subject = `Events/Emergency/Difficult Day - TSO generate Doc.5`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

      for (let i = 0; i < payload?.document5?.length; i++) {
        const excelBuffer = await this.doc5PDF(
          payload?.document5?.[i]?.id,
          null,
          null,
          payload?.document5?.[i]?.group_id,
          true,
        );
        const sG = gSHIPPER?.filter((f: any) => {
          return f?.group_id === payload?.document5?.[i]?.group_id;
        });
        const sGm = sG
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();
        const sendEmail = [payload?.document5?.[i]?.group?.email, ...sGm]?.filter(
          (f: any) => f !== null,
        );

        const templateDocCreate = {
          cc: emailUse?.ccEmail,
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer,
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>Date :  ${payload?.document5?.[i]?.doc_5_input_event_date && dayjs(payload?.document5?.[i]?.doc_5_input_event_date).format("DD/MM/YYYY") || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'emergency_difficult_document.pdf',
          // filename: 'documents.zip',
          contentType: 'application/pdf',
          // contentType: 'application/zip',
        };
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc5PDF(
          payload?.document5TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    } else if (doc === 6) {
      const header = `TSO แจ้งสรุปการปรับปริมาณก๊าซ `;
      const subject = `Events/Emergency/Difficult Day - TSO generate Doc.6`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

      for (let i = 0; i < payload?.document6?.length; i++) {
        const excelBuffer = await this.doc6PDF(
          payload?.document6?.[i]?.id,
          null,
          null,
          payload?.document6?.[i]?.group_id,
          true,
        );
        const sG = gSHIPPER?.filter((f: any) => {
          return f?.group_id === payload?.document6?.[i]?.group_id;
        });
        const sGm = sG
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();
        const sendEmail = [payload?.document6?.[i]?.group?.email, ...sGm]?.filter(
          (f: any) => f !== null,
        );

        const templateDocCreate = {
          cc: emailUse?.ccEmail,
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer,
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>Date :  ${payload?.document6?.[i]?.doc_6_input_when_date && dayjs(payload?.document6?.[i]?.doc_6_input_when_date).format("DD/MM/YYYY") || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
              <li>คำสั่งต่อผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ :  ${payload?.document6?.[i]?.group?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'emergency_difficult_document.pdf',
          // filename: 'documents.zip',
          contentType: 'application/pdf',
          // contentType: 'application/zip',
        };
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc6PDF(
          payload?.document6TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>Type :  ${payload?.event_doc_emer_type?.name_en || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_emer_gas_tranmiss_id === 5 ? payload?.event_doc_emer_gas_tranmiss_other : payload?.event_doc_emer_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    } else if (doc === 7) {
      const header = `TSO แจ้งคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${payload?.event_doc_ofo_type_id === 1 ? "Operation Flow Order" : "Instructed Flow Order"})`;
      const subject = `Events/OFO - TSO generate Doc.7`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

       const maxGroupId = (payload?.document7 ?? []).reduce((mx, r) => {
          const n = Number(r?.group_id);
          return Number.isFinite(n) && n > mx ? n : mx;
        }, -Infinity) ?? null;

      for (let i = 0; i < payload?.document7?.length; i++) {
        if(payload?.document7?.[i]?.seq === maxGroupId){
          const excelBuffer = await this.doc7PDF(
            payload?.document7?.[i]?.id,
            null,
            null,
            payload?.document7?.[i]?.group_id,
            true,
          );
          const sG = gSHIPPER?.filter((f: any) => {
            return f?.group_id === payload?.document7?.[i]?.group_id;
          });
          const sGm = sG
            ?.map((e: any) => e?.email)
            ?.filter((f: any) => f !== null)
            ?.flat();
          const sendEmail = [payload?.document7?.[i]?.group?.email, ...sGm]?.filter(
            (f: any) => f !== null,
          );

          const templateDocCreate = {
            cc: emailUse?.ccEmail,
            header: header,
            subject: subject,
            sendEmail: sendEmail,
            detail: '',
            excelBuffer: excelBuffer,
            tagHTMLDetail: `
            <div>
              <ul>
                <li>Event Code: ${payload?.event_nember || ''}</li>
                <li>Gas Day :  ${payload?.document7?.[i]?.doc_7_input_date_time_of_the_incident || ''}</li>
                <li>ระบบส่งก๊าซ :  ${payload?.event_doc_ofo_gas_tranmiss === 5 ? payload?.event_doc_ofo_gas_tranmiss_other : payload?.event_doc_ofo_gas_tranmiss?.name || ''}</li>
                <li>การสั่งการ :  ${payload?.document7?.[i]?.event_doc_gas_shipper_ofo_match?.[payload?.document7?.[i]?.event_doc_gas_shipper_ofo_match?.length - 1]?.event_doc_gas_shipper_ofo?.ir === 1 ? 'เพิ่ม' : 'ลด'}</li>
                <li>ปริมาณก๊าซ :  ${payload?.document7?.[i]?.event_doc_gas_shipper_ofo_match?.[payload?.document7?.[i]?.event_doc_gas_shipper_ofo_match?.length - 1]?.event_doc_gas_shipper_ofo?.nom_value_mmscfh || ''}</li>
              </ul>
            </div>
            `,
            filename: 'ofo_document.pdf',
            // filename: 'documents.zip',
            contentType: 'application/pdf',
            // contentType: 'application/zip',
          };
          if (sendEmail.length > 0) {
            await this.sendEmailProviderCustomDocs(templateDocCreate);
          }
        }
      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc7PDF(
          payload?.document7TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code: ${payload?.event_nember || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_ofo_gas_tranmiss === 5 ? payload?.event_doc_ofo_gas_tranmiss_other : payload?.event_doc_ofo_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    } else if (doc === 8) {
      const header = `TSO แจ้งคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${payload?.event_doc_ofo_type_id === 1 ? "Operation Flow Order" : "Instructed Flow Order"}})`;
      const subject = `Events/OFO - TSO generated Doc.8`;
      const groupMail = await this.prisma.edit_email_group_for_event.findMany({
        where: {},
        include: {
          edit_email_group_for_event_match: true,
          user_type: true,
          group: true,
        },
      });

      const grMail = emailUse?.emailGroup
        ?.map((e: any) => {
          const find = groupMail?.find((f: any) => {
            return f?.id === e;
          });
          return find ?? null;
        })
        ?.filter((f: any) => f !== null);
      const gTSO = grMail
        ?.filter((f: any) => f?.user_type_id === 2)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });
      const gSHIPPER = grMail
        ?.filter((f: any) => f?.user_type_id === 3)
        ?.map((e: any) => {
          return {
            id: e?.id,
            group_id: e?.group_id,
            email: e?.edit_email_group_for_event_match?.map(
              (m: any) => m?.email,
            ),
          };
        });

      for (let i = 0; i < payload?.document8?.length; i++) {
        const excelBuffer = await this.doc8PDF(
          payload?.document8?.[i]?.id,
          null,
          null,
          payload?.document8?.[i]?.group_id,
          true,
        );
        const sG = gSHIPPER?.filter((f: any) => {
          return f?.group_id === payload?.document8?.[i]?.group_id;
        });
        const sGm = sG
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();
        const sendEmail = [payload?.document8?.[i]?.group?.email, ...sGm]?.filter(
          (f: any) => f !== null,
        );

        const templateDocCreate = {
          cc: emailUse?.ccEmail,
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer,
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code : ${payload?.event_nember || ''}</li>
              <li>Gas Day :  ${payload?.event_date && dayjs(payload?.event_date) || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_ofo_gas_tranmiss_id === 5 ? payload?.event_doc_ofo_gas_tranmiss_other : payload?.event_doc_ofo_gas_tranmiss?.name || ''}</li>

            </ul>
          </div>
          `,
          filename: 'ofo_document.pdf',
          // filename: 'documents.zip',
          contentType: 'application/pdf',
          // contentType: 'application/zip',
        };
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
      if ((gTSO?.length ?? 0) > 0) {
        const excelBuffer = await this.doc8PDF(
          payload?.document8TSOID?.id,
          null,
          null,
          null,
          true,
        );
        const sendEmail = gTSO
          ?.map((e: any) => e?.email)
          ?.filter((f: any) => f !== null)
          ?.flat();

        const templateDocCreate = {
          cc: [],
          header: header,
          subject: subject,
          sendEmail: sendEmail,
          detail: '',
          excelBuffer: excelBuffer, // zip แปลงกลับ
          tagHTMLDetail: `
          <div>
            <ul>
              <li>Event Code : ${payload?.event_nember || ''}</li>
              <li>Gas Day :  ${payload?.event_date && dayjs(payload?.event_date) || ''}</li>
              <li>ระบบส่งก๊าซ :  ${payload?.event_doc_ofo_gas_tranmiss_id === 5 ? payload?.event_doc_ofo_gas_tranmiss_other : payload?.event_doc_ofo_gas_tranmiss?.name || ''}</li>
            </ul>
          </div>
          `,
          filename: 'documents.zip',
          contentType: 'application/zip',
        };
        console.log('templateDocCreate : ', templateDocCreate);
        if (sendEmail.length > 0) {
          await this.sendEmailProviderCustomDocs(templateDocCreate);
        }
      }
    }

    return true;
  }

  async doc2EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc2RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber.findMany({
      where: {
        event_document: {
          // none: {
          some: {
            event_doc_master: {
              id: 1,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    console.log('--- resDoc : ', resDoc);

    const filtered = resDoc.filter(
      (item) =>
        !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    );

    return filtered;
  }

  async doc2Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    // const filtered = resDoc.filter(
    //   (item) =>
    //     !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    // );

    return resDoc;
  }

  // email
  async doc2Create(payload: any, userId: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,
      ref_document,
      doc2_input_delivery_point_at_the_scene,
      doc2_input_date_time_of_the_incident,
      doc2_input_gas_quality_is_not_in_the_gas_quality_requirements,
      doc2_input_reason_the_gas_quality_requirements,
      doc2_input_duration_that_is_expected_to_be_completed,
      doc2_input_duration_of_the_gas_travel_to_various_points,
      doc2_input_note,
      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;

    const checkDocrun =
      ref_document &&
      (await this.prisma.event_document.findFirst({
        where: {
          event_doc_master_id: 2,
          event_runnumber_id: Number(ref_document),
        },
      }));
    if (checkDocrun) {
      throw new HttpException(
        {
          status: HttpStatus.BAD_REQUEST,
          error: 'Event Document used Ref.',
        },
        HttpStatus.BAD_REQUEST,
      );
    }

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;
      console.log('userTypeId : ', userTypeId);
      console.log('groupId : ', groupId);

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      // รอเช็ค ref
      const eventNumberCount =
        !ref_document &&
        (await prisma.event_runnumber.count({
          where: {
            create_date: {
              gte: todayStart,
              lte: todayEnd,
            },
          },
        }));
      const eventNumber =
        !ref_document &&
        `${newDate.format('YYYY')}-OSG-${(eventNumberCount > 0 ? eventNumberCount + 1 : 1).toString().padStart(4, '0')}`;

      const createEventRunnumber = !ref_document
        ? await prisma.event_runnumber.create({
            data: {
              event_nember: eventNumber,
              event_date: getTodayNowAdd7().toDate(),
              event_status: {
                connect: {
                  id: 1,
                },
              },
              group: {
                connect: {
                  id: groupId,
                },
              },
              user_type: {
                connect: {
                  id: userTypeId,
                },
              },
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by_account: {
                connect: {
                  id: Number(userId),
                },
              },
            },
            include: {
              event_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
            },
          })
        : await prisma.event_runnumber.findFirst({
            where: {
              id: Number(ref_document),
            },
            include: {
              event_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
            },
          });

      // -----

      const tsoCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        ref_runnumber_flag: !!ref_document,
        event_runnumber: {
          connect: {
            id: createEventRunnumber?.id,
          },
        },
        event_doc_status: {
          connect: {
            id: 2,
          },
        },
        group: {
          connect: {
            id: groupId,
          },
        },
        user_type: {
          connect: {
            id: userTypeId,
          },
        },
        event_doc_master: {
          connect: {
            id: 2,
          },
        },
        doc2_input_delivery_point_at_the_scene:
          doc2_input_delivery_point_at_the_scene ?? null,
        doc2_input_date_time_of_the_incident:
          doc2_input_date_time_of_the_incident ?? null,
        doc2_input_gas_quality_is_not_in_the_gas_quality_requirements:
          doc2_input_gas_quality_is_not_in_the_gas_quality_requirements ?? null,
        doc2_input_reason_the_gas_quality_requirements:
          doc2_input_reason_the_gas_quality_requirements ?? null,
        doc2_input_duration_that_is_expected_to_be_completed:
          doc2_input_duration_that_is_expected_to_be_completed ?? null,
        doc2_input_duration_of_the_gas_travel_to_various_points:
          doc2_input_duration_of_the_gas_travel_to_various_points ?? null,
        doc2_input_note: doc2_input_note ?? null,
        longdo_dict: longdo_dict ?? null,

        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      };

      const createEventDocument = await prisma.event_document.create({
        data: tsoCreate,
        include: {
          event_doc_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_file.createMany({
          data: fileData,
        });
      }

      await prisma.event_document_action.create({
        data: {
          event_document: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 2,
            },
          },
          input_note: doc2_input_note ?? null,
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      // shipper multi create
      for (let iShipper = 0; iShipper < (shipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ref_runnumber_flag: createEventDocument?.ref_runnumber_flag,
          ref_document: createEventDocument?.id,
          event_runnumber: {
            connect: {
              id: createEventRunnumber?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: shipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 2,
            },
          },
          doc2_input_delivery_point_at_the_scene:
            doc2_input_delivery_point_at_the_scene ?? null,
          doc2_input_date_time_of_the_incident:
            doc2_input_date_time_of_the_incident ?? null,
          doc2_input_gas_quality_is_not_in_the_gas_quality_requirements:
            doc2_input_gas_quality_is_not_in_the_gas_quality_requirements ||
            null,
          doc2_input_reason_the_gas_quality_requirements:
            doc2_input_reason_the_gas_quality_requirements ?? null,
          doc2_input_duration_that_is_expected_to_be_completed:
            doc2_input_duration_that_is_expected_to_be_completed ?? null,
          doc2_input_duration_of_the_gas_travel_to_various_points:
            doc2_input_duration_of_the_gas_travel_to_various_points ?? null,
          doc2_input_note: doc2_input_note ?? null,
          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper = await prisma.event_document.create({
          data: shipperCreate,
        });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_action.create({
          data: {
            event_document: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: shipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 2,
              },
            },
            input_note: doc2_input_note ?? null,
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }

      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_id: createEventDocument?.id,
          edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_id: createEventDocument?.id,
          email: cc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_cc_email.createMany({
          data: CcEmail,
        }));

      // email
      const emailUse = {
        shipper: shipper,
        emailGroup: email_event_for_shipper,
        ccEmail: cc_email,
      };

      return { createEventRunnumber, createEventDocument, emailUse };
    });

    const findOnce = await this.offspecGasOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // sendEmail
    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 2);

    return findOnce;
  }

  // email
  async doc2Edit(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { file, shipper, email_event_for_shipper, cc_email, event_date } =
      payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const getEventDocument = await prisma.event_document.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      // -----

      const tsoCreate = {
        doc2_input_delivery_point_at_the_scene:
          getEventDocument?.doc2_input_delivery_point_at_the_scene ?? null,
        doc2_input_date_time_of_the_incident:
          getEventDocument?.doc2_input_date_time_of_the_incident ?? null,
        doc2_input_gas_quality_is_not_in_the_gas_quality_requirements:
          getEventDocument?.doc2_input_gas_quality_is_not_in_the_gas_quality_requirements ||
          null,
        doc2_input_reason_the_gas_quality_requirements:
          getEventDocument?.doc2_input_reason_the_gas_quality_requirements ||
          null,
        doc2_input_duration_that_is_expected_to_be_completed:
          getEventDocument?.doc2_input_duration_that_is_expected_to_be_completed ||
          null,
        doc2_input_duration_of_the_gas_travel_to_various_points:
          getEventDocument?.doc2_input_duration_of_the_gas_travel_to_various_points ||
          null,
        doc2_input_note: getEventDocument?.doc2_input_note ?? null,
        longdo_dict: getEventDocument?.longdo_dict ?? null,
        event_date: getEventDocument?.event_date ?? null,

        // create_date: getTodayNowAdd7().toDate(),
        // create_date_num: getTodayNowAdd7().unix(),
        // create_by_account: {
        //   connect: {
        //     id: Number(userId),
        //   },
        // },
        update_date: getTodayNowAdd7().toDate(),
        update_date_num: getTodayNowAdd7().unix(),
        update_by: Number(userId),
      };

      const updateEventDocument = await prisma.event_document.updateMany({
        where: { id: getEventDocument?.id },
        data: tsoCreate,
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_id: Number(getEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_file.createMany({
          data: fileData,
        });
      }

      const getEventDocumentNew = await prisma.event_document.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber: {
            include: {
              event_document: true,
            },
          },
          event_document_email_group_for_event: {
            include: {
              edit_email_group_for_event: true,
            },
          },
          event_document_cc_email: true,
          group: true,
          user_type: true,

          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });
      // no event_document_action

      // shipper
      // email_event_for_shipper
      // cc_email

      console.log('getEventDocumentNew : ', getEventDocumentNew);
      const nshipper = [];
      for (let inshipper = 0; inshipper < shipper?.length; inshipper++) {
        const findShipper =
          getEventDocumentNew?.event_runnumber?.event_document?.find(
            (f: any) => {
              return (
                f?.group_id === shipper?.[inshipper] &&
                f?.event_doc_master_id === 2
              );
            },
          );
        if (!findShipper) {
          nshipper.push(shipper?.[inshipper]);
        }
      }
      const nemail_event_for_shipper = [];
      for (
        let inemail_event_for_shipper = 0;
        inemail_event_for_shipper < email_event_for_shipper?.length;
        inemail_event_for_shipper++
      ) {
        const findEmail_event_for_shipper =
          getEventDocumentNew?.event_document_email_group_for_event?.find(
            (f: any) => {
              return (
                f?.edit_email_group_for_event?.id ===
                email_event_for_shipper?.[inemail_event_for_shipper]
              );
            },
          );
        if (!findEmail_event_for_shipper) {
          nemail_event_for_shipper.push(
            email_event_for_shipper?.[inemail_event_for_shipper],
          );
        }
      }
      const ncc_email = [];
      for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
        const findCc_email = getEventDocumentNew?.event_document_cc_email?.find(
          (f: any) => {
            return f?.email === cc_email[incc_email];
          },
        );
        if (!findCc_email) {
          ncc_email.push(cc_email[incc_email]);
        }
      }

      // shipper multi create
      for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          ref_runnumber_flag: getEventDocumentNew?.ref_runnumber_flag,
          ref_document: getEventDocumentNew?.id,
          event_runnumber: {
            connect: {
              id: getEventDocumentNew?.event_runnumber_id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: nshipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 2,
            },
          },
          doc2_input_delivery_point_at_the_scene:
            getEventDocumentNew?.doc2_input_delivery_point_at_the_scene ?? null,
          doc2_input_date_time_of_the_incident:
            getEventDocumentNew?.doc2_input_date_time_of_the_incident ?? null,
          doc2_input_gas_quality_is_not_in_the_gas_quality_requirements:
            getEventDocumentNew?.doc2_input_gas_quality_is_not_in_the_gas_quality_requirements ||
            null,
          doc2_input_reason_the_gas_quality_requirements:
            getEventDocumentNew?.doc2_input_reason_the_gas_quality_requirements ||
            null,
          doc2_input_duration_that_is_expected_to_be_completed:
            getEventDocumentNew?.doc2_input_duration_that_is_expected_to_be_completed ||
            null,
          doc2_input_duration_of_the_gas_travel_to_various_points:
            getEventDocumentNew?.doc2_input_duration_of_the_gas_travel_to_various_points ||
            null,
          doc2_input_note: getEventDocumentNew?.doc2_input_note ?? null,
          longdo_dict: getEventDocumentNew?.longdo_dict ?? null,
          event_date: getEventDocumentNew?.event_date ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper = await prisma.event_document.create({
          data: shipperCreate,
        });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_action.create({
          data: {
            event_document: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: nshipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 2,
              },
            },
            input_note: getEventDocumentNew?.doc2_input_note ?? null,
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }

      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_id: getEventDocumentNew?.id,
          edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_id: getEventDocumentNew?.id,
          email: ncc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_cc_email.createMany({
          data: CcEmail,
        }));

      const emailUse = {
        shipper: nshipper,
        emailGroup: nemail_event_for_shipper,
        ccEmail: ncc_email,
      };

      return {
        createEventRunnumber: { id: getEventDocumentNew?.event_runnumber_id },
        getEventDocumentNew,
        emailUse,
      };
    });

    const findOnce = await this.offspecGasOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: result?.getEventDocumentNew?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 2);

    return findOnce;
  }

  async doc2Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document.findFirst({
            where: {
              event_runnumber_id: Number(id),
              event_doc_master_id: 2,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          })
        : await this.prisma.event_document.findFirst({
            where: {
              event_runnumber_id: Number(id),
              event_doc_master_id: 2,
              ref_document: null,
            },
            include: {
              event_runnumber: {
                include: {
                  event_status: true,
                  event_document: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 2,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_cc_email: true,
              event_document_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc2History(id: any, userId: any, tso: any) {
    const resData = await this.prisma.event_document_log_history.findMany({
      where: {
        ...(tso
          ? {
              event_document: {
                event_runnumber_id: Number(id),
                event_doc_master_id: 2,
              },
            }
          : {
              event_document_id: Number(id),
            }),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  // email
  async doc2Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_doc_status_id, doc2_input_note } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber.findFirst({
        where: {
          event_status_id: 2,
          event_document: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          doc2_input_note: doc2_input_note ?? null,
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_action.create({
        data: {
          event_document: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 2,
            },
          },
          input_note: doc2_input_note ?? null,
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber.findFirst({
        where: {
          event_document: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.offspecGasOnce(result?.eventRunId, userId);

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        event_runnumber: true,
        doc2_input_delivery_point_at_the_scene: true,
        doc2_input_date_time_of_the_incident: true,
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 3
        ? `Shipper ${docId?.group?.name} ตอบรับการแจ้งเหตุคุณภาพก๊าซนำเข้าไมอยู่ในข้อกำหนด`
        : event_doc_status_id === 4
          ? `Shipper ${docId?.group?.name} ปฏิเสธการแจ้งเหตุคุณภาพก๊าซนำเข้าไมอยู่ในข้อกำหนด`
          : ``;
    const subject =
      event_doc_status_id === 3
        ? `Events/Offspec Gas - Shipper Accept (Doc.2)`
        : event_doc_status_id === 4
          ? `Events/Offspec Gas - Shipper Reject (Doc.2)`
          : ``;

    const excelBuffer = await this.doc2PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber?.event_nember || ''}</li>
          <li>จุดที่ส่งเข้าที่เกิดเหตุ :  ${docId?.doc2_input_delivery_point_at_the_scene || ''}</li>
          <li>วัน/เวลาที่เกิดเหตุ :  ${docId?.doc2_input_date_time_of_the_incident || ''}</li>
        
        </ul>
      </div>
      `,
      filename: 'offspec_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  getPdfBuffer(docDefinition: any): Promise<Buffer> {
    return new Promise((resolve, reject) => {
      const pdfDocGenerator = pdfMake.createPdf(docDefinition);
      pdfDocGenerator.getBuffer((buffer: any) => {
        try {
          // แปลงให้เป็น Buffer (Node.js) แน่นอน
          const nodeBuffer = Buffer.from(buffer);
          resolve(nodeBuffer);
        } catch (err) {
          reject(err);
        }
      });
    });
  }

  async doc2PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber?.findFirst({
        where: { event_document: { some: { id: Number(id) } } },
      });

      const rdoc1Find = await this.doc2Find(
        findRunnumber?.id,
        userId,
        null,
        shipperIds,
      );
      console.log('rdoc1Find : ', rdoc1Find);

      const event_document_action = rdoc1Find?.event_document_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');
      const input_delivery_point_at_the_scene =
        rdoc1Find?.doc2_input_delivery_point_at_the_scene;
      const input_date_time_of_the_incident =
        rdoc1Find?.doc2_input_date_time_of_the_incident;
      const input_gas_quality_is_not_in_the_gas_quality_requirements =
        rdoc1Find?.doc2_input_gas_quality_is_not_in_the_gas_quality_requirements;
      const input_reason_the_gas_quality_requirements =
        rdoc1Find?.doc2_input_reason_the_gas_quality_requirements;
      const input_duration_that_is_expected_to_be_completed =
        rdoc1Find?.doc2_input_duration_that_is_expected_to_be_completed;
      const input_duration_of_the_gas_travel_to_various_points =
        rdoc1Find?.doc2_input_duration_of_the_gas_travel_to_various_points;
      const input_note = rdoc1Find?.doc2_input_note;

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งเตือนคุณภาพก๊าซฯ 2',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },
          {
            text: 'เอกสารแจ้งคุณภาพก๊าซผสม ไม่อยู่ในข้อกำหนดคุณภาพก๊าซ',
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'เรียน:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${group?.name}`,
                      // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ (ผู้ทำให้เกิดเหตุการณ์)',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        ul: [
                          {
                            text: [
                              'จุดส่งเข้าที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_delivery_point_at_the_scene ? input_delivery_point_at_the_scene : '_______________',
                                decoration: input_delivery_point_at_the_scene && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'เวลาที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_date_time_of_the_incident ? input_date_time_of_the_incident : '_______________',
                                decoration: input_date_time_of_the_incident && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'ประเภทและค่าของคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_gas_quality_is_not_in_the_gas_quality_requirements ? input_gas_quality_is_not_in_the_gas_quality_requirements : '_______________',
                                decoration: input_gas_quality_is_not_in_the_gas_quality_requirements && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_reason_the_gas_quality_requirements ? input_reason_the_gas_quality_requirements : '_______________',
                                decoration: input_reason_the_gas_quality_requirements && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'ระยะเวลาที่คาดว่าจะแก้ไขแล้วเสร็จ : ',
                              {
                                text: input_duration_that_is_expected_to_be_completed ? input_duration_that_is_expected_to_be_completed : '_______________',
                                decoration: input_duration_that_is_expected_to_be_completed && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'ระยะเวลาที่ก๊าซฯ เดินทางถึงจุดต่าง ๆ : ',
                              {
                                text: input_duration_of_the_gas_travel_to_various_points ? input_duration_of_the_gas_travel_to_various_points : '_______________',
                                decoration: input_duration_of_the_gas_travel_to_various_points && 'underline',
                              },
                            ],
                          },
                          // `จุดส่งเข้าที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_delivery_point_at_the_scene || '-'}`,
                          // `วัน/เวลาที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_date_time_of_the_incident || '-'}`,
                          // `ประเภทและค่าของคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_gas_quality_is_not_in_the_gas_quality_requirements || '-'}`,
                          // `สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_reason_the_gas_quality_requirements || '-'}`,
                          // `ระยะเวลาที่คาดว่าจะแก้ไขแล้วเสร็จ : ${input_duration_that_is_expected_to_be_completed || '-'}`,
                          // `ระยะเวลาที่ก๊าซฯ เดินทางถึงจุดต่าง ๆ : ${input_duration_of_the_gas_travel_to_various_points || '-'}`,
                        ],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วน" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              event_doc_status === 3 ? logoUsed : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [
                              { text: 'รับ ', bold: true },
                              'ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ',
                            ],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        margin: [0, 0, 0, 2],
                      },
                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              event_doc_status === 4 ? logoUsed : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [
                              { text: 'ปฏิเสธ ', bold: true },
                              'ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ (ระบุชื่อลูกค้าที่ไม่สามารถใช้ก๊าซฯ ดังกล่าว)',
                            ],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        margin: [0, 0, 0, 2],
                      },
                      // {
                      //   columns: [
                      //     {
                      //       width: 15,
                      //       image:
                      //         event_doc_status === 5 ? logoUsed : logoNotUsed, // แทนด้วย base64 string
                      //       verticalAlignment: 'middle',
                      //       alignment: 'center',
                      //       fit: [12, 12],
                      //     },
                      //     {
                      //       text: 'รับทราบ',
                      //       bold: true,
                      //       margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                      //       alignment: 'left',
                      //     },
                      //   ],
                      //   margin: [0, 0, 0, 2],
                      // },
                      {
                        // text: `หมายเหตุ: ${input_note || '-'}`,
                        text: [
                          'หมายเหตุ : ',
                          {
                            text: input_note ? input_note : '_______________',
                            decoration: input_note && 'underline',
                          },
                        ],
                        margin: [0, 5, 0, 2],
                      },
                      // {
                      //   text: 'สวัสดี...:',
                      //   margin: [0, 0, 0, 0],
                      //   // decoration: 'underline',
                      // },

                      // 'สวัสดี_______________________________________________________',
                      // '_______________________________________________________',
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // // https://app.clickup.com/t/86eug8bw8
                      fromSignature
                        ? {
                            columns: [
                              { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย ` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },

                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // // https://app.clickup.com/t/86eug8bw8
                      toSignature
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toFullname ? `( ${toFullname} )` : `(                                   )` },
                      // { text: `รับทราบโดย ${toFullname}` },
                      // toSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toCompany} (ผู้ใช้บริการ)`,
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
        },
      };

      // const pdfDocGenerator = pdfMake.createPdf(docDefinition);
      // pdfDocGenerator.getBuffer((buffer) => {
      //   res.setHeader('Content-Type', 'application/pdf');
      //   res.setHeader(
      //     'Content-Disposition',
      //     `attachment; filename=offspec_${group?.name}.pdf`,
      //   );
      //   res.end(buffer);
      // });

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      console.log('id : ', id);
      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      console.log('-----inputList ; ', inputList);
      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber?.findFirst({
          where: { event_document: { some: { id: Number(id) } } },
        });

        const rdoc1Find = await this.doc2Find(findRunnumber?.id, null, groups);
        console.log('- - - - -rdoc1Find : ', rdoc1Find);

        const event_document_action = rdoc1Find?.event_document_action;

        const toAction = event_document_action?.find(
          (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');
        const input_delivery_point_at_the_scene =
          rdoc1Find?.doc2_input_delivery_point_at_the_scene;
        const input_date_time_of_the_incident =
          rdoc1Find?.doc2_input_date_time_of_the_incident;
        const input_gas_quality_is_not_in_the_gas_quality_requirements =
          rdoc1Find?.doc2_input_gas_quality_is_not_in_the_gas_quality_requirements;
        const input_reason_the_gas_quality_requirements =
          rdoc1Find?.doc2_input_reason_the_gas_quality_requirements;
        const input_duration_that_is_expected_to_be_completed =
          rdoc1Find?.doc2_input_duration_that_is_expected_to_be_completed;
        const input_duration_of_the_gas_travel_to_various_points =
          rdoc1Find?.doc2_input_duration_of_the_gas_travel_to_various_points;
        const input_note = rdoc1Find?.doc2_input_note;

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งเตือนคุณภาพก๊าซฯ 2',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },
            {
              text: 'เอกสารแจ้งคุณภาพก๊าซผสม ไม่อยู่ในข้อกำหนดคุณภาพก๊าซ',
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'เรียน:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${groups?.name}`,
                        // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [`${longdo_dict || ''}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ (ผู้ทำให้เกิดเหตุการณ์)',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        ul: [
                          {
                            text: [
                              'จุดส่งเข้าที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_delivery_point_at_the_scene ? input_delivery_point_at_the_scene : '_______________',
                                decoration: input_delivery_point_at_the_scene && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'เวลาที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_date_time_of_the_incident ? input_date_time_of_the_incident : '_______________',
                                decoration: input_date_time_of_the_incident && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'ประเภทและค่าของคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_gas_quality_is_not_in_the_gas_quality_requirements ? input_gas_quality_is_not_in_the_gas_quality_requirements : '_______________',
                                decoration: input_gas_quality_is_not_in_the_gas_quality_requirements && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ : ',
                              {
                                text: input_reason_the_gas_quality_requirements ? input_reason_the_gas_quality_requirements : '_______________',
                                decoration: input_reason_the_gas_quality_requirements && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'ระยะเวลาที่คาดว่าจะแก้ไขแล้วเสร็จ : ',
                              {
                                text: input_duration_that_is_expected_to_be_completed ? input_duration_that_is_expected_to_be_completed : '_______________',
                                decoration: input_duration_that_is_expected_to_be_completed && 'underline',
                              },
                            ],
                          },
                          {
                            text: [
                              'ระยะเวลาที่ก๊าซฯ เดินทางถึงจุดต่าง ๆ : ',
                              {
                                text: input_duration_of_the_gas_travel_to_various_points ? input_duration_of_the_gas_travel_to_various_points : '_______________',
                                decoration: input_duration_of_the_gas_travel_to_various_points && 'underline',
                              },
                            ],
                          },
                          // `จุดส่งเข้าที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_delivery_point_at_the_scene || '-'}`,
                          // `วัน/เวลาที่ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_date_time_of_the_incident || '-'}`,
                          // `ประเภทและค่าของคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_gas_quality_is_not_in_the_gas_quality_requirements || '-'}`,
                          // `สาเหตุที่ทำให้ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ: ${input_reason_the_gas_quality_requirements || '-'}`,
                          // `ระยะเวลาที่คาดว่าจะแก้ไขแล้วเสร็จ : ${input_duration_that_is_expected_to_be_completed || '-'}`,
                          // `ระยะเวลาที่ก๊าซฯ เดินทางถึงจุดต่าง ๆ : ${input_duration_of_the_gas_travel_to_various_points || '-'}`,
                        ],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วน" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              event_doc_status === 3 ? logoUsed : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [
                              { text: 'รับ ', bold: true },
                              'ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ',
                            ],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        margin: [0, 0, 0, 2],
                      },
                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              event_doc_status === 4 ? logoUsed : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [
                              { text: 'ปฏิเสธ ', bold: true },
                              'ก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ (ระบุชื่อลูกค้าที่ไม่สามารถใช้ก๊าซฯ ดังกล่าว)',
                            ],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        margin: [0, 0, 0, 2],
                      },
                      // {
                      //   columns: [
                      //     {
                      //       width: 15,
                      //       image:
                      //         event_doc_status === 5 ? logoUsed : logoNotUsed, // แทนด้วย base64 string
                      //       verticalAlignment: 'middle',
                      //       alignment: 'center',
                      //       fit: [12, 12],
                      //     },
                      //     {
                      //       text: 'รับทราบ',
                      //       bold: true,
                      //       margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                      //       alignment: 'left',
                      //     },
                      //   ],
                      //   margin: [0, 0, 0, 2],
                      // },
                      {
                        // text: `หมายเหตุ: ${input_note || '-'}`,
                        text: [
                          'หมายเหตุ : ',
                          {
                            text: input_note ? input_note : '_______________',
                            decoration: input_note && 'underline',
                          },
                        ],
                        margin: [0, 5, 0, 2],
                      },
                      // {
                      //   text: 'สวัสดี...:',
                      //   margin: [0, 0, 0, 0],
                      //   // decoration: 'underline',
                      // },

                      // 'สวัสดี_______________________________________________________',
                      // '_______________________________________________________',
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

            // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // // https://app.clickup.com/t/86eug8bw8
                      fromSignature
                        ? {
                            columns: [
                              { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย ` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },

                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // // https://app.clickup.com/t/86eug8bw8
                      toSignature
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toFullname ? `( ${toFullname} )` : `(                                   )` },
                      // { text: `รับทราบโดย ${toFullname}` },
                      // toSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toCompany} (ผู้ใช้บริการ)`,
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
          },
        };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }

      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // doc 3

  async doc3EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc3RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber.findMany({
      where: {
        event_document: {
          none: {
            event_doc_master: {
              id: 3,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc3Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    // const filtered = resDoc.filter(
    //   (item) =>
    //     !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    // );

    return resDoc;
  }

  // email userTypeId
  async doc3Create(payload: any, userId: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,
      ref_document,
      longdo_dict,

      doc3_input_shipper_doc_number, // doc3 ผู้ใช้ เอกสารเลขที่
      doc3_input_shipper_doc_quality, // doc3 ผู้ใช้ เอกสารแจ้งเตือนคุณภาพ
      doc3_input_shipper_down_date, // doc3 ผู้ใช้ ลงวันที่
      doc3_input_shipper_time_event_start_date, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ เริ่ม วัน
      doc3_input_shipper_time_event_start_time, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ เริ่ม เวลา
      doc3_input_shipper_time_event_end_date, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ ถึง วัน
      doc3_input_shipper_time_event_end_time, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ ถึง เวลา
      doc3_input_shipper_time_event_summary, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ สรุปการแก้ไข
      doc3_input_tso_doc_number, // doc3 ผู้ให้ เอกสารเลขที่
      doc3_input_tso_down_date, // doc3 ผู้ให้ ลงวันที่
      doc3_input_tso_disapeared_date, // doc3 ผู้ให้ โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจากระบบก๊าซฯ เมื่อวันที่ วัน
      doc3_input_tso_disapeared_time, // doc3 ผู้ให้ โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจากระบบก๊าซฯ เมื่อวันที่ เวลา

      doc3_input_notifyby,
      doc3_input_shipper_cpn_name,

      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      //
    } = payload;

    const checkDocrun =
      ref_document &&
      (await this.prisma.event_document.findFirst({
        where: {
          event_doc_master_id: 3,
          event_runnumber_id: Number(ref_document),
        },
      }));
    if (checkDocrun) {
      throw new HttpException(
        {
          status: HttpStatus.BAD_REQUEST,
          error: 'Event Document used Ref.',
        },
        HttpStatus.BAD_REQUEST,
      );
    }

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;
      console.log('userTypeId : ', userTypeId);
      console.log('groupId : ', groupId);

      if (userTypeId !== 2 && userTypeId !== 3) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }
      // userTypeId 2 tso , 3 shipper

      const createEventRunnumber = await prisma.event_runnumber.findFirst({
        where: {
          id: Number(ref_document),
        },
        include: {
          event_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      const useCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        longdo_dict: longdo_dict ?? null,
        event_runnumber: {
          connect: {
            id: createEventRunnumber?.id,
          },
        },
        event_doc_status: {
          connect: {
            id: userTypeId === 2 ? 2 : 1,
          },
        },
        group: {
          connect: {
            id: groupId,
          },
        },
        user_type: {
          connect: {
            id: userTypeId,
          },
        },
        event_doc_master: {
          connect: {
            id: 3,
          },
        },
        doc3_input_shipper_doc_number: doc3_input_shipper_doc_number ?? null,
        doc3_input_shipper_doc_quality: doc3_input_shipper_doc_quality ?? null,
        doc3_input_shipper_down_date:
          (doc3_input_shipper_down_date &&
            getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
          null,
        doc3_input_shipper_time_event_start_date:
          (doc3_input_shipper_time_event_start_date &&
            getTodayNowAdd7(
              doc3_input_shipper_time_event_start_date,
            ).toDate()) ||
          null,
        doc3_input_shipper_time_event_start_time:
          doc3_input_shipper_time_event_start_time ?? null,
        doc3_input_shipper_time_event_end_date:
          (doc3_input_shipper_time_event_end_date &&
            getTodayNowAdd7(doc3_input_shipper_time_event_end_date).toDate()) ||
          null,
        doc3_input_shipper_time_event_end_time:
          doc3_input_shipper_time_event_end_time ?? null,
        doc3_input_shipper_time_event_summary:
          doc3_input_shipper_time_event_summary ?? null,
        doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
        doc3_input_tso_down_date:
          (doc3_input_tso_down_date &&
            getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
          null,
        doc3_input_tso_disapeared_date:
          (doc3_input_tso_disapeared_date &&
            getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
          null,
        doc3_input_tso_disapeared_time: doc3_input_tso_disapeared_time ?? null,
        doc3_input_notifyby: doc3_input_notifyby ?? null,
        doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,

        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      };

      const createEventDocument = await prisma.event_document.create({
        data: useCreate,
        include: {
          event_doc_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_file.createMany({
          data: fileData,
        });
      }

      await prisma.event_document_action.create({
        data: {
          event_document: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: userTypeId === 2 ? 2 : 1,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 3,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      if (userTypeId === 2) {
        // shipper multi create
        for (let iShipper = 0; iShipper < (shipper?.length ?? 0); iShipper++) {
          //
          const shipperCreate = {
            event_date: getTodayNowAdd7(event_date).toDate(),
            ref_document: createEventDocument?.id,
            event_runnumber: {
              connect: {
                id: createEventRunnumber?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: shipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 3,
              },
            },
            longdo_dict: longdo_dict ?? null,

            doc3_input_shipper_doc_number:
              doc3_input_shipper_doc_number ?? null,
            doc3_input_shipper_doc_quality:
              doc3_input_shipper_doc_quality ?? null,
            doc3_input_shipper_down_date:
              (doc3_input_shipper_down_date &&
                getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_date:
              (doc3_input_shipper_time_event_start_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_start_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_time:
              doc3_input_shipper_time_event_start_time ?? null,
            doc3_input_shipper_time_event_end_date:
              (doc3_input_shipper_time_event_end_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_end_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_end_time:
              doc3_input_shipper_time_event_end_time ?? null,
            doc3_input_shipper_time_event_summary:
              doc3_input_shipper_time_event_summary ?? null,
            doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
            doc3_input_tso_down_date:
              (doc3_input_tso_down_date &&
                getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_date:
              (doc3_input_tso_disapeared_date &&
                getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_time:
              doc3_input_tso_disapeared_time ?? null,
            doc3_input_notifyby: doc3_input_notifyby ?? null,
            doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,

            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          };

          const createEventDocumentShipper = await prisma.event_document.create(
            {
              data: shipperCreate,
            },
          );

          if (file && file.length > 0) {
            const fileData = file?.map((fileItem: any) => {
              return {
                url: fileItem,
                event_document_id: Number(createEventDocumentShipper?.id),
                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by: Number(userId),
              };
            });
            await prisma.event_document_file.createMany({
              data: fileData,
            });
          }

          await prisma.event_document_action.create({
            data: {
              event_document: {
                connect: {
                  id: createEventDocumentShipper?.id,
                },
              },
              event_doc_status: {
                connect: {
                  id: 2,
                },
              },
              group: {
                connect: {
                  id: shipper?.[iShipper],
                },
              },
              user_type: {
                connect: {
                  id: 3,
                },
              },
              event_doc_master: {
                connect: {
                  id: 3,
                },
              },
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by_account: {
                connect: {
                  id: Number(userId),
                },
              },
            },
          });
        }

        // email_event_for_shipper
        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_id: createEventDocument?.id,
            edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_id: createEventDocument?.id,
            email: cc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_cc_email.createMany({
            data: CcEmail,
          }));
      }

      // email
      const emailUse = {
        shipper: shipper,
        emailGroup: email_event_for_shipper,
        ccEmail: cc_email,
      };

      return { createEventRunnumber, createEventDocument, emailUse };
    });

    const findOnce = await this.offspecGasOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    group.user_type?.id === 2 &&
      (await this.sendEmailCondition(result?.emailUse, findOnce, payload, 3));

    return findOnce;
  }

  async doc3Edit(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,
      longdo_dict,

      doc3_input_shipper_doc_number, // doc3 ผู้ใช้ เอกสารเลขที่
      doc3_input_shipper_doc_quality, // doc3 ผู้ใช้ เอกสารแจ้งเตือนคุณภาพ
      doc3_input_shipper_down_date, // doc3 ผู้ใช้ ลงวันที่
      doc3_input_shipper_time_event_start_date, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ เริ่ม วัน
      doc3_input_shipper_time_event_start_time, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ เริ่ม เวลา
      doc3_input_shipper_time_event_end_date, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ ถึง วัน
      doc3_input_shipper_time_event_end_time, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ ถึง เวลา
      doc3_input_shipper_time_event_summary, // doc3 ผู้ใช้ ช่วงเวลาของเหตุการณ์ สรุปการแก้ไข
      doc3_input_tso_doc_number, // doc3 ผู้ให้ เอกสารเลขที่
      doc3_input_tso_down_date, // doc3 ผู้ให้ ลงวันที่
      doc3_input_tso_disapeared_date, // doc3 ผู้ให้ โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจากระบบก๊าซฯ เมื่อวันที่ วัน
      doc3_input_tso_disapeared_time, // doc3 ผู้ให้ โดยก๊าซที่ไม่อยู่ในกำหนด TSO Code ได้หมดไปจากระบบก๊าซฯ เมื่อวันที่ เวลา
      doc3_input_notifyby,
      doc3_input_shipper_cpn_name,
      file,
      shipper,
      email_event_for_shipper,
      cc_email,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      let getEventDocument = await prisma.event_document.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber: {
            include: {
              event_document: true,
            },
          },
          event_document_email_group_for_event: {
            include: {
              edit_email_group_for_event: true,
            },
          },
          event_document_cc_email: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      if (getEventDocument?.event_doc_status_id === 1) {
        const tsoCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          longdo_dict: longdo_dict ?? null,
          event_runnumber: {
            connect: {
              id: getEventDocument?.event_runnumber_id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 3,
            },
          },
          doc3_input_shipper_doc_number: doc3_input_shipper_doc_number ?? null,
          doc3_input_shipper_doc_quality:
            doc3_input_shipper_doc_quality ?? null,
          doc3_input_shipper_down_date:
            (doc3_input_shipper_down_date &&
              getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
            null,
          doc3_input_shipper_time_event_start_date:
            (doc3_input_shipper_time_event_start_date &&
              getTodayNowAdd7(
                doc3_input_shipper_time_event_start_date,
              ).toDate()) ||
            null,
          doc3_input_shipper_time_event_start_time:
            doc3_input_shipper_time_event_start_time ?? null,
          doc3_input_shipper_time_event_end_date:
            (doc3_input_shipper_time_event_end_date &&
              getTodayNowAdd7(
                doc3_input_shipper_time_event_end_date,
              ).toDate()) ||
            null,
          doc3_input_shipper_time_event_end_time:
            doc3_input_shipper_time_event_end_time ?? null,
          doc3_input_shipper_time_event_summary:
            doc3_input_shipper_time_event_summary ?? null,
          doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
          doc3_input_tso_down_date:
            (doc3_input_tso_down_date &&
              getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
            null,
          doc3_input_tso_disapeared_date:
            (doc3_input_tso_disapeared_date &&
              getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
            null,
          doc3_input_tso_disapeared_time:
            doc3_input_tso_disapeared_time ?? null,
          doc3_input_notifyby: doc3_input_notifyby ?? null,
          doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentTSO = await prisma.event_document.create({
          data: tsoCreate,
          include: {
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
        });
        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_id: Number(createEventDocumentTSO?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_action.create({
          data: {
            event_document: {
              connect: {
                id: createEventDocumentTSO?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: groupId,
              },
            },
            user_type: {
              connect: {
                id: userTypeId,
              },
            },
            event_doc_master: {
              connect: {
                id: 3,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        // --- up shipper

        const updateEventDocument = await prisma.event_document.update({
          where: { id: getEventDocument?.id },
          data: {
            ref_document: createEventDocumentTSO?.id,
            event_doc_status_id: 2,
            update_date: getTodayNowAdd7().toDate(),
            update_date_num: getTodayNowAdd7().unix(),
            update_by: Number(userId),
            doc3_input_shipper_doc_number:
              doc3_input_shipper_doc_number ?? null,
            doc3_input_shipper_doc_quality:
              doc3_input_shipper_doc_quality ?? null,
            doc3_input_shipper_down_date:
              (doc3_input_shipper_down_date &&
                getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_date:
              (doc3_input_shipper_time_event_start_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_start_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_time:
              doc3_input_shipper_time_event_start_time ?? null,
            doc3_input_shipper_time_event_end_date:
              (doc3_input_shipper_time_event_end_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_end_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_end_time:
              doc3_input_shipper_time_event_end_time ?? null,
            doc3_input_shipper_time_event_summary:
              doc3_input_shipper_time_event_summary ?? null,
            doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
            doc3_input_tso_down_date:
              (doc3_input_tso_down_date &&
                getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_date:
              (doc3_input_tso_disapeared_date &&
                getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_time:
              doc3_input_tso_disapeared_time ?? null,
            event_date: getTodayNowAdd7(event_date).toDate(),
            longdo_dict: longdo_dict ?? null,
            doc3_input_notifyby: doc3_input_notifyby ?? null,
            doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,
          },
        });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_id: Number(getEventDocument?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_file.createMany({
            data: fileData,
          });
        }
        const findOnceShipper = await this.offspecGasOnce(
          getEventDocument?.event_runnumber_id,
          getEventDocument?.create_by,
        );

        await prisma.event_document_log_history.create({
          data: {
            temp: JSON.stringify(findOnceShipper),
            group: {
              connect: {
                id: findOnceShipper?.group_id,
              },
            },
            user_type: {
              connect: {
                id: findOnceShipper?.user_type_id,
              },
            },
            event_document: {
              connect: {
                id: createEventDocumentTSO?.id,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        //
        getEventDocument = await prisma.event_document.findFirst({
          where: {
            id: Number(createEventDocumentTSO?.id),
          },
          include: {
            event_runnumber: {
              include: {
                event_document: true,
              },
            },
            event_document_email_group_for_event: {
              include: {
                edit_email_group_for_event: true,
              },
            },
            event_document_cc_email: true,
            group: true,
            user_type: true,

            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
        });

        const nshipper = [];
        for (let inshipper = 0; inshipper < shipper?.length; inshipper++) {
          const findShipper =
            getEventDocument?.event_runnumber?.event_document?.find(
              (f: any) => {
                return (
                  f?.group_id === shipper?.[inshipper] &&
                  f?.event_doc_master_id === 3
                );
              },
            );
          if (!findShipper) {
            nshipper.push(shipper?.[inshipper]);
          }
        }
        const nemail_event_for_shipper = [];
        for (
          let inemail_event_for_shipper = 0;
          inemail_event_for_shipper < email_event_for_shipper?.length;
          inemail_event_for_shipper++
        ) {
          const findEmail_event_for_shipper =
            getEventDocument?.event_document_email_group_for_event?.find(
              (f: any) => {
                return (
                  f?.edit_email_group_for_event?.id ===
                  email_event_for_shipper?.[inemail_event_for_shipper]
                );
              },
            );
          if (!findEmail_event_for_shipper) {
            nemail_event_for_shipper.push(
              email_event_for_shipper?.[inemail_event_for_shipper],
            );
          }
        }
        console.log(
          'getEventDocument?.event_document_email_group_for_event ; ',
          getEventDocument?.event_document_email_group_for_event,
        );
        console.log('email_event_for_shipper ; ', email_event_for_shipper);
        console.log('nemail_event_for_shipper ; ', nemail_event_for_shipper);
        const ncc_email = [];
        for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
          const findCc_email = getEventDocument?.event_document_cc_email?.find(
            (f: any) => {
              return f?.email === cc_email[incc_email];
            },
          );
          if (!findCc_email) {
            ncc_email.push(cc_email[incc_email]);
          }
        }

        // shipper multi create
        for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
          //
          const shipperCreate = {
            event_date: getTodayNowAdd7(event_date).toDate(),
            ref_document: getEventDocument?.id,
            event_runnumber: {
              connect: {
                id: getEventDocument?.event_runnumber_id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: nshipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 3,
              },
            },

            longdo_dict: longdo_dict ?? null,
            doc3_input_shipper_doc_number:
              doc3_input_shipper_doc_number ?? null,
            doc3_input_shipper_doc_quality:
              doc3_input_shipper_doc_quality ?? null,
            doc3_input_shipper_down_date:
              (doc3_input_shipper_down_date &&
                getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_date:
              (doc3_input_shipper_time_event_start_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_start_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_time:
              doc3_input_shipper_time_event_start_time ?? null,
            doc3_input_shipper_time_event_end_date:
              (doc3_input_shipper_time_event_end_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_end_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_end_time:
              doc3_input_shipper_time_event_end_time ?? null,
            doc3_input_shipper_time_event_summary:
              doc3_input_shipper_time_event_summary ?? null,
            doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
            doc3_input_tso_down_date:
              (doc3_input_tso_down_date &&
                getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_date:
              (doc3_input_tso_disapeared_date &&
                getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_time:
              doc3_input_tso_disapeared_time ?? null,
            doc3_input_notifyby: doc3_input_notifyby ?? null,
            doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,

            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          };

          const createEventDocumentShipper = await prisma.event_document.create(
            {
              data: shipperCreate,
            },
          );

          if (file && file.length > 0) {
            const fileData = file?.map((fileItem: any) => {
              return {
                url: fileItem,
                event_document_id: Number(createEventDocumentShipper?.id),
                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by: Number(userId),
              };
            });
            await prisma.event_document_file.createMany({
              data: fileData,
            });
          }

          await prisma.event_document_action.create({
            data: {
              event_document: {
                connect: {
                  id: createEventDocumentShipper?.id,
                },
              },
              event_doc_status: {
                connect: {
                  id: 2,
                },
              },
              group: {
                connect: {
                  id: nshipper?.[iShipper],
                },
              },
              user_type: {
                connect: {
                  id: 3,
                },
              },
              event_doc_master: {
                connect: {
                  id: 3,
                },
              },
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by_account: {
                connect: {
                  id: Number(userId),
                },
              },
            },
          });
        }

        // email_event_for_shipper
        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_id: getEventDocument?.id,
            edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_id: getEventDocument?.id,
            email: ncc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_cc_email.createMany({
            data: CcEmail,
          }));

        const findOnce = await this.offspecGasOnce(
          getEventDocument?.event_runnumber_id,
          userId,
        );

        await prisma.event_document_log_history.create({
          data: {
            temp: JSON.stringify(findOnce),
            group: {
              connect: {
                id: findOnce?.group_id,
              },
            },
            user_type: {
              connect: {
                id: findOnce?.user_type_id,
              },
            },
            event_document: {
              connect: {
                id: getEventDocument?.id,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        const emailUse = {
          shipper: nshipper,
          emailGroup: nemail_event_for_shipper,
          ccEmail: ncc_email,
        };

        return { findOnce, emailUse };
      } else {
        // tso edit ปกติ

        const useCreate = {
          doc3_input_shipper_doc_number: doc3_input_shipper_doc_number ?? null,
          doc3_input_shipper_doc_quality:
            doc3_input_shipper_doc_quality ?? null,
          doc3_input_shipper_down_date:
            (doc3_input_shipper_down_date &&
              getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
            null,
          doc3_input_shipper_time_event_start_date:
            (doc3_input_shipper_time_event_start_date &&
              getTodayNowAdd7(
                doc3_input_shipper_time_event_start_date,
              ).toDate()) ||
            null,
          doc3_input_shipper_time_event_start_time:
            doc3_input_shipper_time_event_start_time ?? null,
          doc3_input_shipper_time_event_end_date:
            (doc3_input_shipper_time_event_end_date &&
              getTodayNowAdd7(
                doc3_input_shipper_time_event_end_date,
              ).toDate()) ||
            null,
          doc3_input_shipper_time_event_end_time:
            doc3_input_shipper_time_event_end_time ?? null,
          doc3_input_shipper_time_event_summary:
            doc3_input_shipper_time_event_summary ?? null,
          doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
          doc3_input_tso_down_date:
            (doc3_input_tso_down_date &&
              getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
            null,
          doc3_input_tso_disapeared_date:
            (doc3_input_tso_disapeared_date &&
              getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
            null,
          doc3_input_tso_disapeared_time:
            doc3_input_tso_disapeared_time ?? null,
          event_date: getTodayNowAdd7(event_date).toDate(),
          longdo_dict: longdo_dict ?? null,
          doc3_input_notifyby: doc3_input_notifyby ?? null,
          doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,

          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        };

        const updateEventDocument = await prisma.event_document.updateMany({
          where: { id: getEventDocument?.id },
          data: useCreate,
        });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_id: Number(getEventDocument?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_file.createMany({
            data: fileData,
          });
        }

        getEventDocument = await prisma.event_document.findFirst({
          where: {
            id: Number(id),
          },
          include: {
            event_runnumber: {
              include: {
                event_document: true,
              },
            },
            event_document_email_group_for_event: {
              include: {
                edit_email_group_for_event: true,
              },
            },
            event_document_cc_email: true,
            group: true,
            user_type: true,

            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
        });

        const nshipper = [];
        for (let inshipper = 0; inshipper < shipper?.length; inshipper++) {
          const findShipper =
            getEventDocument?.event_runnumber?.event_document?.find(
              (f: any) => {
                return (
                  f?.group_id === shipper?.[inshipper] &&
                  f?.event_doc_master_id === 3
                );
              },
            );
          if (!findShipper) {
            nshipper.push(shipper?.[inshipper]);
          }
        }
        const nemail_event_for_shipper = [];
        for (
          let inemail_event_for_shipper = 0;
          inemail_event_for_shipper < email_event_for_shipper?.length;
          inemail_event_for_shipper++
        ) {
          const findEmail_event_for_shipper =
            getEventDocument?.event_document_email_group_for_event?.find(
              (f: any) => {
                return (
                  f?.edit_email_group_for_event?.id ===
                  email_event_for_shipper?.[inemail_event_for_shipper]
                );
              },
            );
          if (!findEmail_event_for_shipper) {
            nemail_event_for_shipper.push(
              email_event_for_shipper?.[inemail_event_for_shipper],
            );
          }
        }
        const ncc_email = [];
        for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
          const findCc_email = getEventDocument?.event_document_cc_email?.find(
            (f: any) => {
              return f?.email === cc_email[incc_email];
            },
          );
          if (!findCc_email) {
            ncc_email.push(cc_email[incc_email]);
          }
        }

        // shipper multi create
        for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
          //
          const shipperCreate = {
            event_date: getTodayNowAdd7(event_date).toDate(),
            ref_document: getEventDocument?.id,
            event_runnumber: {
              connect: {
                id: getEventDocument?.event_runnumber_id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: nshipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 3,
              },
            },

            longdo_dict: longdo_dict ?? null,
            doc3_input_shipper_doc_number:
              doc3_input_shipper_doc_number ?? null,
            doc3_input_shipper_doc_quality:
              doc3_input_shipper_doc_quality ?? null,
            doc3_input_shipper_down_date:
              (doc3_input_shipper_down_date &&
                getTodayNowAdd7(doc3_input_shipper_down_date).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_date:
              (doc3_input_shipper_time_event_start_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_start_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_start_time:
              doc3_input_shipper_time_event_start_time ?? null,
            doc3_input_shipper_time_event_end_date:
              (doc3_input_shipper_time_event_end_date &&
                getTodayNowAdd7(
                  doc3_input_shipper_time_event_end_date,
                ).toDate()) ||
              null,
            doc3_input_shipper_time_event_end_time:
              doc3_input_shipper_time_event_end_time ?? null,
            doc3_input_shipper_time_event_summary:
              doc3_input_shipper_time_event_summary ?? null,
            doc3_input_tso_doc_number: doc3_input_tso_doc_number ?? null,
            doc3_input_tso_down_date:
              (doc3_input_tso_down_date &&
                getTodayNowAdd7(doc3_input_tso_down_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_date:
              (doc3_input_tso_disapeared_date &&
                getTodayNowAdd7(doc3_input_tso_disapeared_date).toDate()) ||
              null,
            doc3_input_tso_disapeared_time:
              doc3_input_tso_disapeared_time ?? null,
            doc3_input_notifyby: doc3_input_notifyby ?? null,
            doc3_input_shipper_cpn_name: doc3_input_shipper_cpn_name ?? null,

            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          };

          const createEventDocumentShipper = await prisma.event_document.create(
            {
              data: shipperCreate,
            },
          );

          if (file && file.length > 0) {
            const fileData = file?.map((fileItem: any) => {
              return {
                url: fileItem,
                event_document_id: Number(createEventDocumentShipper?.id),
                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by: Number(userId),
              };
            });
            await prisma.event_document_file.createMany({
              data: fileData,
            });
          }

          await prisma.event_document_action.create({
            data: {
              event_document: {
                connect: {
                  id: createEventDocumentShipper?.id,
                },
              },
              event_doc_status: {
                connect: {
                  id: 2,
                },
              },
              group: {
                connect: {
                  id: nshipper?.[iShipper],
                },
              },
              user_type: {
                connect: {
                  id: 3,
                },
              },
              event_doc_master: {
                connect: {
                  id: 3,
                },
              },
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by_account: {
                connect: {
                  id: Number(userId),
                },
              },
            },
          });
        }

        // email_event_for_shipper
        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_id: getEventDocument?.id,
            edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_id: getEventDocument?.id,
            email: ncc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_cc_email.createMany({
            data: CcEmail,
          }));

        const findOnce = await this.offspecGasOnce(
          getEventDocument?.event_runnumber_id,
          userId,
        );

        await prisma.event_document_log_history.create({
          data: {
            temp: JSON.stringify(findOnce),
            group: {
              connect: {
                id: findOnce?.group_id,
              },
            },
            user_type: {
              connect: {
                id: findOnce?.user_type_id,
              },
            },
            event_document: {
              connect: {
                id: getEventDocument?.id,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        const emailUse = {
          shipper: nshipper,
          emailGroup: nemail_event_for_shipper,
          ccEmail: ncc_email,
        };

        return { findOnce, emailUse };
      }
    });

    // await this.sendEmailCondition(result?.emailUse, findOnce, payload, 3);
    await this.sendEmailCondition(
      result?.emailUse,
      result?.findOnce,
      payload,
      3,
    );

    return result?.findOnce;
  }

  async doc3Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('userId : ', userId);
    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;

    const userTypeId = group.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document.findFirst({
            where: {
              event_runnumber_id: Number(id),
              event_doc_master_id: 3,
              // ref_document: {
              //   not: null,
              // },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber: {
                include: {
                  event_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature_base_64: true,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                  account_manage: {
                    include: {
                      group: true,
                    },
                  },
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          })
        : await this.prisma.event_document.findFirst({
            where: {
              event_runnumber_id: Number(id),
              event_doc_master_id: 3,
              ref_document: null,
            },
            include: {
              event_runnumber: {
                include: {
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature_base_64: true,
                    },
                  },
                  event_status: true,
                  event_document: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 3,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_cc_email: true,
              event_document_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                  account_manage: {
                    include: {
                      group: true,
                    },
                  },
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc3History(id: any, userId: any, tso: any) {
    const resData = await this.prisma.event_document_log_history.findMany({
      where: {
        ...(tso
          ? {
              event_document: {
                event_runnumber_id: Number(id),
                event_doc_master_id: 3,
              },
            }
          : {
              event_document_id: Number(id),
            }),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  // email
  async doc3Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_doc_status_id, doc2_input_note } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber.findFirst({
        where: {
          event_status_id: 2,
          event_document: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_action.create({
        data: {
          event_document: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 3,
            },
          },
          input_note: doc2_input_note ?? null,
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber.findFirst({
        where: {
          event_document: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.offspecGasOnce(result?.eventRunId, userId);

    await this.prisma.event_document_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        event_runnumber: true,
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบคุณภาพก๊าซหรือปริมาณก๊าซนำเข้ากลับเป็นปกติ`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/Offspec Gas - Shipper Accept (Doc.3)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber?.event_nember || ''}</li>
        
        </ul>
      </div>
      `,
      filename: 'offspec_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc3PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;
    // console.log('shipperIds : ', shipperIds);
    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: Number(shipperIds),
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });

    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);
    console.log('group : ', group);
    const userTypeId = group.user_type?.id;
    const groupId = group?.id;
    // userId tso ไว้ก่อน
    if (userTypeId === 3) {
        // {
        //                   text: [
        //                     'หมายเหตุ : ',
        //                     {
        //                       text:
        //                         input_note ? input_note : '____________',
        //                       decoration: input_note && 'underline',
        //                     },
        //                   ],
        //               margin: [0, 5, 0, 2],
        //             },
      const findRunnumber = await this.prisma.event_runnumber?.findFirst({
        where: { event_document: { some: { id: Number(id) } } },
      });

      const rdoc1Find = await this.doc3Find(
        findRunnumber?.id,
        userId,
        null,
        shipperIds,
      );
      console.log('rdoc1Find : ', rdoc1Find);

      const event_document_action = rdoc1Find?.event_document_action;

      const toAction = event_document_action?.find(
        (f: any) =>
          f?.user_type_id === 3 &&
          f?.group_id === groupId &&
          f?.event_doc_status_id !== 2,
      );
      console.log('toAction : ', toAction);
      const toGroupName = toAction?.group?.name || "";

      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) || "";
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      console.log('event_runnumber : ', rdoc1Find?.event_runnumber);
      console.log('rdoc1Find : ', rdoc1Find);

      // ---- create runnumber
      const fromFullnameH =
        (rdoc1Find?.create_by_account?.account_manage?.[0].group?.name &&
          rdoc1Find?.create_by_account?.account_manage?.[0].group?.name) ||
        '';
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany =
        rdoc1Find?.user_type_id !== 3
          ? 'บริษัท ปตท.จำกัด (มหาชน)'
          : rdoc1Find?.group?.company_name || '';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_shipper_doc_number =
        rdoc1Find?.doc3_input_shipper_doc_number;
      const input_shipper_doc_quality =
        rdoc1Find?.doc3_input_shipper_doc_quality;
      const input_shipper_down_date =
        (rdoc1Find?.doc3_input_shipper_down_date &&
          `${dayjs(rdoc1Find?.doc3_input_shipper_down_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_shipper_down_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc3_input_shipper_down_date).locale('th').format('BBBB')}`);
      const input_shipper_time_event_end_date =
        (rdoc1Find?.doc3_input_shipper_time_event_end_date &&
          `${dayjs(rdoc1Find?.doc3_input_shipper_time_event_end_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_end_date).locale('th').format('MMM')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_end_date).locale('th').format('BBBB')}`);
      const input_shipper_time_event_end_time =
        rdoc1Find?.doc3_input_shipper_time_event_end_time;
      const input_shipper_time_event_start_date =
        (rdoc1Find?.doc3_input_shipper_time_event_start_date &&
          `${dayjs(rdoc1Find?.doc3_input_shipper_time_event_start_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_start_date).locale('th').format('MMM')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_start_date).locale('th').format('BBBB')}`);
      const input_shipper_time_event_start_time =
        rdoc1Find?.doc3_input_shipper_time_event_start_time;
      const input_shipper_time_event_summary =
        rdoc1Find?.doc3_input_shipper_time_event_summary;
      const input_tso_disapeared_date =
        (rdoc1Find?.doc3_input_tso_disapeared_date &&
          `${dayjs(rdoc1Find?.doc3_input_tso_disapeared_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_tso_disapeared_date).locale('th').format('MMM')} / ${dayjs(rdoc1Find?.doc3_input_tso_disapeared_date).locale('th').format('BBBB')}`);
      const input_tso_disapeared_time =
        rdoc1Find?.doc3_input_tso_disapeared_time;
      const input_tso_doc_number =
        rdoc1Find?.doc3_input_tso_doc_number;
      const input_tso_down_date =
        (rdoc1Find?.doc3_input_tso_down_date &&
          `${dayjs(rdoc1Find?.doc3_input_tso_down_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_tso_down_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc3_input_tso_down_date).locale('th').format('BBBB')}`);
      const input_notifyby =
        rdoc1Find?.doc3_input_notifyby;
      const input_shipper_cpn_name =
        rdoc1Find?.doc3_input_shipper_cpn_name;

      const longdo_dict = rdoc1Find?.longdo_dict; //สำเนา

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งเตือนคุณภาพก๊าซฯ 3',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          {
            text: 'เอกสารแจ้งคุณภาพก๊าซหรือปริมาณก๊าซนำเข้ากลับเป็นปกติ',
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    // text: `เรียน: ${toGroupName}`,
                    text: `เรียน: `,
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${group?.name}`, `${toCompany}`],
                    // margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ! ======== กรอบ "ส่วนของผู้ใช้บริการ / ผู้ให้บริการ (ผู้ทีท าให้เกิดเหตุการณ์)" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ / ผู้ให้บริการ (ผู้ที่ทำให้เกิดเหตุการณ์)',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `ตามที่ ${input_shipper_cpn_name} ได้แจ้งเรื่องคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ / ปริมาณก๊าซนำเข้าเบี่ยงเบนจาก Nomination มากกว่าเกณฑ์ที่กำหนด ดังรายละเอียดในเอกสารเลขที่ ${input_shipper_doc_number} (เอกสารแจ้งเตือนคุณภาพ ${input_shipper_doc_quality} ) ลงวันที่ ${input_shipper_down_date}`,
                            text: [
                              'ตามที่ ',
                              {
                                text:
                                  input_shipper_cpn_name ? input_shipper_cpn_name : '____________',
                                  decoration: input_shipper_cpn_name && 'underline',
                              },
                              ' ได้แจ้งเรื่องคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ / ปริมาณก๊าซนำเข้าเบี่ยงเบนจาก Nomination มากกว่าเกณฑ์ที่กำหนด ดังรายละเอียดในเอกสารเลขที่ ',
                              {
                                text:
                                input_shipper_doc_number ? input_shipper_doc_number : '____________',
                                decoration: input_shipper_doc_number && 'underline',
                              },
                              ' (เอกสารแจ้งเตือนคุณภาพ ',
                              {
                                text:
                                input_shipper_doc_quality ? input_shipper_doc_quality : '____________',
                                decoration: input_shipper_doc_quality && 'underline',
                              },
                              ' ) ลงวันที่ ',
                              {
                                text:
                                input_shipper_down_date ? input_shipper_down_date : '____________',
                                decoration: input_shipper_down_date && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `บัดนี้ คุณภาพก๊าซดังกล่าว มีคุณภาพ / ปริมาณเป็นไปตามข้อกำหนด / เกณฑ์ที่กำหนด โดยมีข้อสรุปดังนี้ `,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        ul: [
                          {
                            text: [
                              {
                                // text: `ช่วงเวลาของเหตุการณ์: วันที่ ${input_shipper_time_event_start_date} เวลา ${input_shipper_time_event_start_time} น. ถึง วันที่ ${input_shipper_time_event_end_date} เวลา ${input_shipper_time_event_end_time} น.`,
                                text: [
                                  'ช่วงเวลาของเหตุการณ์: วันที่ ',
                                  {
                                    text:
                                      input_shipper_time_event_start_date ? input_shipper_time_event_start_date : '____________',
                                      decoration: input_shipper_time_event_start_date && 'underline',
                                    },
                                    ' เวลา ',
                                    {
                                      text:
                                      input_shipper_time_event_start_time ? input_shipper_time_event_start_time : '____________',
                                      decoration: input_shipper_time_event_start_time && 'underline',
                                    },
                                    ' น. ถึง วันที่ ',
                                    {
                                      text:
                                      input_shipper_time_event_end_date ? input_shipper_time_event_end_date : '____________',
                                      decoration: input_shipper_time_event_end_date && 'underline',
                                    },
                                    ' เวลา ',
                                    {
                                      text:
                                      input_shipper_time_event_end_time ? input_shipper_time_event_end_time : '____________',
                                      decoration: input_shipper_time_event_end_time && 'underline',
                                    },
                                    ' น. ',
                                ]
                              },
                            ],
                            margin: [22, 0, 0, 0],
                          },
                          {
                            text: [
                              {
                                // text: `สรุปการแก้ไข: ${input_shipper_time_event_summary}`,
                                text: [
                                  'สรุปการแก้ไข: ',
                                  {
                                    text:
                                      input_shipper_time_event_summary ? input_shipper_time_event_summary : '____________',
                                      decoration: input_shipper_time_event_summary && 'underline',
                                    },
                                  ]
                              },
                            ],
                            margin: [22, 0, 0, 0],
                          },
                        ],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ! ======== กรอบ "ส่วนของผู้ให้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ให้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },

                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `ตามที่ส่วนบริหารและควบคุมระบบส่งก๊าซ (บค.บคต.) ได้แจ้งคุณภาพก๊าซผสม ไม่อยู่ในข้อกำหนดคุณภาพก๊าซของ TSO Code ดังรายละเอียดในเอกสารเลขที่ ${input_tso_doc_number} (เอกสารแจ้งเตือนคุณภาพ 2) ${input_tso_down_date}`,
                            text: [
                                  'ตามที่ส่วนบริหารและควบคุมระบบส่งก๊าซ (บค.บคต.) ได้แจ้งคุณภาพก๊าซผสม ไม่อยู่ในข้อกำหนดคุณภาพก๊าซของ TSO Code ดังรายละเอียดในเอกสารเลขที่ ',
                                  {
                                    text:
                                    input_tso_doc_number ? input_tso_doc_number : '____________',
                                    decoration: input_tso_doc_number && 'underline',
                                  },
                                  ' (เอกสารแจ้งเตือนคุณภาพ 2) ',
                                  {
                                    text:
                                    input_tso_down_date ? input_tso_down_date : '____________',
                                    decoration: input_tso_down_date && 'underline',
                                  },
                                  ]
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `โดยก๊าซฯที่ไม่อยู่ในคุณสมบัติที่กำหนดตามข้อกำหนด TSO Code ได้หมดไปจากระบบส่งก๊าซฯ เมื่อ วันที่ ${input_tso_disapeared_date} เวลา ${input_tso_disapeared_time} น.`,
                            text: [
                                  'โดยก๊าซฯที่ไม่อยู่ในคุณสมบัติที่กำหนดตามข้อกำหนด TSO Code ได้หมดไปจากระบบส่งก๊าซฯ เมื่อ วันที่ ',
                                  {
                                    text:
                                    input_tso_disapeared_date ? input_tso_disapeared_date : '____________',
                                    decoration: input_tso_disapeared_date && 'underline',
                                  },
                                  ' เวลา ',
                                  {
                                    text:
                                    input_tso_disapeared_time ? input_tso_disapeared_time : '____________',
                                    decoration: input_tso_disapeared_time && 'underline',
                                  },
                                  ' น. ',
                                  ]
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*', '*'],
              body: [
                [
                  {
                    stack: [
                       // https://app.clickup.com/t/86eug8cfe
                      // {
                      //   text: toFullname
                      //     ? `${toFullname}`
                      //     : `_____________________`,
                      // },
                      fromSignature && rdoc1Find?.user_type_id !== 3 // (PTT TSO) https://app.clickup.com/t/86eum0pbr
                        ? {
                            columns: [
                              { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : fromSignature && rdoc1Find?.user_type_id === 3 ? { text: `แจ้งโดย (PTT TSO)` } // (PTT TSO) https://app.clickup.com/t/86eum0pbr
                        : { text: `แจ้งโดย ` },
                      { text: fromFullnameH ? `( ${fromFullnameH} )` : `(                                   )` },
                      // 
                      // { text: `แจ้งโดย ${fromFullnameH}` },
                      // {
                      //   text: fromFullname
                      //     ? `${fromFullname}`
                      //     : `_____________________`,
                      // },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany}` }, // https://app.clickup.com/t/86eum0pah
                      {
                        text: `วันที่เดือนปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น.`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // https://app.clickup.com/t/86eug8cfe
                      // {
                      //   text: toFullname
                      //     ? `${toFullname}`
                      //     : `_____________________`,
                      // },
                      toSignature
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toGroupName ? `( ${toGroupName} )` : `(                                   )` },
                      
                      // { text: `รับทราบโดย ${toGroupName}` },
                      // {
                      //   text: toFullname
                      //     ? `${toFullname}`
                      //     : `_____________________`,
                      // },
                      // toSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
                      {
                        text: `วันที่เดือนปี: ${!toFullname ? ' ' : toDate.format('DD')} / ${!toFullname ? ' ' : toDate.format('MM')} / ${!toFullname ? ' ' : toDate.format('BB')}`,
                      },
                      {
                        text: `เวลา : ${!toFullname ? ' ' : toDate.format('HH:mm')} น.`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      { text: `รับทราบโดย` },
                      { text: `…………………………………………` },
                      { text: `(                                   )` },
                      { text: `หน่วยงาน ………………………………………` },
                      { text: `วันที่เดือนปี : ………/…………/…………` },
                      {
                        text: `เวลา : ………………………………………`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });

      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber?.findFirst({
          where: { event_document: { some: { id: Number(id) } } },
        });

        const rdoc1Find = await this.doc3Find(
          findRunnumber?.id,
          userId,
          null,
          group_id,
        );
        console.log('rdoc1Find : ', rdoc1Find);

        const event_document_action = rdoc1Find?.event_document_action;

        const toAction = event_document_action?.find(
          (f: any) =>
            f?.user_type_id === 3 &&
            f?.group_id === groupId &&
            f?.event_doc_status_id !== 2,
        );
        console.log('toAction : ', toAction);
        const toGroupName = toAction?.group?.name || "";

        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) || "";
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        console.log('event_runnumber : ', rdoc1Find?.event_runnumber);
        console.log('rdoc1Find : ', rdoc1Find);

        // ---- create runnumber
        const fromFullnameH =
          (rdoc1Find?.create_by_account?.account_manage?.[0].group?.name &&
            rdoc1Find?.create_by_account?.account_manage?.[0].group?.name) ||
          '';
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany =
          rdoc1Find?.user_type_id !== 3
            ? 'บริษัท ปตท.จำกัด (มหาชน)'
            : rdoc1Find?.group?.company_name || '';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const input_shipper_doc_number =
          rdoc1Find?.doc3_input_shipper_doc_number;
        const input_shipper_doc_quality =
          rdoc1Find?.doc3_input_shipper_doc_quality;
        const input_shipper_down_date =
          (rdoc1Find?.doc3_input_shipper_down_date &&
            `${dayjs(rdoc1Find?.doc3_input_shipper_down_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_shipper_down_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc3_input_shipper_down_date).locale('th').format('BBBB')}`);
        const input_shipper_time_event_end_date =
          (rdoc1Find?.doc3_input_shipper_time_event_end_date &&
            `${dayjs(rdoc1Find?.doc3_input_shipper_time_event_end_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_end_date).locale('th').format('MMM')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_end_date).locale('th').format('BBBB')}`);
        const input_shipper_time_event_end_time =
          rdoc1Find?.doc3_input_shipper_time_event_end_time;
        const input_shipper_time_event_start_date =
          (rdoc1Find?.doc3_input_shipper_time_event_start_date &&
            `${dayjs(rdoc1Find?.doc3_input_shipper_time_event_start_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_start_date).locale('th').format('MMM')} / ${dayjs(rdoc1Find?.doc3_input_shipper_time_event_start_date).locale('th').format('BBBB')}`);
        const input_shipper_time_event_start_time =
          rdoc1Find?.doc3_input_shipper_time_event_start_time;
        const input_shipper_time_event_summary =
          rdoc1Find?.doc3_input_shipper_time_event_summary;
        const input_tso_disapeared_date =
          (rdoc1Find?.doc3_input_tso_disapeared_date &&
            `${dayjs(rdoc1Find?.doc3_input_tso_disapeared_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_tso_disapeared_date).locale('th').format('MMM')} / ${dayjs(rdoc1Find?.doc3_input_tso_disapeared_date).locale('th').format('BBBB')}`);
        const input_tso_disapeared_time =
          rdoc1Find?.doc3_input_tso_disapeared_time;
        const input_tso_doc_number =
          rdoc1Find?.doc3_input_tso_doc_number;
        const input_tso_down_date =
          (rdoc1Find?.doc3_input_tso_down_date &&
            `${dayjs(rdoc1Find?.doc3_input_tso_down_date).locale('th').format('DD')} / ${dayjs(rdoc1Find?.doc3_input_tso_down_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc3_input_tso_down_date).locale('th').format('BBBB')}`);
        const input_notifyby =
          rdoc1Find?.doc3_input_notifyby;
        const input_shipper_cpn_name =
          rdoc1Find?.doc3_input_shipper_cpn_name;

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งเตือนคุณภาพก๊าซฯ 3',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            {
              text: 'เอกสารแจ้งคุณภาพก๊าซหรือปริมาณก๊าซนำเข้ากลับเป็นปกติ',
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      // text: `เรียน: ${toGroupName}`,
                      text: `เรียน: `,
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      // stack: [`${group_name?.name}`, `${toCompany}`],
                      stack: [`${groups?.name}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [`${longdo_dict || ''}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ! ======== กรอบ "ส่วนของผู้ใช้บริการ / ผู้ให้บริการ (ผู้ทีท าให้เกิดเหตุการณ์)" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ / ผู้ให้บริการ (ผู้ที่ทำให้เกิดเหตุการณ์)',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `ตามที่ ${input_shipper_cpn_name} ได้แจ้งเรื่องคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ / ปริมาณก๊าซนำเข้าเบี่ยงเบนจาก Nomination มากกว่าเกณฑ์ที่กำหนด ดังรายละเอียดในเอกสารเลขที่ ${input_shipper_doc_number} (เอกสารแจ้งเตือนคุณภาพ ${input_shipper_doc_quality} ) ลงวันที่ ${input_shipper_down_date}`,
                            text: [
                              'ตามที่ ',
                              {
                                text:
                                  input_shipper_cpn_name ? input_shipper_cpn_name : '____________',
                                  decoration: input_shipper_cpn_name && 'underline',
                              },
                              ' ได้แจ้งเรื่องคุณภาพก๊าซไม่อยู่ในข้อกำหนดคุณภาพก๊าซ / ปริมาณก๊าซนำเข้าเบี่ยงเบนจาก Nomination มากกว่าเกณฑ์ที่กำหนด ดังรายละเอียดในเอกสารเลขที่ ',
                              {
                                text:
                                input_shipper_doc_number ? input_shipper_doc_number : '____________',
                                decoration: input_shipper_doc_number && 'underline',
                              },
                              ' (เอกสารแจ้งเตือนคุณภาพ ',
                              {
                                text:
                                input_shipper_doc_quality ? input_shipper_doc_quality : '____________',
                                decoration: input_shipper_doc_quality && 'underline',
                              },
                              ' ) ลงวันที่ ',
                              {
                                text:
                                input_shipper_down_date ? input_shipper_down_date : '____________',
                                decoration: input_shipper_down_date && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `บัดนี้ คุณภาพก๊าซดังกล่าว มีคุณภาพ / ปริมาณเป็นไปตามข้อกำหนด / เกณฑ์ที่กำหนด โดยมีข้อสรุปดังนี้ `,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        ul: [
                          {
                            text: [
                              {
                                // text: `ช่วงเวลาของเหตุการณ์: วันที่ ${input_shipper_time_event_start_date} เวลา ${input_shipper_time_event_start_time} น. ถึง วันที่ ${input_shipper_time_event_end_date} เวลา ${input_shipper_time_event_end_time} น.`,
                                text: [
                                  'ช่วงเวลาของเหตุการณ์: วันที่ ',
                                  {
                                    text:
                                      input_shipper_time_event_start_date ? input_shipper_time_event_start_date : '____________',
                                      decoration: input_shipper_time_event_start_date && 'underline',
                                    },
                                    ' เวลา ',
                                    {
                                      text:
                                      input_shipper_time_event_start_time ? input_shipper_time_event_start_time : '____________',
                                      decoration: input_shipper_time_event_start_time && 'underline',
                                    },
                                    ' น. ถึง วันที่ ',
                                    {
                                      text:
                                      input_shipper_time_event_end_date ? input_shipper_time_event_end_date : '____________',
                                      decoration: input_shipper_time_event_end_date && 'underline',
                                    },
                                    ' เวลา ',
                                    {
                                      text:
                                      input_shipper_time_event_end_time ? input_shipper_time_event_end_time : '____________',
                                      decoration: input_shipper_time_event_end_time && 'underline',
                                    },
                                    ' น. ',
                                ]
                              },
                            ],
                            margin: [22, 0, 0, 0],
                          },
                          {
                            text: [
                              {
                                // text: `สรุปการแก้ไข: ${input_shipper_time_event_summary}`,
                                text: [
                                  'สรุปการแก้ไข: ',
                                  {
                                    text:
                                      input_shipper_time_event_summary ? input_shipper_time_event_summary : '____________',
                                      decoration: input_shipper_time_event_summary && 'underline',
                                    },
                                  ]
                              },
                            ],
                            margin: [22, 0, 0, 0],
                          },
                        ],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ! ======== กรอบ "ส่วนของผู้ให้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ให้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },

                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `ตามที่ส่วนบริหารและควบคุมระบบส่งก๊าซ (บค.บคต.) ได้แจ้งคุณภาพก๊าซผสม ไม่อยู่ในข้อกำหนดคุณภาพก๊าซของ TSO Code ดังรายละเอียดในเอกสารเลขที่ ${input_tso_doc_number} (เอกสารแจ้งเตือนคุณภาพ 2) ${input_tso_down_date}`,
                            text: [
                                  'ตามที่ส่วนบริหารและควบคุมระบบส่งก๊าซ (บค.บคต.) ได้แจ้งคุณภาพก๊าซผสม ไม่อยู่ในข้อกำหนดคุณภาพก๊าซของ TSO Code ดังรายละเอียดในเอกสารเลขที่ ',
                                  {
                                    text:
                                    input_tso_doc_number ? input_tso_doc_number : '____________',
                                    decoration: input_tso_doc_number && 'underline',
                                  },
                                  ' (เอกสารแจ้งเตือนคุณภาพ 2) ',
                                  {
                                    text:
                                    input_tso_down_date ? input_tso_down_date : '____________',
                                    decoration: input_tso_down_date && 'underline',
                                  },
                                  ]
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `โดยก๊าซฯที่ไม่อยู่ในคุณสมบัติที่กำหนดตามข้อกำหนด TSO Code ได้หมดไปจากระบบส่งก๊าซฯ เมื่อ วันที่ ${input_tso_disapeared_date} เวลา ${input_tso_disapeared_time} น.`,
                            text: [
                                  'โดยก๊าซฯที่ไม่อยู่ในคุณสมบัติที่กำหนดตามข้อกำหนด TSO Code ได้หมดไปจากระบบส่งก๊าซฯ เมื่อ วันที่ ',
                                  {
                                    text:
                                    input_tso_disapeared_date ? input_tso_disapeared_date : '____________',
                                    decoration: input_tso_disapeared_date && 'underline',
                                  },
                                  ' เวลา ',
                                  {
                                    text:
                                    input_tso_disapeared_time ? input_tso_disapeared_time : '____________',
                                    decoration: input_tso_disapeared_time && 'underline',
                                  },
                                  ' น. ',
                                  ]
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

           // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*', '*'],
              body: [
                [
                  {
                    stack: [
                       // https://app.clickup.com/t/86eug8cfe
                      // {
                      //   text: toFullname
                      //     ? `${toFullname}`
                      //     : `_____________________`,
                      // },
                      fromSignature && rdoc1Find?.user_type_id !== 3 // (PTT TSO) https://app.clickup.com/t/86eum0pbr
                        ? {
                            columns: [
                              { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : fromSignature && rdoc1Find?.user_type_id === 3 ? { text: `แจ้งโดย (PTT TSO)` } // (PTT TSO) https://app.clickup.com/t/86eum0pbr
                        : { text: `แจ้งโดย ` },
                      { text: fromFullnameH ? `( ${fromFullnameH} )` : `(                                   )` },
                      // 
                      // { text: `แจ้งโดย ${fromFullnameH}` },
                      // {
                      //   text: fromFullname
                      //     ? `${fromFullname}`
                      //     : `_____________________`,
                      // },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany}` }, // https://app.clickup.com/t/86eum0pah
                      {
                        text: `วันที่เดือนปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น.`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // https://app.clickup.com/t/86eug8cfe
                      // {
                      //   text: toFullname
                      //     ? `${toFullname}`
                      //     : `_____________________`,
                      // },
                      toSignature
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toGroupName ? `( ${toGroupName} )` : `(                                   )` },
                      
                      // { text: `รับทราบโดย ${toGroupName}` },
                      // {
                      //   text: toFullname
                      //     ? `${toFullname}`
                      //     : `_____________________`,
                      // },
                      // toSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
                      {
                        text: `วันที่เดือนปี: ${!toFullname ? ' ' : toDate.format('DD')} / ${!toFullname ? ' ' : toDate.format('MM')} / ${!toFullname ? ' ' : toDate.format('BB')}`,
                      },
                      {
                        text: `เวลา : ${!toFullname ? ' ' : toDate.format('HH:mm')} น.`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      { text: `รับทราบโดย` },
                      { text: `…………………………………………` },
                      { text: `(                                   )` },
                      { text: `หน่วยงาน ………………………………………` },
                      { text: `วันที่เดือนปี : ………/…………/…………` },
                      {
                        text: `เวลา : ………………………………………`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

            // // ======== กรอบช่องเซ็นชื่อ =========
            // {
            //   table: {
            //     widths: ['*', '*', '*'],
            //     body: [
            //       [
            //         {
            //           stack: [
            //             { text: `แจ้งโดย ${fromFullnameH}` },
            //             {
            //               text: fromFullname
            //                 ? `${fromFullname}`
            //                 : `_____________________`,
            //             },
            //             // fromSignature
            //             //   ? {
            //             //       columns: [
            //             //         { text: '(', width: 'auto', alignment: 'right' },
            //             //         {
            //             //           image: fromSignature, // base64 หรือ path
            //             //           width: 50,
            //             //           alignment: 'center',
            //             //         },
            //             //         { text: ')', width: 'auto', alignment: 'left' },
            //             //       ],
            //             //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
            //             //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //             //     }
            //             //   : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${fromCompany} (ผู้ใช้บริการ)` },
            //             {
            //               text: `วันที่เดือนปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
            //             },
            //             {
            //               text: `เวลา : ${fromDate.format('HH:mm')} น.`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //         {
            //           stack: [
            //             { text: `รับทราบโดย ${toGroupName}` },
            //             {
            //               text: toFullname
            //                 ? `${toFullname}`
            //                 : `_____________________`,
            //             },
            //             toSignature
            //               ? {
            //                   columns: [
            //                     {
            //                       text: '(',
            //                       width: 'auto',
            //                       alignment: 'right',
            //                     },
            //                     {
            //                       image: toSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
            //             {
            //               text: `วันที่เดือนปี: ${!!!toFullname ? ' ' : toDate.format('DD')} / ${!!!toFullname ? ' ' : toDate.format('MM')} / ${!!!toFullname ? ' ' : toDate.format('BB')}`,
            //             },
            //             {
            //               text: `เวลา : ${!!!toFullname ? ' ' : toDate.format('HH:mm')} น.`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //         {
            //           stack: [
            //             { text: `รับทราบโดย` },
            //             { text: `…………………………………………` },
            //             { text: `(                                   )` },
            //             { text: `หน่วยงาน ………………………………………` },
            //             { text: `วันที่เดือนปี : ………/…………/…………` },
            //             {
            //               text: `เวลา : ………………………………………`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //       ],
            //     ],
            //   },
            //   layout: {
            //     hLineWidth: () => 0.5,
            //     vLineWidth: () => 0.5,
            //   },
            //   margin: [0, 0, 0, 0],
            // },

            // // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
          },
        };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }

      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // emer
  emerEventStatus() {
    return this.prisma.event_status.findMany({ orderBy: { id: 'asc' } });
  }

  emerEventDocStatus() {
    return this.prisma.event_doc_status.findMany({
      orderBy: { id: 'asc' },
      where: {
        id: {
          in: [3, 4, 5, 6],
        },
      },
    });
  }

  async emerOnce(id: any, userId: any) {
    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const groupId = group?.id;
    const result = await this.prisma.event_runnumber_emer.findFirst({
      where: {
        id: Number(id),
      },
      include: {
        event_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_doc_emer_type: true,
        event_doc_emer_gas_tranmiss: true,
        event_document_emer: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_emer_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_emer_file_pdf: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            },
            event_document_emer_action: {
              include: {
                event_doc_master: true,
                event_doc_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: {
                id: 'desc',
              },
            },
            event_doc_gas_shipper_match: {
              include: {
                event_doc_gas_shipper: {
                  include: {
                    event_doc_gas_shipper_file: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper: {
              include: {
                event_doc_gas_shipper_match: {
                  include: {
                    event_doc_gas_shipper: {
                      include: {
                        event_doc_gas_shipper_file: {
                          include: {
                            create_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                            update_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
                event_doc_gas_shipper_file: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper_match_41: {
              include: {
                event_doc_gas_shipper_41: {
                  include: {
                    event_doc_gas_shipper_file_41: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper_41: {
              include: {
                event_doc_gas_shipper_match_41: {
                  include: {
                    event_doc_gas_shipper_41: {
                      include: {
                        event_doc_gas_shipper_file_41: {
                          include: {
                            create_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                            update_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
                event_doc_gas_shipper_file_41: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                },
              },
            },
          },
          orderBy: { id: "desc" } 
        },
      },
    });
    const rData = this.emerMapDataEvent(result, result?.user_type_id, groupId);
    return rData;
  }

  async emerAll(query: any, userId: any) {
    console.log('userId : ', userId);
    const {
      eventCode,
      eventDateFrom,
      eventDateTo,
      EventStatus,
      offset,
      limit,
      event_doc_emer_type_id,
    } = query;

    const limit_ = Number(limit);
    const offset_ = Number(offset);

    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group.user_type?.id;
    const groupId = group?.id;

    const eventDateCondition =
      !!eventDateFrom && !!eventDateTo
        ? {
            event_date: {
              gte: getTodayNowYYYYMMDDDfaultAdd7(eventDateFrom).toDate(),
              lte: getTodayNowYYYYMMDDDfaultAdd7(eventDateTo)
                .endOf('day')
                .toDate(),
            },
          }
        : eventDateFrom
          ? {
              event_date: {
                gte: getTodayNowYYYYMMDDDfaultAdd7(eventDateFrom).toDate(),
              },
            }
          : eventDateTo
            ? {
                event_date: {
                  lte: getTodayNowYYYYMMDDDfaultAdd7(eventDateTo)
                    .endOf('day')
                    .toDate(),
                },
              }
            : {};

    const result = await this.prisma.event_runnumber_emer.findMany({
      where: {
        ...(userTypeId === 3 && {
          OR: [
            { group_id: groupId },
            { event_document_emer: { some: { group_id: groupId } } },
          ],
        }),

        event_nember: {
          contains: eventCode && eventCode?.toUpperCase() || "",
        },
        ...(EventStatus && {
          event_status_id: Number(EventStatus),
        }),
        ...eventDateCondition,
        ...(event_doc_emer_type_id && {
          event_doc_emer_type_id: Number(event_doc_emer_type_id),
        }),
      },
      skip: Number(offset_),
      take: Number(limit_),
      include: {
        event_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_doc_emer_type: true,
        event_doc_emer_gas_tranmiss: true,
        event_document_emer: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_emer_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_emer_file_pdf: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            },
            event_document_emer_action: {
              include: {
                event_doc_master: true,
                event_doc_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: {
                id: 'desc',
              },
            },
            event_doc_gas_shipper_match: {
              include: {
                event_doc_gas_shipper: {
                  include: {
                    event_doc_gas_shipper_file: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper: {
              include: {
                event_doc_gas_shipper_file: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper_match_41: {
              include: {
                event_doc_gas_shipper_41: {
                  include: {
                    event_doc_gas_shipper_file_41: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper_41: {
              include: {
                event_doc_gas_shipper_file_41: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                },
              },
            },
          },
        },
      },
      orderBy: [{ create_date: 'desc' }, { id: 'desc' }],
    });

    console.log(result.map((r) => r.id));

    console.log('eventDateCondition : ', eventDateCondition);

    const newData = result?.map((e: any) => {
      const rData = this.emerMapDataEvent(e, userTypeId, groupId);
      return rData;
    });
    // userTypeId
    // document39 document4
    const frData =
      userTypeId === 3
        ? newData?.filter((f: any) => {
            return (
              f?.document39 !== null
              // f?.document4.length !== 0
            );
          })
        : newData;

    const calcLength = Math.abs(frData.length - newData.length);

    const count = await this.prisma.event_runnumber_emer.count({
      where: {
        ...(userTypeId === 3 && {
          OR: [
            { group_id: groupId },
            { event_document_emer: { some: { group_id: groupId } } },
          ],
        }),
        event_nember: {
          contains: eventCode && eventCode?.toUpperCase() || "",
        },
        ...(EventStatus && {
          event_status_id: Number(EventStatus),
        }),
        ...eventDateCondition,
        ...(event_doc_emer_type_id && {
          event_doc_emer_type_id: Number(event_doc_emer_type_id),
        }),
      },
    });

    return {
      total: count - calcLength,
      data: frData,
    };
  }

  emerMapDataEvent(e: any, userTypeId: any, groupId?: any) {
    const { event_document_emer, ...nE } = e;
    let document39 = null;
    let document41 = null;
    // let document4 = null;
    let document5 = null;
    let document6 = null;

    let document39TSOID = null;
    let document41TSOID = null;
    // let document4TSOID = null;
    let document5TSOID = null;
    let document6TSOID = null;
    // console.log('event_document : ', event_document);

    if (userTypeId === 3) {
      // shipper
      const document39CkGen = event_document_emer?.find(
        (f: any) =>
          f?.event_doc_master_id === 309 &&
          f?.group_id === groupId &&
          f?.event_doc_status_id === 6, // เป็น obj 1
      );
      document39 = document39CkGen
        ? null
        : event_document_emer?.find(
            (f: any) =>
              f?.event_doc_master_id === 309 && f?.group_id === groupId, // เป็น obj 1
          );

      const document4CkGen = event_document_emer?.find(
        (f: any) =>
          f?.event_doc_master_id === 4 &&
          f?.group_id === groupId &&
          f?.event_doc_status_id === 6, // เป็น obj 1
      );

      document41 = document4CkGen
        ? []
        : event_document_emer?.filter(
            (f: any) =>
              f?.event_doc_master_id === 41 && f?.group_id === groupId, // เป็น obj 1
          );

      document5 = event_document_emer?.find(
        (f: any) => f?.event_doc_master_id === 5 && f?.group_id === groupId, // เป็น obj 1
      );

      document6 = event_document_emer?.find(
        (f: any) => f?.event_doc_master_id === 6 && f?.group_id === groupId, // เป็น obj 1
      );
    } else {
      // tso | อื่นๆ
      // document1 = event_document_emer?.find(
      //   (f: any) => f?.event_doc_master_id === 1,
      // );
      document39 = event_document_emer?.filter(
        (f: any) => f?.event_doc_master_id === 309 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );
      document39TSOID = event_document_emer?.find(
        (f: any) => f?.event_doc_master_id === 309 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
      )?.id;

      document41 = event_document_emer?.filter(
        (f: any) => f?.event_doc_master_id === 41 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );
      const document41TSOID_ =
        event_document_emer?.filter(
          (f: any) => f?.event_doc_master_id === 41 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
        ) || [];

      document41TSOID = document41TSOID_[document41TSOID_.length - 1]?.id;

      document5 = event_document_emer?.filter(
        (f: any) => f?.event_doc_master_id === 5 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );

      document5TSOID = event_document_emer?.find(
        (f: any) => f?.event_doc_master_id === 5 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
      )?.id;

      document6 = event_document_emer?.filter(
        (f: any) => f?.event_doc_master_id === 6 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );

      document6TSOID = event_document_emer?.find(
        (f: any) => f?.event_doc_master_id === 6 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
      )?.id;
    }

    return {
      ...nE,
      document39: document39 ?? null,
      document39TSOID: document39TSOID ?? null,
      // document4: document4 ?? null,
      // document4TSOID: document4TSOID ?? null,
      document41: document41 ?? null,
      document41TSOID: document41TSOID ?? null,
      document5: document5 ?? null,
      document5TSOID: document5TSOID ?? null,
      document6: document6 ?? null,
      document6TSOID: document6TSOID ?? null,
    };
  }

  async emerUpdateStatus(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_status_id } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId === 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_runnumber_emer.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_status_id: event_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      const eventRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          id: Number(id),
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.emerOnce(result?.eventRunId, userId);

    return findOnce;
  }

  emerEventType() {
    return this.prisma.event_doc_emer_type.findMany({ orderBy: { id: 'asc' } });
  }

  emerEventTermission() {
    return this.prisma.event_doc_emer_gas_tranmiss.findMany({
      orderBy: { id: 'asc' },
    });
  }

  // doc3.9

  // parameter ที่ใช้ gen doc 3.9,4,7

  // ข้อมูล row เขียว
  // gas_day
  // gas_hour
  // zone
  // level
  // accImb_or_accImbInv
  // energyAdjust
  // volumeAdjust
  // volumeAdjustRate_mmscfd
  // volumeAdjustRate_mmscfh

  // ข้อมูล row ขาว (ราย shipper เป็น array)
  // gas_hour
  // shipperName
  // zone
  // flow_type
  // accImb_or_accImbInv
  // energyAdjust
  // volumeAdjust
  // volumeAdjustRate_mmscfd
  // volumeAdjustRate_mmscfh

  // row ขาว ให้ filter เฉพาะที่ energyAdjust ค่าเป็นบวกเหมือน row เขียว หรือ เป็นลบหมือน row เขียว

  async checkType39and4Gen(text: any) {
    if (text === 'DIFFICULT DAY FLOW' || text === 'DD') {
      return 1;
    } else {
      throw new HttpException(
        {
          status: HttpStatus.BAD_REQUEST,
          error: 'Flow Type Is Not Match.',
        },
        HttpStatus.BAD_REQUEST,
      );
    }
  }

  async meterDataUseSystem(gas_day: any) {
    const hvMeter =
      await this.prisma.hv_for_peration_flow_and_instructed_flow.findFirst({
        where: {
          hv_type_id: 1,
          start_date: {
            lte: getTodayNowYYYYMMDDDfaultAdd7(gas_day).toDate(),
          },
        },
        include: {
          metering_point: {
            include: {
              area: {
                include: {
                  nomination_point: true,
                },
              },
            },
          },
        },
        orderBy: {
          start_date: 'desc',
        },
      });
    console.log('hvMeter : ', hvMeter);

    const meterPointName = hvMeter?.metering_point?.metered_point_name;
    const meterPointId = hvMeter?.metering_point?.id;
    const areaName = hvMeter?.metering_point?.area?.name;
    const areaId = hvMeter?.metering_point?.area?.id;
    const areaNom = hvMeter?.metering_point?.area;
    return {
      meterPointName: meterPointName || '',
      meterPointId: meterPointId || '',
      areaName: areaName || '',
      areaId: areaId || '',
      areaNom: areaNom,
    };
  }

  async zoneDataUse(text: any) {
    if (text === 'EAST') {
      return 1;
    } else if (text === 'WEST') {
      return 2;
    } else if (text === 'EAST-WEST') {
      return 3;
    } else {
      return 4;
    }
  }

  async gasHourText(text: any) {
    const hourText = text < 10 ? String(text).padStart(2, '0') : String(text);

    return hourText + ':00';
  }

  async shipperData(shipper: any) {
    const resData = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      include: {},
      orderBy: {
        id: 'desc',
      },
    });

    const shipperData = shipper
      ?.map((e: any) => {
        const find = resData?.find((f: any) => {
          return f?.id_name === e?.shipperName;
        });

        return {
          id: find?.id ?? null,
          ...e,
        };
      })
      ?.filter((f: any) => {
        return f?.id !== null;
      });

    return shipperData;
  }

  async generatedoc39and4(payload: any, userId: any) {
    // หา meter จาก hv dam system
    // doc 4 หา area จาก relate meter จาก hv dam system
    const {
      gas_day,
      gas_hour,
      zone,
      level, // flow type | DD = DIFFICULT DAY FLOW, OFO = OPERATION FLOW, IF = INSTRUCTED FLOW
      accImb_or_accImbInv,
      energyAdjust,
      volumeAdjust,
      volumeAdjustRate_mmscfd,
      volumeAdjustRate_mmscfh,
      shipper,
    } = payload;

    const flowType = await this.checkType39and4Gen(level);
    const event_doc_emer_gas_tranmiss_id = await this.zoneDataUse(zone); // onshore
    const hourText = await this.gasHourText(gas_hour);
    const { meterPointName, areaName } = await this.meterDataUseSystem(gas_day);
    const doc39IrOrderid = accImb_or_accImbInv < 0 ? 2 : 1; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc39IrOrderText = accImb_or_accImbInv < 0 ? 'ลบ' : 'บวก'; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc39IrOrderText2 = accImb_or_accImbInv < 0 ? 'น้อยกว่า' : 'มากกว่า'; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc_4_input_order_ir_id = energyAdjust < 0 ? 2 : 1; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc_4_input_order_ir_text = energyAdjust < 0 ? 'ลด' : 'เพิ่ม'; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc_4_input_order_io_id = 3; // จุดส่งเข้า fix
    const doc_4_input_order_value = `${meterPointName} ${energyAdjust} MMBTU หรือ ${volumeAdjust} MMSCF (Moment rate ที่มีการปรับ ${doc_4_input_order_ir_text}เท่ากับ ${volumeAdjustRate_mmscfd} MMSCFD หรือ ${volumeAdjustRate_mmscfh} MMSCFH) วันที่/เวลาสั่งการ : วันที่ ${gas_day} เวลา ${hourText} น.`; //ปริมาณ
    const doc_39_input_detail_incident = `เกิดความไม่สมดุลด้าน${doc39IrOrderText}อย่างรุนแรง และมีความเสี่ยงที่จะกระทบต่อความมั่นคงต่อระบบท่อส่งก๊าซฝั่ง ${zone} เนื่องจากมีการนำปริมาณก๊าซเข้าระบบ${doc39IrOrderText2}ปริมาณการใช้`;
    // prisma.event_runnumber_emer.findFirst
    const shipperUse = await this.shipperData(shipper);
    console.log('1 - shipperUse : ', shipperUse);
    const doc3Data = {
      generate: false,
      longdo_dict: null, //สำเนา
      event_date: getTodayNowAdd7().format('YYYY-MM-DD'), // วันที่ออกเอกสาร
      doc_39_input_date_time_of_the_incident: null, //วัน/เวลาที่เกิดเหตุ
      doc_39_input_incident:
        event_doc_emer_gas_tranmiss_id === 4 ? zone : `OnShore ${zone}`, //สถานที่เกิดเหตุ ........
      doc_39_input_detail_incident: doc_39_input_detail_incident, //รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ
      doc_39_input_expected_day_time: null, //คาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา
      doc_39_input_note: null, //หมายเหตุ
      event_doc_emer_type_id: flowType,
      event_doc_emer_gas_tranmiss_id: event_doc_emer_gas_tranmiss_id,
      event_doc_emer_gas_tranmiss_other:
        event_doc_emer_gas_tranmiss_id === 4 ? zone : null, // event_doc_emer_gas_tranmiss_id 4 ใส่ด้วย
      file: [],
      shipper: shipperUse?.map((e: any) => e?.id) || [],
      email_event_for_shipper: [],
      cc_email: [],
    };

    const doc39Create = await this.doc39Create(doc3Data, userId, true);
    console.log('2 - doc39Create : ', doc39Create);

    const doc4Data = {
      generate: false,
      // ref_document: doc39Create?.id, // id runnumber จาก doc 3.9
      "id_runnumber": doc39Create?.id, // ใส่มา 
      "id_documents": null, // ตอนสร้าง null | ถ้าใส่ id_runnumber ใส่มาด้วย | ตอน edit version ส่งมาด้วย | (ถ้าตอน status generate ส่ง id มาด้วย )
      longdo_dict: null, //สำเนา
      event_date: getTodayNowAdd7().format('YYYY-MM-DD'), // วันที่ออกเอกสาร
      doc_41_input_date_time_of_the_incident: null, //วัน/เวลาที่เกิดเหตุ
      doc_41_input_incident: null, // สถานที่เกิดเหตุ
      doc_41_input_detail_incident: null, //รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ
      doc_41_input_expected_day_time: null, //คาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา

      // doc_4_input_note: null, //หมายเหตุ
      // doc_4_input_order_ir_id: doc_4_input_order_ir_id, // เพิ่ม 1 , ลด 2, อื่นๆ ใส่ null
      // doc_4_input_order_io_id: doc_4_input_order_io_id, // เข้า 3 , ออก 4, อื่นๆ ใส่ null
      // doc_4_input_order_other_id: null, // อื่นๆ 5, ถ้าเลือก doc_4_input_order_ir_id, doc_4_input_order_io_id ใส่ null
      // doc_4_input_order_other_value: null, // อื่นๆ ให้ใส่, นอกเหนือ null
      // doc_4_input_order_value: doc_4_input_order_value, // ปริมาณ, อื่นๆ ให้ใส่ null
      file: [],
      // shipper: shipperUse?.map((e: any) => e?.id) || [],
      gas_shipper_41:
        shipperUse?.map((e: any) => {
          return {
            id: null, // ต้องใส่ ตอนเพิ่มครั้งแรกยังไม่มีจะเป็น null
            ir: doc_4_input_order_ir_id, // 1 เพิ่ม, 2 ลด
            io: doc_4_input_order_io_id, // 3 จุดส่งเข้า, 4 จุดส่งออก
            iother: null, // 5 อื่นๆ ถ้าเลือก ir รน 1 - 4 ให้ null
            value: null, // ปริมาณ
            more: null, // เพิ่มเติม
            shipper: shipperUse?.map((e: any) => e?.id) || [], // ต้องมี shipper
            file: [], // ไม่มีส่ง []
          };
        }) || [],
      email_event_for_shipper: [],
      cc_email: [],
    };
    console.log('2 - - - doc4Data : ', doc4Data);
    console.log('2 - - - userId : ', userId);

    const doc41Create = await this.doc41Create(doc4Data, userId, true);
    console.log('3 - doc41Create : ', doc41Create);

    // const doc4Create = await this.doc4Create(doc4Data, userId, true);

    return {
      event_runnumber_emer_id: doc39Create?.id,
      document39TSOID: doc39Create?.document39TSOID,
      document41TSOID: doc41Create?.document41TSOID,
    };
  }

  async doc39EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc39Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    // const filtered = resDoc.filter(
    //   (item) =>
    //     !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    // );

    return resDoc;
  }
  // input_shipper_note
  async doc39Create(payload: any, userId: any, generate?: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,

      doc_39_input_date_time_of_the_incident,
      doc_39_input_incident,
      doc_39_input_detail_incident,
      doc_39_input_expected_day_time,
      doc_39_input_note,
      // input_shipper_note,

      event_doc_emer_type_id,
      event_doc_emer_gas_tranmiss_id,
      event_doc_emer_gas_tranmiss_other,

      // doc_39_input_shipper_operation,
      // doc_39_input_shipper_note,

      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;
      console.log('userTypeId : ', userTypeId);
      console.log('groupId : ', groupId);

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      // รอเช็ค ref
      const eventNumberCount = await prisma.event_runnumber_emer.count({
        where: {
          create_date: {
            gte: todayStart,
            lte: todayEnd,
          },
        },
      });
      const eventNumber = `${newDate.format('YYYY')}-EMER-${(eventNumberCount > 0 ? eventNumberCount + 1 : 1).toString().padStart(4, '0')}`;

      const createEventRunnumber = await prisma.event_runnumber_emer.create({
        data: {
          event_nember: eventNumber,
          event_date: getTodayNowAdd7().toDate(),
          event_doc_emer_type: {
            connect: {
              id: event_doc_emer_type_id,
            },
          },
          event_doc_emer_gas_tranmiss: {
            connect: {
              id: event_doc_emer_gas_tranmiss_id,
            },
          },
          event_doc_emer_gas_tranmiss_other:
            event_doc_emer_gas_tranmiss_other ?? null,
          event_status: {
            connect: {
              id: 1,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
        include: {
          event_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      // -----
      console.log('createEventRunnumber : ', createEventRunnumber);

      const tsoCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        event_runnumber_emer: {
          connect: {
            id: createEventRunnumber?.id,
          },
        },
        event_doc_status: {
          connect: {
            id: generate ? 6 : 2,
          },
        },
        group: {
          connect: {
            id: groupId,
          },
        },
        user_type: {
          connect: {
            id: userTypeId,
          },
        },
        event_doc_master: {
          connect: {
            id: 309,
          },
        },
        doc_39_input_date_time_of_the_incident:
          doc_39_input_date_time_of_the_incident ?? null,
        doc_39_input_incident: doc_39_input_incident ?? null,
        doc_39_input_detail_incident: doc_39_input_detail_incident ?? null,
        doc_39_input_expected_day_time: doc_39_input_expected_day_time ?? null,
        doc_39_input_note: doc_39_input_note ?? null,
        longdo_dict: longdo_dict ?? null,

        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      };

      const createEventDocument = await prisma.event_document_emer.create({
        data: tsoCreate,
        include: {
          event_doc_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_emer_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_emer_file.createMany({
          data: fileData,
        });
      }

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: generate ? 6 : 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 309,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      // shipper multi create
      for (let iShipper = 0; iShipper < (shipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ref_document: createEventDocument?.id,
          event_runnumber_emer: {
            connect: {
              id: createEventRunnumber?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: generate ? 6 : 2,
            },
          },
          group: {
            connect: {
              id: shipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 309,
            },
          },
          doc_39_input_date_time_of_the_incident:
            doc_39_input_date_time_of_the_incident ?? null,
          doc_39_input_incident: doc_39_input_incident ?? null,
          doc_39_input_detail_incident: doc_39_input_detail_incident ?? null,
          doc_39_input_expected_day_time:
            doc_39_input_expected_day_time ?? null,
          doc_39_input_note: doc_39_input_note ?? null,
          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_emer.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_emer_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_emer_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: generate ? 6 : 2,
              },
            },
            group: {
              connect: {
                id: shipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 2,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }
      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_emer_id: createEventDocument?.id,
          edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_emer_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_emer_id: createEventDocument?.id,
          email: cc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_emer_cc_email.createMany({
          data: CcEmail,
        }));

      // email
      const emailUse = {
        shipper: shipper,
        emailGroup: email_event_for_shipper,
        ccEmail: cc_email,
      };

      return { createEventRunnumber, createEventDocument, emailUse };
    });

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    !generate &&
      (await this.sendEmailCondition(result?.emailUse, findOnce, payload, 39));

    return findOnce;
  }

  async doc39Edit(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      event_date,

      generate,
      longdo_dict,
      doc_39_input_date_time_of_the_incident,
      doc_39_input_incident,
      doc_39_input_detail_incident,
      doc_39_input_expected_day_time,
      doc_39_input_note,
      event_doc_emer_type_id,
      event_doc_emer_gas_tranmiss_id,
      event_doc_emer_gas_tranmiss_other,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      if (generate) {
        console.log('generate : ', generate);
        await prisma.event_document_emer.update({
          where: {
            id: Number(id),
          },
          data: {
            event_doc_status_id: 2,
            event_doc_emer_type_id,
            event_doc_emer_gas_tranmiss_id,
            event_doc_emer_gas_tranmiss_other,
          },
        });
        await prisma.event_document_emer.updateMany({
          where: {
            ref_document: Number(id),
          },
          data: {
            event_doc_status_id: 2,
          },
        });
      }

      const getEventDocument = await prisma.event_document_emer.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber_emer: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      // -----

      const tsoCreate = {
        doc_39_input_date_time_of_the_incident:
          doc_39_input_date_time_of_the_incident ?? null,
        doc_39_input_incident: doc_39_input_incident ?? null,
        doc_39_input_detail_incident: doc_39_input_detail_incident ?? null,
        doc_39_input_expected_day_time: doc_39_input_expected_day_time ?? null,
        doc_39_input_note: doc_39_input_note ?? null,

        longdo_dict: longdo_dict ?? null,
        event_date: getTodayNowAdd7(event_date).toDate(),

        // create_date: getTodayNowAdd7().toDate(),
        // create_date_num: getTodayNowAdd7().unix(),
        // create_by_account: {
        //   connect: {
        //     id: Number(userId),
        //   },
        // },
        update_date: getTodayNowAdd7().toDate(),
        update_date_num: getTodayNowAdd7().unix(),
        update_by: Number(userId),
      };

      const updateEventDocument = await prisma.event_document_emer.updateMany({
        where: { id: getEventDocument?.id },
        data: tsoCreate,
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_emer_id: Number(getEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_emer_file.createMany({
          data: fileData,
        });
      }

      const getEventDocumentNew = await prisma.event_document_emer.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber_emer: {
            include: {
              event_document_emer: true,
            },
          },
          event_document_emer_email_group_for_event: {
            include: {
              edit_email_group_for_event: true,
            },
          },
          event_document_emer_cc_email: true,
          group: true,
          user_type: true,

          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });
      // no event_document_action

      // shipper
      // email_event_for_shipper
      // cc_email

      console.log('getEventDocumentNew : ', getEventDocumentNew);
      const nshipper = [];
      for (let inshipper = 0; inshipper < shipper?.length; inshipper++) {
        const findShipper =
          getEventDocumentNew?.event_runnumber_emer?.event_document_emer?.find(
            (f: any) => {
              return (
                f?.group_id === shipper?.[inshipper] &&
                f?.event_doc_master_id === 309
              );
            },
          );
        if (!findShipper) {
          nshipper.push(shipper?.[inshipper]);
        }
      }
      const nemail_event_for_shipper = [];
      for (
        let inemail_event_for_shipper = 0;
        inemail_event_for_shipper < email_event_for_shipper?.length;
        inemail_event_for_shipper++
      ) {
        const findEmail_event_for_shipper =
          getEventDocumentNew?.event_document_emer_email_group_for_event?.find(
            (f: any) => {
              return (
                f?.edit_email_group_for_event?.id ===
                email_event_for_shipper?.[inemail_event_for_shipper]
              );
            },
          );
        if (!findEmail_event_for_shipper) {
          nemail_event_for_shipper.push(
            email_event_for_shipper?.[inemail_event_for_shipper],
          );
        }
      }
      const ncc_email = [];
      for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
        const findCc_email =
          getEventDocumentNew?.event_document_emer_cc_email?.find((f: any) => {
            return f?.email === cc_email[incc_email];
          });
        if (!findCc_email) {
          ncc_email.push(cc_email[incc_email]);
        }
      }

      // shipper multi create
      for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          ref_document: getEventDocumentNew?.id,
          event_runnumber_emer: {
            connect: {
              id: getEventDocumentNew?.event_runnumber_emer_id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: nshipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 309,
            },
          },

          doc_39_input_date_time_of_the_incident:
            doc_39_input_date_time_of_the_incident ?? null,
          doc_39_input_incident: doc_39_input_incident ?? null,
          doc_39_input_detail_incident: doc_39_input_detail_incident ?? null,
          doc_39_input_expected_day_time:
            doc_39_input_expected_day_time ?? null,
          doc_39_input_note: doc_39_input_note ?? null,

          longdo_dict: longdo_dict ?? null,
          event_date: getTodayNowAdd7(event_date).toDate(),

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_emer.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_emer_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_emer_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: nshipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 309,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }

      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_emer_id: getEventDocumentNew?.id,
          edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_emer_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_emer_id: getEventDocumentNew?.id,
          email: ncc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_emer_cc_email.createMany({
          data: CcEmail,
        }));

      // let emailUse = generate
      //   ? {
      //       shipper: shipper,
      //       emailGroup: email_event_for_shipper,
      //       ccEmail: cc_email,
      //     }
      //   : {
      //       shipper: nshipper,
      //       emailGroup: nemail_event_for_shipper,
      //       ccEmail: ncc_email,
      //     };
      const emailUse = {
            shipper: nshipper,
            emailGroup: nemail_event_for_shipper,
            ccEmail: ncc_email,
          }

      return {
        createEventRunnumber: {
          id: getEventDocumentNew?.event_runnumber_emer_id,
        },
        getEventDocumentNew,
        emailUse,
      };
    });

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.getEventDocumentNew?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 39);

    return findOnce;
  }

  async doc39Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 309,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          })
        : await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 309,
              ref_document: null,
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 309,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc39History(id: any, userId: any, tso: any) {
    const resData = await this.prisma.event_document_emer_log_history.findMany({
      where: {
        ...(tso
          ? {
              event_document_emer: {
                event_runnumber_emer_id: Number(id),
                event_doc_master_id: 309,
              },
            }
          : {
              event_document_emer_id: Number(id),
            }),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  async doc39Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_doc_status_id,
      doc_39_input_shipper_operation,
      doc_39_input_shipper_note,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_status_id: 2,
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_emer.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          doc_39_input_shipper_operation:
            doc_39_input_shipper_operation ?? null,
          doc_39_input_shipper_note: doc_39_input_shipper_note ?? null,
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 309,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.emerOnce(result?.eventRunId, userId);

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_emer.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        doc_39_input_date_time_of_the_incident: true,
        event_runnumber_emer: {
          include: {
            event_doc_emer_type: true,
            event_doc_emer_gas_tranmiss: true,
          },
        },
      },
    });
    // tso
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            // user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    // https://app.clickup.com/t/86eum0p1d
      const roleMenuAllocationManagementNoticeEmail =
    await this.prisma.account.findMany({
      where: {
        id: {
          not: 99999,
        },
        account_manage: {
          some: {
            account_role: {
              some: {
                role: {
                  user_type_id: 2,
                  menus_config: {
                    some: {
                      menus_id: 106,
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
      orderBy: {
        id: 'asc',
      },
    });
    // console.log('event_doc_status_id : ', event_doc_status_id);
    // console.log('shipperCreate? : ', shipperCreate);
    // console.log('shipperCreate?.email : ', shipperCreate?.email);
    const shipperEmailArr = event_doc_status_id && shipperCreate?.email && event_doc_status_id !== 5 ? [
      ...(roleMenuAllocationManagementNoticeEmail?.map((e:any) => e?.email)),
      docId?.group?.email ?? null,
      shipperCreate?.email,
    ] : [
      ...(roleMenuAllocationManagementNoticeEmail?.map((e:any) => e?.email)),
      docId?.group?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบการแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/Emergency Difficult Day - Shipper Acknowledge (Doc.3.9)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_emer?.event_nember || ''}</li>
          <li>Type :  ${docId?.event_runnumber_emer?.event_doc_emer_type?.name_en || ''}</li>
          <li>Date :  ${docId?.doc_39_input_date_time_of_the_incident || ''}</li>
          <li>ระบบส่งก๊าซ :  ${docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_id === 5 ? docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other : docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'emergency_difficult_day_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc39PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);
    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst({
        where: { event_document_emer: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc39Find(
        findRunnumber?.id,
        userId,
        null,
        shipperIds,
      );
      console.log('rdoc1Find : ', rdoc1Find);
      // rdoc1Find?.event_runnumber_emer
      console.log(
        'rdoc1Find?.event_runnumber_emer : ',
        rdoc1Find?.event_runnumber_emer,
      );

      const event_document_action = rdoc1Find?.event_document_emer_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_date_time_of_the_incident =
        rdoc1Find?.doc_39_input_date_time_of_the_incident;
      const input_incident =
        rdoc1Find?.doc_39_input_incident;
      const input_detail_incident =
        rdoc1Find?.doc_39_input_detail_incident;
      const input_expected_day_time =
        rdoc1Find?.doc_39_input_expected_day_time;
      const input_note = rdoc1Find?.doc_39_input_note;
      const input_shipper_operation =
        rdoc1Find?.doc_39_input_shipper_operation;
      const input_shipper_note =
        rdoc1Find?.doc_39_input_shipper_note;

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง 1',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },
          {
            text: '(เอกสารด่วน)',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
            color: 'red', // หรือใช้โค้ด HEX เช่น '#FF0000'
          },

          {
            columns: [
              {
                width: 15,
                image:
                  rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id === 1
                    ? logoUsed
                    : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                verticalAlignment: 'middle',
                alignment: 'center',
                fit: [12, 12],
              },
              {
                text: [
                  {
                    text: 'เหตุการณ์ไม่สมดุลอย่างรุนแรง (Difficult Day) ',
                    bold: true,
                    fontSize: 18,
                  },
                ],
                margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                alignment: 'left',
              },
              {
                width: 15,
                image:
                  rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id === 2
                    ? logoUsed
                    : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                verticalAlignment: 'middle',
                alignment: 'center',
                fit: [12, 12],
              },
              {
                text: [
                  {
                    text: 'ภาวะฉุกเฉิน (Emergency) ',
                    bold: true,
                    fontSize: 18,
                  },
                ],
                margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                alignment: 'left',
              },
            ],
            margin: [0, 0, 0, 2],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${group?.name}`,
                      // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ระบบส่งก๊าซ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ระบบส่งก๊าซ',
                        bold: true,
                        // decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 1
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [{ text: 'Onshore East', bold: true }],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                          //
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 2
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [{ text: 'Onshore West', bold: true }],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                          //
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 3
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: 'Onshore East - West',
                            bold: true,
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        // margin: [0, 0, 0, 2],
                      },

                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 4
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: `Other: ${rdoc1Find?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other || ''}`,
                            bold: true,
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        // margin: [0, 0, 0, 2],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ให้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ให้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `เนื่องด้วยในวันที่/เวลา: ${input_date_time_of_the_incident} ได้เกิดเหตุการณ์ไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้`,
                            text: [
                              'เนื่องด้วยในวันที่/เวลา:  ',
                              {
                                text:
                                input_date_time_of_the_incident ? input_date_time_of_the_incident : '____________',
                                decoration: input_date_time_of_the_incident && 'underline',
                              },
                              ' ได้เกิดเหตุการณ์ไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้ ',
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'สถานที่เกิดเหตุ: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            // text: `${input_incident}`,
                            text: [
                              {
                                text:
                                input_incident ? input_incident : '____________',
                                decoration: input_incident && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'รายละเอียดของเหตุการณ์และผลกระทบต่อระบบส่งก๊าซ: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            // text: `${input_detail_incident}`,
                             text: [
                              {
                                text:
                                input_detail_incident ? input_detail_incident : '____________',
                                decoration: input_detail_incident && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'โดยคาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            // text: `${input_expected_day_time}`,
                            text: [
                              {
                                text: input_expected_day_time ? input_expected_day_time : '____________',
                                decoration: input_expected_day_time && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          {
                            text: `หมายเหตุ:`,
                            bold: true,
                            decoration: 'underline',
                            fontSize: 10,
                            // font
                          },
                          {
                            // text: `${input_note}`,
                             text: [
                              {
                                text: input_note ? input_note : '____________',
                                decoration: input_note && 'underline',
                                fontSize: 10,
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `การดำเนินการ: `,
                            bold: true,
                          },
                          {
                            // text: `${input_shipper_operation}`,
                            text: [
                              {
                                text:
                                input_shipper_operation ? input_shipper_operation : '____________',
                                decoration: input_shipper_operation && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `หมายเหตุ: `,
                            bold: true,
                          },
                          {
                            // text: `${input_shipper_note}`,
                             text: [
                              {
                                text:
                                input_shipper_note ? input_shipper_note : '____________',
                                decoration: input_shipper_note && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // https://app.clickup.com/t/86eug8dw2
                      fromSignature
                        ? {
                            columns: [
                              { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                      
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      toSignature
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toFullname ? `( ${toFullname} )` : `(                                   )` },
                      // { text: `รับทราบโดย ${toFullname}` },
                      // toSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${toCompany} (ผู้ใช้บริการ)` },
                      {
                        text: `เวลา : ${toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${toDate.format('DD')} / ${toDate.format('MM')} / ${toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_emer.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });
      // console.log('id : ', id);
      // console.log('getDocShipper : ', getDocShipper);

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      console.log('inputList : ', inputList);
      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst(
          {
            where: { event_document_emer: { some: { id: Number(id) } } },
          },
        );
        console.log('findRunnumber : ', findRunnumber);
        const rdoc1Find = await this.doc39Find(
          findRunnumber?.id,
          userId,
          null,
          group_id,
        );
        console.log('rdoc1Find : ', rdoc1Find);
        // rdoc1Find?.event_runnumber_emer
        console.log(
          'rdoc1Find?.event_runnumber_emer : ',
          rdoc1Find?.event_runnumber_emer,
        );

        const event_document_action = rdoc1Find?.event_document_emer_action;

        const toAction = event_document_action?.find(
          (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const input_date_time_of_the_incident =
          rdoc1Find?.doc_39_input_date_time_of_the_incident;
        const input_incident =
          rdoc1Find?.doc_39_input_incident;
        const input_detail_incident =
          rdoc1Find?.doc_39_input_detail_incident;
        const input_expected_day_time =
          rdoc1Find?.doc_39_input_expected_day_time;
        const input_note =
          rdoc1Find?.doc_39_input_note;
        const input_shipper_operation =
          rdoc1Find?.doc_39_input_shipper_operation;
        const input_shipper_note =
          rdoc1Find?.doc_39_input_shipper_note;

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง 1',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            {
              text: '(เอกสารด่วน)',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
              color: 'red', // หรือใช้โค้ด HEX เช่น '#FF0000'
            },

            {
              columns: [
                {
                  width: 15,
                  image:
                    rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id ===
                    1
                      ? logoUsed
                      : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                  verticalAlignment: 'middle',
                  alignment: 'center',
                  fit: [12, 12],
                },
                {
                  text: [
                    {
                      text: 'เหตุการณ์ไม่สมดุลอย่างรุนแรง (Difficult Day) ',
                      bold: true,
                      fontSize: 18,
                    },
                  ],
                  margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                  alignment: 'left',
                },
                {
                  width: 15,
                  image:
                    rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id ===
                    2
                      ? logoUsed
                      : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                  verticalAlignment: 'middle',
                  alignment: 'center',
                  fit: [12, 12],
                },
                {
                  text: [
                    {
                      text: 'ภาวะฉุกเฉิน (Emergency) ',
                      bold: true,
                      fontSize: 18,
                    },
                  ],
                  margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                  alignment: 'left',
                },
              ],
              margin: [0, 0, 0, 2],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'ส่ง:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${groups?.name}`,
                        // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [`${longdo_dict}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ระบบส่งก๊าซ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: 'ระบบส่งก๊าซ',
                          bold: true,
                          // decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 1
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: [{ text: 'Onshore East', bold: true }],
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                            //
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 2
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: [{ text: 'Onshore West', bold: true }],
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                            //
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 3
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: 'Onshore East - West',
                              bold: true,
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                          ],
                          // margin: [0, 0, 0, 2],
                        },

                        {
                          columns: [
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 4
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: `Other: ${rdoc1Find?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other || ''}`,
                              bold: true,
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                          ],
                          // margin: [0, 0, 0, 2],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ส่วนของผู้ให้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ให้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `เนื่องด้วยในวันที่/เวลา: ${input_date_time_of_the_incident} ได้เกิดเหตุการณ์ไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้`,
                            text: [
                              'เนื่องด้วยในวันที่/เวลา:  ',
                              {
                                text:
                                input_date_time_of_the_incident ? input_date_time_of_the_incident : '____________',
                                decoration: input_date_time_of_the_incident && 'underline',
                              },
                              ' ได้เกิดเหตุการณ์ไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้ ',
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'สถานที่เกิดเหตุ: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            // text: `${input_incident}`,
                            text: [
                              {
                                text:
                                input_incident ? input_incident : '____________',
                                decoration: input_incident && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'รายละเอียดของเหตุการณ์และผลกระทบต่อระบบส่งก๊าซ: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            // text: `${input_detail_incident}`,
                             text: [
                              {
                                text:
                                input_detail_incident ? input_detail_incident : '____________',
                                decoration: input_detail_incident && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'โดยคาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            // text: `${input_expected_day_time}`,
                            text: [
                              {
                                text: input_expected_day_time ? input_expected_day_time : '____________',
                                decoration: input_expected_day_time && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          {
                            text: `หมายเหตุ:`,
                            bold: true,
                            decoration: 'underline',
                            fontSize: 10,
                            // font
                          },
                          {
                            // text: `${input_note}`,
                             text: [
                              {
                                text: input_note ? input_note : '____________',
                                decoration: input_note && 'underline',
                                fontSize: 10,
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `การดำเนินการ: `,
                            bold: true,
                          },
                          {
                            // text: `${input_shipper_operation}`,
                            text: [
                              {
                                text:
                                input_shipper_operation ? input_shipper_operation : '____________',
                                decoration: input_shipper_operation && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `หมายเหตุ: `,
                            bold: true,
                          },
                          {
                            // text: `${input_shipper_note}`,
                             text: [
                              {
                                text:
                                input_shipper_note ? input_shipper_note : '____________',
                                decoration: input_shipper_note && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

            // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // https://app.clickup.com/t/86eug8dw2
                      fromSignature
                        ? {
                            columns: [
                              { text: 'แจ้งโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                      
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      toSignature
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toFullname ? `( ${toFullname} )` : `(                                   )` },
                      // { text: `รับทราบโดย ${toFullname}` },
                      // toSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${toCompany} (ผู้ใช้บริการ)` },
                      {
                        text: `เวลา : ${toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${toDate.format('DD')} / ${toDate.format('MM')} / ${toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
            // characterSpacing: -0.5,
          },
        };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }
      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // doc4

  async doc4EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc4RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber_emer.findMany({
      where: {
        event_document_emer: {
          none: {
            event_doc_master: {
              id: 4,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        event_doc_emer_gas_tranmiss: true,
        event_doc_emer_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_emer: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_emer_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc4Order(userId: any) {
    const resDoc = await this.prisma.event_doc_emer_order.findMany({
      where: {},
      orderBy: {
        id: 'asc',
      },
    });

    return resDoc;
  }

  async doc4Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    // const filtered = resDoc.filter(
    //   (item) =>
    //     !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    // );

    return resDoc;
  }

  async doc4Create(payload: any, userId: any, generated?: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,
      ref_document,

      doc_4_input_date_time_of_the_incident, // doc4 วัน/เวลาที่เกิดเหตุ
      doc_4_input_incident, // doc4 สถานที่เกิดเหตุ
      doc_4_input_detail_incident, // doc4 รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ
      doc_4_input_expected_day_time, // doc4 คาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา
      doc_4_input_note, // doc4 หมายเหตุ

      doc_4_input_order_ir_id, // doc สั่งการ เพิ่ม 1 ลด 2
      doc_4_input_order_io_id, // doc สั่งการ เข้า 3 ออก 4
      doc_4_input_order_other_id, // doc สั่งการ อื่นๆ 5
      doc_4_input_order_other_value, // doc4 อื่นๆ
      doc_4_input_order_value, // doc4 ปริมาณ

      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      longdo_dict,

      generate,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;
      console.log('userTypeId : ', userTypeId);
      console.log('groupId : ', groupId);

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      // generate

      // เช็ค ref ref_document
      const createEventRunnumber = await prisma.event_runnumber_emer.findFirst({
        where: {
          id: Number(ref_document),
        },
        include: {
          event_document_emer: true,
          event_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      const versionUse = createEventRunnumber?.event_document_emer?.filter(
        (f: any) => f?.event_doc_master_id === 4,
      );

      const version =
        versionUse.length === 0
          ? 1
          : Math.max(...versionUse.map((f: any) => f.seq || 0)) + 1;

      const tsoCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        ...(generate
          ? {
              event_runnumber_emer_id: createEventRunnumber?.id,
              event_doc_status_id: generated ? 6 : 2,
              group_id: groupId,
              user_type_id: userTypeId,
              event_doc_master_id: 4,
              ...(doc_4_input_order_ir_id && {
                doc_4_input_order_ir_id: doc_4_input_order_ir_id ?? null,
              }),
              ...(doc_4_input_order_io_id && {
                doc_4_input_order_io_id: doc_4_input_order_io_id ?? null,
              }),
              ...(doc_4_input_order_other_id && {
                doc_4_input_order_other_id: doc_4_input_order_other_id ?? null,
              }),
              update_date: getTodayNowAdd7().toDate(),
              update_date_num: getTodayNowAdd7().unix(),
              update_by: Number(userId),
            }
          : {
              event_runnumber_emer: {
                connect: {
                  id: createEventRunnumber?.id,
                },
              },
              event_doc_status: {
                connect: {
                  id: generated ? 6 : 2,
                },
              },
              group: {
                connect: {
                  id: groupId,
                },
              },
              user_type: {
                connect: {
                  id: userTypeId,
                },
              },
              event_doc_master: {
                connect: {
                  id: 4,
                },
              },
              ...(doc_4_input_order_ir_id && {
                doc_4_input_order_ir: {
                  connect: {
                    id: doc_4_input_order_ir_id ?? null,
                  },
                },
              }),
              ...(doc_4_input_order_io_id && {
                doc_4_input_order_io: {
                  connect: {
                    id: doc_4_input_order_io_id ?? null,
                  },
                },
              }),
              ...(doc_4_input_order_other_id && {
                doc_4_input_order_other: {
                  connect: {
                    id: doc_4_input_order_other_id ?? null,
                  },
                },
              }),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by_account: {
                connect: {
                  id: Number(userId),
                },
              },
            }),
        version_text: `V.${generate ? version - 1 : version}`,
        seq: generate ? version - 1 : version,

        doc_4_input_date_time_of_the_incident:
          doc_4_input_date_time_of_the_incident ?? null,
        doc_4_input_incident: doc_4_input_incident ?? null,
        doc_4_input_detail_incident: doc_4_input_detail_incident ?? null,
        doc_4_input_expected_day_time: doc_4_input_expected_day_time ?? null,
        doc_4_input_note: doc_4_input_note ?? null,
        doc_4_input_order_other_value: doc_4_input_order_other_value ?? null,
        doc_4_input_order_value: doc_4_input_order_value ?? null,

        longdo_dict: longdo_dict ?? null,
      };

      const createEventDocumentUp =
        generate &&
        (await prisma.event_document_emer.updateMany({
          where: {
            event_runnumber_emer_id: Number(ref_document),
            event_doc_master_id: 4,
            ref_document: null,
          },
          data: tsoCreate,
        }));

      const createEventDocument = generate
        ? await prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(ref_document),
              event_doc_master_id: 4,
              ref_document: null,
            },
            include: {
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
            },
          })
        : await prisma.event_document_emer.create({
            data: tsoCreate,
            include: {
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
            },
          });

      if (generate) {
        await prisma.event_document_emer_file.deleteMany({
          where: {
            event_document_emer_id: Number(createEventDocument?.id),
          },
        });

        await prisma.event_document_emer.deleteMany({
          where: {
            ref_document: Number(createEventDocument?.id),
          },
        });

        await prisma.event_document_emer_email_group_for_event.deleteMany({
          where: {
            event_document_emer_id: Number(createEventDocument?.id),
          },
        });
        await prisma.event_document_emer_cc_email.deleteMany({
          where: {
            event_document_emer_id: Number(createEventDocument?.id),
          },
        });
      }

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_emer_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_emer_file.createMany({
          data: fileData,
        });
      }

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: generated ? 6 : 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 4,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      // shipper multi create
      for (let iShipper = 0; iShipper < (shipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ref_document: createEventDocument?.id,
          event_runnumber_emer: {
            connect: {
              id: createEventRunnumber?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: generated ? 6 : 2,
            },
          },
          group: {
            connect: {
              id: shipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 4,
            },
          },

          version_text: `V.${generate ? version - 1 : version}`,
          seq: generate ? version - 1 : version,

          doc_4_input_date_time_of_the_incident:
            doc_4_input_date_time_of_the_incident ?? null,
          doc_4_input_incident: doc_4_input_incident ?? null,
          doc_4_input_detail_incident: doc_4_input_detail_incident ?? null,
          doc_4_input_expected_day_time: doc_4_input_expected_day_time ?? null,
          doc_4_input_note: doc_4_input_note ?? null,
          ...(doc_4_input_order_ir_id && {
            doc_4_input_order_ir: {
              connect: {
                id: doc_4_input_order_ir_id ?? null,
              },
            },
          }),
          ...(doc_4_input_order_io_id && {
            doc_4_input_order_io: {
              connect: {
                id: doc_4_input_order_io_id ?? null,
              },
            },
          }),
          ...(doc_4_input_order_other_id && {
            doc_4_input_order_other: {
              connect: {
                id: doc_4_input_order_other_id ?? null,
              },
            },
          }),
          doc_4_input_order_other_value: doc_4_input_order_other_value ?? null,
          doc_4_input_order_value: doc_4_input_order_value ?? null,

          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_emer.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_emer_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_emer_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: generated ? 6 : 2,
              },
            },
            group: {
              connect: {
                id: shipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 2,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }
      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_emer_id: createEventDocument?.id,
          edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_emer_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_emer_id: createEventDocument?.id,
          email: cc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_emer_cc_email.createMany({
          data: CcEmail,
        }));

      const emailUse = {
        shipper: shipper,
        emailGroup: email_event_for_shipper,
        ccEmail: cc_email,
      };

      return { createEventRunnumber, createEventDocument, emailUse };
    });

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    !generated &&
      !generate &&
      (await this.sendEmailCondition(result?.emailUse, findOnce, payload, 4));

    return findOnce;
  }

  async doc4FindVersion(
    id: any,
    userId: any,
    groupObj?: any,
    shipperIds?: any,
  ) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findMany({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 4,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          })
        : await this.prisma.event_document_emer.findMany({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 4,
              ref_document: null,
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 4,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc4FindDoc(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findFirst({
            where: {
              id: Number(id),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          })
        : await this.prisma.event_document_emer.findFirst({
            where: {
              id: Number(id),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 4,
                      ref_document: Number(id),
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc4Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_doc_status_id,
      doc_4_input_shipper_operation,
      doc_4_input_shipper_note,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_status_id: 2,
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_emer.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          doc_4_input_shipper_operation: doc_4_input_shipper_operation ?? null,
          doc_4_input_shipper_note: doc_4_input_shipper_note ?? null,
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 4,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.emerOnce(result?.eventRunId, userId);

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_emer.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        doc_4_input_date_time_of_the_incident: true,
        event_runnumber_emer: {
          include: {
            event_doc_emer_type: true,
            event_doc_emer_gas_tranmiss: true,
          },
        },
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบออกคำสั่งปรับปริมาณก๊าซจากเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/Emergency Difficult Day - Shipper Acknowledge (Doc.4)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_emer?.event_nember || ''}</li>
          <li>Type :  ${docId?.event_runnumber_emer?.event_doc_emer_type?.name_en || ''}</li>
          <li>Date :  ${docId?.doc_4_input_date_time_of_the_incident || ''}</li>
          <li>ระบบส่งก๊าซ :  ${docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_id === 5 ? docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other : docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'emergency_difficult_day_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc4PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);
    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst({
        where: { event_document_emer: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc4FindDoc(id, userId, null, shipperIds);
      console.log('rdoc1Find : ', rdoc1Find);
      // rdoc1Find?.event_runnumber_emer
      console.log(
        'rdoc1Find?.event_runnumber_emer : ',
        rdoc1Find?.event_runnumber_emer,
      );

      const event_document_action = rdoc1Find?.event_document_emer_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_date_time_of_the_incident =
        rdoc1Find?.doc_4_input_date_time_of_the_incident ||
        '___________________';
      const input_incident =
        rdoc1Find?.doc_4_input_incident || '___________________';
      const input_detail_incident =
        rdoc1Find?.doc_4_input_detail_incident || '___________________';
      const input_expected_day_time =
        rdoc1Find?.doc_4_input_expected_day_time || '___________________';
      const input_note = rdoc1Find?.doc_4_input_note || '___________________';
      const input_order_ir_id = rdoc1Find?.doc_4_input_order_ir_id ?? null;
      const input_order_io_id = rdoc1Find?.doc_4_input_order_io_id ?? null;
      const input_order_other_id =
        rdoc1Find?.doc_4_input_order_other_id ?? null;
      const input_order_other_value =
        rdoc1Find?.doc_4_input_order_other_value || '___________________';
      const input_order_value =
        rdoc1Find?.doc_4_input_order_value || '___________________';

      const input_shipper_operation =
        rdoc1Find?.doc_4_input_shipper_operation || '___________________';
      const input_shipper_note =
        rdoc1Find?.doc_4_input_shipper_note || '___________________';

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง 2',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          {
            text: '(เอกสารด่วน)',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
            color: 'red', // หรือใช้โค้ด HEX เช่น '#FF0000'
          },

          {
            columns: [
              {
                width: 15,
                image:
                  rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id === 1
                    ? logoUsed
                    : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                verticalAlignment: 'middle',
                alignment: 'center',
                fit: [12, 12],
              },
              {
                text: [
                  {
                    text: 'เหตุการณ์ไม่สมดุลอย่างรุนแรง (Difficult Day) ',
                    bold: true,
                    fontSize: 18,
                  },
                ],
                margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                alignment: 'left',
              },
              {
                width: 15,
                image:
                  rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id === 2
                    ? logoUsed
                    : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                verticalAlignment: 'middle',
                alignment: 'center',
                fit: [12, 12],
              },
              {
                text: [
                  {
                    text: 'ภาวะฉุกเฉิน (Emergency) ',
                    bold: true,
                    fontSize: 18,
                  },
                ],
                margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                alignment: 'left',
              },
            ],
            margin: [0, 0, 0, 2],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${group?.name}`,
                      // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ระบบส่งก๊าซ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ระบบส่งก๊าซ',
                        bold: true,
                        // decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 1
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [{ text: 'Onshore East', bold: true }],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                          //
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 2
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: [{ text: 'Onshore West', bold: true }],
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                          //
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 3
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: 'Onshore East - West',
                            bold: true,
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        // margin: [0, 0, 0, 2],
                      },

                      {
                        columns: [
                          {
                            width: 15,
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 4
                                ? logoUsed
                                : logoNotUsed, // แทนด้วย base64 string
                            verticalAlignment: 'middle',
                            alignment: 'center',
                            fit: [12, 12],
                          },
                          {
                            text: `Other: ${rdoc1Find?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other || ''}`,
                            bold: true,
                            margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                            alignment: 'left',
                          },
                        ],
                        // margin: [0, 0, 0, 2],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ให้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ให้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `เนื่องด้วยในวันที่/เวลา: ${input_date_time_of_the_incident} ได้เกิดเหตุการณ์ไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'สถานที่เกิดเหตุ: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            text: `${input_incident}`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            text: `${input_detail_incident}`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: 'โดยคาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา: ',
                            bold: true,
                            // margin: [0, 0, 0, 5],
                          },
                          {
                            text: `${input_expected_day_time}`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: 'ในการนี้ เพื่อควบคุมเหตุการณ์ดังกล่าว ผู้ให้บริการระบบส่งก๊าซ (TSO) จึงออกคำสั่งต่อผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ ดังนี้',
                            // margin: [0, 0, 0, 5],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          // { width: 10, text: `${ix + 1}.` },
                          { text: 'การสั่งการ: - ', width: 'auto' },
                          {
                            image:
                              input_order_ir_id === 1 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'เพิ่ม /' },
                          {
                            image:
                              input_order_ir_id === 2 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'ลด ปริมาณก๊าซที่' },
                          {
                            image:
                              input_order_io_id === 3 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'จุดส่งเข้า/' },
                          {
                            image:
                              input_order_io_id === 4 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'จุดจ่ายออก /' },

                          { width: 'auto', text: 'ปริมาณ: ' },
                          {
                            width: 'auto',
                            text: `${input_order_value || '________'}`,
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          // { width: 10, text: `${ix + 1}.` },
                          { text: 'การสั่งการ: - ', width: 'auto', opacity: 0 },
                          {
                            image:
                              input_order_other_id === 5
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          {
                            width: 'auto',
                            text: `อื่นๆ ${input_order_other_value}`,
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },

                      {
                        text: [
                          {
                            text: `หมายเหตุ:`,
                            bold: true,
                            decoration: 'underline',
                          },
                          {
                            text: `${input_note}`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `การดำเนินการ: `,
                            bold: true,
                          },
                          {
                            text: `${input_shipper_operation}`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `หมายเหตุ: `,
                            bold: true,
                          },
                          {
                            text: `${input_shipper_note}`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      fromSignature
                        ? {
                            columns: [
                              {
                                text: 'แจ้งโดย ', // https://app.clickup.com/t/86eum0p2v
                                width: 'auto',
                                alignment: 'right',
                              },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย ` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                      // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                      rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        ? {
                            columns: [
                              {
                                text: 'รับทราบโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              // { text: ')', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย` },
                      {
                        text:
                          rdoc1Find?.event_doc_status?.id === 5
                            ? `(${toFullname})`
                            : '(…………………………………………………………)',
                      },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                      },
                      {
                        text: `(ผู้ใช้บริการ)`,
                        width: 'auto',
                        alignment: 'center',
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },
          // {
          //   table: {
          //     widths: ['*', '*'],
          //     body: [
          //       [
          //         {
          //           stack: [
          //             { text: `แจ้งโดย ${fromFullname}` },
          //             fromSignature
          //               ? {
          //                   columns: [
          //                     { text: '(', width: 'auto', alignment: 'right' },
          //                     {
          //                       image: fromSignature, // base64 หรือ path
          //                       width: 50,
          //                       alignment: 'center',
          //                     },
          //                     { text: ')', width: 'auto', alignment: 'left' },
          //                   ],
          //                   columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
          //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
          //                 }
          //               : { text: `(                                   )` },
          //             { text: `หน่วยงาน ${fromCompany} (ผู้ใช้บริการ)` },
          //             {
          //               text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
          //             },
          //           ],
          //           margin: [5, 5, 5, 5],
          //         },
          //         {
          //           stack: [
          //             { text: `รับทราบโดย ${toFullname}` },
          //             toSignature
          //               ? {
          //                   columns: [
          //                     { text: '(', width: 'auto', alignment: 'right' },
          //                     {
          //                       image: toSignature, // base64 หรือ path
          //                       width: 50,
          //                       alignment: 'center',
          //                     },
          //                     { text: ')', width: 'auto', alignment: 'left' },
          //                   ],
          //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
          //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
          //                 }
          //               : { text: `(                                   )` },
          //             { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
          //             {
          //               text: `เวลา : ${toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${toDate.format('DD')} / ${toDate.format('MM')} / ${toDate.format('BB')}`,
          //             },
          //           ],
          //           margin: [5, 5, 5, 5],
          //         },
          //       ],
          //     ],
          //   },
          //   layout: {
          //     hLineWidth: () => 0.5,
          //     vLineWidth: () => 0.5,
          //   },
          //   margin: [0, 0, 0, 0],
          // },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_emer.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });

      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst(
          {
            where: { event_document_emer: { some: { id: Number(id) } } },
          },
        );
        console.log('findRunnumber : ', findRunnumber);
        const rdoc1Find = await this.doc4FindDoc(id, userId, null, shipperIds);
        console.log('rdoc1Find : ', rdoc1Find);
        // rdoc1Find?.event_runnumber_emer
        console.log(
          'rdoc1Find?.event_runnumber_emer : ',
          rdoc1Find?.event_runnumber_emer,
        );

        const event_document_action = rdoc1Find?.event_document_emer_action;

        const toAction = event_document_action?.find(
          (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const input_date_time_of_the_incident =
          rdoc1Find?.doc_4_input_date_time_of_the_incident ||
          '___________________';
        const input_incident =
          rdoc1Find?.doc_4_input_incident || '___________________';
        const input_detail_incident =
          rdoc1Find?.doc_4_input_detail_incident || '___________________';
        const input_expected_day_time =
          rdoc1Find?.doc_4_input_expected_day_time || '___________________';
        const input_note = rdoc1Find?.doc_4_input_note || '___________________';
        const input_order_ir_id = rdoc1Find?.doc_4_input_order_ir_id ?? null;
        const input_order_io_id = rdoc1Find?.doc_4_input_order_io_id ?? null;
        const input_order_other_id =
          rdoc1Find?.doc_4_input_order_other_id ?? null;
        const input_order_other_value =
          rdoc1Find?.doc_4_input_order_other_value || '___________________';
        const input_order_value =
          rdoc1Find?.doc_4_input_order_value || '___________________';

        const input_shipper_operation =
          rdoc1Find?.doc_4_input_shipper_operation || '___________________';
        const input_shipper_note =
          rdoc1Find?.doc_4_input_shipper_note || '___________________';

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง 2',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            {
              text: '(เอกสารด่วน)',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
              color: 'red', // หรือใช้โค้ด HEX เช่น '#FF0000'
            },

            {
              columns: [
                {
                  width: 15,
                  image:
                    rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id ===
                    1
                      ? logoUsed
                      : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                  verticalAlignment: 'middle',
                  alignment: 'center',
                  fit: [12, 12],
                },
                {
                  text: [
                    {
                      text: 'เหตุการณ์ไม่สมดุลอย่างรุนแรง (Difficult Day) ',
                      bold: true,
                      fontSize: 18,
                    },
                  ],
                  margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                  alignment: 'left',
                },
                {
                  width: 15,
                  image:
                    rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id ===
                    2
                      ? logoUsed
                      : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                  verticalAlignment: 'middle',
                  alignment: 'center',
                  fit: [12, 12],
                },
                {
                  text: [
                    {
                      text: 'ภาวะฉุกเฉิน (Emergency) ',
                      bold: true,
                      fontSize: 18,
                    },
                  ],
                  margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                  alignment: 'left',
                },
              ],
              margin: [0, 0, 0, 2],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'ส่ง:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${group?.name}`,
                        // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [`${longdo_dict || ''}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ระบบส่งก๊าซ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: 'ระบบส่งก๊าซ',
                          bold: true,
                          // decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 1
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: [{ text: 'Onshore East', bold: true }],
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                            //
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 2
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: [{ text: 'Onshore West', bold: true }],
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                            //
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 3
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: 'Onshore East - West',
                              bold: true,
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                          ],
                          // margin: [0, 0, 0, 2],
                        },

                        {
                          columns: [
                            {
                              width: 15,
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 4
                                  ? logoUsed
                                  : logoNotUsed, // แทนด้วย base64 string
                              verticalAlignment: 'middle',
                              alignment: 'center',
                              fit: [12, 12],
                            },
                            {
                              text: `Other: ${rdoc1Find?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other || ''}`,
                              bold: true,
                              margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                              alignment: 'left',
                            },
                          ],
                          // margin: [0, 0, 0, 2],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ส่วนของผู้ให้บริการ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: 'ส่วนของผู้ให้บริการ',
                          bold: true,
                          decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `เนื่องด้วยในวันที่/เวลา: ${input_date_time_of_the_incident} ได้เกิดเหตุการณ์ไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: 'สถานที่เกิดเหตุ: ',
                              bold: true,
                              // margin: [0, 0, 0, 5],
                            },
                            {
                              text: `${input_incident}`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: 'รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ: ',
                              bold: true,
                              // margin: [0, 0, 0, 5],
                            },
                            {
                              text: `${input_detail_incident}`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: 'โดยคาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา: ',
                              bold: true,
                              // margin: [0, 0, 0, 5],
                            },
                            {
                              text: `${input_expected_day_time}`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: 'ในการนี้ เพื่อควบคุมเหตุการณ์ดังกล่าว ผู้ให้บริการระบบส่งก๊าซ (TSO) จึงออกคำสั่งต่อผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ ดังนี้',
                              // margin: [0, 0, 0, 5],
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            // { width: 10, text: `${ix + 1}.` },
                            { text: 'การสั่งการ: - ', width: 'auto' },
                            {
                              image:
                                input_order_ir_id === 1
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'เพิ่ม /' },
                            {
                              image:
                                input_order_ir_id === 2
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'ลด ปริมาณก๊าซที่' },
                            {
                              image:
                                input_order_io_id === 3
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'จุดส่งเข้า/' },
                            {
                              image:
                                input_order_io_id === 4
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'จุดจ่ายออก /' },

                            { width: 'auto', text: 'ปริมาณ: ' },
                            {
                              width: 'auto',
                              text: `${input_order_value || '________'}`,
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            // { width: 10, text: `${ix + 1}.` },
                            {
                              text: 'การสั่งการ: - ',
                              width: 'auto',
                              opacity: 0,
                            },
                            {
                              image:
                                input_order_other_id === 5
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            {
                              width: 'auto',
                              text: `อื่นๆ ${input_order_other_value}`,
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },

                        {
                          text: [
                            {
                              text: `หมายเหตุ:`,
                              bold: true,
                              decoration: 'underline',
                            },
                            {
                              text: `${input_note}`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ส่วนของผู้ใช้บริการ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: 'ส่วนของผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ',
                          bold: true,
                          decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `การดำเนินการ: `,
                              bold: true,
                            },
                            {
                              text: `${input_shipper_operation}`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `หมายเหตุ: `,
                              bold: true,
                            },
                            {
                              text: `${input_shipper_note}`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบช่องเซ็นชื่อ =========
            {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    {
                      stack: [
                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         { text: '(', width: 'auto', alignment: 'right' },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        fromSignature
                          ? {
                              columns: [
                                {
                                  // text: 'รับทราบโดย',
                                  text: 'แจ้งโดย', // https://app.clickup.com/t/86eum0p2v
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `แจ้งโดย` },
                        { text: fromFullname ? `(${fromFullname})` : `(                                   )` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                      stack: [
                        // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                        // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        rdoc1Find?.event_doc_status?.id === 5 && toSignature
                          ? {
                              columns: [
                                {
                                  text: 'รับทราบโดย',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                                {
                                  image: toSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                // { text: ')', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `รับทราบโดย` },
                        {
                          text:
                            rdoc1Find?.event_doc_status?.id === 5
                              ? `(${toFullname})`
                              : '(…………………………………………………………)',
                        },
                        {
                          text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                        },
                        {
                          text: `(ผู้ใช้บริการ)`,
                          width: 'auto',
                          alignment: 'center',
                        },
                        {
                          text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },
            // {
            //   table: {
            //     widths: ['*', '*'],
            //     body: [
            //       [
            //         {
            //           stack: [
            //             { text: `แจ้งโดย ${fromFullname}` },
            //             fromSignature
            //               ? {
            //                   columns: [
            //                     {
            //                       text: '(',
            //                       width: 'auto',
            //                       alignment: 'right',
            //                     },
            //                     {
            //                       image: fromSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${fromCompany} (ผู้ใช้บริการ)` },
            //             {
            //               text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //         {
            //           stack: [
            //             { text: `รับทราบโดย ${toFullname}` },
            //             toSignature
            //               ? {
            //                   columns: [
            //                     {
            //                       text: '(',
            //                       width: 'auto',
            //                       alignment: 'right',
            //                     },
            //                     {
            //                       image: toSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
            //             {
            //               text: `เวลา : ${toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${toDate.format('DD')} / ${toDate.format('MM')} / ${toDate.format('BB')}`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //       ],
            //     ],
            //   },
            //   layout: {
            //     hLineWidth: () => 0.5,
            //     vLineWidth: () => 0.5,
            //   },
            //   margin: [0, 0, 0, 0],
            // },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
            // characterSpacing: -0.5,
          },
        };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }

      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // doc5 rdoc1Find?.event_doc_status?.id === 2 ? ' ' :

  async doc5EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc5RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber_emer.findMany({
      where: {
        event_document_emer: {
          none: {
            event_doc_master: {
              id: 5,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        event_doc_emer_gas_tranmiss: true,
        event_doc_emer_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_emer: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_emer_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_emer_cc_email:true,
            event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc5Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    // const filtered = resDoc.filter(
    //   (item) =>
    //     !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    // );

    return resDoc;
  }

  async doc5Create(payload: any, userId: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,

      ref_document,

      doc_5_input_ref_doc_at, //อ้างอิงเอกสารเลขที่
      doc_5_input_event_date, //ช่วงเวลาของเหตุการณ์ วันที่
      doc_5_input_event_time, //ช่วงเวลาของเหตุการณ์ เวลา
      doc_5_input_event_summary, //ช่วงเวลาของเหตุการณ์ สรุปการแก้ไขปัญหา

      doc_5_input_summary_gas, //สรุปผลกระทบด้านปริมาณก๊าซ และด้านคุณภาพก๊าซ
      doc_5_input_more_info, //ข้อมูลเพิ่มเติม

      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;
      console.log('userTypeId : ', userTypeId);
      console.log('groupId : ', groupId);

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const tsoCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        event_runnumber_emer: {
          connect: {
            id: Number(ref_document),
          },
        },
        event_doc_status: {
          connect: {
            id: 2,
          },
        },
        group: {
          connect: {
            id: groupId,
          },
        },
        user_type: {
          connect: {
            id: userTypeId,
          },
        },
        event_doc_master: {
          connect: {
            id: 5,
          },
        },

        doc_5_input_ref_doc_at: doc_5_input_ref_doc_at ?? null,
        doc_5_input_event_date:
          (doc_5_input_event_date &&
            getTodayNowAdd7(doc_5_input_event_date).toDate()) ||
          null,
        doc_5_input_event_time: doc_5_input_event_time ?? null,
        doc_5_input_event_summary: doc_5_input_event_summary ?? null,

        doc_5_input_summary_gas: doc_5_input_summary_gas ?? null,
        doc_5_input_more_info: doc_5_input_more_info ?? null,

        longdo_dict: longdo_dict ?? null,

        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      };

      const createEventDocument = await prisma.event_document_emer.create({
        data: tsoCreate,
        include: {
          event_doc_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_emer_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_emer_file.createMany({
          data: fileData,
        });
      }

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 5,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      // shipper multi create
      for (let iShipper = 0; iShipper < (shipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ref_document: createEventDocument?.id,
          event_runnumber_emer: {
            connect: {
              id: Number(ref_document),
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: shipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 5,
            },
          },

          doc_5_input_ref_doc_at: doc_5_input_ref_doc_at ?? null,
          doc_5_input_event_date:
            (doc_5_input_event_date &&
              getTodayNowAdd7(doc_5_input_event_date).toDate()) ||
            null,
          doc_5_input_event_time: doc_5_input_event_time ?? null,
          doc_5_input_event_summary: doc_5_input_event_summary ?? null,

          doc_5_input_summary_gas: doc_5_input_summary_gas ?? null,
          doc_5_input_more_info: doc_5_input_more_info ?? null,

          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_emer.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_emer_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_emer_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: shipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 2,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }
      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_emer_id: createEventDocument?.id,
          edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_emer_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_emer_id: createEventDocument?.id,
          email: cc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_emer_cc_email.createMany({
          data: CcEmail,
        }));

      const emailUse = {
        shipper: shipper,
        emailGroup: email_event_for_shipper,
        ccEmail: cc_email,
      };

      return {
        createEventRunnumber: { id: Number(ref_document) },
        createEventDocument,
        emailUse,
      };
    });

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 5);

    return findOnce;
  }

  async doc5Edit(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { file, shipper, email_event_for_shipper, cc_email } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const getEventDocument = await prisma.event_document_emer.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber_emer: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      // -----

      const tsoCreate = {
        doc_5_input_ref_doc_at:
          getEventDocument?.doc_5_input_ref_doc_at ?? null,
        doc_5_input_event_date:
          getEventDocument?.doc_5_input_event_date ?? null,
        doc_5_input_event_time:
          getEventDocument?.doc_5_input_event_time ?? null,
        doc_5_input_event_summary:
          getEventDocument?.doc_5_input_event_summary ?? null,

        doc_5_input_summary_gas:
          getEventDocument?.doc_5_input_summary_gas ?? null,
        doc_5_input_more_info: getEventDocument?.doc_5_input_more_info ?? null,

        longdo_dict: getEventDocument?.longdo_dict ?? null,
        event_date: getEventDocument?.event_date ?? null,

        // create_date: getTodayNowAdd7().toDate(),
        // create_date_num: getTodayNowAdd7().unix(),
        // create_by_account: {
        //   connect: {
        //     id: Number(userId),
        //   },
        // },
        update_date: getTodayNowAdd7().toDate(),
        update_date_num: getTodayNowAdd7().unix(),
        update_by: Number(userId),
      };

      const updateEventDocument = await prisma.event_document_emer.updateMany({
        where: { id: getEventDocument?.id },
        data: tsoCreate,
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_emer_id: Number(getEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_emer_file.createMany({
          data: fileData,
        });
      }

      const getEventDocumentNew = await prisma.event_document_emer.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber_emer: {
            include: {
              event_document_emer: true,
            },
          },
          event_document_emer_email_group_for_event: {
            include: {
              edit_email_group_for_event: true,
            },
          },
          event_document_emer_cc_email: true,
          group: true,
          user_type: true,

          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });
      // no event_document_action

      // shipper
      // email_event_for_shipper
      // cc_email

      console.log('getEventDocumentNew : ', getEventDocumentNew);
      const nshipper = [];
      for (let inshipper = 0; inshipper < shipper?.length; inshipper++) {
        const findShipper =
          getEventDocumentNew?.event_runnumber_emer?.event_document_emer?.find(
            (f: any) => {
              return (
                f?.group_id === shipper?.[inshipper] &&
                f?.event_doc_master_id === 5
              );
            },
          );
        if (!findShipper) {
          nshipper.push(shipper?.[inshipper]);
        }
      }
      const nemail_event_for_shipper = [];
      for (
        let inemail_event_for_shipper = 0;
        inemail_event_for_shipper < email_event_for_shipper?.length;
        inemail_event_for_shipper++
      ) {
        const findEmail_event_for_shipper =
          getEventDocumentNew?.event_document_emer_email_group_for_event?.find(
            (f: any) => {
              return (
                f?.edit_email_group_for_event?.id ===
                email_event_for_shipper?.[inemail_event_for_shipper]
              );
            },
          );
        if (!findEmail_event_for_shipper) {
          nemail_event_for_shipper.push(
            email_event_for_shipper?.[inemail_event_for_shipper],
          );
        }
      }
      const ncc_email = [];
      for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
        const findCc_email =
          getEventDocumentNew?.event_document_emer_cc_email?.find((f: any) => {
            return f?.email === cc_email[incc_email];
          });
        if (!findCc_email) {
          ncc_email.push(cc_email[incc_email]);
        }
      }

      // shipper multi create
      for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          ref_document: getEventDocumentNew?.id,
          event_runnumber_emer: {
            connect: {
              id: getEventDocumentNew?.event_runnumber_emer_id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: nshipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 5,
            },
          },

          doc_5_input_ref_doc_at:
            getEventDocumentNew?.doc_5_input_ref_doc_at ?? null,
          doc_5_input_event_date:
            getEventDocumentNew?.doc_5_input_event_date ?? null,
          doc_5_input_event_time:
            getEventDocumentNew?.doc_5_input_event_time ?? null,
          doc_5_input_event_summary:
            getEventDocumentNew?.doc_5_input_event_summary ?? null,

          doc_5_input_summary_gas:
            getEventDocumentNew?.doc_5_input_summary_gas ?? null,
          doc_5_input_more_info:
            getEventDocumentNew?.doc_5_input_more_info ?? null,

          longdo_dict: getEventDocumentNew?.longdo_dict ?? null,
          event_date: getEventDocumentNew?.event_date ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_emer.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_emer_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_emer_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: nshipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 5,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }

      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_emer_id: getEventDocumentNew?.id,
          edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_emer_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_emer_id: getEventDocumentNew?.id,
          email: ncc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_emer_cc_email.createMany({
          data: CcEmail,
        }));

      const emailUse = {
        shipper: nshipper,
        emailGroup: nemail_event_for_shipper,
        ccEmail: ncc_email,
      };

      return {
        createEventRunnumber: {
          id: getEventDocumentNew?.event_runnumber_emer_id,
        },
        getEventDocumentNew,
        emailUse,
      };
    });

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.getEventDocumentNew?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 5);

    return findOnce;
  }

  async doc5Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 5,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          })
        : await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 5,
              ref_document: null,
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 5,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc5History(id: any, userId: any, tso: any) {
    const resData = await this.prisma.event_document_emer_log_history.findMany({
      where: {
        ...(tso
          ? {
              event_document_emer: {
                event_runnumber_emer_id: Number(id),
                event_doc_master_id: 5,
              },
            }
          : {
              event_document_emer_id: Number(id),
            }),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  async doc5Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_doc_status_id } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_status_id: 2,
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_emer.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 5,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.emerOnce(result?.eventRunId, userId);

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_emer.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        doc_5_input_event_date: true,
        event_runnumber_emer: {
          include: {
            event_doc_emer_type: true,
            event_doc_emer_gas_tranmiss: true,
          },
        },
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบการแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรงกลับเป็นปกติ`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/Emergency Difficult Day - Shipper Acknowledge (Doc.5)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_emer?.event_nember || ''}</li>
          <li>Type :  ${docId?.event_runnumber_emer?.event_doc_emer_type?.name_en || ''}</li>
          <li>Date :  ${docId?.doc_5_input_event_date || ''}</li>
          <li>ระบบส่งก๊าซ :  ${docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_id === 5 ? docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other : docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'emergency_difficult_day_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc5PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);
    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst({
        where: { event_document_emer: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc5Find(
        findRunnumber?.id,
        userId,
        null,
        shipperIds,
      );
      console.log('rdoc1Find : ', rdoc1Find);
      // rdoc1Find?.event_runnumber_emer
      console.log(
        'rdoc1Find?.event_runnumber_emer : ',
        rdoc1Find?.event_runnumber_emer,
      );

      const event_document_action = rdoc1Find?.event_document_emer_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_ref_doc_at = rdoc1Find?.doc_5_input_ref_doc_at || ''; //อ้างอิงเอกสารเลขที่
      const input_event_date =
        (rdoc1Find?.doc_5_input_event_date &&
          `${dayjs(rdoc1Find?.doc_5_input_event_date).locale('th').format('DD')} ${dayjs(rdoc1Find?.doc_5_input_event_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc_5_input_event_date).locale('th').format('BBBB')}`) ||
        ''; //ช่วงเวลาของเหตุการณ์ วันที่
      const input_event_time = rdoc1Find?.doc_5_input_event_time || ''; //ช่วงเวลาของเหตุการณ์ เวลา
      const input_event_summary = rdoc1Find?.doc_5_input_event_summary || ''; //ช่วงเวลาของเหตุการณ์ สรุปการแก้ไขปัญหา
      const input_summary_gas = rdoc1Find?.doc_5_input_summary_gas || ''; //สรุปผลกระทบด้านปริมาณก๊าซ และด้านคุณภาพก๊าซ
      const input_more_info = rdoc1Find?.doc_5_input_more_info || ''; //ข้อมูลเพิ่มเติม

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง กลับเป็นปกติ 3',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${group?.name}`,
                      // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `อ้างอิงการแจ้งเหตุฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง ตามเอกสารเลขที่ `,
                          },
                          {
                            text: input_ref_doc_at
                              ? `${input_ref_doc_at}`
                              : '_________',
                            decoration: input_ref_doc_at ? 'underline' : '',
                          },
                          {
                            text: ` หลังจากที่ผู้ ให้บริการระบบส่งก๊าซ (TSO) ได้ดำเนินการ เพื่อควบคุมเหตุการณ์ที่เกิดขึ้นจนกลับสู่สภาวะปกติ`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: `เมื่อวันที่ `,
                          },
                          {
                            text: input_event_date
                              ? `${input_event_date}`
                              : '_________',
                            decoration: input_event_date ? 'underline' : '',
                          },
                          {
                            text: ` เวลา `,
                          },
                          {
                            text: input_event_time
                              ? `${input_event_time}`
                              : '_________',
                            decoration: input_event_time ? 'underline' : '',
                          },
                          {
                            text: ` น. จึงขอแจ้งสิ้นสุดคำสั่งต่อผู้ใช้บริการในเอกสารดังกล่าว และให้ผู้ใช้บริการรับ-ส่งก๊าซได้ตามปกติ`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        // alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: `สรุปการแก้ไขปัญหา: `,
                          },
                          {
                            text: input_event_summary
                              ? `${input_event_summary}`
                              : '___________________',
                            decoration: input_event_summary ? 'underline' : '',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        // alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `สรุปผลกระทบด้านปริมาณ และด้านคุณภาพก๊าซ: `,
                          },
                          {
                            text: input_summary_gas
                              ? `${input_summary_gas}`
                              : '___________________',
                            decoration: input_summary_gas ? 'underline' : '',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        // alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: `ข้อมูลเพิ่มเติม: `,
                          },
                          {
                            text: input_more_info
                              ? `${input_more_info}`
                              : '___________________',
                            decoration: input_more_info ? 'underline' : '',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        // alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          // {
          //   table: {
          //     widths: ['*', '*'],
          //     body: [
          //       [
          //         {
          //           stack: [
          //             { text: `แจ้งโดย ${fromFullname}` },
          //             fromSignature
          //               ? {
          //                   columns: [
          //                     { text: '(', width: 'auto', alignment: 'right' },
          //                     {
          //                       image: fromSignature, // base64 หรือ path
          //                       width: 50,
          //                       alignment: 'center',
          //                     },
          //                     { text: ')', width: 'auto', alignment: 'left' },
          //                   ],
          //                   columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
          //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
          //                 }
          //               : { text: `(                                   )` },
          //             { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
          //             {
          //               text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
          //             },
          //           ],
          //           margin: [5, 5, 5, 5],
          //         },
          //         {
          //           stack: [
          //             { text: `รับทราบโดย ${toFullname}` },
          //             toSignature
          //               ? {
          //                   columns: [
          //                     { text: '(', width: 'auto', alignment: 'right' },
          //                     {
          //                       image: toSignature, // base64 หรือ path
          //                       width: 50,
          //                       alignment: 'center',
          //                     },
          //                     { text: ')', width: 'auto', alignment: 'left' },
          //                   ],
          //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
          //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
          //                 }
          //               : { text: `(                                   )` },
          //             { text: `หน่วยงาน ${toCompany} (ผู้ใช้บริการ)` },
          //             {
          //               text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
          //             },
          //           ],
          //           margin: [5, 5, 5, 5],
          //         },
          //       ],
          //     ],
          //   },
          //   layout: {
          //     hLineWidth: () => 0.5,
          //     vLineWidth: () => 0.5,
          //   },
          //   margin: [0, 0, 0, 0],
          // },
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      fromSignature
                        ? {
                            columns: [
                              {
                                text: 'แจ้งโดย ',
                                width: 'auto',
                                alignment: 'right',
                              },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย ` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                      // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                      rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        ? {
                            columns: [
                              {
                                text: 'รับทราบโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              // { text: ')', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย` },
                      {
                        text:
                          rdoc1Find?.event_doc_status?.id === 5
                            ? `(${toFullname})`
                            : '(…………………………………………………………)',
                      },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                      },
                      {
                        text: `(ผู้ใช้บริการ)`,
                        width: 'auto',
                        alignment: 'center',
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_emer.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });
      // console.log('id : ', id);
      // console.log('getDocShipper : ', getDocShipper);

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      console.log('inputList : ', inputList);
      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst(
          {
            where: { event_document_emer: { some: { id: Number(id) } } },
          },
        );
        console.log('findRunnumber : ', findRunnumber);
        const rdoc1Find = await this.doc5Find(
          findRunnumber?.id,
          userId,
          null,
          group_id,
        );
        console.log('rdoc1Find : ', rdoc1Find);
        // rdoc1Find?.event_runnumber_emer
        console.log(
          'rdoc1Find?.event_runnumber_emer : ',
          rdoc1Find?.event_runnumber_emer,
        );

        const event_document_action = rdoc1Find?.event_document_emer_action;

        const toAction = event_document_action?.find(
          (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const input_ref_doc_at = rdoc1Find?.doc_5_input_ref_doc_at || ''; //อ้างอิงเอกสารเลขที่
        const input_event_date =
          (rdoc1Find?.doc_5_input_event_date &&
            `${dayjs(rdoc1Find?.doc_5_input_event_date).locale('th').format('DD')} ${dayjs(rdoc1Find?.doc_5_input_event_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc_5_input_event_date).locale('th').format('BBBB')}`) ||
          ''; //ช่วงเวลาของเหตุการณ์ วันที่
        const input_event_time = rdoc1Find?.doc_5_input_event_time || ''; //ช่วงเวลาของเหตุการณ์ เวลา
        const input_event_summary = rdoc1Find?.doc_5_input_event_summary || ''; //ช่วงเวลาของเหตุการณ์ สรุปการแก้ไขปัญหา
        const input_summary_gas = rdoc1Find?.doc_5_input_summary_gas || ''; //สรุปผลกระทบด้านปริมาณก๊าซ และด้านคุณภาพก๊าซ
        const input_more_info = rdoc1Find?.doc_5_input_more_info || ''; //ข้อมูลเพิ่มเติม

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง กลับเป็นปกติ 3',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'ส่ง:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${groups?.name}`,
                        // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [`${longdo_dict || ''}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `อ้างอิงการแจ้งเหตุฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง ตามเอกสารเลขที่ `,
                            },
                            {
                              text: input_ref_doc_at
                                ? `${input_ref_doc_at}`
                                : '_________',
                              decoration: input_ref_doc_at ? 'underline' : '',
                            },
                            {
                              text: ` หลังจากที่ผู้ ให้บริการระบบส่งก๊าซ (TSO) ได้ดำเนินการ เพื่อควบคุมเหตุการณ์ที่เกิดขึ้นจนกลับสู่สภาวะปกติ`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: `เมื่อวันที่ `,
                            },
                            {
                              text: input_event_date
                                ? `${input_event_date}`
                                : '_________',
                              decoration: input_event_date ? 'underline' : '',
                            },
                            {
                              text: ` เวลา `,
                            },
                            {
                              text: input_event_time
                                ? `${input_event_time}`
                                : '_________',
                              decoration: input_event_time ? 'underline' : '',
                            },
                            {
                              text: ` น. จึงขอแจ้งสิ้นสุดคำสั่งต่อผู้ใช้บริการในเอกสารดังกล่าว และให้ผู้ใช้บริการรับ-ส่งก๊าซได้ตามปกติ`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          // alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: `สรุปการแก้ไขปัญหา: `,
                            },
                            {
                              text: input_event_summary
                                ? `${input_event_summary}`
                                : '___________________',
                              decoration: input_event_summary
                                ? 'underline'
                                : '',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          // alignment: 'justify',
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `สรุปผลกระทบด้านปริมาณ และด้านคุณภาพก๊าซ: `,
                            },
                            {
                              text: input_summary_gas
                                ? `${input_summary_gas}`
                                : '___________________',
                              decoration: input_summary_gas ? 'underline' : '',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          // alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: `ข้อมูลเพิ่มเติม: `,
                            },
                            {
                              text: input_more_info
                                ? `${input_more_info}`
                                : '___________________',
                              decoration: input_more_info ? 'underline' : '',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          // alignment: 'justify',
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบช่องเซ็นชื่อ =========
            // {
            //   table: {
            //     widths: ['*', '*'],
            //     body: [
            //       [
            //         {
            //           stack: [
            //             { text: `แจ้งโดย ${fromFullname}` },
            //             fromSignature
            //               ? {
            //                   columns: [
            //                     { text: '(', width: 'auto', alignment: 'right' },
            //                     {
            //                       image: fromSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
            //             {
            //               text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //         {
            //           stack: [
            //             { text: `รับทราบโดย ${toFullname}` },
            //             toSignature
            //               ? {
            //                   columns: [
            //                     { text: '(', width: 'auto', alignment: 'right' },
            //                     {
            //                       image: toSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${toCompany} (ผู้ใช้บริการ)` },
            //             {
            //               text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //       ],
            //     ],
            //   },
            //   layout: {
            //     hLineWidth: () => 0.5,
            //     vLineWidth: () => 0.5,
            //   },
            //   margin: [0, 0, 0, 0],
            // },
            {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    {
                      stack: [
                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         { text: '(', width: 'auto', alignment: 'right' },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        fromSignature
                          ? {
                              columns: [
                                {
                                  text: 'แจ้งโดย ', // https://app.clickup.com/t/86eum0nzh
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `แจ้งโดย ` },
                        { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                      stack: [
                        // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                        // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        rdoc1Find?.event_doc_status?.id === 5 && toSignature
                          ? {
                              columns: [
                                {
                                  text: 'รับทราบโดย',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                                {
                                  image: toSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                // { text: ')', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `รับทราบโดย` },
                        {
                          text:
                            rdoc1Find?.event_doc_status?.id === 5
                              ? `(${toFullname})`
                              : '(…………………………………………………………)',
                        },
                        {
                          text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                        },
                        {
                          text: `(ผู้ใช้บริการ)`,
                          width: 'auto',
                          alignment: 'center',
                        },
                        {
                          text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
            // characterSpacing: -0.5,
          },
        };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }
      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // doc6

  async doc6EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc6RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber_emer.findMany({
      where: {
        event_document_emer: {
          none: {
            event_doc_master: {
              id: 6,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        event_doc_emer_gas_tranmiss: true,
        event_doc_emer_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_emer: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_emer_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc6Nompoint(userId: any) {
    const todayStart = getTodayStartAdd7().toDate();
    const todayEnd = getTodayEndAdd7().toDate();

    const shipperMaster = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
      },
      orderBy: {
        id: 'desc',
      },
    });
    const nominationPointDam = await this.prisma.nomination_point.findMany({
      where: {
        AND: [
          {
            start_date: {
              lte: todayEnd, // start_date ต้องก่อนหรือเท่ากับสิ้นสุดวันนี้
            },
          },
          {
            OR: [
              { end_date: null }, // ถ้า end_date เป็น null
              { end_date: { gte: todayStart } }, // ถ้า end_date ไม่เป็น null ต้องหลังหรือเท่ากับเริ่มต้นวันนี้
            ],
          },
        ],
      },
      include: {},
      orderBy: {
        id: 'asc',
      },
    });
    const nominationPoint =
      await this.prisma.query_shipper_nomination_file.findMany({
        where: {},
        include: {
          nomination_version: {
            include: {
              nomination_row_json: {
                where: {
                  query_shipper_nomination_type_id: 1,
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          },
        },
        orderBy: {
          id: 'asc',
        },
      });

    const cvnominationPoint = nominationPoint?.map((e: any) => {
      const { id, nomination_code, group_id, nomination_version, ...nE } = e;
      const vs = nomination_version[0];
      const rowJson = vs?.nomination_row_json;
      const nrowJson = rowJson?.map((rJs: any) => {
        return {
          id: rJs?.id ?? null,
          zone_text: rJs?.zone_text ?? null,
          area_text: rJs?.area_text ?? null,
          data_temp:
            (rJs?.data_temp && JSON.parse(rJs?.data_temp)?.[3]) ?? null,
          entry_exit_id: rJs?.entry_exit_id ?? null,
        };
      });
      return {
        id,
        nomination_code,
        group_id,
        nomPoint: nrowJson,
      };
    });

    const fnominationPointDam = nominationPointDam?.map((e: any) => {
      const {
        id,
        nomination_point,
        description,
        entry_exit_id,
        maximum_capacity,
        ...nE
      } = e;

      const filterNom = cvnominationPoint?.filter((f: any) => {
        return (
          f?.nomPoint?.filter((ff: any) => {
            return (
              ff?.data_temp === nomination_point &&
              ff?.entry_exit_id === entry_exit_id
            );
          }).length > 0
        );
      });

      const shipperArr = [
        ...new Set(filterNom?.map((sp: any) => sp?.group_id)),
      ];

      const shipper = shipperArr
        ?.map((sp: any) => {
          const fnShipper = shipperMaster?.find((fSp: any) => fSp?.id === sp);
          return fnShipper ?? null;
        })
        ?.filter((filSp: any) => filSp !== null);

      return {
        id,
        nomination_point,
        description,
        entry_exit_id,
        maximum_capacity,
        shipper: shipper || [],
      };
    });

    return fnominationPointDam;
  }

  async doc6Create(payload: any, userId: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,
      ref_document,

      doc_6_input_ref_doc_at, //อ้างอิงเอกสารเลขที่
      doc_6_input_when_date, //ช่วงเวลาของเหตุการณ์ วันที่
      doc_6_input_when_time, //ช่วงเวลาของเหตุการณ์ เวลา
      doc_6_input_note, // หมายเหตุ
      gas_shipper,

      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(
      async (prisma) => {
        const newDate = getTodayNowAdd7();
        const todayStart = getYearStartAdd7().toDate();
        const todayEnd = getYearEndAdd7().toDate();

        const group = await this.prisma.group.findFirst({
          where: {
            account_manage: {
              some: {
                account_id: Number(userId),
              },
            },
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        });
        const userTypeId = group.user_type?.id;
        const groupId = group?.id;
        console.log('userTypeId : ', userTypeId);
        console.log('groupId : ', groupId);

        if (userTypeId !== 2) {
          //tso create
          throw new HttpException(
            {
              status: HttpStatus.BAD_REQUEST,
              error: 'Uset Type Is NOT MATCH',
            },
            HttpStatus.BAD_REQUEST,
          );
        }

        // เช็ค ref ref_document
        const createEventRunnumber =
          await prisma.event_runnumber_emer.findFirst({
            where: {
              id: Number(ref_document),
            },
            include: {
              event_document_emer: true,
              event_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
            },
          });

        // -----
        console.log('createEventRunnumber : ', createEventRunnumber);

        const tsoCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          event_runnumber_emer: {
            connect: {
              id: createEventRunnumber?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 6,
            },
          },

          doc_6_input_ref_doc_at: doc_6_input_ref_doc_at ?? null, //อ้างอิงเอกสารเลขที่
          doc_6_input_when_date:
            (doc_6_input_when_date &&
              getTodayNowAdd7(doc_6_input_when_date).toDate()) ||
            null, //ช่วงเวลาของเหตุการณ์ วันที่
          doc_6_input_when_time: doc_6_input_when_time ?? null, //ช่วงเวลาของเหตุการณ์ เวลา
          doc_6_input_note: doc_6_input_note ?? null, // หมายเหตุ

          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocument = await prisma.event_document_emer.create({
          data: tsoCreate,
          include: {
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
        });

        // create event_doc_gas_shipper gas_shipper,
        for (let i = 0; i < (gas_shipper?.length ?? 0); i++) {
          if (gas_shipper?.[i]?.id === null) {
            const gas_shipper_create =
              await prisma.event_doc_gas_shipper.create({
                data: {
                  ir: gas_shipper?.[i]?.ir ?? null,
                  // nom_point: gas_shipper?.[i]?.nom_point ?? null,
                  nomination_point: {
                    connect: {
                      id: Number(gas_shipper?.[i]?.nom_point),
                    },
                  },
                  nom_value_mmscfh: gas_shipper?.[i]?.nom_value_mmscfh ?? null,
                  gas_command: gas_shipper?.[i]?.gas_command ?? null,
                  gas_more: gas_shipper?.[i]?.gas_more ?? null,
                  event_document_emer: {
                    connect: {
                      id: Number(createEventDocument?.id),
                    },
                  },
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                },
              });
            for (
              let iShipper = 0;
              iShipper < gas_shipper?.[i]?.shipper?.length;
              iShipper++
            ) {
              const findDocShipper = await prisma.event_document_emer.findFirst(
                {
                  where: {
                    ref_document: createEventDocument?.id,
                    group_id: gas_shipper?.[i]?.shipper?.[iShipper],
                  },
                },
              );
              if (findDocShipper) {
                await prisma.event_doc_gas_shipper_match.create({
                  data: {
                    event_document_emer_id: findDocShipper?.id,
                    event_doc_gas_shipper_id: gas_shipper_create?.id,
                  },
                });
              } else {
                const shipperCreate = {
                  event_date: getTodayNowAdd7(event_date).toDate(),
                  ref_document: createEventDocument?.id,
                  event_runnumber_emer: {
                    connect: {
                      id: createEventRunnumber?.id,
                    },
                  },
                  event_doc_status: {
                    connect: {
                      id: 2,
                    },
                  },
                  group: {
                    connect: {
                      id: gas_shipper?.[i]?.shipper?.[iShipper],
                    },
                  },
                  user_type: {
                    connect: {
                      id: 3,
                    },
                  },
                  event_doc_master: {
                    connect: {
                      id: 6,
                    },
                  },

                  doc_6_input_ref_doc_at: doc_6_input_ref_doc_at ?? null, //อ้างอิงเอกสารเลขที่
                  doc_6_input_when_date:
                    (doc_6_input_when_date &&
                      getTodayNowAdd7(doc_6_input_when_date).toDate()) ||
                    null, //ช่วงเวลาของเหตุการณ์ วันที่
                  doc_6_input_when_time: doc_6_input_when_time ?? null, //ช่วงเวลาของเหตุการณ์ เวลา
                  doc_6_input_note: doc_6_input_note ?? null, // หมายเหตุ

                  longdo_dict: longdo_dict ?? null,

                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                };

                const createEventDocumentShipper =
                  await prisma.event_document_emer.create({
                    data: shipperCreate,
                  });

                await prisma.event_doc_gas_shipper_match.create({
                  data: {
                    event_document_emer_id: createEventDocumentShipper?.id,
                    event_doc_gas_shipper_id: gas_shipper_create?.id,
                  },
                });
              }
            }

            if (gas_shipper?.[i]?.file && gas_shipper?.[i]?.file.length > 0) {
              const fileData = gas_shipper?.[i]?.file?.map((fileItem: any) => {
                return {
                  url: fileItem,
                  event_doc_gas_shipper_id: Number(gas_shipper_create?.id),
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by: Number(userId),
                };
              });
              await prisma.event_doc_gas_shipper_file.createMany({
                data: fileData,
              });
            }
          }
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocument?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: groupId,
              },
            },
            user_type: {
              connect: {
                id: userTypeId,
              },
            },
            event_doc_master: {
              connect: {
                id: 6,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        // -----

        // email_event_for_shipper
        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_emer_id: createEventDocument?.id,
            edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_emer_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_emer_id: createEventDocument?.id,
            email: cc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_emer_cc_email.createMany({
            data: CcEmail,
          }));

        const emailUse = {
          shipper: gas_shipper?.map((gs: any) => gs?.['shipper']).flat(),
          emailGroup: email_event_for_shipper,
          ccEmail: cc_email,
        };

        return { createEventRunnumber, createEventDocument, emailUse };
      },
      {
        timeout: 15000, // เพิ่มเป็น 10 วินาที
        maxWait: 15000, // รอให้ transaction พร้อม
      },
    );

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });
    console.log('emailUse : ', result?.emailUse);
    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 6);

    return findOnce;
  }

  async doc6Edit(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { email_event_for_shipper, cc_email, event_date, gas_shipper } =
      payload;

    const result = await this.prisma.$transaction(
      async (prisma) => {
        const shipperNewIdArr = [];
        const newDate = getTodayNowAdd7();
        const todayStart = getYearStartAdd7().toDate();
        const todayEnd = getYearEndAdd7().toDate();

        const group = await this.prisma.group.findFirst({
          where: {
            account_manage: {
              some: {
                account_id: Number(userId),
              },
            },
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        });
        const userTypeId = group.user_type?.id;
        const groupId = group?.id;

        if (userTypeId !== 2) {
          //tso create
          throw new HttpException(
            {
              status: HttpStatus.BAD_REQUEST,
              error: 'Uset Type Is NOT MATCH',
            },
            HttpStatus.BAD_REQUEST,
          );
        }

        const getEventDocument = await prisma.event_document_emer.findFirst({
          where: {
            id: Number(id),
          },
          include: {
            event_runnumber_emer: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
          },
        });

        const tsoCreate = {
          event_date: getTodayNowAdd7(event_date).toDate() ?? null,

          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        };

        const updateEventDocument = await prisma.event_document_emer.updateMany(
          {
            where: { id: getEventDocument?.id },
            data: tsoCreate,
          },
        );

        const getEventDocumentNew = await prisma.event_document_emer.findFirst({
          where: {
            id: Number(id),
          },
          include: {
            event_runnumber_emer: {
              include: {
                event_document_emer: {
                  include: {
                    event_doc_gas_shipper: {
                      include: {
                        event_doc_gas_shipper_match: {
                          include: {
                            event_document_emer: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_document_emer_email_group_for_event: {
              include: {
                edit_email_group_for_event: true,
              },
            },
            event_document_emer_cc_email: true,
            group: true,
            user_type: true,

            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_doc_gas_shipper_match: {
              include: {
                event_doc_gas_shipper: {
                  include: {
                    event_doc_gas_shipper_file: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper: {
              include: {
                event_doc_gas_shipper_match: {
                  include: {
                    event_document_emer: true,
                    event_doc_gas_shipper: {
                      include: {
                        event_doc_gas_shipper_file: {
                          include: {
                            create_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                            update_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
                event_doc_gas_shipper_file: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                  orderBy: { id: 'desc' },
                },
              },
            },
          },
        });

        // gas_shipper -------

        console.log('getEventDocumentNew : ', getEventDocumentNew);

        // --------s------

        for (let i = 0; i < (gas_shipper?.length ?? 0); i++) {
          if (gas_shipper?.[i]?.id === null) {
            const gas_shipper_create =
              await prisma.event_doc_gas_shipper.create({
                data: {
                  ir: gas_shipper?.[i]?.ir ?? null,
                  // nom_point: gas_shipper?.[i]?.nom_point ?? null,
                  nomination_point: {
                    connect: {
                      id: Number(gas_shipper?.[i]?.nom_point),
                    },
                  },
                  nom_value_mmscfh: gas_shipper?.[i]?.nom_value_mmscfh ?? null,
                  gas_command: gas_shipper?.[i]?.gas_command ?? null,
                  gas_more: gas_shipper?.[i]?.gas_more ?? null,
                  event_document_emer: {
                    connect: {
                      id: Number(getEventDocumentNew?.id),
                    },
                  },
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                },
              });

            for (
              let iShipper = 0;
              iShipper < gas_shipper?.[i]?.shipper?.length;
              iShipper++
            ) {
              const findDocShipper = await prisma.event_document_emer.findFirst(
                {
                  where: {
                    ref_document: getEventDocumentNew?.id,
                    group_id: gas_shipper?.[i]?.shipper?.[iShipper],
                  },
                },
              );
              if (findDocShipper) {
                await prisma.event_doc_gas_shipper_match.create({
                  data: {
                    event_document_emer_id: findDocShipper?.id,
                    event_doc_gas_shipper_id: gas_shipper_create?.id,
                  },
                });
              } else {
                const shipperCreate = {
                  event_date: getTodayNowAdd7(event_date).toDate(),
                  ref_document: getEventDocumentNew?.id,
                  event_runnumber_emer: {
                    connect: {
                      id: getEventDocumentNew?.event_runnumber_emer_id,
                    },
                  },
                  event_doc_status: {
                    connect: {
                      id: 2,
                    },
                  },
                  group: {
                    connect: {
                      id: gas_shipper?.[i]?.shipper?.[iShipper],
                    },
                  },
                  user_type: {
                    connect: {
                      id: 3,
                    },
                  },
                  event_doc_master: {
                    connect: {
                      id: 6,
                    },
                  },

                  doc_6_input_ref_doc_at:
                    getEventDocumentNew?.doc_6_input_ref_doc_at ?? null, //อ้างอิงเอกสารเลขที่
                  doc_6_input_when_date:
                    (getEventDocumentNew?.doc_6_input_when_date &&
                      getTodayNowAdd7(
                        getEventDocumentNew?.doc_6_input_when_date,
                      ).toDate()) ||
                    null, //ช่วงเวลาของเหตุการณ์ วันที่
                  doc_6_input_when_time:
                    getEventDocumentNew?.doc_6_input_when_time ?? null, //ช่วงเวลาของเหตุการณ์ เวลา
                  doc_6_input_note:
                    getEventDocumentNew?.doc_6_input_note ?? null, // หมายเหตุ

                  longdo_dict: getEventDocumentNew?.longdo_dict ?? null,

                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                };

                const createEventDocumentShipper =
                  await prisma.event_document_emer.create({
                    data: shipperCreate,
                  });
                shipperNewIdArr.push(gas_shipper?.[i]?.shipper?.[iShipper]);

                await prisma.event_doc_gas_shipper_match.create({
                  data: {
                    event_document_emer_id: createEventDocumentShipper?.id,
                    event_doc_gas_shipper_id: gas_shipper_create?.id,
                  },
                });
              }
            }

            if (gas_shipper?.[i]?.file && gas_shipper?.[i]?.file.length > 0) {
              const fileData = gas_shipper?.[i]?.file?.map((fileItem: any) => {
                return {
                  url: fileItem,
                  event_doc_gas_shipper_id: Number(gas_shipper_create?.id),
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by: Number(userId),
                };
              });
              await prisma.event_doc_gas_shipper_file.createMany({
                data: fileData,
              });
            }
          } else {
            // update
            const gas_shipper_find =
              await prisma.event_doc_gas_shipper.findFirst({
                where: {
                  id: gas_shipper?.[i]?.id,
                },
              });
            // gas_shipper_find

            // gas_shipper?.[i]?.shipper

            const nshipper = [];
            for (
              let inshipper = 0;
              inshipper < gas_shipper?.[i]?.shipper?.length;
              inshipper++
            ) {
              const findShipper =
                getEventDocumentNew?.event_doc_gas_shipper?.find((f: any) => {
                  return (
                    // f?.group_id === gas_shipper?.[i]?.shipper?.[inshipper] &&
                    f?.id === gas_shipper_find?.id
                  );
                });
              if (
                findShipper &&
                findShipper?.event_doc_gas_shipper_match.length > 0
              ) {
                const findSp = findShipper?.event_doc_gas_shipper_match?.find(
                  (f: any) => {
                    return (
                      f?.event_document_emer?.group_id ===
                      gas_shipper?.[i]?.shipper?.[inshipper]
                    );
                  },
                );
                if (!findSp) {
                  nshipper.push(gas_shipper?.[i]?.shipper?.[inshipper]);
                }
              }
            }
            console.log('nshipper : ', nshipper);

            for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
              const findDocShipper = await prisma.event_document_emer.findFirst(
                {
                  where: {
                    ref_document: getEventDocumentNew?.id,
                    group_id: nshipper?.[iShipper],
                  },
                },
              );
              if (findDocShipper) {
                await prisma.event_doc_gas_shipper_match.create({
                  data: {
                    event_document_emer_id: findDocShipper?.id,
                    event_doc_gas_shipper_id: gas_shipper_find?.id,
                  },
                });
              } else {
                const shipperCreate = {
                  event_date: getTodayNowAdd7(event_date).toDate(),
                  ref_document: getEventDocumentNew?.id,
                  event_runnumber_emer: {
                    connect: {
                      id: getEventDocumentNew?.event_runnumber_emer_id,
                    },
                  },
                  event_doc_status: {
                    connect: {
                      id: 2,
                    },
                  },
                  group: {
                    connect: {
                      id: nshipper?.[iShipper],
                    },
                  },
                  user_type: {
                    connect: {
                      id: 3,
                    },
                  },
                  event_doc_master: {
                    connect: {
                      id: 6,
                    },
                  },

                  doc_6_input_ref_doc_at:
                    getEventDocumentNew?.doc_6_input_ref_doc_at ?? null, //อ้างอิงเอกสารเลขที่
                  doc_6_input_when_date:
                    (getEventDocumentNew?.doc_6_input_when_date &&
                      getTodayNowAdd7(
                        getEventDocumentNew?.doc_6_input_when_date,
                      ).toDate()) ||
                    null, //ช่วงเวลาของเหตุการณ์ วันที่
                  doc_6_input_when_time:
                    getEventDocumentNew?.doc_6_input_when_time ?? null, //ช่วงเวลาของเหตุการณ์ เวลา
                  doc_6_input_note:
                    getEventDocumentNew?.doc_6_input_note ?? null, // หมายเหตุ

                  longdo_dict: getEventDocumentNew?.longdo_dict ?? null,

                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                };

                const createEventDocumentShipper =
                  await prisma.event_document_emer.create({
                    data: shipperCreate,
                  });

                shipperNewIdArr.push(nshipper?.[iShipper]);

                await prisma.event_doc_gas_shipper_match.create({
                  data: {
                    event_document_emer_id: createEventDocumentShipper?.id,
                    event_doc_gas_shipper_id: gas_shipper_find?.id,
                  },
                });
              }
            }

            if (gas_shipper?.[i]?.file && gas_shipper?.[i]?.file.length > 0) {
              const fileData = gas_shipper?.[i]?.file?.map((fileItem: any) => {
                return {
                  url: fileItem,
                  event_doc_gas_shipper_id: Number(gas_shipper_find?.id),
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by: Number(userId),
                };
              });
              await prisma.event_doc_gas_shipper_file.createMany({
                data: fileData,
              });
            }

            // ====
          }
        }

        // -----------

        const nemail_event_for_shipper = [];
        for (
          let inemail_event_for_shipper = 0;
          inemail_event_for_shipper < email_event_for_shipper?.length;
          inemail_event_for_shipper++
        ) {
          const findEmail_event_for_shipper =
            getEventDocumentNew?.event_document_emer_email_group_for_event?.find(
              (f: any) => {
                return (
                  f?.edit_email_group_for_event?.id ===
                  email_event_for_shipper?.[inemail_event_for_shipper]
                );
              },
            );
          if (!findEmail_event_for_shipper) {
            nemail_event_for_shipper.push(
              email_event_for_shipper?.[inemail_event_for_shipper],
            );
          }
        }

        const ncc_email = [];
        for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
          const findCc_email =
            getEventDocumentNew?.event_document_emer_cc_email?.find(
              (f: any) => {
                return f?.email === cc_email[incc_email];
              },
            );
          if (!findCc_email) {
            ncc_email.push(cc_email[incc_email]);
          }
        }

        // email_event_for_shipper
        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_emer_id: getEventDocumentNew?.id,
            edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_emer_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_emer_id: getEventDocumentNew?.id,
            email: ncc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_emer_cc_email.createMany({
            data: CcEmail,
          }));

        // shipperNewIdArr
        const emailUse = {
          shipper: shipperNewIdArr,
          emailGroup: nemail_event_for_shipper,
          ccEmail: ncc_email,
        };

        return {
          createEventRunnumber: {
            id: getEventDocumentNew?.event_runnumber_emer_id,
          },
          getEventDocumentNew,
          emailUse,
        };
      },
      {
        timeout: 15000, // เพิ่มเป็น 15 วินาที
        maxWait: 15000, // รอให้ transaction พร้อม
      },
    );

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.getEventDocumentNew?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    console.log('emailUse : ', result?.emailUse);
    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 6);

    return findOnce;
  }

  async doc6Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;

    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 6,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_match: {
                include: {
                  event_doc_gas_shipper: {
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_file: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                      nomination_point: true,
                    },
                  },
                  event_document_emer: true,
                },
              },
              event_doc_gas_shipper: {
                include: {
                  event_doc_gas_shipper_match: {
                    include: {
                      event_doc_gas_shipper: {
                        include: {
                          event_document_emer: true,
                          event_doc_gas_shipper_file: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_file: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                  nomination_point: true,
                },
              },
            },
          })
        : await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 6,
              ref_document: null,
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 6,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_doc_gas_shipper_match: {
                include: {
                  event_doc_gas_shipper: {
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_file: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                    },
                  },
                  event_document_emer: true,
                },
              },
              event_doc_gas_shipper: {
                include: {
                  event_doc_gas_shipper_match: {
                    include: {
                      event_doc_gas_shipper: {
                        include: {
                          event_document_emer: true,
                          event_doc_gas_shipper_file: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                      event_document_emer: true,
                    },
                  },
                  event_doc_gas_shipper_file: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc6History(id: any, userId: any, tso: any) {
    const resData = await this.prisma.event_document_emer_log_history.findMany({
      where: {
        ...(tso
          ? {
              event_document_emer: {
                event_runnumber_emer_id: Number(id),
                event_doc_master_id: 6,
              },
            }
          : {
              event_document_emer_id: Number(id),
            }),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  async doc6Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_doc_status_id } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_status_id: 2,
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_emer.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 6,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.emerOnce(result?.eventRunId, userId);

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_emer.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        doc_6_input_when_date: true,
        event_runnumber_emer: {
          include: {
            event_doc_emer_type: true,
            event_doc_emer_gas_tranmiss: true,
          },
        },
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบการแจ้งสรุปการปรับปริมาณก๊าซ`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/Emergency Difficult Day - Shipper Acknowledge (Doc.6)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_emer?.event_nember || ''}</li>
          <li>Type :  ${docId?.event_runnumber_emer?.event_doc_emer_type?.name_en || ''}</li>
          <li>Date :  ${docId?.doc_6_input_when_date || ''}</li>
          <li>ระบบส่งก๊าซ :  ${docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_id === 5 ? docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other : docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'emergency_difficult_day_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc6PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);

    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst({
        where: { event_document_emer: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc6Find(
        findRunnumber?.id,
        userId,
        null,
        shipperIds,
      );
      console.log('rdoc1Find : ', rdoc1Find);
      // rdoc1Find?.event_runnumber_emer
      console.log(
        'rdoc1Find?.event_runnumber_emer : ',
        rdoc1Find?.event_runnumber_emer,
      );

      const event_document_action = rdoc1Find?.event_document_emer_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_ref_doc_at = rdoc1Find?.doc_6_input_ref_doc_at || ''; //อ้างอิงเอกสารเลขที่
      const input_when_date =
        (rdoc1Find?.doc_6_input_when_date &&
          `${dayjs(rdoc1Find?.doc_6_input_when_date).locale('th').format('DD')} ${dayjs(rdoc1Find?.doc_6_input_when_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc_6_input_when_date).locale('th').format('BBBB')}`) ||
        ''; //ช่วงเวลาของเหตุการณ์ วันที่
      const input_when_time = rdoc1Find?.doc_6_input_when_time || ''; //ช่วงเวลาของเหตุการณ์ เวลา
      const input_note = rdoc1Find?.doc_6_input_note || ''; //หมายเหตุ

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      // gas_shipper[] gas_command สั่งการ
      // const input_more_info = rdoc1Find?.doc_5_input_more_info || '___________________'; //ข้อมูลเพิ่มเติม gas_shipper[] gas_more

      // rdoc1Find?.event_doc_gas_shipper_match
      // groupId
      const gasShipper = rdoc1Find?.event_doc_gas_shipper_match
        ?.filter((f: any) => {
          return f?.event_document_emer?.group_id === groupId;
        })
        ?.map((gs: any) => gs?.event_doc_gas_shipper);

      const irShipper = Array.from({ length: 5 }, (_, i) => i)?.map(
        (ir: any, ix: number) => {
          const datas = gasShipper?.[ix] ?? null;
          return {
            columns: [
              { width: 'auto', text: `space`, opacity: 0 },
              { width: 10, text: `${ix + 1}.` },
              {
                image: datas?.ir === 1 ? logoUsed : logoNotUsed,
                width: 12,
                height: 12,
                margin: [0, 0, 3, 0],
              },
              { width: 'auto', text: 'เพิ่ม /' },
              {
                image: datas?.ir === 2 ? logoUsed : logoNotUsed,
                width: 12,
                height: 12,
                margin: [0, 0, 3, 0],
              },
              { width: 'auto', text: 'ลด' },
              { width: 'auto', text: 'ปริมาณก๊าซที่' },
              {
                width: 'auto',
                text: datas?.nomination_point?.nomination_point
                  ? `${datas?.nomination_point?.nomination_point}`
                  : '________',
                decoration: datas?.nomination_point?.nomination_point
                  ? 'underline'
                  : '',
              },
              { width: 'auto', text: 'คิดเป็นปริมาณ:' },
              {
                width: 'auto',
                text: datas?.nom_value_mmscfh
                  ? `${datas?.nom_value_mmscfh} MMSCFH`
                  : '________' + ' MMSCFH',
                decoration: datas?.nom_value_mmscfh ? 'underline' : '',
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };
        },
      );

      const ir6Shipper =
        gasShipper?.map((ir: any, ix: number) => {
          return {
            columns: [
              { width: 'auto', text: `space___`, opacity: 0 },
              {
                width: 'auto',
                text: `${ix + 1} ${ir?.gas_command}`,
                decoration: 'underline',
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };
        }) || [];

      const ir6ShipperMore =
        gasShipper?.map((ir: any, ix: number) => {
          return {
            columns: [
              { width: 'auto', text: `space___`, opacity: 0 },
              {
                width: 'auto',
                text: `${ix + 1} ${ir?.gas_more}`,
                decoration: 'underline',
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };
        }) || [];

      console.log('gasShipper : ', gasShipper);
      console.log('groupId : ', groupId);

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งสรุปการปรับปริมาณก๊าซ',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${group?.name}`,
                      // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ส่วนของผู้ให้บริการ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: 'ส่วนของผู้ให้บริการ',
                        bold: true,
                        decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `เนื่องด้วยเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง ในวันที่/เวลา: `,
                          },
                          {
                            text: input_when_date
                              ? `${input_when_date}`
                              : '_______________',
                            decoration: input_when_date ? 'underline' : '',
                          },
                          {
                            text: ` เวลา `,
                          },
                          {
                            text: input_when_time
                              ? `${input_when_time}`
                              : '_______________',
                            decoration: input_when_time ? 'underline' : '',
                          },
                          {
                            text: ` ซึ่งมีรายละเอียดดังเอกสารเลขที่ `,
                          },
                          {
                            text: input_ref_doc_at
                              ? `${input_ref_doc_at}`
                              : '_______________',
                            decoration: input_ref_doc_at ? 'underline' : '',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `ทั้งนี้เพื่อควบคุมสถานการณ์ และรักษาความมั่นคงปลอดภัยของระบบส่งก๊าซ ผู้ให้บริการระบบส่งก๊าซ (TSO) จึงออกคำสั่งต่อผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ ดังต่อไปนี้`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      ...irShipper,
                      {
                        columns: [
                          { width: 'auto', text: `space`, opacity: 0 },
                          { width: 'auto', text: `6. การสั่งการอื่นๆ : ` },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      ...ir6Shipper,
                      {
                        text: [
                          {
                            text: `หมายเหตุ: `,
                            bold: true,
                            decoration: 'underline',
                          },
                          {
                            text: ` `,
                          },
                          {
                            text: input_note
                              ? `${input_note}`
                              : '_______________',
                            decoration: input_note ? 'underline' : '',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          {
                            text: `ข้อมูลเพิ่มเติม (ถ้ามี) : `,
                            bold: true,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      ...ir6ShipperMore,
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          // {
          //   table: {
          //     widths: ['*', '*'],
          //     body: [
          //       [
          //         {
          //           stack: [
          //             { text: `แจ้งโดย ${fromFullname}` },
          //             fromSignature
          //               ? {
          //                   columns: [
          //                     { text: '(', width: 'auto', alignment: 'right' },
          //                     {
          //                       image: fromSignature, // base64 หรือ path
          //                       width: 50,
          //                       alignment: 'center',
          //                     },
          //                     { text: ')', width: 'auto', alignment: 'left' },
          //                   ],
          //                   columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
          //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
          //                 }
          //               : { text: `(                                   )` },
          //             { text: `หน่วยงาน ${fromCompany} (ผู้ใช้บริการ)` },
          //             {
          //               text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
          //             },
          //           ],
          //           margin: [5, 5, 5, 5],
          //         },
          //         {
          //           stack: [
          //             { text: `รับทราบโดย ${toFullname}` },
          //             toSignature
          //               ? {
          //                   columns: [
          //                     { text: '(', width: 'auto', alignment: 'right' },
          //                     {
          //                       image: toSignature, // base64 หรือ path
          //                       width: 50,
          //                       alignment: 'center',
          //                     },
          //                     { text: ')', width: 'auto', alignment: 'left' },
          //                   ],
          //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
          //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
          //                 }
          //               : { text: `(                                   )` },
          //             { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
          //             {
          //               text: `เวลา : ${toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${toDate.format('DD')} / ${toDate.format('MM')} / ${toDate.format('BB')}`,
          //             },
          //           ],
          //           margin: [5, 5, 5, 5],
          //         },
          //       ],
          //     ],
          //   },
          //   layout: {
          //     hLineWidth: () => 0.5,
          //     vLineWidth: () => 0.5,
          //   },
          //   margin: [0, 0, 0, 0],
          // },

          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      fromSignature
                        ? {
                            columns: [
                              {
                                text: 'รับทราบโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `(                                   )` },
                      { text: `(${fromFullname})` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                      // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                      rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        ? {
                            columns: [
                              {
                                text: 'รับทราบโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              // { text: ')', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย` },
                      {
                        text:
                          rdoc1Find?.event_doc_status?.id === 5
                            ? `(${toFullname})`
                            : '(…………………………………………………………)',
                      },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                      },
                      {
                        text: `(ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ/ผู้เกี่ยวข้อง)`,
                        width: 'auto',
                        alignment: 'center',
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_emer.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });
      // console.log('id : ', id);
      // console.log('getDocShipper : ', getDocShipper);

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      console.log('inputList : ', inputList);
      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst(
          {
            where: { event_document_emer: { some: { id: Number(id) } } },
          },
        );
        console.log('findRunnumber : ', findRunnumber);
        const rdoc1Find = await this.doc6Find(
          findRunnumber?.id,
          userId,
          null,
          group_id,
        );
        console.log('rdoc1Find : ', rdoc1Find);
        // rdoc1Find?.event_runnumber_emer
        console.log(
          'rdoc1Find?.event_runnumber_emer : ',
          rdoc1Find?.event_runnumber_emer,
        );

        const event_document_action = rdoc1Find?.event_document_emer_action;

        const toAction = event_document_action?.find(
          (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const input_ref_doc_at = rdoc1Find?.doc_6_input_ref_doc_at || ''; //อ้างอิงเอกสารเลขที่
        const input_when_date =
          (rdoc1Find?.doc_6_input_when_date &&
            `${dayjs(rdoc1Find?.doc_6_input_when_date).locale('th').format('DD')} ${dayjs(rdoc1Find?.doc_6_input_when_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc_6_input_when_date).locale('th').format('BBBB')}`) ||
          ''; //ช่วงเวลาของเหตุการณ์ วันที่
        const input_when_time = rdoc1Find?.doc_6_input_when_time || ''; //ช่วงเวลาของเหตุการณ์ เวลา
        const input_note = rdoc1Find?.doc_6_input_note || ''; //หมายเหตุ

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        // gas_shipper[] gas_command สั่งการ
        // const input_more_info = rdoc1Find?.doc_5_input_more_info || '___________________'; //ข้อมูลเพิ่มเติม gas_shipper[] gas_more

        // rdoc1Find?.event_doc_gas_shipper_match
        // groupId
        const gasShipper = rdoc1Find?.event_doc_gas_shipper_match
          ?.filter((f: any) => {
            return f?.event_document_emer?.group_id === groupId;
          })
          ?.map((gs: any) => gs?.event_doc_gas_shipper);

        const irShipper = Array.from({ length: 5 }, (_, i) => i)?.map(
          (ir: any, ix: number) => {
            const datas = gasShipper?.[ix] ?? null;
            return {
              columns: [
                { width: 'auto', text: `space`, opacity: 0 },
                { width: 10, text: `${ix + 1}.` },
                {
                  image: datas?.ir === 1 ? logoUsed : logoNotUsed,
                  width: 12,
                  height: 12,
                  margin: [0, 0, 3, 0],
                },
                { width: 'auto', text: 'เพิ่ม /' },
                {
                  image: datas?.ir === 2 ? logoUsed : logoNotUsed,
                  width: 12,
                  height: 12,
                  margin: [0, 0, 3, 0],
                },
                { width: 'auto', text: 'ลด' },
                { width: 'auto', text: 'ปริมาณก๊าซที่' },
                {
                  width: 'auto',
                  text: datas?.nomination_point?.nomination_point
                    ? `${datas?.nomination_point?.nomination_point}`
                    : '________',
                  decoration: datas?.nomination_point?.nomination_point
                    ? 'underline'
                    : '',
                },
                { width: 'auto', text: 'คิดเป็นปริมาณ:' },
                {
                  width: 'auto',
                  text: datas?.nom_value_mmscfh
                    ? `${datas?.nom_value_mmscfh} MMSCFH`
                    : '________' + ' MMSCFH',
                  decoration: datas?.nom_value_mmscfh ? 'underline' : '',
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };
          },
        );

        const ir6Shipper =
          gasShipper?.map((ir: any, ix: number) => {
            return {
              columns: [
                { width: 'auto', text: `space___`, opacity: 0 },
                {
                  width: 'auto',
                  text: `${ix + 1} ${ir?.gas_command}`,
                  decoration: 'underline',
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };
          }) || [];

        const ir6ShipperMore =
          gasShipper?.map((ir: any, ix: number) => {
            return {
              columns: [
                { width: 'auto', text: `space___`, opacity: 0 },
                {
                  width: 'auto',
                  text: `${ix + 1} ${ir?.gas_more}`,
                  decoration: 'underline',
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };
          }) || [];

        console.log('gasShipper : ', gasShipper);
        console.log('groupId : ', groupId);

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งสรุปการปรับปริมาณก๊าซ',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'ส่ง:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${groups?.name}`,
                        // 'โรงไฟฟ้าพลังความร้อนร่วมบางปะกงชุดที่ 1 (BPK-C1)',
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [`${longdo_dict}`],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ส่วนของผู้ให้บริการ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: 'ส่วนของผู้ให้บริการ',
                          bold: true,
                          decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `เนื่องด้วยเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง ในวันที่/เวลา: `,
                            },
                            {
                              text: input_when_date
                                ? `${input_when_date}`
                                : '_______________',
                              decoration: input_when_date ? 'underline' : '',
                            },
                            {
                              text: ` เวลา `,
                            },
                            {
                              text: input_when_time
                                ? `${input_when_time}`
                                : '_______________',
                              decoration: input_when_time ? 'underline' : '',
                            },
                            {
                              text: ` ซึ่งมีรายละเอียดดังเอกสารเลขที่ `,
                            },
                            {
                              text: input_ref_doc_at
                                ? `${input_ref_doc_at}`
                                : '_______________',
                              decoration: input_ref_doc_at ? 'underline' : '',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `ทั้งนี้เพื่อควบคุมสถานการณ์ และรักษาความมั่นคงปลอดภัยของระบบส่งก๊าซ ผู้ให้บริการระบบส่งก๊าซ (TSO) จึงออกคำสั่งต่อผู้ใช้บริการ / คู่สัญญาของผู้ใช้บริการ ดังต่อไปนี้`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        ...irShipper,
                        {
                          columns: [
                            { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `6. การสั่งการอื่นๆ : ` },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        ...ir6Shipper,
                        {
                          text: [
                            {
                              text: `หมายเหตุ: `,
                              bold: true,
                              decoration: 'underline',
                            },
                            {
                              text: ` `,
                            },
                            {
                              text: input_note
                                ? `${input_note}`
                                : '_______________',
                              decoration: input_note ? 'underline' : '',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            {
                              text: `ข้อมูลเพิ่มเติม (ถ้ามี) : `,
                              bold: true,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        ...ir6ShipperMore,
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบช่องเซ็นชื่อ =========
            // {
            //   table: {
            //     widths: ['*', '*'],
            //     body: [
            //       [
            //         {
            //           stack: [
            //             { text: `แจ้งโดย ${fromFullname}` },
            //             fromSignature
            //               ? {
            //                   columns: [
            //                     { text: '(', width: 'auto', alignment: 'right' },
            //                     {
            //                       image: fromSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${fromCompany} (ผู้ใช้บริการ)` },
            //             {
            //               text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //         {
            //           stack: [
            //             { text: `รับทราบโดย ${toFullname}` },
            //             toSignature
            //               ? {
            //                   columns: [
            //                     { text: '(', width: 'auto', alignment: 'right' },
            //                     {
            //                       image: toSignature, // base64 หรือ path
            //                       width: 50,
            //                       alignment: 'center',
            //                     },
            //                     { text: ')', width: 'auto', alignment: 'left' },
            //                   ],
            //                   columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
            //                   margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
            //                 }
            //               : { text: `(                                   )` },
            //             { text: `หน่วยงาน ${toCompany} (ผู้ให้บริการ)` },
            //             {
            //               text: `เวลา : ${toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${toDate.format('DD')} / ${toDate.format('MM')} / ${toDate.format('BB')}`,
            //             },
            //           ],
            //           margin: [5, 5, 5, 5],
            //         },
            //       ],
            //     ],
            //   },
            //   layout: {
            //     hLineWidth: () => 0.5,
            //     vLineWidth: () => 0.5,
            //   },
            //   margin: [0, 0, 0, 0],
            // },

            {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    {
                      stack: [
                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         { text: '(', width: 'auto', alignment: 'right' },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        fromSignature
                          ? {
                              columns: [
                                {
                                  text: 'รับทราบโดย',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `(                                   )` },
                        { text: `(${fromFullname})` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                      stack: [
                        // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                        // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        rdoc1Find?.event_doc_status?.id === 5 && toSignature
                          ? {
                              columns: [
                                {
                                  text: 'รับทราบโดย',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                                {
                                  image: toSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                // { text: ')', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `รับทราบโดย` },
                        {
                          text:
                            rdoc1Find?.event_doc_status?.id === 5
                              ? `(${toFullname})`
                              : '(…………………………………………………………)',
                        },
                        {
                          text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                        },
                        {
                          text: `(ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ/ผู้เกี่ยวข้อง)`,
                          width: 'auto',
                          alignment: 'center',
                        },
                        {
                          text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
            // characterSpacing: -0.5,
          },
        };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }
      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // ofo

  ofoEventType() {
    return this.prisma.event_doc_ofo_type.findMany({ orderBy: { id: 'asc' } });
  }

  ofoEventTermission() {
    return this.prisma.event_doc_ofo_gas_tranmiss.findMany({
      orderBy: { id: 'asc' },
    });
  }

  ofoEventStatus() {
    return this.prisma.event_status.findMany({ orderBy: { id: 'asc' } });
  }

  ofoEventDocStatus() {
    return this.prisma.event_doc_status.findMany({
      orderBy: { id: 'asc' },
      where: {
        id: {
          in: [3, 4, 5, 6],
        },
      },
    });
  }

  async ofoUpdateStatus(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_status_id } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId === 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_runnumber_ofo.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_status_id: event_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      const eventRunId = await prisma.event_runnumber_ofo.findFirst({
        where: {
          id: Number(id),
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.ofoOnce(result?.eventRunId, userId);

    return findOnce;
  }

  async ofoOnce(id: any, userId: any) {
    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const groupId = group?.id;
    const result = await this.prisma.event_runnumber_ofo.findFirst({
      where: {
        id: Number(id),
      },
      include: {
        event_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_doc_ofo_type: true,
        event_doc_ofo_gas_tranmiss: true,
        event_document_ofo: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_ofo_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_ofo_file_pdf: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            },
            event_document_ofo_action: {
              include: {
                event_doc_master: true,
                event_doc_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: {
                id: 'desc',
              },
            },
            event_doc_gas_shipper_ofo_match: {
              include: {
                event_document_ofo: true,
                event_doc_gas_shipper_ofo: {
                  include: {
                    event_doc_gas_shipper_ofo_file: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },

            event_doc_gas_shipper_ofo: {
              include: {
                event_doc_gas_shipper_ofo_match: {
                  include: {
                    event_document_ofo: true,
                    event_doc_gas_shipper_ofo: {
                      include: {
                        event_doc_gas_shipper_ofo_file: {
                          include: {
                            create_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                            update_by_account: {
                              select: {
                                id: true,
                                email: true,
                                first_name: true,
                                last_name: true,
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                },
                event_doc_gas_shipper_ofo_file: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                },
              },
            },
          },
        },
      },
    });
    const rData = this.ofoMapDataEvent(result, result?.user_type_id, groupId);
    return rData;
  }

  async ofoAll(query: any, userId: any) {
    console.log('userId : ', userId);
    const {
      eventCode,
      eventDateFrom,
      eventDateTo,
      EventStatus,
      offset,
      limit,
      event_doc_ofo_type_id
    } = query;

    const limit_ = Number(limit);
    const offset_ = Number(offset);
    console.log('eventDateFrom : ', eventDateFrom);
    console.log('eventDateTo : ', eventDateTo);
    console.log('limit_ : ', limit_);
    console.log('offset_ : ', offset_);

    const group = await this.prisma.group.findFirst({
      where: {
        account_manage: {
          some: {
            account_id: Number(userId),
          },
        },
      },
      select: {
        id: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group.user_type?.id;
    const groupId = group?.id;

    const eventDateCondition =
      !!eventDateFrom && !!eventDateTo
        ? {
            event_date: {
              gte: getTodayNowYYYYMMDDDfaultAdd7(eventDateFrom).toDate(),
              lte: getTodayNowYYYYMMDDDfaultAdd7(eventDateTo)
                .endOf('day')
                .toDate(),
            },
          }
        : eventDateFrom
          ? {
              event_date: {
                gte: getTodayNowYYYYMMDDDfaultAdd7(eventDateFrom).toDate(),
              },
            }
          : eventDateTo
            ? {
                event_date: {
                  lte: getTodayNowYYYYMMDDDfaultAdd7(eventDateTo)
                    .endOf('day')
                    .toDate(),
                },
              }
            : {};

    const result = await this.prisma.event_runnumber_ofo.findMany({
      where: {
        ...(userTypeId === 3 && {
          OR: [
            { group_id: groupId },
            { event_document_ofo: { some: { group_id: groupId } } },
          ],
        }),

        event_nember: {
          contains: eventCode && eventCode?.toUpperCase() || "",
        },
        ...(EventStatus && {
          event_status_id: Number(EventStatus),
        }),
        ...eventDateCondition,
        ...(event_doc_ofo_type_id && {
          event_doc_ofo_type_id: Number(event_doc_ofo_type_id)
        }),
      },
      skip: Number(offset_),
      take: Number(limit_),
      include: {
        event_status: true,
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_doc_ofo_type: true,
        event_doc_ofo_gas_tranmiss: true,
        event_document_ofo: {
          include: {
            event_doc_master: true,
            event_doc_status: true,
            group: true,
            user_type: true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_ofo_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
            event_document_ofo_file_pdf: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            },
            event_document_ofo_action: {
              include: {
                event_doc_master: true,
                event_doc_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: {
                id: 'desc',
              },
            },
            event_doc_gas_shipper_ofo_match: {
              include: {
                event_doc_gas_shipper_ofo: {
                  include: {
                    event_doc_gas_shipper_ofo_file: {
                      include: {
                        create_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                        update_by_account: {
                          select: {
                            id: true,
                            email: true,
                            first_name: true,
                            last_name: true,
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
            event_doc_gas_shipper_ofo: {
              include: {
                event_doc_gas_shipper_ofo_file: {
                  include: {
                    create_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                    update_by_account: {
                      select: {
                        id: true,
                        email: true,
                        first_name: true,
                        last_name: true,
                      },
                    },
                  },
                },
              },
            },
          },
        },
      },
      orderBy: [{ create_date: 'desc' }, { id: 'desc' }],
    });

    console.log(result.map((r) => r.id));

    console.log('eventDateCondition : ', eventDateCondition);

    const newData = result?.map((e: any) => {
      const rData = this.ofoMapDataEvent(e, userTypeId, groupId);
      return rData;
    });

    const frData =
      userTypeId === 3
        ? newData?.filter((f: any) => {
            return f?.document7 !== null;
          })
        : newData;

    const calcLength = Math.abs(frData.length - newData.length);

    const count = await this.prisma.event_runnumber_ofo.count({
      where: {
        ...(userTypeId === 3 && {
          OR: [
            { group_id: groupId },
            { event_document_ofo: { some: { group_id: groupId } } },
          ],
        }),
        event_nember: {
          contains: eventCode && eventCode?.toUpperCase() || "",
        },
        ...(EventStatus && {
          event_status_id: Number(EventStatus),
        }),
        ...eventDateCondition,
        ...(event_doc_ofo_type_id && {
          event_doc_ofo_type_id: Number(event_doc_ofo_type_id)
        }),
      },
    });

    return {
      total: count - calcLength,
      data: frData,
    };
  }

  ofoMapDataEvent(e: any, userTypeId: any, groupId?: any) {
    const { event_document_ofo, ...nE } = e;
    let document7 = null;
    let document8 = null;

    let document7TSOID = null;
    let document7TSOOBJ = null;
    let document8TSOID = null;
    let document8TSOOBJ = null;
    // console.log('event_document : ', event_document);

    if (userTypeId === 3) {
      // shipper
      const document4CkGen = event_document_ofo?.find(
        (f: any) =>
          f?.event_doc_master_id === 4 &&
          f?.group_id === groupId &&
          f?.event_doc_status_id === 6, // เป็น obj 1
      );

      document7 = document4CkGen
        ? []
        : event_document_ofo?.filter(
            (f: any) => f?.event_doc_master_id === 7 && f?.group_id === groupId, // เป็น obj 1
          );

      document8 = event_document_ofo?.find(
        (f: any) => f?.event_doc_master_id === 8 && f?.group_id === groupId, // เป็น obj 1
      );
    } else {
      // tso | อื่นๆ

      document7 = event_document_ofo?.filter(
        (f: any) => f?.event_doc_master_id === 7 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );
      const document7TSOID_ =
        event_document_ofo?.filter(
          (f: any) => f?.event_doc_master_id === 7 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
        ) || [];

      document7TSOID = document7TSOID_[document7TSOID_.length - 1]?.id;
      document7TSOOBJ = document7TSOID_[document7TSOID_.length - 1];

      document8 = event_document_ofo?.filter(
        (f: any) => f?.event_doc_master_id === 8 && f?.ref_document !== null, // เป็น [] shipper only สำหรับนับ
      );

      document8TSOID = event_document_ofo?.find(
        (f: any) => f?.event_doc_master_id === 8 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
      )?.id;

      document8TSOOBJ = event_document_ofo?.find(
        (f: any) => f?.event_doc_master_id === 8 && f?.ref_document === null, // เป็น [] shipper only สำหรับนับ
      );
    }

    return {
      ...nE,
      document7: document7 ?? null,
      document7TSOID: document7TSOID ?? null,
      document7TSOOBJ: document7TSOOBJ ?? null,
      document8: document8 ?? null,
      document8TSOID: document8TSOID ?? null,
      document8TSOOBJ: document8TSOOBJ ?? null,
    };
  }

  // doc7
  async doc7RefMaster(userId: any){
    const results = await this.prisma.event_doc_ofo_refer.findMany({
      orderBy:{ id: "asc" },
    })
    return results
  }

  async checkType7Gen(text: any) {
    if (text === 'OPERATION FLOW' || text === 'OFO') {
      return 1;
    } else if (text === 'INSTRUCTED FLOW' || text === 'IF') {
      return 2;
    } else {
      throw new HttpException(
        {
          status: HttpStatus.BAD_REQUEST,
          error: 'Flow Type Is Not Match.',
        },
        HttpStatus.BAD_REQUEST,
      );
    }
  }

  async generatedoc7(payload: any, userId: any) {
    // หา meter จาก hv dam system
    // doc 4 หา area จาก relate meter จาก hv dam system
    const {
      gas_day,
      gas_hour,
      zone,
      level, // flow type | DD = DIFFICULT DAY FLOW, OFO = OPERATION FLOW, IF = INSTRUCTED FLOW
      accImb_or_accImbInv,
      energyAdjust,
      volumeAdjust,
      volumeAdjustRate_mmscfd,
      volumeAdjustRate_mmscfh,
      shipper,
    } = payload;

    const flowType = await this.checkType7Gen(level);
    const event_doc_ofo_gas_tranmiss_id = await this.zoneDataUse(zone); // onshore
    const hourText =
      typeof gas_hour === 'number'
        ? await this.gasHourText(gas_hour)
        : gas_hour;
    const { meterPointName, areaName, areaId, areaNom } =
      await this.meterDataUseSystem(gas_day);
    const doc7IrOrderid = accImb_or_accImbInv < 0 ? 2 : 1; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc7IrOrderText = accImb_or_accImbInv < 0 ? 'ลบ' : 'บวก'; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc7IrOrderText2 = accImb_or_accImbInv < 0 ? 'น้อยกว่า' : 'มากกว่า'; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    const doc_7_input_detail_incident = `เกิดความไม่สมดุลด้าน${doc7IrOrderText}อย่างรุนแรง และมีความเสี่ยงที่จะกระทบต่อความมั่นคงต่อระบบท่อส่งก๊าซฝั่ง ${zone} เนื่องจากมีการนำปริมาณก๊าซเข้าระบบ${doc7IrOrderText2}ปริมาณการใช้`;
    const doc_7_input_order_ir_id = energyAdjust < 0 ? 2 : 1; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    // const doc_4_input_order_ir_text = energyAdjust < 0 ? 'ลด' : 'เพิ่ม'; // 1 เพิ่ม, 2 ลด //ระบบส่งก๊าซ
    // const doc_4_input_order_io_id = 3; // จุดส่งเข้า fix
    // const doc_4_input_order_value = `${meterPointName} ${energyAdjust} MMBTU หรือ ${volumeAdjust} MMSCF (Moment rate ที่มีการปรับ ${doc_4_input_order_ir_text}เท่ากับ ${volumeAdjustRate_mmscfd} MMSCFD หรือ ${volumeAdjustRate_mmscfh} MMSCFH) วันที่/เวลาสั่งการ : วันที่ ${gas_day} เวลา ${hourText} น.`; //ปริมาณ

    const shipperUse = await this.shipperData(shipper);

    const doc7Nompoint = await this.doc7Nompoint(userId);
    let nomData = null;
    const findArea = doc7Nompoint?.find((f: any) => f?.id === areaId);
    for (let i = 0; i < findArea?.nom.length; i++) {
      // doc7Nompoint[i]?.nom
      const findNom = areaNom?.nomination_point?.find(
        (f: any) => f?.id === findArea?.nom?.[i]?.id,
      );
      if (findNom) {
        nomData = findNom;
        break;
      }
    }
    console.log('nomData : ', nomData);
    const doc7Data = {
      generate: false, // fix create true gen , false default
      id_documents: null, // fix create ตอนสร้าง null | ถ้าใส่ id_runnumber ใส่มาด้วย | ตอน edit version ส่งมาด้วย | (ถ้าตอน status generate ส่ง id มาด้วย )
      id_runnumber: null, // fix create ใส่มาตอน edit version

      longdo_dict: null, //สำเนา
      event_date: getTodayNowAdd7().format('YYYY-MM-DD'), // วันที่ออกเอกสาร

      doc_7_input_date_time_of_the_incident: `วันที่ ${gas_day} เวลา ${hourText}`, //วัน/เวลาที่เกิดเหตุ
      doc_7_input_detail_incident: doc_7_input_detail_incident, // **** รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ
      doc_7_input_time_event_start_date: null, //วันที่เริ่มดำเนินการ เริ่ม วัน
      doc_7_input_time_event_start_time: null, //วันที่เริ่มดำเนินการ เริ่ม เวลา
      doc_7_input_time_event_end_date: null, //วันที่เริ่มดำเนินการ ถึง วัน
      doc_7_input_time_event_end_time: null, //วันที่เริ่มดำเนินการ ถึง เวลา
      doc_7_input_note: null, //หมายเหตุ
      doc_7_input_ref_1_id: null, // อ้างอิง อันแรก ติ้กใส่ 1 ไม่ติ๊ก null
      doc_7_input_ref_2_id: null, // อ้างอิง อันแรก ติ้กใส่ 2 ไม่ติ๊ก null

      event_doc_ofo_type_id: flowType,
      event_doc_ofo_gas_tranmiss_id: event_doc_ofo_gas_tranmiss_id,
      event_doc_ofo_gas_tranmiss_other:
        event_doc_ofo_gas_tranmiss_id === 4 ? zone : null, // event_doc_ofo_gas_tranmiss_id 4 ใส่ด้วย
      file: [],
      // temp:{
      //   meterPointName: meterPointName,
      //   areaName: areaName,
      //   areaId: areaId,
      //   nomData,
      // },
      gas_shipper: [
        nomData && {
          // row 1 // ถ้าไม่มี shipper ห้ามส่ง row นี้มา
          id: null, // ต้องใส่ ตอนเพิ่มครั้งแรกยังไม่มีจะเป็น null
          ir: doc_7_input_order_ir_id, // 1 เพิ่ม, 2 ลด
          io: 3, // 3 จุดส่งเข้า, 4 จุดส่งออก
          area: nomData?.area_id, // area
          nom_point: nomData?.id, // (BPK1 มี shipper 62, 67) ปริมาณก๊าซ (id nom point)
          nom_value_mmscfh:
            (nomData?.maximum_capacity &&
              String(nomData?.maximum_capacity.toFixed(6))) ||
            null, //คิดเป็นปริมาณ (MMSCFH) default มาจาก maximum_capacity nompoint
          gas_command: 'ดำเนินการตรวจสอบจุดที่ 1', // สั่งการ
          gas_more: 'เร่งดำเนินการตามจุด', // ข้อมูลเพิ่มเติม
          shipper: shipperUse?.map((e: any) => e?.id) || [], // ต้องมี shipper
          file: [], // ไม่มีส่ง []
        },
      ].filter((f: any) => f !== null),
      email_event_for_shipper: [],
      cc_email: [],
    };

    console.log('doc7Data : ', doc7Data);

    const doc7Create = await this.doc7Create(doc7Data, userId, true);

    return {
      doc7Data,
      event_runnumber_ofo_id: doc7Create?.id,
      document7TSOID: doc7Create?.document7TSOID,
    };
  }

  async doc7EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc7RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber_ofo.findMany({
      where: {
        event_document_ofo: {
          none: {
            event_doc_master: {
              id: 7,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        event_doc_ofo_gas_tranmiss: true,
        event_doc_ofo_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_ofo: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_ofo_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc7Nompoint(userId: any) {
    const todayStart = getTodayStartAdd7().toDate();
    const todayEnd = getTodayEndAdd7().toDate();

    const shipperMaster = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
      },
      orderBy: {
        id: 'desc',
      },
    });
    const areaDam = await this.prisma.area.findMany({
      where: {
        AND: [
          {
            start_date: {
              lte: todayEnd, // start_date ต้องก่อนหรือเท่ากับสิ้นสุดวันนี้
            },
          },
          {
            OR: [
              { end_date: null }, // ถ้า end_date เป็น null
              { end_date: { gte: todayStart } }, // ถ้า end_date ไม่เป็น null ต้องหลังหรือเท่ากับเริ่มต้นวันนี้
            ],
          },
        ],
      },
      select: {
        id: true,
        name: true,
        entry_exit_id: true,
      },
      orderBy: {
        id: 'asc',
      },
    });
    const nominationPointDam = await this.prisma.nomination_point.findMany({
      where: {
        AND: [
          {
            start_date: {
              lte: todayEnd, // start_date ต้องก่อนหรือเท่ากับสิ้นสุดวันนี้
            },
          },
          {
            OR: [
              { end_date: null }, // ถ้า end_date เป็น null
              { end_date: { gte: todayStart } }, // ถ้า end_date ไม่เป็น null ต้องหลังหรือเท่ากับเริ่มต้นวันนี้
            ],
          },
        ],
      },
      include: {},
      orderBy: {
        id: 'asc',
      },
    });
    const nominationPoint =
      await this.prisma.query_shipper_nomination_file.findMany({
        where: {},
        include: {
          nomination_version: {
            include: {
              nomination_row_json: {
                where: {
                  query_shipper_nomination_type_id: 1,
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          },
        },
        orderBy: {
          id: 'asc',
        },
      });

    const cvnominationPoint = nominationPoint?.map((e: any) => {
      const { id, nomination_code, group_id, nomination_version, ...nE } = e;
      const vs = nomination_version[0];
      const rowJson = vs?.nomination_row_json;
      const nrowJson = rowJson?.map((rJs: any) => {
        return {
          id: rJs?.id ?? null,
          zone_text: rJs?.zone_text ?? null,
          area_text: rJs?.area_text ?? null,
          data_temp:
            (rJs?.data_temp && JSON.parse(rJs?.data_temp)?.[3]) ?? null,
          entry_exit_id: rJs?.entry_exit_id ?? null,
        };
      });
      return {
        id,
        nomination_code,
        group_id,
        nomPoint: nrowJson,
      };
    });

    const fnominationPointDam = nominationPointDam?.map((e: any) => {
      const {
        id,
        area_id,
        nomination_point,
        description,
        entry_exit_id,
        maximum_capacity,
        ...nE
      } = e;

      const filterNom = cvnominationPoint?.filter((f: any) => {
        return (
          f?.nomPoint?.filter((ff: any) => {
            return (
              ff?.data_temp === nomination_point &&
              ff?.entry_exit_id === entry_exit_id
            );
          }).length > 0
        );
      });

      const shipperArr = [
        ...new Set(filterNom?.map((sp: any) => sp?.group_id)),
      ];

      const shipper = shipperArr
        ?.map((sp: any) => {
          const fnShipper = shipperMaster?.find((fSp: any) => fSp?.id === sp);
          return fnShipper ?? null;
        })
        ?.filter((filSp: any) => filSp !== null);

      return {
        id,
        area_id,
        nomination_point,
        description,
        entry_exit_id,
        maximum_capacity,
        shipper: shipper || [],
      };
    });

    const areaDamNom = areaDam?.map((e: any) => {
      const findArea = fnominationPointDam?.filter((f: any) => {
        return f?.area_id === e?.id;
      });
      return {
        ...e,
        nom: findArea || [],
      };
    });

    return areaDamNom;
  }

  async doc7Order(userId: any) {
    const resDoc = await this.prisma.event_doc_ofo_order.findMany({
      where: {},
      orderBy: {
        id: 'asc',
      },
    });

    return resDoc;
  }

  async doc7Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;

    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    const result =
      userTypeId === 3
        ? await this.prisma.event_document_ofo.findFirst({
            where: {
              event_runnumber_ofo_id: Number(id),
              event_doc_master_id: 7,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_ofo_match: {
                include: {
                  event_doc_gas_shipper_ofo: {
                    include: {
                      event_document_ofo: true,
                      event_doc_gas_shipper_ofo_file: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                      nomination_point: true,
                    },
                  },
                  event_document_ofo: true,
                },
              },
              event_doc_gas_shipper_ofo: {
                include: {
                  event_doc_gas_shipper_ofo_match: {
                    include: {
                      event_doc_gas_shipper_ofo: {
                        include: {
                          event_document_ofo: true,
                          event_doc_gas_shipper_ofo_file: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_ofo_file: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                  nomination_point: true,
                },
              },
            },
          })
        : await this.prisma.event_document_ofo.findFirst({
            where: {
              event_runnumber_ofo_id: Number(id),
              event_doc_master_id: 7,
              ref_document: null,
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                  event_document_ofo: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 7,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_ofo_cc_email: true,
              event_document_ofo_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_doc_gas_shipper_ofo_match: {
                include: {
                  event_doc_gas_shipper_ofo: {
                    include: {
                      event_document_ofo: true,
                      event_doc_gas_shipper_ofo_file: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                    },
                  },
                  event_document_ofo: true,
                },
              },
              event_doc_gas_shipper_ofo: {
                include: {
                  event_doc_gas_shipper_ofo_match: {
                    include: {
                      event_doc_gas_shipper_ofo: {
                        include: {
                          event_doc_gas_shipper_ofo_file: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                    where: {
                      event_doc_gas_shipper_ofo: {
                        event_document_ofo: {
                          user_type_id: 3,
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_ofo_file: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc7Create(payload: any, userId: any, generated?: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,

      gas_shipper,

      doc_7_input_date_time_of_the_incident, //วัน/เวลาที่เกิดเหตุ
      doc_7_input_detail_incident, //รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ
      doc_7_input_time_event_start_date, //วันที่เริ่มดำเนินการ เริ่ม วัน
      doc_7_input_time_event_start_time, //วันที่เริ่มดำเนินการ เริ่ม เวลา
      doc_7_input_time_event_end_date, //วันที่เริ่มดำเนินการ ถึง วัน
      doc_7_input_time_event_end_time, //วันที่เริ่มดำเนินการ ถึง เวลา
      doc_7_input_note, //หมายเหตุ
      doc_7_input_ref_1_id, // อ้างอิง อันแรก ติ้กใส่ 1 ไม่ติ๊ก null
      doc_7_input_ref_2_id, // อ้างอิง อันแรก ติ้กใส่ 2 ไม่ติ๊ก null

      doc_7_input_order_ir_id, // เพิ่ม 1 , ลด 2, อื่นๆ ใส่ null
      doc_7_input_order_io_id, // เข้า 3 , ออก 4, อื่นๆ ใส่ null
      doc_7_input_order_other_id, // อื่นๆ 5, ถ้าเลือก doc_4_input_order_ir_id, doc_4_input_order_io_id ใส่ null
      doc_7_input_order_other_value, // อื่นๆ ให้ใส่, นอกเหนือ null

      event_doc_ofo_type_id, //ประเภท
      event_doc_ofo_gas_tranmiss_id, //ระบบส่งก๊าซ
      event_doc_ofo_gas_tranmiss_other, // event_doc_ofo_gas_tranmiss_other 4 ใส่ด้วย

      id_documents, // ใช้ตอน edit version
      id_runnumber,

      generate,

      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(
      async (prisma) => {
        const newDate = getTodayNowAdd7();
        const todayStart = getYearStartAdd7().toDate();
        const todayEnd = getYearEndAdd7().toDate();

        const group = await this.prisma.group.findFirst({
          where: {
            account_manage: {
              some: {
                account_id: Number(userId),
              },
            },
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        });
        const userTypeId = group.user_type?.id;
        const groupId = group?.id;
        console.log('userTypeId : ', userTypeId);
        console.log('groupId : ', groupId);

        if (userTypeId !== 2) {
          //tso create
          throw new HttpException(
            {
              status: HttpStatus.BAD_REQUEST,
              error: 'Uset Type Is NOT MATCH',
            },
            HttpStatus.BAD_REQUEST,
          );
        }
        // generated

        // version
        // generate
        // id_documents

        // เช็ค ref ref_document
        const eventNumberCount = await prisma.event_runnumber_ofo.count({
          where: {
            create_date: {
              gte: todayStart,
              lte: todayEnd,
            },
          },
        });
        const eventNumber = `${newDate.format('YYYY')}-OFO-${(eventNumberCount > 0 ? eventNumberCount + 1 : 1).toString().padStart(4, '0')}`;

        const createEventRunnumber = id_runnumber
          ? await prisma.event_runnumber_ofo.findFirst({
              where: {
                id: Number(id_runnumber),
              },
              include: {
                event_document_ofo: true,
                event_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            })
          : await prisma.event_runnumber_ofo.create({
              data: {
                event_nember: eventNumber,
                event_date: getTodayNowAdd7().toDate(),
                event_doc_ofo_type: {
                  connect: {
                    id: event_doc_ofo_type_id,
                  },
                },
                event_doc_ofo_gas_tranmiss: {
                  connect: {
                    id: event_doc_ofo_gas_tranmiss_id,
                  },
                },
                event_doc_ofo_gas_tranmiss_other:
                  event_doc_ofo_gas_tranmiss_other ?? null,
                event_status: {
                  connect: {
                    id: 1,
                  },
                },
                group: {
                  connect: {
                    id: groupId,
                  },
                },
                user_type: {
                  connect: {
                    id: userTypeId,
                  },
                },
                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by_account: {
                  connect: {
                    id: Number(userId),
                  },
                },
              },
              include: {
                event_document_ofo: true,
                event_status: true,
                group: true,
                user_type: true,
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
            });

        // -----
        console.log('id_runnumber : ', id_runnumber);
        console.log('id_documents : ', id_documents);
        console.log('createEventRunnumber : ', createEventRunnumber);
        console.log('generate : ', generate);

        const versionUse = createEventRunnumber?.event_document_ofo?.filter(
          (f: any) => f?.event_doc_master_id === 7,
        );

        const version =
          versionUse.length === 0
            ? 1
            : Math.max(...versionUse.map((f: any) => f.seq || 0)) + 1;

        console.log('version : ', version);

        const tsoCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ...(!!generate && !!id_documents
            ? {
                event_doc_status_id: 2,
                doc_7_input_date_time_of_the_incident:
                  doc_7_input_date_time_of_the_incident ?? null,
                doc_7_input_detail_incident:
                  doc_7_input_detail_incident ?? null,
                doc_7_input_time_event_start_date:
                  (doc_7_input_time_event_start_date &&
                    getTodayNowAdd7(
                      doc_7_input_time_event_start_date,
                    ).toDate()) ||
                  null,
                doc_7_input_time_event_start_time:
                  doc_7_input_time_event_start_time ?? null,
                doc_7_input_time_event_end_date:
                  (doc_7_input_time_event_end_date &&
                    getTodayNowAdd7(
                      doc_7_input_time_event_end_date,
                    ).toDate()) ||
                  null,
                doc_7_input_time_event_end_time:
                  doc_7_input_time_event_end_time ?? null,
                doc_7_input_note: doc_7_input_note ?? null,
                ...(doc_7_input_ref_1_id && {
                  doc_7_input_ref_1_id: doc_7_input_ref_1_id ?? null,
                }),
                ...(doc_7_input_ref_2_id && {
                  doc_7_input_ref_2_id: doc_7_input_ref_2_id ?? null,
                }),
                ...(doc_7_input_order_ir_id && {
                  doc_7_input_order_ir_id: doc_7_input_order_ir_id ?? null,
                }),
                ...(doc_7_input_order_io_id && {
                  doc_7_input_order_io_id: doc_7_input_order_io_id ?? null,
                }),
                ...(doc_7_input_order_other_id && {
                  doc_7_input_order_other_id:
                    doc_7_input_order_other_id ?? null,
                }),
                doc_7_input_order_other_value:
                  doc_7_input_order_other_value ?? null,

                longdo_dict: longdo_dict ?? null,

                update_date: getTodayNowAdd7().toDate(),
                update_date_num: getTodayNowAdd7().unix(),
                update_by: Number(userId),
              }
            : {
                version_text: `V.${generate ? version - 1 : version}`,
                seq: generate ? version - 1 : version,

                event_runnumber_ofo: {
                  connect: {
                    id: createEventRunnumber?.id,
                  },
                },
                event_doc_status: {
                  connect: {
                    id: generated ? 6 : 2,
                  },
                },
                group: {
                  connect: {
                    id: groupId,
                  },
                },
                user_type: {
                  connect: {
                    id: userTypeId,
                  },
                },
                event_doc_master: {
                  connect: {
                    id: 7,
                  },
                },

                doc_7_input_date_time_of_the_incident:
                  doc_7_input_date_time_of_the_incident ?? null,
                doc_7_input_detail_incident:
                  doc_7_input_detail_incident ?? null,
                doc_7_input_time_event_start_date:
                  (doc_7_input_time_event_start_date &&
                    getTodayNowAdd7(
                      doc_7_input_time_event_start_date,
                    ).toDate()) ||
                  null,
                doc_7_input_time_event_start_time:
                  doc_7_input_time_event_start_time ?? null,
                doc_7_input_time_event_end_date:
                  (doc_7_input_time_event_end_date &&
                    getTodayNowAdd7(
                      doc_7_input_time_event_end_date,
                    ).toDate()) ||
                  null,
                doc_7_input_time_event_end_time:
                  doc_7_input_time_event_end_time ?? null,
                doc_7_input_note: doc_7_input_note ?? null,
                ...(doc_7_input_ref_1_id && {
                  doc_7_input_ref_1: {
                    connect: {
                      id: doc_7_input_ref_1_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_ref_2_id && {
                  doc_7_input_ref_2: {
                    connect: {
                      id: doc_7_input_ref_2_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_order_ir_id && {
                  doc_7_input_order_ir: {
                    connect: {
                      id: doc_7_input_order_ir_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_order_io_id && {
                  doc_7_input_order_io: {
                    connect: {
                      id: doc_7_input_order_io_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_order_other_id && {
                  doc_7_input_order_other: {
                    connect: {
                      id: doc_7_input_order_other_id ?? null,
                    },
                  },
                }),
                doc_7_input_order_other_value:
                  doc_7_input_order_other_value ?? null,

                longdo_dict: longdo_dict ?? null,

                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by_account: {
                  connect: {
                    id: Number(userId),
                  },
                },
              }),
        };

        if (!!id_runnumber && !!generate) {
          await prisma.event_document_ofo.update({
            where: { id: Number(id_documents) },
            data: tsoCreate,
          });
        }

        const createEventDocument =
          !!id_runnumber && !!generate
            ? await prisma.event_document_ofo.findFirst({
                where: { id: Number(id_documents) },
                include: {
                  event_doc_gas_shipper_ofo: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              })
            : await prisma.event_document_ofo.create({
                data: tsoCreate,
                include: {
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              });
        console.log('createEventDocument : ', createEventDocument);

        // generate

        if (!!id_runnumber && !!generate) {
          await prisma.event_document_ofo.deleteMany({
            where: {
              ref_document: Number(createEventDocument?.id),
              // event_doc_gas_shipper_ofo_id: Number(gas_shipper?.[i]?.id),
            },
          });
        }

        for (let i = 0; i < (gas_shipper?.length ?? 0); i++) {
          if (!!id_runnumber && !!generate) {
            if (gas_shipper?.[i]?.id === null) {
              const gas_shipper_create =
                await prisma.event_doc_gas_shipper_ofo.create({
                  data: {
                    ir: gas_shipper?.[i]?.ir ?? null,
                    io: gas_shipper?.[i]?.io ?? null,
                    area: {
                      connect: {
                        id: Number(gas_shipper?.[i]?.area),
                      },
                    },
                    nomination_point: {
                      connect: {
                        id: Number(gas_shipper?.[i]?.nom_point),
                      },
                    },
                    nom_value_mmscfh: gas_shipper?.[i]?.nom_value_mmscfh ?? null,
                    gas_command: gas_shipper?.[i]?.gas_command ?? null,
                    gas_more: gas_shipper?.[i]?.gas_more ?? null,
                    event_document_ofo: {
                      connect: {
                        id: Number(createEventDocument?.id),
                      },
                    },
                    create_date: getTodayNowAdd7().toDate(),
                    create_date_num: getTodayNowAdd7().unix(),
                    create_by_account: {
                      connect: {
                        id: Number(userId),
                      },
                    },
                  },
                });
              for (
                let iShipper = 0;
                iShipper < gas_shipper?.[i]?.shipper?.length;
                iShipper++
              ) {
                const findDocShipper =
                  await prisma.event_document_ofo.findFirst({
                    where: {
                      ref_document: createEventDocument?.id,
                      group_id: gas_shipper?.[i]?.shipper?.[iShipper],
                    },
                  });
                if (findDocShipper) {
                  await prisma.event_doc_gas_shipper_ofo_match.create({
                    data: {
                      event_document_ofo_id: findDocShipper?.id,
                      event_doc_gas_shipper_ofo_id: gas_shipper_create?.id,
                    },
                  });
                } else {
                  const shipperCreate = {
                    event_date: getTodayNowAdd7(event_date).toDate(),
                    version_text: `V.${generate ? version - 1 : version}`,
                    seq: generate ? version - 1 : version,
                    ref_document: createEventDocument?.id,
                    event_runnumber_ofo: {
                      connect: {
                        id: createEventRunnumber?.id,
                      },
                    },
                    event_doc_status: {
                      connect: {
                        id: generated ? 6 : 2,
                      },
                    },
                    group: {
                      connect: {
                        id: gas_shipper?.[i]?.shipper?.[iShipper],
                      },
                    },
                    user_type: {
                      connect: {
                        id: 3,
                      },
                    },
                    event_doc_master: {
                      connect: {
                        id: 7,
                      },
                    },

                    doc_7_input_date_time_of_the_incident:
                      doc_7_input_date_time_of_the_incident ?? null,
                    doc_7_input_detail_incident:
                      doc_7_input_detail_incident ?? null,
                    doc_7_input_time_event_start_date:
                      (doc_7_input_time_event_start_date &&
                        getTodayNowAdd7(
                          doc_7_input_time_event_start_date,
                        ).toDate()) ||
                      null,
                    doc_7_input_time_event_start_time:
                      doc_7_input_time_event_start_time ?? null,
                    doc_7_input_time_event_end_date:
                      (doc_7_input_time_event_end_date &&
                        getTodayNowAdd7(
                          doc_7_input_time_event_end_date,
                        ).toDate()) ||
                      null,
                    doc_7_input_time_event_end_time:
                      doc_7_input_time_event_end_time ?? null,
                    doc_7_input_note: doc_7_input_note ?? null,
                    ...(doc_7_input_ref_1_id && {
                      doc_7_input_ref_1: {
                        connect: {
                          id: doc_7_input_ref_1_id ?? null,
                        },
                      },
                    }),
                    ...(doc_7_input_ref_2_id && {
                      doc_7_input_ref_2: {
                        connect: {
                          id: doc_7_input_ref_2_id ?? null,
                        },
                      },
                    }),
                    ...(doc_7_input_order_ir_id && {
                      doc_7_input_order_ir: {
                        connect: {
                          id: doc_7_input_order_ir_id ?? null,
                        },
                      },
                    }),
                    ...(doc_7_input_order_io_id && {
                      doc_7_input_order_io: {
                        connect: {
                          id: doc_7_input_order_io_id ?? null,
                        },
                      },
                    }),
                    ...(doc_7_input_order_other_id && {
                      doc_7_input_order_other: {
                        connect: {
                          id: doc_7_input_order_other_id ?? null,
                        },
                      },
                    }),
                    doc_7_input_order_other_value:
                      doc_7_input_order_other_value ?? null,

                    longdo_dict: longdo_dict ?? null,

                    create_date: getTodayNowAdd7().toDate(),
                    create_date_num: getTodayNowAdd7().unix(),
                    create_by_account: {
                      connect: {
                        id: Number(userId),
                      },
                    },
                  };

                  const createEventDocumentShipper =
                    await prisma.event_document_ofo.create({
                      data: shipperCreate,
                    });

                  await prisma.event_doc_gas_shipper_ofo_match.create({
                    data: {
                      event_document_ofo_id: createEventDocumentShipper?.id,
                      event_doc_gas_shipper_ofo_id: gas_shipper_create?.id,
                    },
                  });
                }
              }

              if (gas_shipper?.[i]?.file && gas_shipper?.[i]?.file.length > 0) {
                const fileData = gas_shipper?.[i]?.file?.map((fileItem: any) => {
                  return {
                    url: fileItem,
                    event_doc_gas_shipper_ofo_id: Number(
                      gas_shipper_create?.id,
                    ),
                    create_date: getTodayNowAdd7().toDate(),
                    create_date_num: getTodayNowAdd7().unix(),
                    create_by: Number(userId),
                  };
                });
                await prisma.event_doc_gas_shipper_ofo_file.createMany({
                  data: fileData,
                });
              }
            } else {
              for (
                let iShipper = 0;
                iShipper < gas_shipper?.[i]?.shipper?.length;
                iShipper++
              ) {
                // const findDocShipper =
                //   await prisma.event_document_ofo.findFirst({
                //     where: {
                //       ref_document: createEventDocument?.id,
                //       group_id: gas_shipper?.[i]?.shipper?.[iShipper],
                //     },
                //   });
                // if (findDocShipper) {

                //   const ckMatch = await prisma.event_doc_gas_shipper_ofo_match.findFirst({
                //     where: {
                //       event_document_ofo_id: findDocShipper?.id,
                //       event_doc_gas_shipper_ofo_id: Number(gas_shipper?.[i]?.id),
                //       // event_doc_gas_shipper_ofo:{
                //       //   event_document_ofo:{
                //       //     group_id: Number(gas_shipper?.[i]?.id),
                //       //   }
                //       // }
                //     },
                //   });
                //   // console.log('findDocShipper : ', findDocShipper?.id);
                //   // console.log('ckMatch : ', ckMatch);
                //   if(ckMatch){
                //     await prisma.event_document_ofo.updateMany({
                //       where:{
                //         id: findDocShipper?.id,
                //       },
                //       data:{
                //         event_doc_status_id: 2,
                //       }
                //     })

                //   }else{

                //     await prisma.event_doc_gas_shipper_ofo_match.create({
                //       data: {
                //         event_document_ofo_id: findDocShipper?.id,
                //         event_doc_gas_shipper_ofo_id: Number(gas_shipper?.[i]?.id),
                //       },
                //     });
                //   }

                // } else {
                const shipperCreate = {
                  event_date: getTodayNowAdd7(event_date).toDate(),
                  version_text: `V.${generate ? version - 1 : version}`,
                  seq: generate ? version - 1 : version,
                  ref_document: createEventDocument?.id,
                  event_runnumber_ofo: {
                    connect: {
                      id: createEventRunnumber?.id,
                    },
                  },
                  event_doc_status: {
                    connect: {
                      id: generated ? 6 : 2,
                    },
                  },
                  group: {
                    connect: {
                      id: gas_shipper?.[i]?.shipper?.[iShipper],
                    },
                  },
                  user_type: {
                    connect: {
                      id: 3,
                    },
                  },
                  event_doc_master: {
                    connect: {
                      id: 7,
                    },
                  },

                  doc_7_input_date_time_of_the_incident:
                    doc_7_input_date_time_of_the_incident ?? null,
                  doc_7_input_detail_incident:
                    doc_7_input_detail_incident ?? null,
                  doc_7_input_time_event_start_date:
                    (doc_7_input_time_event_start_date &&
                      getTodayNowAdd7(
                        doc_7_input_time_event_start_date,
                      ).toDate()) ||
                    null,
                  doc_7_input_time_event_start_time:
                    doc_7_input_time_event_start_time ?? null,
                  doc_7_input_time_event_end_date:
                    (doc_7_input_time_event_end_date &&
                      getTodayNowAdd7(
                        doc_7_input_time_event_end_date,
                      ).toDate()) ||
                    null,
                  doc_7_input_time_event_end_time:
                    doc_7_input_time_event_end_time ?? null,
                  doc_7_input_note: doc_7_input_note ?? null,
                  ...(doc_7_input_ref_1_id && {
                    doc_7_input_ref_1: {
                      connect: {
                        id: doc_7_input_ref_1_id ?? null,
                      },
                    },
                  }),
                  ...(doc_7_input_ref_2_id && {
                    doc_7_input_ref_2: {
                      connect: {
                        id: doc_7_input_ref_2_id ?? null,
                      },
                    },
                  }),
                  ...(doc_7_input_order_ir_id && {
                    doc_7_input_order_ir: {
                      connect: {
                        id: doc_7_input_order_ir_id ?? null,
                      },
                    },
                  }),
                  ...(doc_7_input_order_io_id && {
                    doc_7_input_order_io: {
                      connect: {
                        id: doc_7_input_order_io_id ?? null,
                      },
                    },
                  }),
                  ...(doc_7_input_order_other_id && {
                    doc_7_input_order_other: {
                      connect: {
                        id: doc_7_input_order_other_id ?? null,
                      },
                    },
                  }),
                  doc_7_input_order_other_value:
                    doc_7_input_order_other_value ?? null,

                  longdo_dict: longdo_dict ?? null,

                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                };
                const createEventDocumentShipper =
                  await prisma.event_document_ofo.create({
                    data: shipperCreate,
                  });

                console.log('gas_shipper[i] : ', gas_shipper?.[i]);
                console.log(
                  'createEventDocumentShipper : ',
                  createEventDocumentShipper,
                );

                // await prisma.event_doc_gas_shipper_ofo_match.deleteMany({
                //   where: {
                //     event_doc_gas_shipper_ofo_id: Number(gas_shipper?.[i]?.id),
                //   },
                // });

                await prisma.event_doc_gas_shipper_ofo_match.create({
                  data: {
                    event_document_ofo_id: createEventDocumentShipper?.id,
                    event_doc_gas_shipper_ofo_id: Number(gas_shipper?.[i]?.id),
                  },
                });
                // }
              }

              if (gas_shipper?.[i]?.file && gas_shipper?.[i]?.file.length > 0) {
                const fileData = gas_shipper?.[i]?.file?.map((fileItem: any) => {
                  return {
                    url: fileItem,
                    event_doc_gas_shipper_ofo_id: Number(gas_shipper?.[i]?.id),
                    create_date: getTodayNowAdd7().toDate(),
                    create_date_num: getTodayNowAdd7().unix(),
                    create_by: Number(userId),
                  };
                });
                await prisma.event_doc_gas_shipper_ofo_file.createMany({
                  data: fileData,
                });
              }
            }
          } else {
            console.log('******');

            const gas_shipper_create =
              await prisma.event_doc_gas_shipper_ofo.create({
                data: {
                  ir: gas_shipper?.[i]?.ir ?? null,
                  io: gas_shipper?.[i]?.io ?? null,
                  ...(!!gas_shipper?.[i]?.area && {
                    area: {
                      connect: {
                        id: Number(gas_shipper?.[i]?.area),
                      },
                    },
                  }),
                  ...(!!gas_shipper?.[i]?.nom_point && {
                    nomination_point: {
                      connect: {
                        id: Number(gas_shipper?.[i]?.nom_point),
                      },
                    },
                  }),
                  nom_value_mmscfh: gas_shipper?.[i]?.nom_value_mmscfh ?? null,
                  gas_command: gas_shipper?.[i]?.gas_command ?? null,
                  gas_more: gas_shipper?.[i]?.gas_more ?? null,
                  event_document_ofo: {
                    connect: {
                      id: Number(createEventDocument?.id),
                    },
                  },
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                },
              });
            for (
              let iShipper = 0;
              iShipper < gas_shipper?.[i]?.shipper?.length;
              iShipper++
            ) {
              const shipperCreate = {
                event_date: getTodayNowAdd7(event_date).toDate(),
                version_text: `V.${generate ? version - 1 : version}`,
                seq: generate ? version - 1 : version,
                ref_document: createEventDocument?.id,
                event_runnumber_ofo: {
                  connect: {
                    id: createEventRunnumber?.id,
                  },
                },
                event_doc_status: {
                  connect: {
                    id: generated ? 6 : 2,
                  },
                },
                group: {
                  connect: {
                    id: gas_shipper?.[i]?.shipper?.[iShipper],
                  },
                },
                user_type: {
                  connect: {
                    id: 3,
                  },
                },
                event_doc_master: {
                  connect: {
                    id: 7,
                  },
                },

                doc_7_input_date_time_of_the_incident:
                  doc_7_input_date_time_of_the_incident ?? null,
                doc_7_input_detail_incident:
                  doc_7_input_detail_incident ?? null,
                doc_7_input_time_event_start_date:
                  (doc_7_input_time_event_start_date &&
                    getTodayNowAdd7(
                      doc_7_input_time_event_start_date,
                    ).toDate()) ||
                  null,
                doc_7_input_time_event_start_time:
                  doc_7_input_time_event_start_time ?? null,
                doc_7_input_time_event_end_date:
                  (doc_7_input_time_event_end_date &&
                    getTodayNowAdd7(
                      doc_7_input_time_event_end_date,
                    ).toDate()) ||
                  null,
                doc_7_input_time_event_end_time:
                  doc_7_input_time_event_end_time ?? null,
                doc_7_input_note: doc_7_input_note ?? null,
                ...(doc_7_input_ref_1_id && {
                  doc_7_input_ref_1: {
                    connect: {
                      id: doc_7_input_ref_1_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_ref_2_id && {
                  doc_7_input_ref_2: {
                    connect: {
                      id: doc_7_input_ref_2_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_order_ir_id && {
                  doc_7_input_order_ir: {
                    connect: {
                      id: doc_7_input_order_ir_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_order_io_id && {
                  doc_7_input_order_io: {
                    connect: {
                      id: doc_7_input_order_io_id ?? null,
                    },
                  },
                }),
                ...(doc_7_input_order_other_id && {
                  doc_7_input_order_other: {
                    connect: {
                      id: doc_7_input_order_other_id ?? null,
                    },
                  },
                }),
                doc_7_input_order_other_value:
                  doc_7_input_order_other_value ?? null,

                longdo_dict: longdo_dict ?? null,

                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by_account: {
                  connect: {
                    id: Number(userId),
                  },
                },
              };

              const createEventDocumentShipper =
                await prisma.event_document_ofo.create({
                  data: shipperCreate,
                });

              await prisma.event_doc_gas_shipper_ofo_match.create({
                data: {
                  event_document_ofo_id: createEventDocumentShipper?.id,
                  event_doc_gas_shipper_ofo_id: gas_shipper_create?.id,
                },
              });
            }

            if (gas_shipper?.[i]?.file && gas_shipper?.[i]?.file.length > 0) {
              const fileData = gas_shipper?.[i]?.file?.map((fileItem: any) => {
                return {
                  url: fileItem,
                  event_doc_gas_shipper_ofo_id: Number(gas_shipper_create?.id),
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by: Number(userId),
                };
              });
              await prisma.event_doc_gas_shipper_ofo_file.createMany({
                data: fileData,
              });
            }
          }
        }

        await prisma.event_document_ofo_action.create({
          data: {
            event_document_ofo: {
              connect: {
                id: createEventDocument?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: generated ? 6 : 2,
              },
            },
            group: {
              connect: {
                id: groupId,
              },
            },
            user_type: {
              connect: {
                id: userTypeId,
              },
            },
            event_doc_master: {
              connect: {
                id: 7,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        // -----

        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_ofo_id: createEventDocument?.id,
            edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_ofo_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_ofo_id: createEventDocument?.id,
            email: cc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_ofo_cc_email.createMany({
            data: CcEmail,
          }));

        const emailUse = {
          shipper: gas_shipper?.map((gs: any) => gs?.['shipper']).flat(),
          emailGroup: email_event_for_shipper,
          ccEmail: cc_email,
        };

        return { createEventRunnumber, createEventDocument, emailUse };
      },
      {
        timeout: 15000, // เพิ่มเป็น 10 วินาที
        maxWait: 15000, // รอให้ transaction พร้อม
      },
    );

    const findOnce = await this.ofoOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_ofo_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_ofo: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    console.log('emailUse : ', result?.emailUse);
    !generate &&
      !generated &&
      (await this.sendEmailCondition(result?.emailUse, findOnce, payload, 7));

    return findOnce;
  }

  async doc7FindVersion(
    id: any,
    userId: any,
    groupObj?: any,
    shipperIds?: any,
  ) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_ofo.findMany({
            where: {
              event_runnumber_ofo_id: Number(id),
              event_doc_master_id: 7,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_ofo_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          })
        : await this.prisma.event_document_ofo.findMany({
            where: {
              event_runnumber_ofo_id: Number(id),
              event_doc_master_id: 7,
              ref_document: null,
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                  event_document_ofo: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 7,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_ofo_cc_email: true,
              event_document_ofo_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_ofo_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc7FindDoc(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_ofo.findFirst({
            where: {
              id: Number(id),
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_ofo_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_ofo_match: {
                where: {
                  event_document_ofo_id: {
                    not: null,
                  },
                },
                include: {
                  event_doc_gas_shipper_ofo: {
                    include: {
                      event_document_ofo: true,
                      event_doc_gas_shipper_ofo_file: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                      nomination_point: {
                        include: {
                          area: true,
                        },
                      },
                    },
                  },
                  event_document_ofo: true,
                },
              },
              event_doc_gas_shipper_ofo: {
                include: {
                  event_doc_gas_shipper_ofo_match: {
                    where: {
                      event_document_ofo_id: {
                        not: null,
                      },
                    },
                    include: {
                      event_document_ofo: true,
                      event_doc_gas_shipper_ofo: {
                        include: {
                          event_document_ofo: true,
                          event_doc_gas_shipper_ofo_file: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_ofo_file: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                  nomination_point: {
                    include: {
                      area: true,
                    },
                  },
                },
              },
            },
          })
        : await this.prisma.event_document_ofo.findFirst({
            where: {
              id: Number(id),
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                  event_document_ofo: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 7,
                      ref_document: Number(id),
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_ofo_cc_email: true,
              event_document_ofo_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_ofo_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_ofo_match: {
                include: {
                  event_doc_gas_shipper_ofo: {
                    include: {
                      event_document_ofo: true,
                      event_doc_gas_shipper_ofo_file: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                      nomination_point: {
                        include: {
                          area: true,
                        },
                      },
                    },
                  },
                  event_document_ofo: true,
                },
                where: {
                  event_document_ofo_id: {
                    not: null,
                  },
                },
              },
              event_doc_gas_shipper_ofo: {
                include: {
                  event_doc_gas_shipper_ofo_match: {
                    where: {
                      event_document_ofo_id: {
                        not: null,
                      },
                    },
                    include: {
                      event_document_ofo: true,
                      event_doc_gas_shipper_ofo: {
                        include: {
                          event_document_ofo: true,
                          event_doc_gas_shipper_ofo_file: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_ofo_file: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                  nomination_point: {
                    include: {
                      area: true,
                    },
                  },
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc7Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_doc_status_id,
      doc_4_input_shipper_operation,
      doc_4_input_shipper_note,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_ofo.findFirst({
        where: {
          event_status_id: 2,
          event_document_ofo: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_ofo.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_ofo_action.create({
        data: {
          event_document_ofo: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 7,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_ofo.findFirst({
        where: {
          event_document_ofo: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.ofoOnce(result?.eventRunId, userId);

    await this.prisma.event_document_ofo_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_ofo: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_ofo.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        event_runnumber_ofo: {
          include: {
            event_doc_ofo_type: true,
            event_doc_ofo_gas_tranmiss: true,
          },
        },
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบคำสั่งเพิ่ม/ลดปริมาณก๊าซ (Operation Flow Order)`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/OFO - Shipper Acknowledge (Doc.7)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_ofo?.event_nember || ''}</li>
          <li>ระบบส่งก๊าซ :  ${payload?.event_doc_ofo_gas_tranmiss === 5 ? payload?.event_doc_ofo_gas_tranmiss_other : payload?.event_doc_ofo_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'ofo_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc7PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;
    const logocheckBoxCheck = `data:image/png;base64,${checkBoxCheck}`;
    const logocheckBox = `data:image/png;base64,${checkBox}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);
    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber_ofo?.findFirst({
        where: { event_document_ofo: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc7FindDoc(id, userId, null, shipperIds);
      console.log('rdoc1Find : ', rdoc1Find);
      console.log(
        'rdoc1Find?.event_runnumber_ofo : ',
        rdoc1Find?.event_runnumber_ofo,
      );

      const event_document_action = rdoc1Find?.event_document_ofo_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_ofo?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const event_doc_ofo_gas_tranmiss_other =
        rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_gas_tranmiss_other ||
        '___________';

      const input_date_time_of_the_incident =
        rdoc1Find?.doc_7_input_date_time_of_the_incident || ''; //วัน/เวลาที่เกิดเหตุ
      const input_detail_incident =
        rdoc1Find?.doc_7_input_detail_incident || ''; //รายละเอียดของเหตุการณ์
      const input_note = rdoc1Find?.doc_7_input_note || ''; //หมายเหตุ

      const input_time_event_start_date =
        (rdoc1Find?.doc_7_input_time_event_start_date &&
          `${dayjs(rdoc1Find?.doc_7_input_time_event_start_date).locale('th').format('DD')}/${dayjs(rdoc1Find?.doc_7_input_time_event_start_date).locale('th').format('MM')}/${dayjs(rdoc1Find?.doc_7_input_time_event_start_date).locale('th').format('BBBB')}`) ||
        ''; //วันที่เริ่มดำเนินการ เริ่ม วัน
      const input_time_event_start_time =
        rdoc1Find?.doc_7_input_time_event_start_time || ''; //วันที่เริ่มดำเนินการ เริ่ม เวลา
      const input_time_event_end_date =
        (rdoc1Find?.doc_7_input_time_event_end_date &&
          `${dayjs(rdoc1Find?.doc_7_input_time_event_end_date).locale('th').format('DD')}/${dayjs(rdoc1Find?.doc_7_input_time_event_end_date).locale('th').format('MM')}/${dayjs(rdoc1Find?.doc_7_input_time_event_end_date).locale('th').format('BBBB')}`) ||
        ''; //วันที่เริ่มดำเนินการ ถึง วัน
      const input_time_event_end_time =
        rdoc1Find?.doc_7_input_time_event_end_time || ''; //วันที่เริ่มดำเนินการ ถึง เวลา
      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      // const irShipper = Array.from({ length: 5 }, (_, i) => i)?.map(
      const irShipper = rdoc1Find?.event_doc_gas_shipper_ofo_match?.flatMap(
        (ir: any, ix: number) => {
          // group?.name
          // event_doc_gas_shipper_ofo

          const hrLine = {
            canvas: [
              { type: 'line', x1: 0, y1: 0, x2: 400, y2: 0, lineWidth: 0.5 },
            ],
            margin: [0, 5, 0, 5],
          };

          const data1 = {
            // dynamic
            columns: [
              // { width: 'auto', text: `space`, opacity: 0 },
              { width: 'auto', text: 'ปรับ' },
              {
                image:
                  ir?.event_doc_gas_shipper_ofo?.ir === 1
                    ? logocheckBoxCheck
                    : logocheckBox,
                width: 12,
                height: 12,
                margin: [0, 0, 3, 0],
              },
              { width: 'auto', text: 'เพิ่ม / ' },
              {
                image:
                  ir?.event_doc_gas_shipper_ofo?.ir === 2
                    ? logocheckBoxCheck
                    : logocheckBox,
                width: 12,
                height: 12,
                margin: [0, 0, 3, 0],
              },
              { width: 'auto', text: 'ลดปริมาณก๊าซของผู้ใช้บริการ ' },
              {
                width: 'auto',
                text: `${group?.name}`,
                decoration: 'underline',
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };

          const dataI = {
            // dynamic
            columns: [
              // { width: 'auto', text: `space`, opacity: 0 },
              {
                image:
                  ir?.event_doc_gas_shipper_ofo?.io === 3
                    ? logocheckBoxCheck
                    : logocheckBox,
                width: 12,
                height: 12,
                margin: [0, 0, 3, 0],
              },
              { width: 'auto', text: 'จุดส่งเข้า ' },
              {
                width: 'auto',
                text: `${(ir?.event_doc_gas_shipper_ofo?.io === 3 && `${ir?.event_doc_gas_shipper_ofo?.nomination_point?.area?.name || ''} จุดเชื่อมต่อจาก (${ir?.event_doc_gas_shipper_ofo?.nomination_point?.nomination_point})`) || '________'}`,
                ...(ir?.event_doc_gas_shipper_ofo?.io === 3 &&
                  ir?.event_doc_gas_shipper_ofo?.nomination_point
                    ?.nomination_point && {
                    decoration: 'underline',
                  }),
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };

          const dataIValue = {
            // dynamic
            columns: [
              // { width: 'auto', text: `space`, opacity: 0 },
              { width: 'auto', text: 'ปริมาณ ' },
              {
                width: 'auto',
                text: `${(ir?.event_doc_gas_shipper_ofo?.io === 3 && !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh) || '________'}`,
                ...(ir?.event_doc_gas_shipper_ofo?.io === 3 &&
                  !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && {
                    decoration: 'underline',
                  }),
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };

          const dataO = {
            // dynamic
            columns: [
              // { width: 'auto', text: `space`, opacity: 0 },
              {
                image:
                  ir?.event_doc_gas_shipper_ofo?.io === 4
                    ? logocheckBoxCheck
                    : logocheckBox,
                width: 12,
                height: 12,
                margin: [0, 0, 3, 0],
              },
              { width: 'auto', text: 'จุดจ่ายออก ' },
              {
                width: 'auto',
                text: `${(ir?.event_doc_gas_shipper_ofo?.io === 4 && `${ir?.event_doc_gas_shipper_ofo?.nomination_point?.area?.name || ''} จุดเชื่อมต่อจาก (${ir?.event_doc_gas_shipper_ofo?.nomination_point?.nomination_point})`) || '________'}`,
                ...(ir?.event_doc_gas_shipper_ofo?.io === 4 &&
                  ir?.event_doc_gas_shipper_ofo?.nomination_point
                    ?.nomination_point && {
                    decoration: 'underline',
                  }),
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };

          const dataOValue = {
            // dynamic
            columns: [
              // { width: 'auto', text: `space`, opacity: 0 },
              { width: 'auto', text: 'ปริมาณ ' },
              {
                width: 'auto',
                text: `${(ir?.event_doc_gas_shipper_ofo?.io === 4 && !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh) || '________'}`,
                ...(ir?.event_doc_gas_shipper_ofo?.io === 4 &&
                  !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && {
                    decoration: 'underline',
                  }),
              },
            ],
            columnGap: 5,
            margin: [0, 0, 0, 5],
          };

          return [data1, dataI, dataIValue, dataO, dataOValue]; // https://app.clickup.com/t/86eum0nt8
          // return [data1, dataI, dataIValue, hrLine, dataO, dataOValue];
        },
      );

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: `คําส่ังเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'})`,
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      // 'ส่วนปฏิบัติกํารรับจ่ํายก๊ําซธรรมชําติรํายวัน (Intra-day Natural Gas Operations Division)',
                      `${group?.name}`,
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${longdo_dict || ''}`,
                      //
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ระบบส่งก๊าซ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: '(1.) ระบบส่งก๊าซ',
                        bold: true,
                        // decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            image:
                              rdoc1Find?.event_runnumber_ofo
                                ?.event_doc_ofo_gas_tranmiss_id === 1
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Onshore East' },
                          {
                            image:
                              rdoc1Find?.event_runnumber_ofo
                                ?.event_doc_ofo_gas_tranmiss_id === 2
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Onshore West' },
                          {
                            image:
                              rdoc1Find?.event_runnumber_ofo
                                ?.event_doc_ofo_gas_tranmiss_id === 3
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Onshore East - West' },
                          {
                            image:
                              rdoc1Find?.event_runnumber_ofo
                                ?.event_doc_ofo_gas_tranmiss_id === 4
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Other:' },
                          {
                            width: 'auto',
                            text: `${event_doc_ofo_gas_tranmiss_other}`,
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            image:
                              rdoc1Find?.doc_7_input_ref_1_id === 1
                                ? logocheckBoxCheck
                                : logocheckBox,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          {
                            width: 'auto',
                            text: 'อ้างอิง TSO Code ข้อที่ 8.8.4.5 เนื่องจากความไม่สมดุลของระบบส่งก๊าซ เข้าใกล้ขีดจำกัดที่ระบบจะสามารถรองรับจึงออกคำสั่ง Operational Flow Order เพื่อรักษาเสถียรภาพของระบบส่งก๊าซ',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            image:
                              rdoc1Find?.doc_7_input_ref_2_id === 2
                                ? logocheckBoxCheck
                                : logocheckBox,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          {
                            width: 'auto',
                            text: 'อ้างอิง TSO Code ข้อที่ 8.4.1.1(ง), 8.4.1.1(ฌ) และ 8.4.1.2 (ข) เพื่อควบคุมคุณภาพก๊าซรวมที่เข้าสู่ระบบให้เป็นไปตามข้อกำหนดคุณภาพก๊าซควบคุมที่เขตส่งมอบก๊าซ และเพื่อไม่ให้เกิดผลกระทบต่อผู้ใช้บริการและผู้ใช้ก๊าซจึงออกคำสั่ง Operational Flow Order',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            width: 'auto',
                            text: `วันที่ / เวลา ที่เกิดเหตุการณ์:`,
                          },
                          {
                            width: 'auto',
                            text: `${input_date_time_of_the_incident}`,
                            decoration: 'underline',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            width: 'auto',
                            text: 'รายละเอียดเหตุการณ์ความไม่สมดุล หรือเหตุการณ์เพื่อควบคุมคุณภาพก๊าซที่ต้องสั่งการอย่างจำเป็นเร่งด่วนเพื่อปกป้อง หรือระงับความเสียหายหรืออันตรายที่อาจเกิดขึ้นกับระบบส่งก๊าซ และรายละเอียดการสั่งการ: ',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            width: 'auto',
                            text: `${input_detail_incident}`,
                            decoration: 'underline',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      ...irShipper,
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          // { width: 'auto', text: `โดยอย่างช้าให้เริ่มดำเนินการตั้งแต่  น. วันที่ และดำเนินการให้แล้วเสร็จภายใน 00:01 น.วันที่ 13/08/2566` },
                          {
                            width: 'auto',
                            text: `โดยอย่างช้าให้เริ่มดำเนินการตั้งแต่`,
                          },
                          {
                            width: 'auto',
                            text: `${input_time_event_start_date}`,
                            decoration: 'underline',
                          },
                          { width: 'auto', text: ` น. วันที่ ` },
                          {
                            width: 'auto',
                            text: `${input_time_event_start_time}`,
                            decoration: 'underline',
                          },
                          {
                            width: 'auto',
                            text: ` และดำเนินการให้แล้วเสร็จภายใน `,
                          },
                          {
                            width: 'auto',
                            text: `${input_time_event_end_date}`,
                            decoration: 'underline',
                          },
                          { width: 'auto', text: ` น.วันที่ ` },
                          {
                            width: 'auto',
                            text: `${input_time_event_end_time}`,
                            decoration: 'underline',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          { width: 'auto', text: `หมายเหตุ:` },
                          {
                            width: 'auto',
                            text: `${input_note}`,
                            decoration: 'underline',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  {
                    stack: [
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      fromSignature
                        ? {
                            columns: [
                              {
                                // text: 'รับทราบโดย',
                                text: 'แจ้งโดย', // https://app.clickup.com/t/86eum0p1r
                                width: 'auto',
                                alignment: 'right',
                              },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย ` },
                      { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                      // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                      rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        ? {
                            columns: [
                              {
                                text: 'รับทราบโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              // { text: ')', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย` },
                      {
                        text:
                          rdoc1Find?.event_doc_status?.id === 5
                            ? `(${toFullname})`
                            : '(…………………………………………………………)',
                      },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                      },
                      {
                        text: `(ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ/ผู้เกี่ยวข้อง)`,
                        width: 'auto',
                        alignment: 'center',
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_ofo.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      console.log('--- : ', inputList);

      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber_ofo?.findFirst({
          where: { event_document_ofo: { some: { id: Number(id) } } },
        });
        console.log('findRunnumber : ', findRunnumber);
        const rdoc1Find = await this.doc7FindDoc(id, userId, null, group_id);
        console.log('rdoc1Find : ', rdoc1Find);
        console.log(
          'rdoc1Find?.event_runnumber_ofo : ',
          rdoc1Find?.event_runnumber_ofo,
        );

        const event_document_action = rdoc1Find?.event_document_ofo_action;

        const toAction = event_document_action?.find(
          // (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
          (f: any) => f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber_ofo?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const event_doc_ofo_gas_tranmiss_other =
          rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_gas_tranmiss_other ||
          '___________';

        const input_date_time_of_the_incident =
          rdoc1Find?.doc_7_input_date_time_of_the_incident || ''; //วัน/เวลาที่เกิดเหตุ
        const input_detail_incident =
          rdoc1Find?.doc_7_input_detail_incident || ''; //รายละเอียดของเหตุการณ์
        const input_note = rdoc1Find?.doc_7_input_note || ''; //หมายเหตุ

        const input_time_event_start_date =
          (rdoc1Find?.doc_7_input_time_event_start_date &&
            `${dayjs(rdoc1Find?.doc_7_input_time_event_start_date).locale('th').format('DD')}/${dayjs(rdoc1Find?.doc_7_input_time_event_start_date).locale('th').format('MM')}/${dayjs(rdoc1Find?.doc_7_input_time_event_start_date).locale('th').format('BBBB')}`) ||
          ''; //วันที่เริ่มดำเนินการ เริ่ม วัน
        const input_time_event_start_time =
          rdoc1Find?.doc_7_input_time_event_start_time || ''; //วันที่เริ่มดำเนินการ เริ่ม เวลา
        const input_time_event_end_date =
          (rdoc1Find?.doc_7_input_time_event_end_date &&
            `${dayjs(rdoc1Find?.doc_7_input_time_event_end_date).locale('th').format('DD')}/${dayjs(rdoc1Find?.doc_7_input_time_event_end_date).locale('th').format('MM')}/${dayjs(rdoc1Find?.doc_7_input_time_event_end_date).locale('th').format('BBBB')}`) ||
          ''; //วันที่เริ่มดำเนินการ ถึง วัน
        const input_time_event_end_time =
          rdoc1Find?.doc_7_input_time_event_end_time || ''; //วันที่เริ่มดำเนินการ ถึง เวลา
        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        // const irShipper = Array.from({ length: 5 }, (_, i) => i)?.map(
        const irShipper = rdoc1Find?.event_doc_gas_shipper_ofo_match?.flatMap(
          (ir: any, ix: number) => {
            // group?.name
            // event_doc_gas_shipper_ofo

            const hrLine = {
              canvas: [
                { type: 'line', x1: 0, y1: 0, x2: 400, y2: 0, lineWidth: 0.5 },
              ],
              margin: [0, 5, 0, 5],
            };

            const data1 = {
              // dynamic
              columns: [
                // { width: 'auto', text: `space`, opacity: 0 },
                { width: 'auto', text: 'ปรับ' },
                {
                  image:
                    ir?.event_doc_gas_shipper_ofo?.ir === 1
                      ? logocheckBoxCheck
                      : logocheckBox,
                  width: 12,
                  height: 12,
                  margin: [0, 0, 3, 0],
                },
                { width: 'auto', text: 'เพิ่ม / ' },
                {
                  image:
                    ir?.event_doc_gas_shipper_ofo?.ir === 2
                      ? logocheckBoxCheck
                      : logocheckBox,
                  width: 12,
                  height: 12,
                  margin: [0, 0, 3, 0],
                },
                { width: 'auto', text: 'ลดปริมาณก๊าซของผู้ใช้บริการ ' },
                {
                  width: 'auto',
                  text: `${group?.name}`,
                  decoration: 'underline',
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };

            const dataI = {
              // dynamic
              columns: [
                // { width: 'auto', text: `space`, opacity: 0 },
                {
                  image:
                    ir?.event_doc_gas_shipper_ofo?.io === 3
                      ? logocheckBoxCheck
                      : logocheckBox,
                  width: 12,
                  height: 12,
                  margin: [0, 0, 3, 0],
                },
                { width: 'auto', text: 'จุดส่งเข้า ' },
                {
                  width: 'auto',
                  text: `${(ir?.event_doc_gas_shipper_ofo?.io === 3 && `${ir?.event_doc_gas_shipper_ofo?.nomination_point?.area?.name || ''} จุดเชื่อมต่อจาก (${ir?.event_doc_gas_shipper_ofo?.nomination_point?.nomination_point})`) || '________'}`,
                  ...(ir?.event_doc_gas_shipper_ofo?.io === 3 &&
                    ir?.event_doc_gas_shipper_ofo?.nomination_point
                      ?.nomination_point && {
                      decoration: 'underline',
                    }),
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };

            const dataIValue = {
              // dynamic
              columns: [
                // { width: 'auto', text: `space`, opacity: 0 },
                { width: 'auto', text: 'ปริมาณ ' },
                {
                  width: 'auto',
                  text: `${(ir?.event_doc_gas_shipper_ofo?.io === 3 && !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh) || '________'}`,
                  ...(ir?.event_doc_gas_shipper_ofo?.io === 3 &&
                    !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && {
                      decoration: 'underline',
                    }),
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };

            const dataO = {
              // dynamic
              columns: [
                // { width: 'auto', text: `space`, opacity: 0 },
                {
                  image:
                    ir?.event_doc_gas_shipper_ofo?.io === 4
                      ? logocheckBoxCheck
                      : logocheckBox,
                  width: 12,
                  height: 12,
                  margin: [0, 0, 3, 0],
                },
                { width: 'auto', text: 'จุดจ่ายออก ' },
                {
                  width: 'auto',
                  text: `${(ir?.event_doc_gas_shipper_ofo?.io === 4 && `${ir?.event_doc_gas_shipper_ofo?.nomination_point?.area?.name || ''} จุดเชื่อมต่อจาก (${ir?.event_doc_gas_shipper_ofo?.nomination_point?.nomination_point})`) || '________'}`,
                  ...(ir?.event_doc_gas_shipper_ofo?.io === 4 &&
                    ir?.event_doc_gas_shipper_ofo?.nomination_point
                      ?.nomination_point && {
                      decoration: 'underline',
                    }),
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };

            const dataOValue = {
              // dynamic
              columns: [
                // { width: 'auto', text: `space`, opacity: 0 },
                { width: 'auto', text: 'ปริมาณ ' },
                {
                  width: 'auto',
                  text: `${(ir?.event_doc_gas_shipper_ofo?.io === 4 && !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh) || '________'}`,
                  ...(ir?.event_doc_gas_shipper_ofo?.io === 4 &&
                    !!ir?.event_doc_gas_shipper_ofo?.nom_value_mmscfh && {
                      decoration: 'underline',
                    }),
                },
              ],
              columnGap: 5,
              margin: [0, 0, 0, 5],
            };

            return [data1, dataI, dataIValue, dataO, dataOValue]; // https://app.clickup.com/t/86eum0nt8
          // return [data1, dataI, dataIValue, hrLine, dataO, dataOValue];
          },
        );
        console.log('----');
        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: `คําส่ังเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'})`,
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'ส่ง:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        // 'ส่วนปฏิบัติกํารรับจ่ํายก๊ําซธรรมชําติรํายวัน (Intra-day Natural Gas Operations Division)',
                        `${groups?.name}`,
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${longdo_dict || ''}`,
                        //
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ระบบส่งก๊าซ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: '(1.) ระบบส่งก๊าซ',
                          bold: true,
                          // decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              image:
                                rdoc1Find?.event_runnumber_ofo
                                  ?.event_doc_ofo_gas_tranmiss_id === 1
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Onshore East' },
                            {
                              image:
                                rdoc1Find?.event_runnumber_ofo
                                  ?.event_doc_ofo_gas_tranmiss_id === 2
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Onshore West' },
                            {
                              image:
                                rdoc1Find?.event_runnumber_ofo
                                  ?.event_doc_ofo_gas_tranmiss_id === 3
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Onshore East - West' },
                            {
                              image:
                                rdoc1Find?.event_runnumber_ofo
                                  ?.event_doc_ofo_gas_tranmiss_id === 4
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Other:' },
                            {
                              width: 'auto',
                              text: `${event_doc_ofo_gas_tranmiss_other}`,
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              image:
                                rdoc1Find?.doc_7_input_ref_1_id === 1
                                  ? logocheckBoxCheck
                                  : logocheckBox,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            {
                              width: 'auto',
                              text: 'อ้างอิง TSO Code ข้อที่ 8.8.4.5 เนื่องจากความไม่สมดุลของระบบส่งก๊าซ เข้าใกล้ขีดจำกัดที่ระบบจะสามารถรองรับจึงออกคำสั่ง Operational Flow Order เพื่อรักษาเสถียรภาพของระบบส่งก๊าซ',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              image:
                                rdoc1Find?.doc_7_input_ref_2_id === 2
                                  ? logocheckBoxCheck
                                  : logocheckBox,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            {
                              width: 'auto',
                              text: 'อ้างอิง TSO Code ข้อที่ 8.4.1.1(ง), 8.4.1.1(ฌ) และ 8.4.1.2 (ข) เพื่อควบคุมคุณภาพก๊าซรวมที่เข้าสู่ระบบให้เป็นไปตามข้อกำหนดคุณภาพก๊าซควบคุมที่เขตส่งมอบก๊าซ และเพื่อไม่ให้เกิดผลกระทบต่อผู้ใช้บริการและผู้ใช้ก๊าซจึงออกคำสั่ง Operational Flow Order',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              width: 'auto',
                              text: `วันที่ / เวลา ที่เกิดเหตุการณ์:`,
                            },
                            {
                              width: 'auto',
                              text: `${input_date_time_of_the_incident}`,
                              decoration: 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              width: 'auto',
                              text: 'รายละเอียดเหตุการณ์ความไม่สมดุล หรือเหตุการณ์เพื่อควบคุมคุณภาพก๊าซที่ต้องสั่งการอย่างจำเป็นเร่งด่วนเพื่อปกป้อง หรือระงับความเสียหายหรืออันตรายที่อาจเกิดขึ้นกับระบบส่งก๊าซ และรายละเอียดการสั่งการ: ',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              width: 'auto',
                              text: `${input_detail_incident}`,
                              decoration: 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        ...irShipper,
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            // { width: 'auto', text: `โดยอย่างช้าให้เริ่มดำเนินการตั้งแต่  น. วันที่ และดำเนินการให้แล้วเสร็จภายใน 00:01 น.วันที่ 13/08/2566` },
                            {
                              width: 'auto',
                              text: `โดยอย่างช้าให้เริ่มดำเนินการตั้งแต่`,
                            },
                            {
                              width: 'auto',
                              text: `${input_time_event_start_date}`,
                              decoration: 'underline',
                            },
                            { width: 'auto', text: ` น. วันที่ ` },
                            {
                              width: 'auto',
                              text: `${input_time_event_start_time}`,
                              decoration: 'underline',
                            },
                            {
                              width: 'auto',
                              text: ` และดำเนินการให้แล้วเสร็จภายใน `,
                            },
                            {
                              width: 'auto',
                              text: `${input_time_event_end_date}`,
                              decoration: 'underline',
                            },
                            { width: 'auto', text: ` น.วันที่ ` },
                            {
                              width: 'auto',
                              text: `${input_time_event_end_time}`,
                              decoration: 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `หมายเหตุ:` },
                            {
                              width: 'auto',
                              text: `${input_note}`,
                              decoration: 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบช่องเซ็นชื่อ =========
            {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    {
                      stack: [
                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         { text: '(', width: 'auto', alignment: 'right' },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        fromSignature
                          ? {
                              columns: [
                                {
                                  // text: 'รับทราบโดย',
                                  text: 'แจ้งโดย', // https://app.clickup.com/t/86eum0p1r
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `แจ้งโดย ` },
                        { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                      stack: [
                        // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                        // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        rdoc1Find?.event_doc_status?.id === 5 && toSignature
                          ? {
                              columns: [
                                {
                                  text: 'รับทราบโดย',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                                {
                                  image: toSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                // { text: ')', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `รับทราบโดย` },
                        {
                          text:
                            rdoc1Find?.event_doc_status?.id === 5
                              ? `(${toFullname})`
                              : '(…………………………………………………………)',
                        },
                        {
                          text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                        },
                        {
                          text: `(ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ/ผู้เกี่ยวข้อง)`,
                          width: 'auto',
                          alignment: 'center',
                        },
                        {
                          text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
            // characterSpacing: -0.5,
          },
        };
        console.log('docDefinition : ', docDefinition);

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }
      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  async doc7updateRef(payload: any, userId: any) {
    const { id, text } = payload;
    await this.prisma.event_doc_ofo_refer.updateMany({
      where: {
        id: Number(id),
      },
      data: {
        text: text,
      },
    });
    return payload;
  }

  // doc8
  async doc8EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc8RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber_ofo.findMany({
      where: {
        event_document_ofo: {
          none: {
            event_doc_master: {
              id: 8,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        event_doc_ofo_gas_tranmiss: true,
        event_doc_ofo_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_ofo: {
          include: {
            event_document_ofo_cc_email:true,
            event_document_ofo_email_group_for_event:true,
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_ofo_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc8Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc8Create(payload: any, userId: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,

      ref_document,

      doc_8_input_ref_doc_at, // doc8 ตามเอกสารเลขที่
      doc_8_input_date, // doc8 วันที่และเวลา วัน
      doc_8_input_time, // doc8 วันที่และเวลา เวลา
      doc_8_input_summary, // doc8 สรุปการแก้ปัญหา
      doc_8_input_summary_gas, // doc8 สรุปผลกระทบด้านปริมาณและด้านคุณภาพก๊าซ
      doc_8_input_more, // doc8 ข้อมูลเพิ่มเติม

      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;
      console.log('userTypeId : ', userTypeId);
      console.log('groupId : ', groupId);

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const tsoCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        event_runnumber_ofo: {
          connect: {
            id: Number(ref_document),
          },
        },
        event_doc_status: {
          connect: {
            id: 2,
          },
        },
        group: {
          connect: {
            id: groupId,
          },
        },
        user_type: {
          connect: {
            id: userTypeId,
          },
        },
        event_doc_master: {
          connect: {
            id: 8,
          },
        },

        doc_8_input_ref_doc_at: doc_8_input_ref_doc_at ?? null,
        doc_8_input_date:
          (doc_8_input_date && getTodayNowAdd7(doc_8_input_date).toDate()) ||
          null,
        doc_8_input_time: doc_8_input_time ?? null,
        doc_8_input_summary: doc_8_input_summary ?? null,

        doc_8_input_summary_gas: doc_8_input_summary_gas ?? null,
        doc_8_input_more: doc_8_input_more ?? null,

        longdo_dict: longdo_dict ?? null,

        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      };

      const createEventDocument = await prisma.event_document_ofo.create({
        data: tsoCreate,
        include: {
          event_doc_status: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_ofo_id: Number(createEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_ofo_file.createMany({
          data: fileData,
        });
      }

      await prisma.event_document_ofo_action.create({
        data: {
          event_document_ofo: {
            connect: {
              id: createEventDocument?.id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 8,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      // shipper multi create
      for (let iShipper = 0; iShipper < (shipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ref_document: createEventDocument?.id,
          event_runnumber_ofo: {
            connect: {
              id: Number(ref_document),
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: shipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 8,
            },
          },

          doc_8_input_ref_doc_at: doc_8_input_ref_doc_at ?? null,
          doc_8_input_date:
            (doc_8_input_date && getTodayNowAdd7(doc_8_input_date).toDate()) ||
            null,
          doc_8_input_time: doc_8_input_time ?? null,
          doc_8_input_summary: doc_8_input_summary ?? null,

          doc_8_input_summary_gas: doc_8_input_summary_gas ?? null,
          doc_8_input_more: doc_8_input_more ?? null,

          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_ofo.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_ofo_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_ofo_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_ofo_action.create({
          data: {
            event_document_ofo: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: shipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 8,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }
      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_ofo_id: createEventDocument?.id,
          edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_ofo_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_ofo_id: createEventDocument?.id,
          email: cc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_ofo_cc_email.createMany({
          data: CcEmail,
        }));

      const emailUse = {
        shipper: shipper,
        emailGroup: email_event_for_shipper,
        ccEmail: cc_email,
      };

      return {
        createEventRunnumber: { id: Number(ref_document) },
        createEventDocument,
        emailUse,
      };
    });

    const findOnce = await this.ofoOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_ofo_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_ofo: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 8);

    return findOnce;
  }

  async doc8Edit(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,

      ref_document,

      doc_8_input_ref_doc_at, // doc8 ตามเอกสารเลขที่
      doc_8_input_date, // doc8 วันที่และเวลา วัน
      doc_8_input_time, // doc8 วันที่และเวลา เวลา
      doc_8_input_summary, // doc8 สรุปการแก้ปัญหา
      doc_8_input_summary_gas, // doc8 สรุปผลกระทบด้านปริมาณและด้านคุณภาพก๊าซ
      doc_8_input_more, // doc8 ข้อมูลเพิ่มเติม

      file,
      shipper,
      email_event_for_shipper,
      cc_email,
      longdo_dict,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 2) {
        //tso create
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const getEventDocument = await prisma.event_document_emer.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber_emer: true,
          group: true,
          user_type: true,
          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      // -----

      const tsoCreate = {
        event_date: getTodayNowAdd7(event_date).toDate(),
        doc_8_input_ref_doc_at: doc_8_input_ref_doc_at ?? null,
        doc_8_input_date:
          (doc_8_input_date && getTodayNowAdd7(doc_8_input_date).toDate()) ||
          null,
        doc_8_input_time: doc_8_input_time ?? null,
        doc_8_input_summary: doc_8_input_summary ?? null,

        doc_8_input_summary_gas: doc_8_input_summary_gas ?? null,
        doc_8_input_more: doc_8_input_more ?? null,

        longdo_dict: longdo_dict ?? null,

        // create_date: getTodayNowAdd7().toDate(),
        // create_date_num: getTodayNowAdd7().unix(),
        // create_by_account: {
        //   connect: {
        //     id: Number(userId),
        //   },
        // },
        update_date: getTodayNowAdd7().toDate(),
        update_date_num: getTodayNowAdd7().unix(),
        update_by: Number(userId),
      };

      const updateEventDocument = await prisma.event_document_ofo.updateMany({
        where: { id: getEventDocument?.id },
        data: tsoCreate,
      });

      if (file && file.length > 0) {
        const fileData = file?.map((fileItem: any) => {
          return {
            url: fileItem,
            event_document_ofo_id: Number(getEventDocument?.id),
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          };
        });
        await prisma.event_document_ofo_file.createMany({
          data: fileData,
        });
      }

      const getEventDocumentNew = await prisma.event_document_ofo.findFirst({
        where: {
          id: Number(id),
        },
        include: {
          event_runnumber_ofo: {
            include: {
              event_document_ofo: true,
            },
          },
          event_document_ofo_email_group_for_event: {
            include: {
              edit_email_group_for_event: true,
            },
          },
          event_document_ofo_cc_email: true,
          group: true,
          user_type: true,

          create_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
          update_by_account: {
            select: {
              id: true,
              email: true,
              first_name: true,
              last_name: true,
            },
          },
        },
      });

      console.log('getEventDocumentNew : ', getEventDocumentNew);
      const nshipper = [];
      for (let inshipper = 0; inshipper < shipper?.length; inshipper++) {
        const findShipper =
          getEventDocumentNew?.event_runnumber_ofo?.event_document_ofo?.find(
            (f: any) => {
              return (
                f?.group_id === shipper?.[inshipper] &&
                f?.event_doc_master_id === 8
              );
            },
          );
        if (!findShipper) {
          nshipper.push(shipper?.[inshipper]);
        }
      }
      const nemail_event_for_shipper = [];
      for (
        let inemail_event_for_shipper = 0;
        inemail_event_for_shipper < email_event_for_shipper?.length;
        inemail_event_for_shipper++
      ) {
        const findEmail_event_for_shipper =
          getEventDocumentNew?.event_document_ofo_email_group_for_event?.find(
            (f: any) => {
              return (
                f?.edit_email_group_for_event?.id ===
                email_event_for_shipper?.[inemail_event_for_shipper]
              );
            },
          );
        if (!findEmail_event_for_shipper) {
          nemail_event_for_shipper.push(
            email_event_for_shipper?.[inemail_event_for_shipper],
          );
        }
      }
      const ncc_email = [];
      for (let incc_email = 0; incc_email < cc_email?.length; incc_email++) {
        const findCc_email =
          getEventDocumentNew?.event_document_ofo_cc_email?.find((f: any) => {
            return f?.email === cc_email[incc_email];
          });
        if (!findCc_email) {
          ncc_email.push(cc_email[incc_email]);
        }
      }

      // shipper multi create
      for (let iShipper = 0; iShipper < (nshipper?.length ?? 0); iShipper++) {
        //
        const shipperCreate = {
          ref_document: getEventDocumentNew?.id,
          event_runnumber_ofo: {
            connect: {
              id: getEventDocumentNew?.event_runnumber_ofo_id,
            },
          },
          event_doc_status: {
            connect: {
              id: 2,
            },
          },
          group: {
            connect: {
              id: nshipper?.[iShipper],
            },
          },
          user_type: {
            connect: {
              id: 3,
            },
          },
          event_doc_master: {
            connect: {
              id: 8,
            },
          },

          event_date: getTodayNowAdd7(event_date).toDate(),
          doc_8_input_ref_doc_at: doc_8_input_ref_doc_at ?? null,
          doc_8_input_date:
            (doc_8_input_date && getTodayNowAdd7(doc_8_input_date).toDate()) ||
            null,
          doc_8_input_time: doc_8_input_time ?? null,
          doc_8_input_summary: doc_8_input_summary ?? null,

          doc_8_input_summary_gas: doc_8_input_summary_gas ?? null,
          doc_8_input_more: doc_8_input_more ?? null,

          longdo_dict: longdo_dict ?? null,

          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        };

        const createEventDocumentShipper =
          await prisma.event_document_ofo.create({
            data: shipperCreate,
          });

        if (file && file.length > 0) {
          const fileData = file?.map((fileItem: any) => {
            return {
              url: fileItem,
              event_document_ofo_id: Number(createEventDocumentShipper?.id),
              create_date: getTodayNowAdd7().toDate(),
              create_date_num: getTodayNowAdd7().unix(),
              create_by: Number(userId),
            };
          });
          await prisma.event_document_ofo_file.createMany({
            data: fileData,
          });
        }

        await prisma.event_document_ofo_action.create({
          data: {
            event_document_ofo: {
              connect: {
                id: createEventDocumentShipper?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: 2,
              },
            },
            group: {
              connect: {
                id: nshipper?.[iShipper],
              },
            },
            user_type: {
              connect: {
                id: 3,
              },
            },
            event_doc_master: {
              connect: {
                id: 8,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });
      }

      // email_event_for_shipper
      const EEFS = [];
      for (let iEEFS = 0; iEEFS < (nemail_event_for_shipper?.length ?? 0); iEEFS++) {
        EEFS.push({
          event_document_ofo_id: getEventDocumentNew?.id,
          edit_email_group_for_event_id: nemail_event_for_shipper?.[iEEFS],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      EEFS.length > 0 &&
        (await prisma.event_document_ofo_email_group_for_event.createMany({
          data: EEFS,
        }));

      // cc_email
      const CcEmail = [];
      for (let iCcEmail = 0; iCcEmail < ncc_email.length; iCcEmail++) {
        CcEmail.push({
          event_document_ofo_id: getEventDocumentNew?.id,
          email: ncc_email[iCcEmail],
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by: Number(userId),
        });
      }
      CcEmail.length > 0 &&
        (await prisma.event_document_ofo_cc_email.createMany({
          data: CcEmail,
        }));

      const emailUse = {
        shipper: nshipper,
        emailGroup: nemail_event_for_shipper,
        ccEmail: ncc_email,
      };

      return {
        createEventRunnumber: {
          id: getEventDocumentNew?.event_runnumber_ofo_id,
        },
        getEventDocumentNew,
        emailUse,
      };
    });

    const findOnce = await this.ofoOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_ofo_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_ofo: {
          connect: {
            id: result?.getEventDocumentNew?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    await this.sendEmailCondition(result?.emailUse, findOnce, payload, 8);

    return findOnce;
  }

  async doc8Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_ofo.findFirst({
            where: {
              event_runnumber_ofo_id: Number(id),
              event_doc_master_id: 8,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_ofo_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          })
        : await this.prisma.event_document_ofo.findFirst({
            where: {
              event_runnumber_ofo_id: Number(id),
              event_doc_master_id: 8,
              ref_document: null,
            },
            include: {
              event_runnumber_ofo: {
                include: {
                  event_status: true,
                  event_document_ofo: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 8,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_ofo_cc_email: true,
              event_document_ofo_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_ofo_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_ofo_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_ofo_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc8History(id: any, userId: any, tso: any) {
    const resData = await this.prisma.event_document_ofo_log_history.findMany({
      where: {
        ...(tso
          ? {
              event_document_ofo: {
                event_runnumber_ofo_id: Number(id),
                event_doc_master_id: 8,
              },
            }
          : {
              event_document_ofo_id: Number(id),
            }),
      },
      include: {
        group: true,
        user_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
    });
    const nresData = resData?.map((e: any) => {
      const { temp, ...nE } = e;

      return {
        ...nE,
        row: temp ? JSON.parse(temp) : null,
      };
    });
    return nresData;
  }

  async doc8Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const { event_doc_status_id } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_ofo.findFirst({
        where: {
          event_status_id: 2,
          event_document_ofo: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_ofo.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_ofo_action.create({
        data: {
          event_document_ofo: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 8,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_ofo.findFirst({
        where: {
          event_document_ofo: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.ofoOnce(result?.eventRunId, userId);

    await this.prisma.event_document_ofo_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_ofo: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_ofo.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        doc_8_input_date: true,
        event_runnumber_ofo: {
          include: {
            event_doc_ofo_type: true,
            event_doc_ofo_gas_tranmiss: true,
          },
        },
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });
    const tesoNotiCenter = await this.tesoNotiCenter(1013)
    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
      ...tesoNotiCenter,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบคำสั่งเพิ่ม/ลดปริมาณก๊าซ (Operation Flow Order)`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/OFO - Shipper Acknowledge (Doc.8)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_ofo?.event_nember || ''}</li>
          <li>Type :  ${docId?.event_runnumber_ofo?.event_doc_ofo_type?.name_en || ''}</li>
          <li>Date :  ${docId?.doc_8_input_date || ''}</li>
          <li>ระบบส่งก๊าซ :  ${docId?.event_runnumber_ofo?.event_doc_ofo_gas_tranmiss_id === 5 ? docId?.event_runnumber_ofo?.event_doc_ofo_gas_tranmiss_other : docId?.event_runnumber_ofo?.event_doc_ofo_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'emergency_difficult_day_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc8PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);
    if (userTypeId === 3) {
      console.log('- -');
      const findRunnumber = await this.prisma.event_runnumber_ofo?.findFirst({
        where: { event_document_ofo: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc8Find(
        findRunnumber?.id,
        userId,
        null,
        shipperIds,
      );
      console.log('rdoc1Find : ', rdoc1Find);
      // rdoc1Find?.event_runnumber_ofo
      console.log(
        'rdoc1Find?.event_runnumber_ofo : ',
        rdoc1Find?.event_runnumber_ofo,
      );

      const event_document_action = rdoc1Find?.event_document_ofo_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_ofo?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_ref_doc_at =
        rdoc1Find?.doc_8_input_ref_doc_at; //อ้างอิงเอกสารเลขที่
      const input_event_date =
        (rdoc1Find?.doc_8_input_date &&
          `${dayjs(rdoc1Find?.doc_8_input_date).locale('th').format('DD')} ${dayjs(rdoc1Find?.doc_8_input_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc_8_input_date).locale('th').format('BBBB')}`) //ช่วงเวลาของเหตุการณ์ วันที่
      const input_event_time =
        rdoc1Find?.doc_8_input_time; //ช่วงเวลาของเหตุการณ์ เวลา
      const input_event_summary =
        rdoc1Find?.doc_8_input_summary; //ช่วงเวลาของเหตุการณ์ สรุปการแก้ไขปัญหา
      const input_summary_gas =
        rdoc1Find?.doc_8_input_summary_gas; //สรุปผลกระทบด้านปริมาณก๊าซ และด้านคุณภาพก๊าซ
      const input_more_info =
        rdoc1Find?.doc_8_input_more; //ข้อมูลเพิ่มเติม

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: `เอกสารแจ้งสิ้นสุดคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'})`,
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${group?.name}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `อ้างอิงคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ตามเอกสารเลขที่ ${input_ref_doc_at} เพื่อปกป้องหรือระงับความเสียหายหรืออันตรายที่อากเกิดขึ้นกับระบบส่งก๊าซ`,
                            text: [
                              `อ้างอิงคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ตามเอกสารเลขที่ `,
                              {
                                text:
                                input_ref_doc_at ? input_ref_doc_at : '____________',
                                decoration: input_ref_doc_at && 'underline',
                              },
                              ` เพื่อปกป้องหรือระงับความเสียหายหรืออันตรายที่อากเกิดขึ้นกับระบบส่งก๊าซ`,
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `ปัจจุบันผู้ให้บริการระบบส่งก๊าซ (TSO) สามารถควบคุมเหตุการณ์ที่เกิดขึ้นจนกลับสู่สภาวะปกติ เมื่อวันที่ ${input_event_date} เวลา ${input_event_time} น. จึงขอแจ้งสิ้นสุดคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ในเอกสารดังกล่าว และให้ผู้ใช้บริการรับ-ส่งก๊าซได้ตามปกติ`,
                            text: [
                              `ปัจจุบันผู้ให้บริการระบบส่งก๊าซ (TSO) สามารถควบคุมเหตุการณ์ที่เกิดขึ้นจนกลับสู่สภาวะปกติ เมื่อวันที่ `,
                              {
                                text:
                                input_event_date ? input_event_date : '____________',
                                decoration: input_event_date && 'underline',
                              },
                              ` เวลา `,
                              {
                                text:
                                input_event_time ? input_event_time : '____________',
                                decoration: input_event_time && 'underline',
                              },
                              ` น. จึงขอแจ้งสิ้นสุดคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ในเอกสารดังกล่าว และให้ผู้ใช้บริการรับ-ส่งก๊าซได้ตามปกติ`,
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            // text: `สรุปการแก้ไขปัญหา: ${input_event_summary}`,
                             text: [
                              `สรุปการแก้ไขปัญหา `,
                              {
                                text:
                                input_event_summary ? input_event_summary : '____________',
                                decoration: input_event_summary && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            // text: `สรุปผลกระทบด้านปริมาณ และด้านคุณภาพก๊าซ: ${input_summary_gas}`,
                            text: [
                              `สรุปผลกระทบด้านปริมาณ และด้านคุณภาพก๊าซ: `,
                              {
                                text:
                                input_summary_gas ? input_summary_gas : '____________',
                                decoration: input_summary_gas && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            // text: `ข้อมูลเพิ่มเติม: ${input_more_info}`,
                             text: [
                              `ข้อมูลเพิ่มเติม: `,
                              {
                                text:
                                input_more_info ? input_more_info : '____________',
                                decoration: input_more_info && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    {
                      stack: [
                        // https://app.clickup.com/t/86eugkjfb
                        fromSignature
                          ? {
                              columns: [
                                {
                                  text: 'แจ้งโดย ',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                { text: '', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `แจ้งโดย ` },
                          { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },

                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         {
                        //           text: '(',
                        //           width: 'auto',
                        //           alignment: 'right',
                        //         },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                    stack: [
                      toSignature && toFullname 
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toFullname ? `( ${toFullname} )` : `(                                   )` },

                      // { text: `รับทราบโดย ${toFullname}` },
                      // toSignature && toFullname 
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${toFullname && toCompany || "________________"} (ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ)` },
                      {
                        text: `เวลา : ${toFullname && toDate.format('HH:mm') || "___"} น. วันที่/เดือน/ปี: ${toFullname && toDate.format('DD') || "___"} / ${toFullname && toDate.format('MM') || "___"} / ${toFullname && toDate.format('BB') || "___"}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_ofo.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      // group
      console.log('inputList : ', inputList);
      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;
        console.log('- groupId : ', groupId);

        const findRunnumber = await this.prisma.event_runnumber_ofo?.findFirst({
        where: { event_document_ofo: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc8Find(
        findRunnumber?.id,
        userId,
        null,
        group_id,
      );
      console.log('rdoc1Find : ', rdoc1Find);
      // rdoc1Find?.event_runnumber_ofo
      console.log(
        'rdoc1Find?.event_runnumber_ofo : ',
        rdoc1Find?.event_runnumber_ofo,
      );

      const event_document_action = rdoc1Find?.event_document_ofo_action;
      console.log('event_document_action : ', event_document_action);
      const toAction = event_document_action?.find(
        // (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        (f: any) => f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        // toAction?.event_doc_status_id !== 1 &&
        // toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_ofo?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const input_ref_doc_at =
        rdoc1Find?.doc_8_input_ref_doc_at; //อ้างอิงเอกสารเลขที่
      const input_event_date =
        (rdoc1Find?.doc_8_input_date &&
          `${dayjs(rdoc1Find?.doc_8_input_date).locale('th').format('DD')} ${dayjs(rdoc1Find?.doc_8_input_date).locale('th').format('MMM')} ${dayjs(rdoc1Find?.doc_8_input_date).locale('th').format('BBBB')}`) //ช่วงเวลาของเหตุการณ์ วันที่
      const input_event_time =
        rdoc1Find?.doc_8_input_time; //ช่วงเวลาของเหตุการณ์ เวลา
      const input_event_summary =
        rdoc1Find?.doc_8_input_summary; //ช่วงเวลาของเหตุการณ์ สรุปการแก้ไขปัญหา
      const input_summary_gas =
        rdoc1Find?.doc_8_input_summary_gas; //สรุปผลกระทบด้านปริมาณก๊าซ และด้านคุณภาพก๊าซ
      const input_more_info =
        rdoc1Find?.doc_8_input_more; //ข้อมูลเพิ่มเติม

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา
      console.log('- -');

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: `เอกสารแจ้งสิ้นสุดคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'})`,
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${groups?.name}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [`${longdo_dict || ''}`],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `อ้างอิงคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ตามเอกสารเลขที่ ${input_ref_doc_at} เพื่อปกป้องหรือระงับความเสียหายหรืออันตรายที่อากเกิดขึ้นกับระบบส่งก๊าซ`,
                            text: [
                              `อ้างอิงคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ตามเอกสารเลขที่ `,
                              {
                                text:
                                input_ref_doc_at ? input_ref_doc_at : '____________',
                                decoration: input_ref_doc_at && 'underline',
                              },
                              ` เพื่อปกป้องหรือระงับความเสียหายหรืออันตรายที่อากเกิดขึ้นกับระบบส่งก๊าซ`,
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            // text: `ปัจจุบันผู้ให้บริการระบบส่งก๊าซ (TSO) สามารถควบคุมเหตุการณ์ที่เกิดขึ้นจนกลับสู่สภาวะปกติ เมื่อวันที่ ${input_event_date} เวลา ${input_event_time} น. จึงขอแจ้งสิ้นสุดคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ในเอกสารดังกล่าว และให้ผู้ใช้บริการรับ-ส่งก๊าซได้ตามปกติ`,
                            text: [
                              `ปัจจุบันผู้ให้บริการระบบส่งก๊าซ (TSO) สามารถควบคุมเหตุการณ์ที่เกิดขึ้นจนกลับสู่สภาวะปกติ เมื่อวันที่ `,
                              {
                                text:
                                input_event_date ? input_event_date : '____________',
                                decoration: input_event_date && 'underline',
                              },
                              ` เวลา `,
                              {
                                text:
                                input_event_time ? input_event_time : '____________',
                                decoration: input_event_time && 'underline',
                              },
                              ` น. จึงขอแจ้งสิ้นสุดคำสั่งเพิ่ม/ลดปริมาณก๊าซ (${rdoc1Find?.event_runnumber_ofo?.event_doc_ofo_type_id === 1 ? 'Operation Flow Order' : 'Instructed Flow Order'}) ในเอกสารดังกล่าว และให้ผู้ใช้บริการรับ-ส่งก๊าซได้ตามปกติ`,
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            // text: `สรุปการแก้ไขปัญหา: ${input_event_summary}`,
                             text: [
                              `สรุปการแก้ไขปัญหา `,
                              {
                                text:
                                input_event_summary ? input_event_summary : '____________',
                                decoration: input_event_summary && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            // text: `สรุปผลกระทบด้านปริมาณ และด้านคุณภาพก๊าซ: ${input_summary_gas}`,
                            text: [
                              `สรุปผลกระทบด้านปริมาณ และด้านคุณภาพก๊าซ: `,
                              {
                                text:
                                input_summary_gas ? input_summary_gas : '____________',
                                decoration: input_summary_gas && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            // text: `ข้อมูลเพิ่มเติม: ${input_more_info}`,
                             text: [
                              `ข้อมูลเพิ่มเติม: `,
                              {
                                text:
                                input_more_info ? input_more_info : '____________',
                                decoration: input_more_info && 'underline',
                              },
                            ],
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    {
                      stack: [
                        // https://app.clickup.com/t/86eugkjfb
                        fromSignature
                          ? {
                              columns: [
                                {
                                  text: 'แจ้งโดย ',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                { text: '', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `แจ้งโดย ` },
                          { text: fromFullname ? `( ${fromFullname} )` : `(                                   )` },

                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         {
                        //           text: '(',
                        //           width: 'auto',
                        //           alignment: 'right',
                        //         },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                    stack: [
                      toSignature && toFullname 
                        ? {
                            columns: [
                              { text: 'รับทราบโดย ', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              { text: '', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย ` },
                      { text: toFullname ? `( ${toFullname} )` : `(                                   )` },

                      // { text: `รับทราบโดย ${toFullname}` },
                      // toSignature && toFullname 
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: toSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      { text: `หน่วยงาน ${toFullname && toCompany || "________________"} (ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ)` },
                      {
                        text: `เวลา : ${toFullname && toDate.format('HH:mm') || "___"} น. วันที่/เดือน/ปี: ${toFullname && toDate.format('DD') || "___"} / ${toFullname && toDate.format('MM') || "___"} / ${toFullname && toDate.format('BB') || "___"}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }
      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }

  // doc41

  async doc41EmailGroupForEvent(userId: any) {
    const resEmail = await this.prisma.edit_email_group_for_event.findMany({
      include: {
        edit_email_group_for_event_match: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });
    return resEmail;
  }

  async doc41Shipper(userId: any) {
    const resDoc = await this.prisma.group.findMany({
      where: {
        user_type_id: 3,
      },
      select: {
        id: true,
        id_name: true,
        name: true,
        company_name: true,
        email: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    // const filtered = resDoc.filter(
    //   (item) =>
    //     !item.event_document.some((doc) => doc.event_doc_master_id === 2),
    // );

    return resDoc;
  }

  async doc41RefDocUsed(userId: any) {
    const resDoc = await this.prisma.event_runnumber_emer.findMany({
      where: {
        event_document_emer: {
          none: {
            event_doc_master: {
              id: 4,
            },
          },
        },
        event_status_id: 1,
      },
      include: {
        group: true,
        event_doc_emer_gas_tranmiss: true,
        event_doc_emer_type: true,
        create_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        update_by_account: {
          select: {
            id: true,
            email: true,
            first_name: true,
            last_name: true,
          },
        },
        event_document_emer: {
          include: {
            create_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            update_by_account: {
              select: {
                id: true,
                email: true,
                first_name: true,
                last_name: true,
              },
            },
            event_document_emer_file: {
              include: {
                create_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
                update_by_account: {
                  select: {
                    id: true,
                    email: true,
                    first_name: true,
                    last_name: true,
                  },
                },
              },
              orderBy: { id: 'desc' },
            },
          },
        },
      },
      orderBy: {
        id: 'desc',
      },
    });

    return resDoc;
  }

  async doc41Order(userId: any) {
    const resDoc = await this.prisma.event_doc_emer_order.findMany({
      where: {},
      orderBy: {
        id: 'asc',
      },
    });

    return resDoc;
  }

  async doc41Find(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;

    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 41,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_match_41: {
                include: {
                  event_doc_gas_shipper_41: {
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_file_41: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                    },
                  },
                  event_document_emer: true,
                },
              },
              event_doc_gas_shipper_41: {
                include: {
                  event_doc_gas_shipper_match_41: {
                    include: {
                      event_doc_gas_shipper_41: {
                        include: {
                          event_document_emer: true,
                          event_doc_gas_shipper_file_41: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_file_41: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                },
              },
            },
          })
        : await this.prisma.event_document_emer.findFirst({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 41,
              ref_document: null,
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 6,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_doc_gas_shipper_match_41: {
                include: {
                  event_doc_gas_shipper_41: {
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_file_41: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                    },
                  },
                  event_document_emer: true,
                },
              },
              event_doc_gas_shipper_41: {
                include: {
                  event_doc_gas_shipper_match_41: {
                    include: {
                      event_doc_gas_shipper_41: {
                        include: {
                          event_document_emer: true,
                          event_doc_gas_shipper_file_41: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                      event_document_emer: true,
                    },
                  },
                  event_doc_gas_shipper_file_41: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc41Create(payload: any, userId: any, generated?: any) {
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_date,

      doc_41_input_date_time_of_the_incident, //วัน/เวลาที่เกิดเหตุ
      doc_41_input_incident, // สถานที่
      doc_41_input_detail_incident, //รายละเอียดของเหตุการณ์ และผลกระทบต่อระบบส่งก๊าซ
      doc_41_input_expected_day_time, //คาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา
      doc_41_input_note, // หมายเหตุ
      gas_shipper_41,

      id_documents, // ใช้ตอน edit version
      id_runnumber,

      generate,

      email_event_for_shipper,
      cc_email,
      longdo_dict,
      //
    } = payload;
    console.log('payload : ', payload);

    const result = await this.prisma.$transaction(
      async (prisma) => {
        const newDate = getTodayNowAdd7();
        const todayStart = getYearStartAdd7().toDate();
        const todayEnd = getYearEndAdd7().toDate();

        const group = await this.prisma.group.findFirst({
          where: {
            account_manage: {
              some: {
                account_id: Number(userId),
              },
            },
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        });
        const userTypeId = group.user_type?.id;
        const groupId = group?.id;
        console.log('userTypeId : ', userTypeId);
        console.log('groupId : ', groupId);

        if (userTypeId !== 2) {
          //tso create
          throw new HttpException(
            {
              status: HttpStatus.BAD_REQUEST,
              error: 'Uset Type Is NOT MATCH',
            },
            HttpStatus.BAD_REQUEST,
          );
        }
        // generated

        // version
        // generate
        // id_documents

        const createEventRunnumber =
          await prisma.event_runnumber_emer.findFirst({
            where: {
              id: Number(id_runnumber),
            },
            include: {
              event_document_emer: true,
              event_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                },
              },
            },
          });

        // -----
        console.log('id_runnumber : ', id_runnumber);
        console.log('id_documents : ', id_documents);
        console.log('createEventRunnumber : ', createEventRunnumber);
        console.log('generate : ', generate);

        const versionUse =
          createEventRunnumber?.event_document_emer?.filter(
            (f: any) => f?.event_doc_master_id === 41,
          ) || [];
        console.log('versionUse : ', versionUse);
        const version =
          versionUse?.length === 0
            ? 1
            : Math.max(...versionUse?.map((f: any) => f.seq || 0)) + 1;

        console.log('version : ', version);
        console.log('createEventRunnumber : ', createEventRunnumber);

        const tsoCreate = {
          event_date: getTodayNowAdd7(event_date).toDate(),
          ...(!!generate && !!id_documents
            ? {
                event_doc_status_id: 2,

                doc_41_input_date_time_of_the_incident:
                  doc_41_input_date_time_of_the_incident ?? null,
                doc_41_input_incident: doc_41_input_incident ?? null,
                doc_41_input_detail_incident:
                  doc_41_input_detail_incident ?? null,
                doc_41_input_expected_day_time:
                  doc_41_input_expected_day_time ?? null,
                doc_41_input_note: doc_41_input_note ?? null,

                longdo_dict: longdo_dict ?? null,

                update_date: getTodayNowAdd7().toDate(),
                update_date_num: getTodayNowAdd7().unix(),
                update_by: Number(userId),
              }
            : {
                version_text: `V.${generate ? version - 1 : version}`,
                seq: generate ? version - 1 : version,

                event_runnumber_emer: {
                  connect: {
                    id: createEventRunnumber?.id,
                  },
                },
                event_doc_status: {
                  connect: {
                    id: generated ? 6 : 2,
                  },
                },
                group: {
                  connect: {
                    id: groupId,
                  },
                },
                user_type: {
                  connect: {
                    id: userTypeId,
                  },
                },
                event_doc_master: {
                  connect: {
                    id: 41,
                  },
                },

                doc_41_input_date_time_of_the_incident:
                  doc_41_input_date_time_of_the_incident ?? null,
                doc_41_input_incident: doc_41_input_incident ?? null,
                doc_41_input_detail_incident:
                  doc_41_input_detail_incident ?? null,
                doc_41_input_expected_day_time:
                  doc_41_input_expected_day_time ?? null,
                doc_41_input_note: doc_41_input_note ?? null,

                longdo_dict: longdo_dict ?? null,

                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by_account: {
                  connect: {
                    id: Number(userId),
                  },
                },
              }),
        };

        if (!!id_runnumber && !!generate) {
          await prisma.event_document_emer.update({
            where: { id: Number(id_documents) },
            data: tsoCreate,
          });
        }

        const createEventDocument =
          !!id_runnumber && !!generate
            ? await prisma.event_document_emer.findFirst({
                where: { id: Number(id_documents) },
                include: {
                  event_doc_gas_shipper_41: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              })
            : await prisma.event_document_emer.create({
                data: tsoCreate,
                include: {
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              });
        console.log('createEventDocument : ', createEventDocument);

        if (!!id_runnumber && !!generate) {
          await prisma.event_document_emer.deleteMany({
            where: {
              ref_document: Number(createEventDocument?.id),
            },
          });
        }

        for (let i = 0; i < (gas_shipper_41?.length ?? 0); i++) {
          if (!!id_runnumber && !!generate) {
            if (gas_shipper_41?.[i]?.id === null) {
              const gas_shipper_create =
                await prisma.event_doc_gas_shipper_41.create({
                  data: {
                    ir: gas_shipper_41?.[i]?.ir ?? null,
                    io: gas_shipper_41?.[i]?.io ?? null,
                    iother: gas_shipper_41?.[i]?.iother ?? null,

                    value: gas_shipper_41?.[i]?.value ?? null,
                    more: gas_shipper_41?.[i]?.more ?? null,
                    event_document_emer: {
                      connect: {
                        id: Number(createEventDocument?.id),
                      },
                    },
                    create_date: getTodayNowAdd7().toDate(),
                    create_date_num: getTodayNowAdd7().unix(),
                    create_by_account: {
                      connect: {
                        id: Number(userId),
                      },
                    },
                  },
                });
              for (
                let iShipper = 0;
                iShipper < gas_shipper_41?.[i]?.shipper?.length;
                iShipper++
              ) {
                const findDocShipper =
                  await prisma.event_document_emer.findFirst({
                    where: {
                      ref_document: createEventDocument?.id,
                      group_id: gas_shipper_41?.[i]?.shipper?.[iShipper],
                    },
                  });
                if (findDocShipper) {
                  await prisma.event_doc_gas_shipper_match_41.create({
                    data: {
                      event_document_emer_id: findDocShipper?.id,
                      event_doc_gas_shipper_41_id: gas_shipper_create?.id,
                    },
                  });
                } else {
                  const shipperCreate = {
                    event_date: getTodayNowAdd7(event_date).toDate(),
                    version_text: `V.${generate ? version - 1 : version}`,
                    seq: generate ? version - 1 : version,
                    ref_document: createEventDocument?.id,
                    event_runnumber_emer: {
                      connect: {
                        id: createEventRunnumber?.id,
                      },
                    },
                    event_doc_status: {
                      connect: {
                        id: generated ? 6 : 2,
                      },
                    },
                    group: {
                      connect: {
                        id: gas_shipper_41?.[i]?.shipper?.[iShipper],
                      },
                    },
                    user_type: {
                      connect: {
                        id: 3,
                      },
                    },
                    event_doc_master: {
                      connect: {
                        id: 41,
                      },
                    },

                    doc_41_input_date_time_of_the_incident:
                      doc_41_input_date_time_of_the_incident ?? null,
                    doc_41_input_incident: doc_41_input_incident ?? null,
                    doc_41_input_detail_incident:
                      doc_41_input_detail_incident ?? null,
                    doc_41_input_expected_day_time:
                      doc_41_input_expected_day_time ?? null,
                    doc_41_input_note: doc_41_input_note ?? null,

                    longdo_dict: longdo_dict ?? null,

                    create_date: getTodayNowAdd7().toDate(),
                    create_date_num: getTodayNowAdd7().unix(),
                    create_by_account: {
                      connect: {
                        id: Number(userId),
                      },
                    },
                  };

                  const createEventDocumentShipper =
                    await prisma.event_document_emer.create({
                      data: shipperCreate,
                    });

                  await prisma.event_doc_gas_shipper_match_41.create({
                    data: {
                      event_document_emer_id: createEventDocumentShipper?.id,
                      event_doc_gas_shipper_41_id: gas_shipper_create?.id,
                    },
                  });
                }
              }

              if (
                gas_shipper_41?.[i]?.file &&
                gas_shipper_41?.[i]?.file.length > 0
              ) {
                const fileData = gas_shipper_41?.[i]?.file?.map(
                  (fileItem: any) => {
                    return {
                      url: fileItem,
                      event_doc_gas_shipper_41_id: Number(
                        gas_shipper_create?.id,
                      ),
                      create_date: getTodayNowAdd7().toDate(),
                      create_date_num: getTodayNowAdd7().unix(),
                      create_by: Number(userId),
                    };
                  },
                );
                await prisma.event_doc_gas_shipper_file_41.createMany({
                  data: fileData,
                });
              }
            } else {
              for (
                let iShipper = 0;
                iShipper < gas_shipper_41?.[i]?.shipper?.length;
                iShipper++
              ) {
                const shipperCreate = {
                  event_date: getTodayNowAdd7(event_date).toDate(),
                  version_text: `V.${generate ? version - 1 : version}`,
                  seq: generate ? version - 1 : version,
                  ref_document: createEventDocument?.id,
                  event_runnumber_emer: {
                    connect: {
                      id: createEventRunnumber?.id,
                    },
                  },
                  event_doc_status: {
                    connect: {
                      id: generated ? 6 : 2,
                    },
                  },
                  group: {
                    connect: {
                      id: gas_shipper_41?.[i]?.shipper?.[iShipper],
                    },
                  },
                  user_type: {
                    connect: {
                      id: 3,
                    },
                  },
                  event_doc_master: {
                    connect: {
                      id: 41,
                    },
                  },

                  doc_41_input_date_time_of_the_incident:
                    doc_41_input_date_time_of_the_incident ?? null,
                  doc_41_input_incident: doc_41_input_incident ?? null,
                  doc_41_input_detail_incident:
                    doc_41_input_detail_incident ?? null,
                  doc_41_input_expected_day_time:
                    doc_41_input_expected_day_time ?? null,
                  doc_41_input_note: doc_41_input_note ?? null,

                  longdo_dict: longdo_dict ?? null,

                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                };
                const createEventDocumentShipper =
                  await prisma.event_document_emer.create({
                    data: shipperCreate,
                  });

                console.log('gas_shipper_41[i] : ', gas_shipper_41?.[i]);
                console.log(
                  'createEventDocumentShipper : ',
                  createEventDocumentShipper,
                );

                await prisma.event_doc_gas_shipper_match_41.create({
                  data: {
                    event_document_emer_id: createEventDocumentShipper?.id,
                    event_doc_gas_shipper_41_id: Number(gas_shipper_41?.[i]?.id),
                  },
                });
                // }
              }

              if (
                gas_shipper_41?.[i]?.file &&
                gas_shipper_41?.[i]?.file.length > 0
              ) {
                const fileData = gas_shipper_41?.[i]?.file?.map(
                  (fileItem: any) => {
                    return {
                      url: fileItem,
                      event_doc_gas_shipper_41_id: Number(
                        gas_shipper_41?.[i]?.id,
                      ),
                      create_date: getTodayNowAdd7().toDate(),
                      create_date_num: getTodayNowAdd7().unix(),
                      create_by: Number(userId),
                    };
                  },
                );
                await prisma.event_doc_gas_shipper_file_41.createMany({
                  data: fileData,
                });
              }
            }
          } else {
            console.log('******');

            const gas_shipper_create =
              await prisma.event_doc_gas_shipper_41.create({
                data: {
                  ir: gas_shipper_41?.[i]?.ir ?? null,
                  io: gas_shipper_41?.[i]?.io ?? null,
                  ...(!!gas_shipper_41?.[i]?.area && {
                    area: {
                      connect: {
                        id: Number(gas_shipper_41?.[i]?.area),
                      },
                    },
                  }),
                  ...(!!gas_shipper_41?.[i]?.nom_point && {
                    nomination_point: {
                      connect: {
                        id: Number(gas_shipper_41?.[i]?.nom_point),
                      },
                    },
                  }),
                  value: gas_shipper_41?.[i]?.value ?? null,
                  more: gas_shipper_41?.[i]?.more ?? null,
                  event_document_emer: {
                    connect: {
                      id: Number(createEventDocument?.id),
                    },
                  },
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by_account: {
                    connect: {
                      id: Number(userId),
                    },
                  },
                },
              });
            for (
              let iShipper = 0;
              iShipper < gas_shipper_41?.[i]?.shipper?.length;
              iShipper++
            ) {
              const shipperCreate = {
                event_date: getTodayNowAdd7(event_date).toDate(),
                version_text: `V.${generate ? version - 1 : version}`,
                seq: generate ? version - 1 : version,
                ref_document: createEventDocument?.id,
                event_runnumber_emer: {
                  connect: {
                    id: createEventRunnumber?.id,
                  },
                },
                event_doc_status: {
                  connect: {
                    id: generated ? 6 : 2,
                  },
                },
                group: {
                  connect: {
                    id: gas_shipper_41?.[i]?.shipper?.[iShipper],
                  },
                },
                user_type: {
                  connect: {
                    id: 3,
                  },
                },
                event_doc_master: {
                  connect: {
                    id: 41,
                  },
                },

                doc_41_input_date_time_of_the_incident:
                  doc_41_input_date_time_of_the_incident ?? null,
                doc_41_input_incident: doc_41_input_incident ?? null,
                doc_41_input_detail_incident:
                  doc_41_input_detail_incident ?? null,
                doc_41_input_expected_day_time:
                  doc_41_input_expected_day_time ?? null,
                doc_41_input_note: doc_41_input_note ?? null,

                // }),
                // ...(doc_7_input_order_ir_id && {
                //   doc_7_input_order_ir: {
                //     connect: {
                //       id: doc_7_input_order_ir_id ?? null,
                //     },
                //   },
                // }),
                // ...(doc_7_input_order_io_id && {
                //   doc_7_input_order_io: {
                //     connect: {
                //       id: doc_7_input_order_io_id ?? null,
                //     },
                //   },
                // }),
                // ...(doc_7_input_order_other_id && {
                //   doc_7_input_order_other: {
                //     connect: {
                //       id: doc_7_input_order_other_id ?? null,
                //     },
                //   },
                // }),
                // doc_7_input_order_other_value:
                //   doc_7_input_order_other_value ?? null,

                longdo_dict: longdo_dict ?? null,

                create_date: getTodayNowAdd7().toDate(),
                create_date_num: getTodayNowAdd7().unix(),
                create_by_account: {
                  connect: {
                    id: Number(userId),
                  },
                },
              };

              const createEventDocumentShipper =
                await prisma.event_document_emer.create({
                  data: shipperCreate,
                });

              await prisma.event_doc_gas_shipper_match_41.create({
                data: {
                  event_document_emer_id: createEventDocumentShipper?.id,
                  event_doc_gas_shipper_41_id: gas_shipper_create?.id,
                },
              });
            }

            if (gas_shipper_41?.[i]?.file && gas_shipper_41?.[i]?.file.length > 0) {
              const fileData = gas_shipper_41?.[i]?.file?.map((fileItem: any) => {
                return {
                  url: fileItem,
                  event_doc_gas_shipper_41_id: Number(gas_shipper_create?.id),
                  create_date: getTodayNowAdd7().toDate(),
                  create_date_num: getTodayNowAdd7().unix(),
                  create_by: Number(userId),
                };
              });
              await prisma.event_doc_gas_shipper_file_41.createMany({
                data: fileData,
              });
            }
          }
        }

        await prisma.event_document_emer_action.create({
          data: {
            event_document_emer: {
              connect: {
                id: createEventDocument?.id,
              },
            },
            event_doc_status: {
              connect: {
                id: generated ? 6 : 2,
              },
            },
            group: {
              connect: {
                id: groupId,
              },
            },
            user_type: {
              connect: {
                id: userTypeId,
              },
            },
            event_doc_master: {
              connect: {
                id: 41,
              },
            },
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by_account: {
              connect: {
                id: Number(userId),
              },
            },
          },
        });

        // -----

        const EEFS = [];
        for (let iEEFS = 0; iEEFS < (email_event_for_shipper?.length ?? 0); iEEFS++) {
          EEFS.push({
            event_document_emer_id: createEventDocument?.id,
            edit_email_group_for_event_id: email_event_for_shipper?.[iEEFS],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        EEFS.length > 0 &&
          (await prisma.event_document_emer_email_group_for_event.createMany({
            data: EEFS,
          }));

        // cc_email
        const CcEmail = [];
        for (let iCcEmail = 0; iCcEmail < cc_email.length; iCcEmail++) {
          CcEmail.push({
            event_document_emer_id: createEventDocument?.id,
            email: cc_email[iCcEmail],
            create_date: getTodayNowAdd7().toDate(),
            create_date_num: getTodayNowAdd7().unix(),
            create_by: Number(userId),
          });
        }
        CcEmail.length > 0 &&
          (await prisma.event_document_emer_cc_email.createMany({
            data: CcEmail,
          }));

        const emailUse = {
          shipper: gas_shipper_41?.map((gs: any) => gs?.['shipper']).flat(),
          emailGroup: email_event_for_shipper,
          ccEmail: cc_email,
        };

        return { createEventRunnumber, createEventDocument, emailUse };
      },
      {
        timeout: 15000, // เพิ่มเป็น 10 วินาที
        maxWait: 15000, // รอให้ transaction พร้อม
      },
    );

    const findOnce = await this.emerOnce(
      result?.createEventRunnumber?.id,
      userId,
    );

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: result?.createEventDocument?.id,
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    console.log('emailUse : ', result?.emailUse);
    !generate &&
      !generated &&
      (await this.sendEmailCondition(result?.emailUse, findOnce, payload, 41));

    return findOnce;
  }

  async doc41FindVersion(
    id: any,
    userId: any,
    groupObj?: any,
    shipperIds?: any,
  ) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findMany({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 41,
              ref_document: {
                not: null,
              },
              group_id: Number(groupId),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          })
        : await this.prisma.event_document_emer.findMany({
            where: {
              event_runnumber_emer_id: Number(id),
              event_doc_master_id: 41,
              ref_document: null,
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 41,
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
            },
            orderBy: {
              id: 'desc',
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc41FindDoc(id: any, userId: any, groupObj?: any, shipperIds?: any) {
    console.log('userId : ', userId);
    console.log('shipperIds : ', shipperIds);

    const group = shipperIds
      ? await this.prisma.group.findFirst({
          where: {
            id: shipperIds,
          },
          select: {
            id: true,
            user_type: {
              select: {
                id: true,
              },
            },
          },
        })
      : userId
        ? await this.prisma.group.findFirst({
            where: {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            },
            select: {
              id: true,
              user_type: {
                select: {
                  id: true,
                },
              },
            },
          })
        : groupObj;
    console.log('group : ', group);
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;

    console.log('userTypeId : ', userTypeId);
    console.log('groupId : ', groupId);
    const result =
      userTypeId === 3
        ? await this.prisma.event_document_emer.findFirst({
            where: {
              id: Number(id),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_match_41: {
                where: {
                  event_document_emer_id: {
                    not: null,
                  },
                },
                include: {
                  event_doc_gas_shipper_41: {
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_file_41: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                    },
                  },
                  event_document_emer: true,
                },
              },
              event_doc_gas_shipper_41: {
                include: {
                  event_doc_gas_shipper_match_41: {
                    where: {
                      event_document_emer_id: {
                        not: null,
                      },
                    },
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_41: {
                        include: {
                          event_document_emer: true,
                          event_doc_gas_shipper_file_41: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_file_41: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                },
              },
            },
          })
        : await this.prisma.event_document_emer.findFirst({
            where: {
              id: Number(id),
            },
            include: {
              event_runnumber_emer: {
                include: {
                  event_status: true,
                  event_document_emer: {
                    include: {
                      event_doc_status: true,
                      group: true,
                      user_type: true,
                    },
                    where: {
                      user_type: {
                        id: 3,
                      },
                      event_doc_master_id: 41,
                      ref_document: Number(id),
                    },
                  },
                },
              },
              event_doc_master: true,
              event_doc_status: true,
              event_document_emer_cc_email: true,
              event_document_emer_email_group_for_event: {
                include: {
                  edit_email_group_for_event: true,
                },
              },
              group: true,
              user_type: true,
              create_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              update_by_account: {
                select: {
                  id: true,
                  email: true,
                  first_name: true,
                  last_name: true,
                  signature_base_64: true,
                },
              },
              event_document_emer_file: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
                orderBy: { id: 'desc' },
              },
              event_document_emer_file_pdf: {
                include: {
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                    },
                  },
                },
              },
              event_document_emer_action: {
                include: {
                  event_doc_master: true,
                  event_doc_status: true,
                  group: true,
                  user_type: true,
                  create_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                  update_by_account: {
                    select: {
                      id: true,
                      email: true,
                      first_name: true,
                      last_name: true,
                      signature: true,
                      signature_base_64: true,
                    },
                  },
                },
                orderBy: {
                  id: 'desc',
                },
              },
              event_doc_gas_shipper_match_41: {
                include: {
                  event_doc_gas_shipper_41: {
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_file_41: {
                        include: {
                          create_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                          update_by_account: {
                            select: {
                              id: true,
                              email: true,
                              first_name: true,
                              last_name: true,
                            },
                          },
                        },
                      },
                    },
                  },
                  event_document_emer: true,
                },
                where: {
                  event_document_emer_id: {
                    not: null,
                  },
                },
              },
              event_doc_gas_shipper_41: {
                include: {
                  event_doc_gas_shipper_match_41: {
                    where: {
                      event_document_emer_id: {
                        not: null,
                      },
                    },
                    include: {
                      event_document_emer: true,
                      event_doc_gas_shipper_41: {
                        include: {
                          event_document_emer: true,
                          event_doc_gas_shipper_file_41: {
                            include: {
                              create_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                              update_by_account: {
                                select: {
                                  id: true,
                                  email: true,
                                  first_name: true,
                                  last_name: true,
                                },
                              },
                            },
                          },
                        },
                      },
                    },
                  },
                  event_doc_gas_shipper_file_41: {
                    include: {
                      create_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                      update_by_account: {
                        select: {
                          id: true,
                          email: true,
                          first_name: true,
                          last_name: true,
                        },
                      },
                    },
                    orderBy: { id: 'desc' },
                  },
                },
              },
            },
          });
    console.log('result : ', result);
    return result;
  }

  async doc41Action(id: any, payload: any, userId: any) {
    console.log('id : ', id);
    console.log('userId : ', userId);
    console.log('payload : ', payload);
    const {
      event_doc_status_id,
      doc_41_input_shipper_operation,
      doc_41_input_shipper_note,
    } = payload;

    const result = await this.prisma.$transaction(async (prisma) => {
      const newDate = getTodayNowAdd7();
      const todayStart = getYearStartAdd7().toDate();
      const todayEnd = getYearEndAdd7().toDate();

      const group = await this.prisma.group.findFirst({
        where: {
          account_manage: {
            some: {
              account_id: Number(userId),
            },
          },
        },
        select: {
          id: true,
          user_type: {
            select: {
              id: true,
            },
          },
        },
      });
      const userTypeId = group.user_type?.id;
      const groupId = group?.id;

      if (userTypeId !== 3) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Uset Type Is NOT MATCH',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      const checkStatusRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_status_id: 2,
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      if (checkStatusRunId) {
        throw new HttpException(
          {
            status: HttpStatus.BAD_REQUEST,
            error: 'Status Closed Is NOT Action',
          },
          HttpStatus.BAD_REQUEST,
        );
      }

      await prisma.event_document_emer.updateMany({
        where: {
          id: Number(id),
        },
        data: {
          doc_41_input_shipper_operation:
            doc_41_input_shipper_operation ?? null,
          doc_41_input_shipper_note: doc_41_input_shipper_note ?? null,
          event_doc_status_id: event_doc_status_id,
          update_date: getTodayNowAdd7().toDate(),
          update_date_num: getTodayNowAdd7().unix(),
          update_by: Number(userId),
        },
      });

      await prisma.event_document_emer_action.create({
        data: {
          event_document_emer: {
            connect: {
              id: Number(id),
            },
          },
          event_doc_status: {
            connect: {
              id: event_doc_status_id,
            },
          },
          group: {
            connect: {
              id: groupId,
            },
          },
          user_type: {
            connect: {
              id: userTypeId,
            },
          },
          event_doc_master: {
            connect: {
              id: 4,
            },
          },
          create_date: getTodayNowAdd7().toDate(),
          create_date_num: getTodayNowAdd7().unix(),
          create_by_account: {
            connect: {
              id: Number(userId),
            },
          },
        },
      });

      const eventRunId = await prisma.event_runnumber_emer.findFirst({
        where: {
          event_document_emer: {
            some: {
              id: Number(id),
            },
          },
        },
        select: {
          id: true,
        },
      });

      return { eventRunId: Number(eventRunId?.id) };
    });
    const findOnce = await this.emerOnce(result?.eventRunId, userId);

    await this.prisma.event_document_emer_log_history.create({
      data: {
        temp: JSON.stringify(findOnce),
        group: {
          connect: {
            id: findOnce?.group_id,
          },
        },
        user_type: {
          connect: {
            id: findOnce?.user_type_id,
          },
        },
        event_document_emer: {
          connect: {
            id: Number(id),
          },
        },
        create_date: getTodayNowAdd7().toDate(),
        create_date_num: getTodayNowAdd7().unix(),
        create_by_account: {
          connect: {
            id: Number(userId),
          },
        },
      },
    });

    // เพิ่มคนสร้าง
    const docId = await this.prisma.event_document_emer.findFirst({
      where: { id: Number(id) },
      select: {
        id: true,
        create_by: true,
        group: true,
        group_id: true,
        doc_4_input_date_time_of_the_incident: true,
        event_runnumber_emer: {
          include: {
            event_doc_emer_type: true,
            event_doc_emer_gas_tranmiss: true,
          },
        },
      },
    });
    console.log('docId : ', docId);
    const shipperCreate = await this.prisma.account.findFirst({
      where: {
        id: Number(docId?.create_by),
        account_manage: {
          some: {
            user_type_id: 3,
            account_role: {
              some: {
                role: {
                  menus_config: {
                    some: {
                      menus_id: 107,
                      // f_noti_inapp: 1
                      f_noti_email: 1,
                    },
                  },
                },
              },
            },
          },
        },
      },
      select: {
        id: true,
        email: true,
        first_name: true,
        last_name: true,
        telephone: true,
        account_manage: {
          include: {
            account_role: {
              include: {
                role: true,
              },
            },
          },
        },
      },
    });

    const shipperEmailArr = [
      docId?.group?.email ?? null,
      shipperCreate?.email ?? null,
    ]
      ?.filter((f: any) => f !== null)
      .join(', ');

    const header =
      event_doc_status_id === 5
        ? `Shipper ${docId?.group?.name} รับทราบออกคำสั่งปรับปริมาณก๊าซจากเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง`
        : ``;
    const subject =
      event_doc_status_id === 5
        ? `Events/Emergency Difficult Day - Shipper Acknowledge (Doc.4)`
        : ``;

    const excelBuffer = await this.doc3PDF(
      docId?.id,
      null,
      null,
      docId?.group_id,
      true,
    );

    const originalData = {
      header: header,
      subject: subject,
      sendEmail: shipperEmailArr,
      detail: '',
      excelBuffer: excelBuffer,
      tagHTMLDetail: `
      <div>
        <ul>
          <li>Event Code: ${docId?.event_runnumber_emer?.event_nember || ''}</li>
          <li>Type :  ${docId?.event_runnumber_emer?.event_doc_emer_type?.name_en || ''}</li>
          <li>Date :  ${docId?.doc_4_input_date_time_of_the_incident || ''}</li>
          <li>ระบบส่งก๊าซ :  ${docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_id === 5 ? docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other : docId?.event_runnumber_emer?.event_doc_emer_gas_tranmiss?.name || ''}</li>
        </ul>
      </div>
      `,
      filename: 'emergency_difficult_day_document.pdf',
      // filename: 'documents.zip',
      contentType: 'application/pdf',
      // contentType: 'application/zip',
    };
    await this.sendEmailProviderCustomEvent(originalData);

    return findOnce;
  }

  async doc41PDF(id: any, userId: any, res: any, shipperIds?: any, buff?: any) {
    const logoImage = `data:image/png;base64,${logoPtt}`;
    const logoUsed = `data:image/png;base64,${used}`;
    const logoNotUsed = `data:image/png;base64,${notUsed}`;
    const logocheckBoxCheck = `data:image/png;base64,${checkBoxCheck}`;
    const logocheckBox = `data:image/png;base64,${checkBox}`;

    const group = await this.prisma.group.findFirst({
      where: {
        ...(shipperIds
          ? {
              id: shipperIds,
            }
          : {
              account_manage: {
                some: {
                  account_id: Number(userId),
                },
              },
            }),
      },
      select: {
        id: true,
        name: true,
        user_type: {
          select: {
            id: true,
          },
        },
      },
    });
    const userTypeId = group?.user_type?.id;
    const groupId = group?.id;
    console.log('userTypeId : ', userTypeId);
    if (userTypeId === 3) {
      const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst({
        where: { event_document_emer: { some: { id: Number(id) } } },
      });
      console.log('findRunnumber : ', findRunnumber);
      const rdoc1Find = await this.doc41FindDoc(id, userId, null, shipperIds);
      console.log('rdoc1Find : ', rdoc1Find);
      console.log(
        'rdoc1Find?.event_runnumber_ofo : ',
        rdoc1Find?.event_runnumber_emer,
      );

      const event_document_action = rdoc1Find?.event_document_emer_action;

      const toAction = event_document_action?.find(
        (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
      );
      console.log('toAction : ', toAction);
      const toFullname =
        toAction?.event_doc_status_id !== 1 &&
        toAction?.event_doc_status_id !== 2 &&
        toAction?.create_by_account?.first_name &&
        toAction?.create_by_account?.last_name
          ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
          : '';

      const toCompany =
        (toAction?.group?.company_name && toAction?.group?.company_name) ||
        '';
      const toDate = dayjs(toAction?.create_date).locale('th');
      const toSignature =
        (toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.signature_base_64) ||
        ''; //

      // ----
      const fromFullname =
        rdoc1Find?.create_by_account?.first_name &&
        rdoc1Find?.create_by_account?.last_name
          ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
          : '';
      const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
      const fromSignature =
        rdoc1Find?.create_by_account?.signature_base_64 || ''; //

      const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

      const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
      const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
      const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

      const event_doc_ofo_gas_tranmiss_other =
        rdoc1Find?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other ||
        '___________';

      const input_date_time_of_the_incident =
        rdoc1Find?.doc_41_input_date_time_of_the_incident || ''; //วัน/เวลาที่เกิดเหตุ
      const input_incident = rdoc1Find?.doc_41_input_incident || ''; //รายละเอียดของเหตุการณ์
      const input_detail_incident =
        rdoc1Find?.doc_41_input_detail_incident || ''; //รายละเอียดของเหตุการณ์
      const input_expected_day_time =
        rdoc1Find?.doc_41_input_expected_day_time || ''; //รายละเอียดของเหตุการณ์

      const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

      const input_order_ir_id =
        rdoc1Find?.event_doc_gas_shipper_match_41?.[0]?.event_doc_gas_shipper_41
          ?.ir ?? null;
      const input_order_io_id =
        rdoc1Find?.event_doc_gas_shipper_match_41?.[0]?.event_doc_gas_shipper_41
          ?.io ?? null;
      const input_order_iother_id =
        rdoc1Find?.event_doc_gas_shipper_match_41?.[0]?.event_doc_gas_shipper_41
          ?.iother ?? null;
      const input_value =
        rdoc1Find?.event_doc_gas_shipper_match_41?.[0]?.event_doc_gas_shipper_41
          ?.value ?? null;
      const input_more =
        rdoc1Find?.event_doc_gas_shipper_match_41?.[0]?.event_doc_gas_shipper_41
          ?.more ?? null;

      const input_shipper_operation =
        rdoc1Find?.doc_41_input_shipper_operation ?? null;
      const input_shipper_note = rdoc1Find?.doc_41_input_shipper_note ?? null;
      const input_note = rdoc1Find?.doc_41_input_note ?? null;

      (pdfMake as any).vfs = vfs;
      const fonts = {
        THSarabun: {
          normal: 'THSarabunNew.ttf',
          bold: 'THSarabunNew-Bold.ttf',
          italics: 'THSarabunNew.ttf',
          bolditalics: 'THSarabunNew-Bold.ttf',
        },
      };
      (pdfMake as any).fonts = fonts;
      const docDefinition = {
        header: (currentPage, pageCount) => {
          return {
            columns: [
              { width: '*', text: '' }, // เว้นซ้าย
              {
                width: 'auto',
                stack: [
                  {
                    text: `เลขที่เอกสาร: …………${event_nember}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                  {
                    text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                    fontSize: 12,
                    alignment: 'right',
                  },
                ],
                margin: [0, 5, 10, 0], // [left, top, right, bottom],
              },
            ],
          };
        },
        content: [
          {
            image: logoImage,
            width: 70,
            alignment: 'center',
            margin: [0, 0, 0, 10],
          },

          {
            text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง 2',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
          },

          {
            text: '(เอกสารด่วน)',
            alignment: 'center',
            fontSize: 18,
            bold: true,
            margin: [0, 0, 0, 5],
            color: 'red', // หรือใช้โค้ด HEX เช่น '#FF0000'
          },

          {
            columns: [
              {
                width: 15,
                image:
                  rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id === 1
                    ? logoUsed
                    : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                verticalAlignment: 'middle',
                alignment: 'center',
                fit: [12, 12],
              },
              {
                text: [
                  {
                    text: 'เหตุการณ์ไม่สมดุลอย่างรุนแรง (Difficult Day) ',
                    bold: true,
                    fontSize: 18,
                  },
                ],
                margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                alignment: 'left',
              },
              {
                width: 15,
                image:
                  rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id === 2
                    ? logoUsed
                    : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                verticalAlignment: 'middle',
                alignment: 'center',
                fit: [12, 12],
              },
              {
                text: [
                  {
                    text: 'ภาวะฉุกเฉิน (Emergency) ',
                    bold: true,
                    fontSize: 18,
                  },
                ],
                margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                alignment: 'left',
              },
            ],
            margin: [0, 0, 0, 2],
          },

          // ======== กรอบ "เรียน / สำเนา" =========
          {
            table: {
              widths: ['auto', '*'],
              body: [
                [
                  {
                    text: 'ส่ง:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      // 'ส่วนปฏิบัติกํารรับจ่ํายก๊ําซธรรมชําติรํายวัน (Intra-day Natural Gas Operations Division)',
                      `${group?.name}`,
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
                [
                  {
                    text: 'สำเนา:',
                    bold: true,
                    alignment: 'center',
                    verticalAlignment: 'middle',
                    margin: [0, 10, 0, 10],
                  },
                  {
                    stack: [
                      `${longdo_dict || ''}`,
                      //
                    ],
                    margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ "ระบบส่งก๊าซ" =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        text: '(1.) ระบบส่งก๊าซ',
                        bold: true,
                        // decoration: 'underline',
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          {
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 1
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Onshore East' },
                          {
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 2
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Onshore West' },
                          {
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 3
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Onshore East - West' },
                          {
                            image:
                              rdoc1Find?.event_runnumber_emer
                                ?.event_doc_emer_gas_tranmiss_id === 4
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'Other:' },
                          {
                            width: 'auto',
                            text: `${event_doc_ofo_gas_tranmiss_other}`,
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        columns: [
                          {
                            text: 'ส่วนของผู้ให้บริการ',
                            bold: true,
                            decoration: 'underline',
                            margin: [0, 0, 0, 5],
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          { text: `space`, opacity: 0 },
                          {
                            text: `เนื่องด้วยในวันที่/เวลา: `,
                          },
                          {
                            text:
                              (input_date_time_of_the_incident &&
                                `${input_date_time_of_the_incident}`) ||
                              '________',
                            decoration:
                              input_date_time_of_the_incident && 'underline',
                          },
                          {
                            text: ` เกิดเหตุการไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้`,
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: `สถานที่เกิดเหตุ: `,
                          },
                          {
                            text:
                              (input_incident && `${input_incident}`) ||
                              '________',
                            decoration: input_incident && 'underline',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: `รายละเอียดของเหตุการณ์: `,
                          },
                          {
                            text:
                              (input_detail_incident &&
                                `${input_detail_incident}`) ||
                              '________',
                            decoration: input_detail_incident && 'underline',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        columns: [
                          {
                            text: '_______________________________________________________',
                            margin: [0, 0, 0, 5],
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        text: [
                          // { text: `space`, opacity: 0 },
                          {
                            text: `คาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา: `,
                            bold: true,
                            decoration: 'underline',
                          },
                          {
                            text:
                              (input_expected_day_time &&
                                `${input_expected_day_time}`) ||
                              '________',
                            decoration: input_expected_day_time && 'underline',
                          },
                        ],
                        margin: [0, 0, 0, 5],
                        alignment: 'justify',
                      },
                      {
                        columns: [
                          {
                            text: 'ผู้ให้บริการ ดังนี้',
                            // bold: true,
                            // decoration: 'underline',
                            margin: [0, 0, 0, 5],
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          // { width: 10, text: `${ix + 1}.` },
                          { text: 'การสั่งการ: - ', width: 'auto',
                            bold: true,
                            decoration: 'underline',
                           },
                          {
                            image:
                              input_order_ir_id === 1 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'เพิ่ม /' },
                          {
                            image:
                              input_order_ir_id === 2 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'ลด ปริมาณก๊าซที่' },
                          {
                            image:
                              input_order_io_id === 3 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'จุดส่งเข้า/' },
                          {
                            image:
                              input_order_io_id === 4 ? logoUsed : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          { width: 'auto', text: 'จุดจ่ายออก /' },

                          { width: 'auto', text: 'ปริมาณ: ' },
                          {
                            width: 'auto',
                            text: `${input_value || '________'}`,
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          // { width: 10, text: `${ix + 1}.` },
                          {
                            text: 'การสั่งการ: - ',
                            width: 'auto',
                            opacity: 0,
                            bold: true,
                            decoration: 'underline',
                          },
                          {
                            image:
                              input_order_iother_id === 5
                                ? logoUsed
                                : logoNotUsed,
                            width: 12,
                            height: 12,
                            margin: [0, 0, 3, 0],
                          },
                          {
                            width: 'auto',
                            text: `อื่นๆ: `,
                          },
                          {
                            width: 'auto',
                            text: (input_more && `${input_more}`) || '________',
                            decoration: input_more && 'underline',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },

                      {
                        columns: [
                          // { width: 'auto', text: `space`, opacity: 0 },
                          { width: 'auto', text: `หมายเหตุ:`, 
                            bold: true,
                            decoration: 'underline',
                           },
                          {
                            width: 'auto',
                            text: `${input_note}`,
                            decoration: 'underline',
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบ =========
          {
            table: {
              widths: ['*'],
              body: [
                [
                  {
                    stack: [
                      {
                        columns: [
                          {
                            text: 'ส่วนของผู้ใช้บริการ / คู่สัญญา',
                            bold: true,
                            decoration: 'underline',
                            margin: [0, 0, 0, 5],
                          },
                        ],
                        columnGap: 5,
                        margin: [0, 0, 0, 5],
                      },
                      {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `การดำเนินการ:` },
                            {
                              width: 'auto',
                              text: input_shipper_operation ? `${input_shipper_operation}` : `__________`,
                              decoration: input_shipper_operation && 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `หมายเหตุ:` },
                            {
                              width: 'auto',
                              text: input_shipper_note ? `${input_shipper_note}` : `__________`,
                              decoration: input_shipper_note && 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== กรอบช่องเซ็นชื่อ =========
          {
            table: {
              widths: ['*', '*'],
              body: [
                [
                  // {
                  //     text: 'ส่วนของผู้ใช้บริการ (ผู้ทำให้เกิดเหตุการณ์)',
                  //     bold: true,
                  //     decoration: 'underline',
                  //     margin: [0, 0, 0, 5],
                  //   },
                  {
                    stack: [
                      // { text: `แจ้งโดย ${fromFullname}` },
                      // fromSignature
                      //   ? {
                      //       columns: [
                      //         { text: '(', width: 'auto', alignment: 'right' },
                      //         {
                      //           image: fromSignature, // base64 หรือ path
                      //           width: 50,
                      //           alignment: 'center',
                      //         },
                      //         { text: ')', width: 'auto', alignment: 'left' },
                      //       ],
                      //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                      //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                      //     }
                      //   : { text: `(                                   )` },
                      fromSignature
                        ? {
                            columns: [
                              {
                                text: 'แจ้งโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              {
                                image: fromSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                            ],
                            columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `แจ้งโดย ` },
                      { text: `(${fromFullname})` },
                      { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                      {
                        text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                  {
                    stack: [
                      // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                      // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                      rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        ? {
                            columns: [
                              {
                                text: 'รับทราบโดย',
                                width: 'auto',
                                alignment: 'right',
                              },
                              // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                              {
                                image: toSignature, // base64 หรือ path
                                width: 50,
                                alignment: 'center',
                              },
                              // { text: ')', width: 'auto', alignment: 'left' },
                            ],
                            columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                            margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                          }
                        : { text: `รับทราบโดย` },
                      {
                        text:
                          rdoc1Find?.event_doc_status?.id === 5
                            ? `(${toFullname})`
                            : '(…………………………………………………………)',
                      },
                      {
                        text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                      },
                      {
                        text: `(ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ/ผู้เกี่ยวข้อง)`,
                        width: 'auto',
                        alignment: 'center',
                      },
                      {
                        text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                      },
                    ],
                    margin: [5, 5, 5, 5],
                  },
                ],
              ],
            },
            layout: {
              hLineWidth: () => 0.5,
              vLineWidth: () => 0.5,
            },
            margin: [0, 0, 0, 0],
          },

          // ======== Footer ========
          // {
          //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
          //   alignment: 'left',
          //   fontSize: 10,
          //   bold: true,
          //   margin: [0, 10, 0, 0],
          // },
        ],
        defaultStyle: {
          font: 'THSarabun',
          fontSize: 14,
          // characterSpacing: -0.5,
        },
      };

      if (buff) {
        return new Promise<Buffer>((resolve, reject) => {
          const pdfDocGenerator = pdfMake.createPdf(docDefinition);
          pdfDocGenerator.getBuffer((buffer) => {
            resolve(buffer); // ✅ return buffer ออกไป
          });
        });
      } else {
        const pdfDocGenerator = pdfMake.createPdf(docDefinition);
        pdfDocGenerator.getBuffer((buffer) => {
          res.setHeader('Content-Type', 'application/pdf');
          res.setHeader(
            'Content-Disposition',
            `attachment; filename=offspec_${id}.pdf`,
          );
          res.end(buffer);
        });
      }
    } else {
      const archive = archiver('zip');
      !buff && res.setHeader('Content-Type', 'application/zip');
      !buff &&
        res.setHeader(
          'Content-Disposition',
          'attachment; filename=documents.zip',
        );
      !buff && archive.pipe(res);

      // จำลอง input: [ { userId, id } ]
      const getDocShipper = await this.prisma.event_document_ofo.findMany({
        where: {
          ref_document: Number(id),
        },
        include: {
          group: {
            include: {
              user_type: true,
            },
          },
        },
      });

      const inputList = getDocShipper?.map((gs: any) => {
        return {
          group_id: gs?.group_id,
          group_name: gs?.group?.name,
          groups: gs?.group,
          id: gs?.id,
        };
      });
      console.log('--- : ', inputList);

      // loop shipper
      for (let i = 0; i < inputList.length; i++) {
        const { group_id, group_name, groups, id } = inputList[i];

        const groupId = group_id;

        const findRunnumber = await this.prisma.event_runnumber_emer?.findFirst(
          {
            where: { event_document_emer: { some: { id: Number(id) } } },
          },
        );
        console.log('findRunnumber : ', findRunnumber);
        const rdoc1Find = await this.doc41FindDoc(id, userId, null, group_id);
        console.log('rdoc1Find : ', rdoc1Find);
        console.log(
          'rdoc1Find?.event_runnumber_ofo : ',
          rdoc1Find?.event_runnumber_emer,
        );

        const event_document_action = rdoc1Find?.event_document_emer_action;

        const toAction = event_document_action?.find(
          (f: any) => f?.user_type_id === 3 && f?.group_id === groupId,
        );
        console.log('toAction : ', toAction);
        const toFullname =
          toAction?.event_doc_status_id !== 1 &&
          toAction?.event_doc_status_id !== 2 &&
          toAction?.create_by_account?.first_name &&
          toAction?.create_by_account?.last_name
            ? `${toAction?.create_by_account?.first_name} ${toAction?.create_by_account?.last_name}`
            : '';

        const toCompany =
          (toAction?.group?.company_name && toAction?.group?.company_name) ||
          '';
        const toDate = dayjs(toAction?.create_date).locale('th');
        const toSignature =
          (toAction?.event_doc_status_id !== 1 &&
            toAction?.event_doc_status_id !== 2 &&
            toAction?.create_by_account?.signature_base_64) ||
          ''; //

        // ----
        const fromFullname =
          rdoc1Find?.create_by_account?.first_name &&
          rdoc1Find?.create_by_account?.last_name
            ? `${rdoc1Find?.create_by_account?.first_name} ${rdoc1Find?.create_by_account?.last_name}`
            : '';
        const fromCompany = 'บริษัท ปตท.จำกัด (มหาชน)';
        const fromSignature =
          rdoc1Find?.create_by_account?.signature_base_64 || ''; //

        const fromDate = dayjs(rdoc1Find?.create_date).locale('th');

        const event_nember = rdoc1Find?.event_runnumber_emer?.event_nember;
        const event_doc_status = rdoc1Find?.event_doc_status?.id; // 3 accept, 4 reject, 5 Acknowledge
        const event_runnumber = dayjs(rdoc1Find?.event_date).locale('th');

        const event_doc_ofo_gas_tranmiss_other =
          rdoc1Find?.event_runnumber_emer?.event_doc_emer_gas_tranmiss_other ||
          '___________';

        const input_date_time_of_the_incident =
          rdoc1Find?.doc_41_input_date_time_of_the_incident || ''; //วัน/เวลาที่เกิดเหตุ
        const input_incident = rdoc1Find?.doc_41_input_incident || ''; //รายละเอียดของเหตุการณ์
        const input_detail_incident =
          rdoc1Find?.doc_41_input_detail_incident || ''; //รายละเอียดของเหตุการณ์
        const input_expected_day_time =
          rdoc1Find?.doc_41_input_expected_day_time || ''; //รายละเอียดของเหตุการณ์

        const longdo_dict = rdoc1Find?.longdo_dict || ''; //สำเนา

        const input_order_ir_id =
          rdoc1Find?.event_doc_gas_shipper_match_41?.[0]
            ?.event_doc_gas_shipper_41?.ir ?? null;
        const input_order_io_id =
          rdoc1Find?.event_doc_gas_shipper_match_41?.[0]
            ?.event_doc_gas_shipper_41?.io ?? null;
        const input_order_iother_id =
          rdoc1Find?.event_doc_gas_shipper_match_41?.[0]
            ?.event_doc_gas_shipper_41?.iother ?? null;
        const input_value =
          rdoc1Find?.event_doc_gas_shipper_match_41?.[0]
            ?.event_doc_gas_shipper_41?.value ?? null;
        const input_more =
          rdoc1Find?.event_doc_gas_shipper_match_41?.[0]
            ?.event_doc_gas_shipper_41?.more ?? null;

        const input_shipper_operation =
          rdoc1Find?.doc_41_input_shipper_operation ?? null;
        const input_shipper_note = rdoc1Find?.doc_41_input_shipper_note ?? null;
        const input_note = rdoc1Find?.doc_41_input_note ?? null;

        (pdfMake as any).vfs = vfs;
        const fonts = {
          THSarabun: {
            normal: 'THSarabunNew.ttf',
            bold: 'THSarabunNew-Bold.ttf',
            italics: 'THSarabunNew.ttf',
            bolditalics: 'THSarabunNew-Bold.ttf',
          },
        };
        (pdfMake as any).fonts = fonts;
        const docDefinition = {
          header: (currentPage, pageCount) => {
            return {
              columns: [
                { width: '*', text: '' }, // เว้นซ้าย
                {
                  width: 'auto',
                  stack: [
                    {
                      text: `เลขที่เอกสาร: …………${event_nember}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                    {
                      text: `วันเดือนปีเอกสาร: ……${event_runnumber.format('DD')}…/……${event_runnumber.format('MMM')}……${event_runnumber.format('BBBB')}…………`,
                      fontSize: 12,
                      alignment: 'right',
                    },
                  ],
                  margin: [0, 5, 10, 0], // [left, top, right, bottom],
                },
              ],
            };
          },
          content: [
            {
              image: logoImage,
              width: 70,
              alignment: 'center',
              margin: [0, 0, 0, 10],
            },

            {
              text: 'เอกสารแจ้งเหตุการณ์ฉุกเฉิน/เหตุการณ์ความไม่สมดุลอย่างรุนแรง 2',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
            },

            {
              text: '(เอกสารด่วน)',
              alignment: 'center',
              fontSize: 18,
              bold: true,
              margin: [0, 0, 0, 5],
              color: 'red', // หรือใช้โค้ด HEX เช่น '#FF0000'
            },

            {
              columns: [
                {
                  width: 15,
                  image:
                    rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id ===
                    1
                      ? logoUsed
                      : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                  verticalAlignment: 'middle',
                  alignment: 'center',
                  fit: [12, 12],
                },
                {
                  text: [
                    {
                      text: 'เหตุการณ์ไม่สมดุลอย่างรุนแรง (Difficult Day) ',
                      bold: true,
                      fontSize: 18,
                    },
                  ],
                  margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                  alignment: 'left',
                },
                {
                  width: 15,
                  image:
                    rdoc1Find?.event_runnumber_emer?.event_doc_emer_type_id ===
                    2
                      ? logoUsed
                      : logoNotUsed, // แทนด้วย base64 string //event_doc_status
                  verticalAlignment: 'middle',
                  alignment: 'center',
                  fit: [12, 12],
                },
                {
                  text: [
                    {
                      text: 'ภาวะฉุกเฉิน (Emergency) ',
                      bold: true,
                      fontSize: 18,
                    },
                  ],
                  margin: [5, 0, 0, 0], // เว้นระยะจากรูป
                  alignment: 'left',
                },
              ],
              margin: [0, 0, 0, 2],
            },

            // ======== กรอบ "เรียน / สำเนา" =========
            {
              table: {
                widths: ['auto', '*'],
                body: [
                  [
                    {
                      text: 'ส่ง:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        // 'ส่วนปฏิบัติกํารรับจ่ํายก๊ําซธรรมชําติรํายวัน (Intra-day Natural Gas Operations Division)',
                        `${groups?.name}`,
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                  [
                    {
                      text: 'สำเนา:',
                      bold: true,
                      alignment: 'center',
                      verticalAlignment: 'middle',
                      margin: [0, 10, 0, 10],
                    },
                    {
                      stack: [
                        `${longdo_dict || ''}`,
                        //
                      ],
                      margin: [0, 10, 0, 10], // << บังคับความสูงให้จัดกลาง
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ "ระบบส่งก๊าซ" =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          text: '(1.) ระบบส่งก๊าซ',
                          bold: true,
                          // decoration: 'underline',
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            {
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 1
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Onshore East' },
                            {
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 2
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Onshore West' },
                            {
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 3
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Onshore East - West' },
                            {
                              image:
                                rdoc1Find?.event_runnumber_emer
                                  ?.event_doc_emer_gas_tranmiss_id === 4
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'Other:' },
                            {
                              width: 'auto',
                              text: `${event_doc_ofo_gas_tranmiss_other}`,
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          columns: [
                            {
                              text: 'ส่วนของผู้ให้บริการ',
                              bold: true,
                              decoration: 'underline',
                              margin: [0, 0, 0, 5],
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          text: [
                            { text: `space`, opacity: 0 },
                            {
                              text: `เนื่องด้วยในวันที่/เวลา: `,
                            },
                            {
                              text:
                                (input_date_time_of_the_incident &&
                                  `${input_date_time_of_the_incident}`) ||
                                '________',
                              decoration:
                                input_date_time_of_the_incident && 'underline',
                            },
                            {
                              text: ` เกิดเหตุการไม่สมดุลอย่างรุนแรง / ภาวะฉุกเฉิน ซึ่งมีรายละเอียดดังนี้`,
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: `สถานที่เกิดเหตุ: `,
                            },
                            {
                              text:
                                (input_incident && `${input_incident}`) ||
                                '________',
                              decoration: input_incident && 'underline',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: `รายละเอียดของเหตุการณ์: `,
                            },
                            {
                              text:
                                (input_detail_incident &&
                                  `${input_detail_incident}`) ||
                                '________',
                              decoration: input_detail_incident && 'underline',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          columns: [
                            {
                              text: '_______________________________________________________',
                              margin: [0, 0, 0, 5],
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          text: [
                            // { text: `space`, opacity: 0 },
                            {
                              text: `คาดว่าจะแก้ไขปัญหาแล้วเสร็จในวันที่/เวลา: `,
                              bold: true,
                            decoration: 'underline',
                            },
                            {
                              text:
                                (input_expected_day_time &&
                                  `${input_expected_day_time}`) ||
                                '________',
                              decoration:
                                input_expected_day_time && 'underline',
                            },
                          ],
                          margin: [0, 0, 0, 5],
                          alignment: 'justify',
                        },
                        {
                          columns: [
                            {
                              text: 'ผู้ให้บริการ ดังนี้',
                              // bold: true,
                              // decoration: 'underline',
                              margin: [0, 0, 0, 5],
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            // { width: 10, text: `${ix + 1}.` },
                            { text: 'การสั่งการ: - ', width: 'auto',
                              bold: true,
                            decoration: 'underline',
                             },
                            {
                              image:
                                input_order_ir_id === 1
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'เพิ่ม /' },
                            {
                              image:
                                input_order_ir_id === 2
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'ลด ปริมาณก๊าซที่' },
                            {
                              image:
                                input_order_io_id === 3
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'จุดส่งเข้า/' },
                            {
                              image:
                                input_order_io_id === 4
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            { width: 'auto', text: 'จุดจ่ายออก /' },

                            { width: 'auto', text: 'ปริมาณ: ' },
                            {
                              width: 'auto',
                              text: `${input_value || '________'}`,
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            // { width: 10, text: `${ix + 1}.` },
                            {
                              text: 'การสั่งการ: - ',
                              width: 'auto',
                              opacity: 0,
                              bold: true,
                            decoration: 'underline',
                            },
                            {
                              image:
                                input_order_iother_id === 5
                                  ? logoUsed
                                  : logoNotUsed,
                              width: 12,
                              height: 12,
                              margin: [0, 0, 3, 0],
                            },
                            {
                              width: 'auto',
                              text: `อื่นๆ: `,
                            },
                            {
                              width: 'auto',
                              text:
                                (input_more && `${input_more}`) || '________',
                              decoration: input_more && 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },

                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `หมายเหตุ:`,
                              bold: true,
                            decoration: 'underline',
                             },
                            {
                              width: 'auto',
                              text: `${input_note}`,
                              decoration: 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบ =========
            {
              table: {
                widths: ['*'],
                body: [
                  [
                    {
                      stack: [
                        {
                          columns: [
                            {
                              text: 'ส่วนของผู้ใช้บริการ / คู่สัญญา',
                              bold: true,
                              decoration: 'underline',
                              margin: [0, 0, 0, 5],
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `การดำเนินการ:` },
                            {
                              width: 'auto',
                              text: input_shipper_operation ? `${input_shipper_operation}` : `__________`,
                              decoration: input_shipper_operation && 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                        {
                          columns: [
                            // { width: 'auto', text: `space`, opacity: 0 },
                            { width: 'auto', text: `หมายเหตุ:` },
                            {
                              width: 'auto',
                              text: input_shipper_note ? `${input_shipper_note}` : `__________`,
                              decoration: input_shipper_note && 'underline',
                            },
                          ],
                          columnGap: 5,
                          margin: [0, 0, 0, 5],
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== กรอบช่องเซ็นชื่อ =========
            {
              table: {
                widths: ['*', '*'],
                body: [
                  [
                    // {
                    //     text: 'ส่วนของผู้ใช้บริการ (ผู้ทำให้เกิดเหตุการณ์)',
                    //     bold: true,
                    //     decoration: 'underline',
                    //     margin: [0, 0, 0, 5],
                    //   },
                    {
                      stack: [
                        // { text: `แจ้งโดย ${fromFullname}` },
                        // fromSignature
                        //   ? {
                        //       columns: [
                        //         { text: '(', width: 'auto', alignment: 'right' },
                        //         {
                        //           image: fromSignature, // base64 หรือ path
                        //           width: 50,
                        //           alignment: 'center',
                        //         },
                        //         { text: ')', width: 'auto', alignment: 'left' },
                        //       ],
                        //       columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                        //       margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                        //     }
                        //   : { text: `(                                   )` },
                        fromSignature
                          ? {
                              columns: [
                                {
                                  text: 'แจ้งโดย ',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                {
                                  image: fromSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                              ],
                              columnGap: 15, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `แจ้งโดย ` },
                        { text: `(${fromFullname})` },
                        { text: `หน่วยงาน ${fromCompany} (ผู้ให้บริการ)` },
                        {
                          text: `เวลา : ${fromDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${fromDate.format('DD')} / ${fromDate.format('MM')} / ${fromDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                    {
                      stack: [
                        // { text: `รับทราบโดย ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toFullname}` },
                        // rdoc1Find?.event_doc_status?.id === 5 && toSignature
                        rdoc1Find?.event_doc_status?.id === 5 && toSignature
                          ? {
                              columns: [
                                {
                                  text: 'รับทราบโดย',
                                  width: 'auto',
                                  alignment: 'right',
                                },
                                // { text: 'รับทราบโดย', width: 'auto', alignment: 'right' },
                                {
                                  image: toSignature, // base64 หรือ path
                                  width: 50,
                                  alignment: 'center',
                                },
                                // { text: ')', width: 'auto', alignment: 'left' },
                              ],
                              columnGap: 5, // ระยะห่างระหว่างวงเล็บกับภาพ
                              margin: [0, 2, 0, 5], // ปรับระยะรอบภาพ
                            }
                          : { text: `รับทราบโดย` },
                        {
                          text:
                            rdoc1Find?.event_doc_status?.id === 5
                              ? `(${toFullname})`
                              : '(…………………………………………………………)',
                        },
                        {
                          text: `หน่วยงาน ${rdoc1Find?.event_doc_status?.id === 2 ? '………………………………………………………………' : toCompany}`,
                        },
                        {
                          text: `(ผู้ใช้บริการ/คู่สัญญาของผู้ใช้บริการ/ผู้เกี่ยวข้อง)`,
                          width: 'auto',
                          alignment: 'center',
                        },
                        {
                          text: `เวลา : ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('HH:mm')} น. วันที่/เดือน/ปี: ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('DD')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('MM')} / ${rdoc1Find?.event_doc_status?.id === 2 ? ' ' : toDate.format('BB')}`,
                        },
                      ],
                      margin: [5, 5, 5, 5],
                    },
                  ],
                ],
              },
              layout: {
                hLineWidth: () => 0.5,
                vLineWidth: () => 0.5,
              },
              margin: [0, 0, 0, 0],
            },

            // ======== Footer ========
            // {
            //   text: 'F–บก.บกคด.–0023 ประกาศใช้ 05/11/2564 เวอร์ชั่น 4',
            //   alignment: 'left',
            //   fontSize: 10,
            //   bold: true,
            //   margin: [0, 10, 0, 0],
            // },
          ],
          defaultStyle: {
            font: 'THSarabun',
            fontSize: 14,
            // characterSpacing: -0.5,
          },
        };
        console.log('docDefinition : ', docDefinition);

        const buffer = await this.getPdfBuffer(docDefinition); // แปลงเป็น Buffer แบบ Node.js

        archive.append(buffer, {
          name: `offspec_${group_name}.pdf`,
        });
      }
      if (buff) {
        return await new Promise<Buffer>((resolve, reject) => {
          const chunks: Buffer[] = [];
          archive.on('data', (chunk) => chunks.push(chunk));
          archive.on('end', () => resolve(Buffer.concat(chunks)));
          archive.on('error', (err) => reject(err));
          archive.finalize();
        });
      } else {
        await archive.finalize();
      }
    }
  }
}
